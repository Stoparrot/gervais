import{aB as Bo,F as yr,aA as qi}from"./HdFacVVh.js";var Ni=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function $i(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var hr={exports:{}},Fi=hr.exports,bo;function Ui(){return bo||(bo=1,function(a,n){(function(r,o){a.exports=o()})(Fi,function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(s,i){s.__proto__=i}||function(s,i){for(var u in i)Object.prototype.hasOwnProperty.call(i,u)&&(s[u]=i[u])})(e,t)},o=function(){return(o=Object.assign||function(e){for(var t,s=1,i=arguments.length;s<i;s++)for(var u in t=arguments[s])Object.prototype.hasOwnProperty.call(t,u)&&(e[u]=t[u]);return e}).apply(this,arguments)};function c(e,t,s){for(var i,u=0,l=t.length;u<l;u++)!i&&u in t||((i=i||Array.prototype.slice.call(t,0,u))[u]=t[u]);return e.concat(i||Array.prototype.slice.call(t))}var h=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:Ni,S=Object.keys,P=Array.isArray;function D(e,t){return typeof t!="object"||S(t).forEach(function(s){e[s]=t[s]}),e}typeof Promise>"u"||h.Promise||(h.Promise=Promise);var B=Object.getPrototypeOf,L={}.hasOwnProperty;function $(e,t){return L.call(e,t)}function W(e,t){typeof t=="function"&&(t=t(B(e))),(typeof Reflect>"u"?S:Reflect.ownKeys)(t).forEach(function(s){oe(e,s,t[s])})}var V=Object.defineProperty;function oe(e,t,s,i){V(e,t,D(s&&$(s,"get")&&typeof s.get=="function"?{get:s.get,set:s.set,configurable:!0}:{value:s,configurable:!0,writable:!0},i))}function ge(e){return{from:function(t){return e.prototype=Object.create(t.prototype),oe(e.prototype,"constructor",e),{extend:W.bind(null,e.prototype)}}}}var ye=Object.getOwnPropertyDescriptor,he=[].slice;function ee(e,t,s){return he.call(e,t,s)}function de(e,t){return t(e)}function ce(e){if(!e)throw new Error("Assertion Failed")}function je(e){h.setImmediate?setImmediate(e):setTimeout(e,0)}function be(e,t){if(typeof t=="string"&&$(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var s=[],i=0,u=t.length;i<u;++i){var l=be(e,t[i]);s.push(l)}return s}var f=t.indexOf(".");if(f!==-1){var d=e[t.substr(0,f)];return d==null?void 0:be(d,t.substr(f+1))}}function ie(e,t,s){if(e&&t!==void 0&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){ce(typeof s!="string"&&"length"in s);for(var i=0,u=t.length;i<u;++i)ie(e,t[i],s[i])}else{var l,f,d=t.indexOf(".");d!==-1?(l=t.substr(0,d),(f=t.substr(d+1))===""?s===void 0?P(e)&&!isNaN(parseInt(l))?e.splice(l,1):delete e[l]:e[l]=s:ie(d=!(d=e[l])||!$(e,l)?e[l]={}:d,f,s)):s===void 0?P(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=s}}function Ae(e){var t,s={};for(t in e)$(e,t)&&(s[t]=e[t]);return s}var vt=[].concat;function Ve(e){return vt.apply([],e)}var _t="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Ve([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return h[e]}),Ze=new Set(_t.map(function(e){return h[e]})),Ce=null;function He(e){return Ce=new WeakMap,e=function t(s){if(!s||typeof s!="object")return s;var i=Ce.get(s);if(i)return i;if(P(s)){i=[],Ce.set(s,i);for(var u=0,l=s.length;u<l;++u)i.push(t(s[u]))}else if(Ze.has(s.constructor))i=s;else{var f,d=B(s);for(f in i=d===Object.prototype?{}:Object.create(d),Ce.set(s,i),s)$(s,f)&&(i[f]=t(s[f]))}return i}(e),Ce=null,e}var it={}.toString;function Rt(e){return it.call(e).slice(8,-1)}var et=typeof Symbol<"u"?Symbol.iterator:"@@iterator",_n=typeof et=="symbol"?function(e){var t;return e!=null&&(t=e[et])&&t.apply(e)}:function(){return null};function tt(e,t){return t=e.indexOf(t),0<=t&&e.splice(t,1),0<=t}var De={};function ne(e){var t,s,i,u;if(arguments.length===1){if(P(e))return e.slice();if(this===De&&typeof e=="string")return[e];if(u=_n(e)){for(s=[];!(i=u.next()).done;)s.push(i.value);return s}if(e==null)return[e];if(typeof(t=e.length)!="number")return[e];for(s=new Array(t);t--;)s[t]=e[t];return s}for(t=arguments.length,s=new Array(t);t--;)s[t]=arguments[t];return s}var Ee=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},zt=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Ue=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(zt),Ct={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function Be(e,t){this.name=e,this.message=t}function wt(e,t){return e+". Errors: "+Object.keys(t).map(function(s){return t[s].toString()}).filter(function(s,i,u){return u.indexOf(s)===i}).join(`
`)}function at(e,t,s,i){this.failures=t,this.failedKeys=i,this.successCount=s,this.message=wt(e,t)}function ve(e,t){this.name="BulkError",this.failures=Object.keys(t).map(function(s){return t[s]}),this.failuresByPos=t,this.message=wt(e,this.failures)}ge(Be).from(Error).extend({toString:function(){return this.name+": "+this.message}}),ge(at).from(Be),ge(ve).from(Be);var we=Ue.reduce(function(e,t){return e[t]=t+"Error",e},{}),ae=Be,q=Ue.reduce(function(e,t){var s=t+"Error";function i(u,l){this.name=s,u?typeof u=="string"?(this.message="".concat(u).concat(l?`
 `+l:""),this.inner=l||null):typeof u=="object"&&(this.message="".concat(u.name," ").concat(u.message),this.inner=u):(this.message=Ct[t]||s,this.inner=null)}return ge(i).from(ae),e[t]=i,e},{});q.Syntax=SyntaxError,q.Type=TypeError,q.Range=RangeError;var _e=zt.reduce(function(e,t){return e[t+"Error"]=q[t],e},{}),re=Ue.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=q[t]),e},{});function U(){}function le(e){return e}function qe(e,t){return e==null||e===le?t:function(s){return t(e(s))}}function Je(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function ci(e,t){return e===U?t:function(){var s=e.apply(this,arguments);s!==void 0&&(arguments[0]=s);var i=this.onsuccess,u=this.onerror;this.onsuccess=null,this.onerror=null;var l=t.apply(this,arguments);return i&&(this.onsuccess=this.onsuccess?Je(i,this.onsuccess):i),u&&(this.onerror=this.onerror?Je(u,this.onerror):u),l!==void 0?l:s}}function li(e,t){return e===U?t:function(){e.apply(this,arguments);var s=this.onsuccess,i=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),s&&(this.onsuccess=this.onsuccess?Je(s,this.onsuccess):s),i&&(this.onerror=this.onerror?Je(i,this.onerror):i)}}function fi(e,t){return e===U?t:function(s){var i=e.apply(this,arguments);D(s,i);var u=this.onsuccess,l=this.onerror;return this.onsuccess=null,this.onerror=null,s=t.apply(this,arguments),u&&(this.onsuccess=this.onsuccess?Je(u,this.onsuccess):u),l&&(this.onerror=this.onerror?Je(l,this.onerror):l),i===void 0?s===void 0?void 0:s:D(i,s)}}function hi(e,t){return e===U?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function Ar(e,t){return e===U?t:function(){var s=e.apply(this,arguments);if(s&&typeof s.then=="function"){for(var i=this,u=arguments.length,l=new Array(u);u--;)l[u]=arguments[u];return s.then(function(){return t.apply(i,l)})}return t.apply(this,arguments)}}re.ModifyError=at,re.DexieError=Be,re.BulkError=ve;var ze=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function qs(e){ze=e}var Jt={},Ns=100,_t=typeof Promise>"u"?[]:function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,B(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,B(t),e]}(),zt=_t[0],Ue=_t[1],_t=_t[2],Ue=Ue&&Ue.then,xt=zt&&zt.constructor,Er=!!_t,Xt=function(e,t){Yt.push([e,t]),xn&&(queueMicrotask(pi),xn=!1)},Pr=!0,xn=!0,St=[],Sn=[],Or=le,ut={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:U,pgp:!1,env:{},finalize:U},F=ut,Yt=[],kt=0,kn=[];function j(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var t=this._PSD=F;if(typeof e!="function"){if(e!==Jt)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Mr(this,this._value))}this._state=null,this._value=null,++t.ref,function s(i,u){try{u(function(l){if(i._state===null){if(l===i)throw new TypeError("A promise cannot be resolved with itself.");var f=i._lib&&Dt();l&&typeof l.then=="function"?s(i,function(d,m){l instanceof j?l._then(d,m):l.then(d,m)}):(i._state=!0,i._value=l,Fs(i)),f&&Kt()}},Mr.bind(null,i))}catch(l){Mr(i,l)}}(this,e)}var Ir={get:function(){var e=F,t=On;function s(i,u){var l=this,f=!e.global&&(e!==F||t!==On),d=f&&!lt(),m=new j(function(y,w){Tr(l,new $s(Ls(i,e,f,d),Ls(u,e,f,d),y,w,e))});return this._consoleTask&&(m._consoleTask=this._consoleTask),m}return s.prototype=Jt,s},set:function(e){oe(this,"then",e&&e.prototype===Jt?Ir:{get:function(){return e},set:Ir.set})}};function $s(e,t,s,i,u){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=s,this.reject=i,this.psd=u}function Mr(e,t){var s,i;Sn.push(t),e._state===null&&(s=e._lib&&Dt(),t=Or(t),e._state=!1,e._value=t,i=e,St.some(function(u){return u._value===i._value})||St.push(i),Fs(e),s&&Kt())}function Fs(e){var t=e._listeners;e._listeners=[];for(var s=0,i=t.length;s<i;++s)Tr(e,t[s]);var u=e._PSD;--u.ref||u.finalize(),kt===0&&(++kt,Xt(function(){--kt==0&&Rr()},[]))}function Tr(e,t){if(e._state!==null){var s=e._state?t.onFulfilled:t.onRejected;if(s===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++kt,Xt(di,[s,e,t])}else e._listeners.push(t)}function di(e,t,s){try{var i,u=t._value;!t._state&&Sn.length&&(Sn=[]),i=ze&&t._consoleTask?t._consoleTask.run(function(){return e(u)}):e(u),t._state||Sn.indexOf(u)!==-1||function(l){for(var f=St.length;f;)if(St[--f]._value===l._value)return St.splice(f,1)}(t),s.resolve(i)}catch(l){s.reject(l)}finally{--kt==0&&Rr(),--s.psd.ref||s.psd.finalize()}}function pi(){At(ut,function(){Dt()&&Kt()})}function Dt(){var e=Pr;return xn=Pr=!1,e}function Kt(){var e,t,s;do for(;0<Yt.length;)for(e=Yt,Yt=[],s=e.length,t=0;t<s;++t){var i=e[t];i[0].apply(null,i[1])}while(0<Yt.length);xn=Pr=!0}function Rr(){var e=St;St=[],e.forEach(function(i){i._PSD.onunhandled.call(null,i._value,i)});for(var t=kn.slice(0),s=t.length;s;)t[--s]()}function An(e){return new j(Jt,!1,e)}function fe(e,t){var s=F;return function(){var i=Dt(),u=F;try{return ft(s,!0),e.apply(this,arguments)}catch(l){t&&t(l)}finally{ft(u,!1),i&&Kt()}}}W(j.prototype,{then:Ir,_then:function(e,t){Tr(this,new $s(null,null,e,t,F))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=e,s=arguments[1];return typeof t=="function"?this.then(null,function(i){return(i instanceof t?s:An)(i)}):this.then(null,function(i){return(i&&i.name===t?s:An)(i)})},finally:function(e){return this.then(function(t){return j.resolve(e()).then(function(){return t})},function(t){return j.resolve(e()).then(function(){return An(t)})})},timeout:function(e,t){var s=this;return e<1/0?new j(function(i,u){var l=setTimeout(function(){return u(new q.Timeout(t))},e);s.then(i,u).finally(clearTimeout.bind(null,l))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&oe(j.prototype,Symbol.toStringTag,"Dexie.Promise"),ut.env=Us(),W(j,{all:function(){var e=ne.apply(null,arguments).map(In);return new j(function(t,s){e.length===0&&t([]);var i=e.length;e.forEach(function(u,l){return j.resolve(u).then(function(f){e[l]=f,--i||t(e)},s)})})},resolve:function(e){return e instanceof j?e:e&&typeof e.then=="function"?new j(function(t,s){e.then(t,s)}):new j(Jt,!0,e)},reject:An,race:function(){var e=ne.apply(null,arguments).map(In);return new j(function(t,s){e.map(function(i){return j.resolve(i).then(t,s)})})},PSD:{get:function(){return F},set:function(e){return F=e}},totalEchoes:{get:function(){return On}},newPSD:ct,usePSD:At,scheduler:{get:function(){return Xt},set:function(e){Xt=e}},rejectionMapper:{get:function(){return Or},set:function(e){Or=e}},follow:function(e,t){return new j(function(s,i){return ct(function(u,l){var f=F;f.unhandleds=[],f.onunhandled=l,f.finalize=Je(function(){var d,m=this;d=function(){m.unhandleds.length===0?u():l(m.unhandleds[0])},kn.push(function y(){d(),kn.splice(kn.indexOf(y),1)}),++kt,Xt(function(){--kt==0&&Rr()},[])},f.finalize),e()},t,s,i)})}}),xt&&(xt.allSettled&&oe(j,"allSettled",function(){var e=ne.apply(null,arguments).map(In);return new j(function(t){e.length===0&&t([]);var s=e.length,i=new Array(s);e.forEach(function(u,l){return j.resolve(u).then(function(f){return i[l]={status:"fulfilled",value:f}},function(f){return i[l]={status:"rejected",reason:f}}).then(function(){return--s||t(i)})})})}),xt.any&&typeof AggregateError<"u"&&oe(j,"any",function(){var e=ne.apply(null,arguments).map(In);return new j(function(t,s){e.length===0&&s(new AggregateError([]));var i=e.length,u=new Array(i);e.forEach(function(l,f){return j.resolve(l).then(function(d){return t(d)},function(d){u[f]=d,--i||s(new AggregateError(u))})})})}),xt.withResolvers&&(j.withResolvers=xt.withResolvers));var xe={awaits:0,echoes:0,id:0},mi=0,En=[],Pn=0,On=0,gi=0;function ct(e,t,s,i){var u=F,l=Object.create(u);return l.parent=u,l.ref=0,l.global=!1,l.id=++gi,ut.env,l.env=Er?{Promise:j,PromiseProp:{value:j,configurable:!0,writable:!0},all:j.all,race:j.race,allSettled:j.allSettled,any:j.any,resolve:j.resolve,reject:j.reject}:{},t&&D(l,t),++u.ref,l.finalize=function(){--this.parent.ref||this.parent.finalize()},i=At(l,e,s,i),l.ref===0&&l.finalize(),i}function jt(){return xe.id||(xe.id=++mi),++xe.awaits,xe.echoes+=Ns,xe.id}function lt(){return!!xe.awaits&&(--xe.awaits==0&&(xe.id=0),xe.echoes=xe.awaits*Ns,!0)}function In(e){return xe.echoes&&e&&e.constructor===xt?(jt(),e.then(function(t){return lt(),t},function(t){return lt(),pe(t)})):e}function yi(){var e=En[En.length-1];En.pop(),ft(e,!1)}function ft(e,t){var s,i=F;(t?!xe.echoes||Pn++&&e===F:!Pn||--Pn&&e===F)||queueMicrotask(t?(function(u){++On,xe.echoes&&--xe.echoes!=0||(xe.echoes=xe.awaits=xe.id=0),En.push(F),ft(u,!0)}).bind(null,e):yi),e!==F&&(F=e,i===ut&&(ut.env=Us()),Er&&(s=ut.env.Promise,t=e.env,(i.global||e.global)&&(Object.defineProperty(h,"Promise",t.PromiseProp),s.all=t.all,s.race=t.race,s.resolve=t.resolve,s.reject=t.reject,t.allSettled&&(s.allSettled=t.allSettled),t.any&&(s.any=t.any))))}function Us(){var e=h.Promise;return Er?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(h,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject}:{}}function At(e,t,s,i,u){var l=F;try{return ft(e,!0),t(s,i,u)}finally{ft(l,!1)}}function Ls(e,t,s,i){return typeof e!="function"?e:function(){var u=F;s&&jt(),ft(t,!0);try{return e.apply(this,arguments)}finally{ft(u,!1),i&&queueMicrotask(lt)}}}function Cr(e){Promise===xt&&xe.echoes===0?Pn===0?e():enqueueNativeMicroTask(e):setTimeout(e,0)}(""+Ue).indexOf("[native code]")===-1&&(jt=lt=U);var pe=j.reject,Et="ï¿¿",nt="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Ws="String expected.",Bt=[],Mn="__dbnames",Dr="readonly",Kr="readwrite";function Pt(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var Hs={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Tn(e){return typeof e!="string"||/\./.test(e)?function(t){return t}:function(t){return t[e]===void 0&&e in t&&delete(t=He(t))[e],t}}function Gs(){throw q.Type()}function Q(e,t){try{var s=Vs(e),i=Vs(t);if(s!==i)return s==="Array"?1:i==="Array"?-1:s==="binary"?1:i==="binary"?-1:s==="string"?1:i==="string"?-1:s==="Date"?1:i!=="Date"?NaN:-1;switch(s){case"number":case"Date":case"string":return t<e?1:e<t?-1:0;case"binary":return function(u,l){for(var f=u.length,d=l.length,m=f<d?f:d,y=0;y<m;++y)if(u[y]!==l[y])return u[y]<l[y]?-1:1;return f===d?0:f<d?-1:1}(Js(e),Js(t));case"Array":return function(u,l){for(var f=u.length,d=l.length,m=f<d?f:d,y=0;y<m;++y){var w=Q(u[y],l[y]);if(w!==0)return w}return f===d?0:f<d?-1:1}(e,t)}}catch{}return NaN}function Vs(e){var t=typeof e;return t!="object"?t:ArrayBuffer.isView(e)?"binary":(e=Rt(e),e==="ArrayBuffer"?"binary":e)}function Js(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var zs=(ue.prototype._trans=function(e,t,s){var i=this._tx||F.trans,u=this.name,l=ze&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(e==="readonly"?"read":"write"," ").concat(this.name));function f(y,w,p){if(!p.schema[u])throw new q.NotFound("Table "+u+" not part of transaction");return t(p.idbtrans,p)}var d=Dt();try{var m=i&&i.db._novip===this.db._novip?i===F.trans?i._promise(e,f,s):ct(function(){return i._promise(e,f,s)},{trans:i,transless:F.transless||F}):function y(w,p,x,g){if(w.idbdb&&(w._state.openComplete||F.letThrough||w._vip)){var v=w._createTransaction(p,x,w._dbSchema);try{v.create(),w._state.PR1398_maxLoop=3}catch(_){return _.name===we.InvalidState&&w.isOpen()&&0<--w._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),w.close({disableAutoOpen:!1}),w.open().then(function(){return y(w,p,x,g)})):pe(_)}return v._promise(p,function(_,b){return ct(function(){return F.trans=v,g(_,b,v)})}).then(function(_){if(p==="readwrite")try{v.idbtrans.commit()}catch{}return p==="readonly"?_:v._completion.then(function(){return _})})}if(w._state.openComplete)return pe(new q.DatabaseClosed(w._state.dbOpenError));if(!w._state.isBeingOpened){if(!w._state.autoOpen)return pe(new q.DatabaseClosed);w.open().catch(U)}return w._state.dbReadyPromise.then(function(){return y(w,p,x,g)})}(this.db,e,[this.name],f);return l&&(m._consoleTask=l,m=m.catch(function(y){return console.trace(y),pe(y)})),m}finally{d&&Kt()}},ue.prototype.get=function(e,t){var s=this;return e&&e.constructor===Object?this.where(e).first(t):e==null?pe(new q.Type("Invalid argument to Table.get()")):this._trans("readonly",function(i){return s.core.get({trans:i,key:e}).then(function(u){return s.hook.reading.fire(u)})}).then(t)},ue.prototype.where=function(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(P(e))return new this.db.WhereClause(this,"[".concat(e.join("+"),"]"));var t=S(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);var s=this.schema.indexes.concat(this.schema.primKey).filter(function(d){if(d.compound&&t.every(function(y){return 0<=d.keyPath.indexOf(y)})){for(var m=0;m<t.length;++m)if(t.indexOf(d.keyPath[m])===-1)return!1;return!0}return!1}).sort(function(d,m){return d.keyPath.length-m.keyPath.length})[0];if(s&&this.db._maxKey!==Et){var l=s.keyPath.slice(0,t.length);return this.where(l).equals(l.map(function(m){return e[m]}))}!s&&ze&&console.warn("The query ".concat(JSON.stringify(e)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(t.join("+"),"]"));var i=this.schema.idxByName;function u(d,m){return Q(d,m)===0}var f=t.reduce(function(p,m){var y=p[0],w=p[1],p=i[m],x=e[m];return[y||p,y||!p?Pt(w,p&&p.multi?function(g){return g=be(g,m),P(g)&&g.some(function(v){return u(x,v)})}:function(g){return u(x,be(g,m))}):w]},[null,null]),l=f[0],f=f[1];return l?this.where(l.name).equals(e[l.keyPath]).filter(f):s?this.filter(f):this.where(t).equals("")},ue.prototype.filter=function(e){return this.toCollection().and(e)},ue.prototype.count=function(e){return this.toCollection().count(e)},ue.prototype.offset=function(e){return this.toCollection().offset(e)},ue.prototype.limit=function(e){return this.toCollection().limit(e)},ue.prototype.each=function(e){return this.toCollection().each(e)},ue.prototype.toArray=function(e){return this.toCollection().toArray(e)},ue.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},ue.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,P(e)?"[".concat(e.join("+"),"]"):e))},ue.prototype.reverse=function(){return this.toCollection().reverse()},ue.prototype.mapToClass=function(e){var t,s=this.db,i=this.name;function u(){return t!==null&&t.apply(this,arguments)||this}(this.schema.mappedClass=e).prototype instanceof Gs&&(function(m,y){if(typeof y!="function"&&y!==null)throw new TypeError("Class extends value "+String(y)+" is not a constructor or null");function w(){this.constructor=m}r(m,y),m.prototype=y===null?Object.create(y):(w.prototype=y.prototype,new w)}(u,t=e),Object.defineProperty(u.prototype,"db",{get:function(){return s},enumerable:!1,configurable:!0}),u.prototype.table=function(){return i},e=u);for(var l=new Set,f=e.prototype;f;f=B(f))Object.getOwnPropertyNames(f).forEach(function(m){return l.add(m)});function d(m){if(!m)return m;var y,w=Object.create(e.prototype);for(y in m)if(!l.has(y))try{w[y]=m[y]}catch{}return w}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=d,this.hook("reading",d),e},ue.prototype.defineClass=function(){return this.mapToClass(function(e){D(this,e)})},ue.prototype.add=function(e,t){var s=this,i=this.schema.primKey,u=i.auto,l=i.keyPath,f=e;return l&&u&&(f=Tn(l)(e)),this._trans("readwrite",function(d){return s.core.mutate({trans:d,type:"add",keys:t!=null?[t]:null,values:[f]})}).then(function(d){return d.numFailures?j.reject(d.failures[0]):d.lastResult}).then(function(d){if(l)try{ie(e,l,d)}catch{}return d})},ue.prototype.update=function(e,t){return typeof e!="object"||P(e)?this.where(":id").equals(e).modify(t):(e=be(e,this.schema.primKey.keyPath),e===void 0?pe(new q.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(e).modify(t))},ue.prototype.put=function(e,t){var s=this,i=this.schema.primKey,u=i.auto,l=i.keyPath,f=e;return l&&u&&(f=Tn(l)(e)),this._trans("readwrite",function(d){return s.core.mutate({trans:d,type:"put",values:[f],keys:t!=null?[t]:null})}).then(function(d){return d.numFailures?j.reject(d.failures[0]):d.lastResult}).then(function(d){if(l)try{ie(e,l,d)}catch{}return d})},ue.prototype.delete=function(e){var t=this;return this._trans("readwrite",function(s){return t.core.mutate({trans:s,type:"delete",keys:[e]})}).then(function(s){return s.numFailures?j.reject(s.failures[0]):void 0})},ue.prototype.clear=function(){var e=this;return this._trans("readwrite",function(t){return e.core.mutate({trans:t,type:"deleteRange",range:Hs})}).then(function(t){return t.numFailures?j.reject(t.failures[0]):void 0})},ue.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",function(s){return t.core.getMany({keys:e,trans:s}).then(function(i){return i.map(function(u){return t.hook.reading.fire(u)})})})},ue.prototype.bulkAdd=function(e,t,s){var i=this,u=Array.isArray(t)?t:void 0,l=(s=s||(u?void 0:t))?s.allKeys:void 0;return this._trans("readwrite",function(f){var y=i.schema.primKey,d=y.auto,y=y.keyPath;if(y&&u)throw new q.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(u&&u.length!==e.length)throw new q.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,y=y&&d?e.map(Tn(y)):e;return i.core.mutate({trans:f,type:"add",keys:u,values:y,wantResults:l}).then(function(v){var p=v.numFailures,x=v.results,g=v.lastResult,v=v.failures;if(p===0)return l?x:g;throw new ve("".concat(i.name,".bulkAdd(): ").concat(p," of ").concat(m," operations failed"),v)})})},ue.prototype.bulkPut=function(e,t,s){var i=this,u=Array.isArray(t)?t:void 0,l=(s=s||(u?void 0:t))?s.allKeys:void 0;return this._trans("readwrite",function(f){var y=i.schema.primKey,d=y.auto,y=y.keyPath;if(y&&u)throw new q.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(u&&u.length!==e.length)throw new q.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,y=y&&d?e.map(Tn(y)):e;return i.core.mutate({trans:f,type:"put",keys:u,values:y,wantResults:l}).then(function(v){var p=v.numFailures,x=v.results,g=v.lastResult,v=v.failures;if(p===0)return l?x:g;throw new ve("".concat(i.name,".bulkPut(): ").concat(p," of ").concat(m," operations failed"),v)})})},ue.prototype.bulkUpdate=function(e){var t=this,s=this.core,i=e.map(function(f){return f.key}),u=e.map(function(f){return f.changes}),l=[];return this._trans("readwrite",function(f){return s.getMany({trans:f,keys:i,cache:"clone"}).then(function(d){var m=[],y=[];e.forEach(function(p,x){var g=p.key,v=p.changes,_=d[x];if(_){for(var b=0,k=Object.keys(v);b<k.length;b++){var A=k[b],E=v[A];if(A===t.schema.primKey.keyPath){if(Q(E,g)!==0)throw new q.Constraint("Cannot update primary key in bulkUpdate()")}else ie(_,A,E)}l.push(x),m.push(g),y.push(_)}});var w=m.length;return s.mutate({trans:f,type:"put",keys:m,values:y,updates:{keys:i,changeSpecs:u}}).then(function(p){var x=p.numFailures,g=p.failures;if(x===0)return w;for(var v=0,_=Object.keys(g);v<_.length;v++){var b,k=_[v],A=l[Number(k)];A!=null&&(b=g[k],delete g[k],g[A]=b)}throw new ve("".concat(t.name,".bulkUpdate(): ").concat(x," of ").concat(w," operations failed"),g)})})})},ue.prototype.bulkDelete=function(e){var t=this,s=e.length;return this._trans("readwrite",function(i){return t.core.mutate({trans:i,type:"delete",keys:e})}).then(function(f){var u=f.numFailures,l=f.lastResult,f=f.failures;if(u===0)return l;throw new ve("".concat(t.name,".bulkDelete(): ").concat(u," of ").concat(s," operations failed"),f)})},ue);function ue(){}function Qt(e){function t(f,d){if(d){for(var m=arguments.length,y=new Array(m-1);--m;)y[m-1]=arguments[m];return s[f].subscribe.apply(null,y),e}if(typeof f=="string")return s[f]}var s={};t.addEventType=l;for(var i=1,u=arguments.length;i<u;++i)l(arguments[i]);return t;function l(f,d,m){if(typeof f!="object"){var y;d=d||hi;var w={subscribers:[],fire:m=m||U,subscribe:function(p){w.subscribers.indexOf(p)===-1&&(w.subscribers.push(p),w.fire=d(w.fire,p))},unsubscribe:function(p){w.subscribers=w.subscribers.filter(function(x){return x!==p}),w.fire=w.subscribers.reduce(d,m)}};return s[f]=t[f]=w}S(y=f).forEach(function(p){var x=y[p];if(P(x))l(p,y[p][0],y[p][1]);else{if(x!=="asap")throw new q.InvalidArgument("Invalid event config");var g=l(p,le,function(){for(var v=arguments.length,_=new Array(v);v--;)_[v]=arguments[v];g.subscribers.forEach(function(b){je(function(){b.apply(null,_)})})})}})}}function Zt(e,t){return ge(t).from({prototype:e}),t}function qt(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function jr(e,t){e.filter=Pt(e.filter,t)}function Br(e,t,s){var i=e.replayFilter;e.replayFilter=i?function(){return Pt(i(),t())}:t,e.justLimit=s&&!i}function Rn(e,t){if(e.isPrimKey)return t.primaryKey;var s=t.getIndexByKeyPath(e.index);if(!s)throw new q.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return s}function Xs(e,t,s){var i=Rn(e,t.schema);return t.openCursor({trans:s,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:i,range:e.range}})}function Cn(e,t,s,i){var u=e.replayFilter?Pt(e.filter,e.replayFilter()):e.filter;if(e.or){var l={},f=function(d,m,y){var w,p;u&&!u(m,y,function(x){return m.stop(x)},function(x){return m.fail(x)})||((p=""+(w=m.primaryKey))=="[object ArrayBuffer]"&&(p=""+new Uint8Array(w)),$(l,p)||(l[p]=!0,t(d,m,y)))};return Promise.all([e.or._iterate(f,s),Ys(Xs(e,i,s),e.algorithm,f,!e.keysOnly&&e.valueMapper)])}return Ys(Xs(e,i,s),Pt(e.algorithm,u),t,!e.keysOnly&&e.valueMapper)}function Ys(e,t,s,i){var u=fe(i?function(l,f,d){return s(i(l),f,d)}:s);return e.then(function(l){if(l)return l.start(function(){var f=function(){return l.continue()};t&&!t(l,function(d){return f=d},function(d){l.stop(d),f=U},function(d){l.fail(d),f=U})||u(l.value,l,function(d){return f=d}),f()})})}var en=(Qs.prototype.execute=function(e){var t=this["@@propmod"];if(t.add!==void 0){var s=t.add;if(P(s))return c(c([],P(e)?e:[],!0),s).sort();if(typeof s=="number")return(Number(e)||0)+s;if(typeof s=="bigint")try{return BigInt(e)+s}catch{return BigInt(0)+s}throw new TypeError("Invalid term ".concat(s))}if(t.remove!==void 0){var i=t.remove;if(P(i))return P(e)?e.filter(function(u){return!i.includes(u)}).sort():[];if(typeof i=="number")return Number(e)-i;if(typeof i=="bigint")try{return BigInt(e)-i}catch{return BigInt(0)-i}throw new TypeError("Invalid subtrahend ".concat(i))}return s=(s=t.replacePrefix)===null||s===void 0?void 0:s[0],s&&typeof e=="string"&&e.startsWith(s)?t.replacePrefix[1]+e.substring(s.length):e},Qs);function Qs(e){this["@@propmod"]=e}var bi=(te.prototype._read=function(e,t){var s=this._ctx;return s.error?s.table._trans(null,pe.bind(null,s.error)):s.table._trans("readonly",e).then(t)},te.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,pe.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},te.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=Pt(t.algorithm,e)},te.prototype._iterate=function(e,t){return Cn(this._ctx,e,t,this._ctx.table.core)},te.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),s=Object.create(this._ctx);return e&&D(s,e),t._ctx=s,t},te.prototype.raw=function(){return this._ctx.valueMapper=null,this},te.prototype.each=function(e){var t=this._ctx;return this._read(function(s){return Cn(t,e,s,t.table.core)})},te.prototype.count=function(e){var t=this;return this._read(function(s){var i=t._ctx,u=i.table.core;if(qt(i,!0))return u.count({trans:s,query:{index:Rn(i,u.schema),range:i.range}}).then(function(f){return Math.min(f,i.limit)});var l=0;return Cn(i,function(){return++l,!1},s,u).then(function(){return l})}).then(e)},te.prototype.sortBy=function(e,t){var s=e.split(".").reverse(),i=s[0],u=s.length-1;function l(m,y){return y?l(m[s[y]],y-1):m[i]}var f=this._ctx.dir==="next"?1:-1;function d(m,y){return Q(l(m,u),l(y,u))*f}return this.toArray(function(m){return m.sort(d)}).then(t)},te.prototype.toArray=function(e){var t=this;return this._read(function(s){var i=t._ctx;if(i.dir==="next"&&qt(i,!0)&&0<i.limit){var u=i.valueMapper,l=Rn(i,i.table.core.schema);return i.table.core.query({trans:s,limit:i.limit,values:!0,query:{index:l,range:i.range}}).then(function(d){return d=d.result,u?d.map(u):d})}var f=[];return Cn(i,function(d){return f.push(d)},s,i.table.core).then(function(){return f})},e)},te.prototype.offset=function(e){var t=this._ctx;return e<=0||(t.offset+=e,qt(t)?Br(t,function(){var s=e;return function(i,u){return s===0||(s===1?--s:u(function(){i.advance(s),s=0}),!1)}}):Br(t,function(){var s=e;return function(){return--s<0}})),this},te.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Br(this._ctx,function(){var t=e;return function(s,i,u){return--t<=0&&i(u),0<=t}},!0),this},te.prototype.until=function(e,t){return jr(this._ctx,function(s,i,u){return!e(s.value)||(i(u),t)}),this},te.prototype.first=function(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)},te.prototype.last=function(e){return this.reverse().first(e)},te.prototype.filter=function(e){var t;return jr(this._ctx,function(s){return e(s.value)}),(t=this._ctx).isMatch=Pt(t.isMatch,e),this},te.prototype.and=function(e){return this.filter(e)},te.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},te.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},te.prototype.desc=function(){return this.reverse()},te.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(s,i){e(i.key,i)})},te.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},te.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(s,i){e(i.primaryKey,i)})},te.prototype.keys=function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var s=[];return this.each(function(i,u){s.push(u.key)}).then(function(){return s}).then(e)},te.prototype.primaryKeys=function(e){var t=this._ctx;if(t.dir==="next"&&qt(t,!0)&&0<t.limit)return this._read(function(i){var u=Rn(t,t.table.core.schema);return t.table.core.query({trans:i,values:!1,limit:t.limit,query:{index:u,range:t.range}})}).then(function(i){return i.result}).then(e);t.keysOnly=!t.isMatch;var s=[];return this.each(function(i,u){s.push(u.primaryKey)}).then(function(){return s}).then(e)},te.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},te.prototype.firstKey=function(e){return this.limit(1).keys(function(t){return t[0]}).then(e)},te.prototype.lastKey=function(e){return this.reverse().firstKey(e)},te.prototype.distinct=function(){var e=this._ctx,e=e.index&&e.table.schema.idxByName[e.index];if(!e||!e.multi)return this;var t={};return jr(this._ctx,function(u){var i=u.primaryKey.toString(),u=$(t,i);return t[i]=!0,!u}),this},te.prototype.modify=function(e){var t=this,s=this._ctx;return this._write(function(i){var u,l,f;f=typeof e=="function"?e:(u=S(e),l=u.length,function(b){for(var k=!1,A=0;A<l;++A){var E=u[A],O=e[E],I=be(b,E);O instanceof en?(ie(b,E,O.execute(I)),k=!0):I!==O&&(ie(b,E,O),k=!0)}return k});var d=s.table.core,p=d.schema.primaryKey,m=p.outbound,y=p.extractKey,w=200,p=t.db._options.modifyChunkSize;p&&(w=typeof p=="object"?p[d.name]||p["*"]||200:p);function x(b,E){var A=E.failures,E=E.numFailures;v+=b-E;for(var O=0,I=S(A);O<I.length;O++){var C=I[O];g.push(A[C])}}var g=[],v=0,_=[];return t.clone().primaryKeys().then(function(b){function k(E){var O=Math.min(w,b.length-E);return d.getMany({trans:i,keys:b.slice(E,E+O),cache:"immutable"}).then(function(I){for(var C=[],M=[],T=m?[]:null,K=[],R=0;R<O;++R){var N=I[R],G={value:He(N),primKey:b[E+R]};f.call(G,G.value,G)!==!1&&(G.value==null?K.push(b[E+R]):m||Q(y(N),y(G.value))===0?(M.push(G.value),m&&T.push(b[E+R])):(K.push(b[E+R]),C.push(G.value)))}return Promise.resolve(0<C.length&&d.mutate({trans:i,type:"add",values:C}).then(function(X){for(var Y in X.failures)K.splice(parseInt(Y),1);x(C.length,X)})).then(function(){return(0<M.length||A&&typeof e=="object")&&d.mutate({trans:i,type:"put",keys:T,values:M,criteria:A,changeSpec:typeof e!="function"&&e,isAdditionalChunk:0<E}).then(function(X){return x(M.length,X)})}).then(function(){return(0<K.length||A&&e===qr)&&d.mutate({trans:i,type:"delete",keys:K,criteria:A,isAdditionalChunk:0<E}).then(function(X){return x(K.length,X)})}).then(function(){return b.length>E+O&&k(E+w)})})}var A=qt(s)&&s.limit===1/0&&(typeof e!="function"||e===qr)&&{index:s.index,range:s.range};return k(0).then(function(){if(0<g.length)throw new at("Error modifying one or more objects",g,v,_);return b.length})})})},te.prototype.delete=function(){var e=this._ctx,t=e.range;return qt(e)&&(e.isPrimKey||t.type===3)?this._write(function(s){var i=e.table.core.schema.primaryKey,u=t;return e.table.core.count({trans:s,query:{index:i,range:u}}).then(function(l){return e.table.core.mutate({trans:s,type:"deleteRange",range:u}).then(function(f){var d=f.failures;if(f.lastResult,f.results,f=f.numFailures,f)throw new at("Could not delete some values",Object.keys(d).map(function(m){return d[m]}),l-f);return l-f})})}):this.modify(qr)},te);function te(){}var qr=function(e,t){return t.value=null};function vi(e,t){return e<t?-1:e===t?0:1}function wi(e,t){return t<e?-1:e===t?0:1}function Ne(e,t,s){return e=e instanceof eo?new e.Collection(e):e,e._ctx.error=new(s||TypeError)(t),e}function Nt(e){return new e.Collection(e,function(){return Zs("")}).limit(0)}function Dn(e,t,s,i){var u,l,f,d,m,y,w,p=s.length;if(!s.every(function(v){return typeof v=="string"}))return Ne(e,Ws);function x(v){u=v==="next"?function(b){return b.toUpperCase()}:function(b){return b.toLowerCase()},l=v==="next"?function(b){return b.toLowerCase()}:function(b){return b.toUpperCase()},f=v==="next"?vi:wi;var _=s.map(function(b){return{lower:l(b),upper:u(b)}}).sort(function(b,k){return f(b.lower,k.lower)});d=_.map(function(b){return b.upper}),m=_.map(function(b){return b.lower}),w=(y=v)==="next"?"":i}x("next"),e=new e.Collection(e,function(){return ht(d[0],m[p-1]+i)}),e._ondirectionchange=function(v){x(v)};var g=0;return e._addAlgorithm(function(v,_,b){var k=v.key;if(typeof k!="string")return!1;var A=l(k);if(t(A,m,g))return!0;for(var E=null,O=g;O<p;++O){var I=function(C,M,T,K,R,N){for(var G=Math.min(C.length,K.length),X=-1,Y=0;Y<G;++Y){var $e=M[Y];if($e!==K[Y])return R(C[Y],T[Y])<0?C.substr(0,Y)+T[Y]+T.substr(Y+1):R(C[Y],K[Y])<0?C.substr(0,Y)+K[Y]+T.substr(Y+1):0<=X?C.substr(0,X)+M[X]+T.substr(X+1):null;R(C[Y],$e)<0&&(X=Y)}return G<K.length&&N==="next"?C+T.substr(C.length):G<C.length&&N==="prev"?C.substr(0,T.length):X<0?null:C.substr(0,X)+K[X]+T.substr(X+1)}(k,A,d[O],m[O],f,y);I===null&&E===null?g=O+1:(E===null||0<f(E,I))&&(E=I)}return _(E!==null?function(){v.continue(E+w)}:b),!1}),e}function ht(e,t,s,i){return{type:2,lower:e,upper:t,lowerOpen:s,upperOpen:i}}function Zs(e){return{type:1,lower:e,upper:e}}var eo=(Object.defineProperty(Se.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),Se.prototype.between=function(e,t,s,i){s=s!==!1,i=i===!0;try{return 0<this._cmp(e,t)||this._cmp(e,t)===0&&(s||i)&&(!s||!i)?Nt(this):new this.Collection(this,function(){return ht(e,t,!s,!i)})}catch{return Ne(this,nt)}},Se.prototype.equals=function(e){return e==null?Ne(this,nt):new this.Collection(this,function(){return Zs(e)})},Se.prototype.above=function(e){return e==null?Ne(this,nt):new this.Collection(this,function(){return ht(e,void 0,!0)})},Se.prototype.aboveOrEqual=function(e){return e==null?Ne(this,nt):new this.Collection(this,function(){return ht(e,void 0,!1)})},Se.prototype.below=function(e){return e==null?Ne(this,nt):new this.Collection(this,function(){return ht(void 0,e,!1,!0)})},Se.prototype.belowOrEqual=function(e){return e==null?Ne(this,nt):new this.Collection(this,function(){return ht(void 0,e)})},Se.prototype.startsWith=function(e){return typeof e!="string"?Ne(this,Ws):this.between(e,e+Et,!0,!0)},Se.prototype.startsWithIgnoreCase=function(e){return e===""?this.startsWith(e):Dn(this,function(t,s){return t.indexOf(s[0])===0},[e],Et)},Se.prototype.equalsIgnoreCase=function(e){return Dn(this,function(t,s){return t===s[0]},[e],"")},Se.prototype.anyOfIgnoreCase=function(){var e=ne.apply(De,arguments);return e.length===0?Nt(this):Dn(this,function(t,s){return s.indexOf(t)!==-1},e,"")},Se.prototype.startsWithAnyOfIgnoreCase=function(){var e=ne.apply(De,arguments);return e.length===0?Nt(this):Dn(this,function(t,s){return s.some(function(i){return t.indexOf(i)===0})},e,Et)},Se.prototype.anyOf=function(){var e=this,t=ne.apply(De,arguments),s=this._cmp;try{t.sort(s)}catch{return Ne(this,nt)}if(t.length===0)return Nt(this);var i=new this.Collection(this,function(){return ht(t[0],t[t.length-1])});i._ondirectionchange=function(l){s=l==="next"?e._ascending:e._descending,t.sort(s)};var u=0;return i._addAlgorithm(function(l,f,d){for(var m=l.key;0<s(m,t[u]);)if(++u===t.length)return f(d),!1;return s(m,t[u])===0||(f(function(){l.continue(t[u])}),!1)}),i},Se.prototype.notEqual=function(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},Se.prototype.noneOf=function(){var e=ne.apply(De,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return Ne(this,nt)}var t=e.reduce(function(s,i){return s?s.concat([[s[s.length-1][1],i]]):[[-1/0,i]]},null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},Se.prototype.inAnyRange=function(k,t){var s=this,i=this._cmp,u=this._ascending,l=this._descending,f=this._min,d=this._max;if(k.length===0)return Nt(this);if(!k.every(function(A){return A[0]!==void 0&&A[1]!==void 0&&u(A[0],A[1])<=0}))return Ne(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",q.InvalidArgument);var m=!t||t.includeLowers!==!1,y=t&&t.includeUppers===!0,w,p=u;function x(A,E){return p(A[0],E[0])}try{(w=k.reduce(function(A,E){for(var O=0,I=A.length;O<I;++O){var C=A[O];if(i(E[0],C[1])<0&&0<i(E[1],C[0])){C[0]=f(C[0],E[0]),C[1]=d(C[1],E[1]);break}}return O===I&&A.push(E),A},[])).sort(x)}catch{return Ne(this,nt)}var g=0,v=y?function(A){return 0<u(A,w[g][1])}:function(A){return 0<=u(A,w[g][1])},_=m?function(A){return 0<l(A,w[g][0])}:function(A){return 0<=l(A,w[g][0])},b=v,k=new this.Collection(this,function(){return ht(w[0][0],w[w.length-1][1],!m,!y)});return k._ondirectionchange=function(A){p=A==="next"?(b=v,u):(b=_,l),w.sort(x)},k._addAlgorithm(function(A,E,O){for(var I,C=A.key;b(C);)if(++g===w.length)return E(O),!1;return!v(I=C)&&!_(I)||(s._cmp(C,w[g][1])===0||s._cmp(C,w[g][0])===0||E(function(){p===u?A.continue(w[g][0]):A.continue(w[g][1])}),!1)}),k},Se.prototype.startsWithAnyOf=function(){var e=ne.apply(De,arguments);return e.every(function(t){return typeof t=="string"})?e.length===0?Nt(this):this.inAnyRange(e.map(function(t){return[t,t+Et]})):Ne(this,"startsWithAnyOf() only works with strings")},Se);function Se(){}function Xe(e){return fe(function(t){return tn(t),e(t.target.error),!1})}function tn(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var nn="storagemutated",Nr="x-storagemutated-1",dt=Qt(null,nn),_i=(Ye.prototype._lock=function(){return ce(!F.global),++this._reculock,this._reculock!==1||F.global||(F.lockOwnerFor=this),this},Ye.prototype._unlock=function(){if(ce(!F.global),--this._reculock==0)for(F.global||(F.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var e=this._blockedFuncs.shift();try{At(e[1],e[0])}catch{}}return this},Ye.prototype._locked=function(){return this._reculock&&F.lockOwnerFor!==this},Ye.prototype.create=function(e){var t=this;if(!this.mode)return this;var s=this.db.idbdb,i=this.db._state.dbOpenError;if(ce(!this.idbtrans),!e&&!s)switch(i&&i.name){case"DatabaseClosedError":throw new q.DatabaseClosed(i);case"MissingAPIError":throw new q.MissingAPI(i.message,i);default:throw new q.OpenFailed(i)}if(!this.active)throw new q.TransactionInactive;return ce(this._completion._state===null),(e=this.idbtrans=e||(this.db.core||s).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=fe(function(u){tn(u),t._reject(e.error)}),e.onabort=fe(function(u){tn(u),t.active&&t._reject(new q.Abort(e.error)),t.active=!1,t.on("abort").fire(u)}),e.oncomplete=fe(function(){t.active=!1,t._resolve(),"mutatedParts"in e&&dt.storagemutated.fire(e.mutatedParts)}),this},Ye.prototype._promise=function(e,t,s){var i=this;if(e==="readwrite"&&this.mode!=="readwrite")return pe(new q.ReadOnly("Transaction is readonly"));if(!this.active)return pe(new q.TransactionInactive);if(this._locked())return new j(function(l,f){i._blockedFuncs.push([function(){i._promise(e,t,s).then(l,f)},F])});if(s)return ct(function(){var l=new j(function(f,d){i._lock();var m=t(f,d,i);m&&m.then&&m.then(f,d)});return l.finally(function(){return i._unlock()}),l._lib=!0,l});var u=new j(function(l,f){var d=t(l,f,i);d&&d.then&&d.then(l,f)});return u._lib=!0,u},Ye.prototype._root=function(){return this.parent?this.parent._root():this},Ye.prototype.waitFor=function(e){var t,s=this._root(),i=j.resolve(e);s._waitingFor?s._waitingFor=s._waitingFor.then(function(){return i}):(s._waitingFor=i,s._waitingQueue=[],t=s.idbtrans.objectStore(s.storeNames[0]),function l(){for(++s._spinCount;s._waitingQueue.length;)s._waitingQueue.shift()();s._waitingFor&&(t.get(-1/0).onsuccess=l)}());var u=s._waitingFor;return new j(function(l,f){i.then(function(d){return s._waitingQueue.push(fe(l.bind(null,d)))},function(d){return s._waitingQueue.push(fe(f.bind(null,d)))}).finally(function(){s._waitingFor===u&&(s._waitingFor=null)})})},Ye.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new q.Abort))},Ye.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if($(t,e))return t[e];var s=this.schema[e];if(!s)throw new q.NotFound("Table "+e+" not part of transaction");return s=new this.db.Table(e,s,this),s.core=this.db.core.table(e),t[e]=s},Ye);function Ye(){}function $r(e,t,s,i,u,l,f){return{name:e,keyPath:t,unique:s,multi:i,auto:u,compound:l,src:(s&&!f?"&":"")+(i?"*":"")+(u?"++":"")+to(t)}}function to(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Fr(e,t,s){return{name:e,primKey:t,indexes:s,mappedClass:null,idxByName:(i=function(u){return[u.name,u]},s.reduce(function(u,l,f){return f=i(l,f),f&&(u[f[0]]=f[1]),u},{}))};var i}var rn=function(e){try{return e.only([[]]),rn=function(){return[[]]},[[]]}catch{return rn=function(){return Et},Et}};function Ur(e){return e==null?function(){}:typeof e=="string"?(t=e).split(".").length===1?function(s){return s[t]}:function(s){return be(s,t)}:function(s){return be(s,e)};var t}function no(e){return[].slice.call(e)}var xi=0;function sn(e){return e==null?":id":typeof e=="string"?e:"[".concat(e.join("+"),"]")}function Si(e,t,m){function i(b){if(b.type===3)return null;if(b.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var g=b.lower,v=b.upper,_=b.lowerOpen,b=b.upperOpen;return g===void 0?v===void 0?null:t.upperBound(v,!!b):v===void 0?t.lowerBound(g,!!_):t.bound(g,v,!!_,!!b)}function u(x){var g,v=x.name;return{name:v,schema:x,mutate:function(_){var b=_.trans,k=_.type,A=_.keys,E=_.values,O=_.range;return new Promise(function(I,C){I=fe(I);var M=b.objectStore(v),T=M.keyPath==null,K=k==="put"||k==="add";if(!K&&k!=="delete"&&k!=="deleteRange")throw new Error("Invalid operation type: "+k);var R,N=(A||E||{length:1}).length;if(A&&E&&A.length!==E.length)throw new Error("Given keys array must have same length as given values array.");if(N===0)return I({numFailures:0,failures:{},results:[],lastResult:void 0});function G(Ke){++$e,tn(Ke)}var X=[],Y=[],$e=0;if(k==="deleteRange"){if(O.type===4)return I({numFailures:$e,failures:Y,results:[],lastResult:void 0});O.type===3?X.push(R=M.clear()):X.push(R=M.delete(i(O)))}else{var T=K?T?[E,A]:[E,null]:[A,null],H=T[0],Oe=T[1];if(K)for(var Ie=0;Ie<N;++Ie)X.push(R=Oe&&Oe[Ie]!==void 0?M[k](H[Ie],Oe[Ie]):M[k](H[Ie])),R.onerror=G;else for(Ie=0;Ie<N;++Ie)X.push(R=M[k](H[Ie])),R.onerror=G}function Vn(Ke){Ke=Ke.target.result,X.forEach(function(Mt,is){return Mt.error!=null&&(Y[is]=Mt.error)}),I({numFailures:$e,failures:Y,results:k==="delete"?A:X.map(function(Mt){return Mt.result}),lastResult:Ke})}R.onerror=function(Ke){G(Ke),Vn(Ke)},R.onsuccess=Vn})},getMany:function(_){var b=_.trans,k=_.keys;return new Promise(function(A,E){A=fe(A);for(var O,I=b.objectStore(v),C=k.length,M=new Array(C),T=0,K=0,R=function(X){X=X.target,M[X._pos]=X.result,++K===T&&A(M)},N=Xe(E),G=0;G<C;++G)k[G]!=null&&((O=I.get(k[G]))._pos=G,O.onsuccess=R,O.onerror=N,++T);T===0&&A(M)})},get:function(_){var b=_.trans,k=_.key;return new Promise(function(A,E){A=fe(A);var O=b.objectStore(v).get(k);O.onsuccess=function(I){return A(I.target.result)},O.onerror=Xe(E)})},query:(g=y,function(_){return new Promise(function(b,k){b=fe(b);var A,E,O,T=_.trans,I=_.values,C=_.limit,R=_.query,M=C===1/0?void 0:C,K=R.index,R=R.range,T=T.objectStore(v),K=K.isPrimaryKey?T:T.index(K.name),R=i(R);if(C===0)return b({result:[]});g?((M=I?K.getAll(R,M):K.getAllKeys(R,M)).onsuccess=function(N){return b({result:N.target.result})},M.onerror=Xe(k)):(A=0,E=!I&&"openKeyCursor"in K?K.openKeyCursor(R):K.openCursor(R),O=[],E.onsuccess=function(N){var G=E.result;return G?(O.push(I?G.value:G.primaryKey),++A===C?b({result:O}):void G.continue()):b({result:O})},E.onerror=Xe(k))})}),openCursor:function(_){var b=_.trans,k=_.values,A=_.query,E=_.reverse,O=_.unique;return new Promise(function(I,C){I=fe(I);var K=A.index,M=A.range,T=b.objectStore(v),T=K.isPrimaryKey?T:T.index(K.name),K=E?O?"prevunique":"prev":O?"nextunique":"next",R=!k&&"openKeyCursor"in T?T.openKeyCursor(i(M),K):T.openCursor(i(M),K);R.onerror=Xe(C),R.onsuccess=fe(function(N){var G,X,Y,$e,H=R.result;H?(H.___id=++xi,H.done=!1,G=H.continue.bind(H),X=(X=H.continuePrimaryKey)&&X.bind(H),Y=H.advance.bind(H),$e=function(){throw new Error("Cursor not stopped")},H.trans=b,H.stop=H.continue=H.continuePrimaryKey=H.advance=function(){throw new Error("Cursor not started")},H.fail=fe(C),H.next=function(){var Oe=this,Ie=1;return this.start(function(){return Ie--?Oe.continue():Oe.stop()}).then(function(){return Oe})},H.start=function(Oe){function Ie(){if(R.result)try{Oe()}catch(Ke){H.fail(Ke)}else H.done=!0,H.start=function(){throw new Error("Cursor behind last entry")},H.stop()}var Vn=new Promise(function(Ke,Mt){Ke=fe(Ke),R.onerror=Xe(Mt),H.fail=Mt,H.stop=function(is){H.stop=H.continue=H.continuePrimaryKey=H.advance=$e,Ke(is)}});return R.onsuccess=fe(function(Ke){R.onsuccess=Ie,Ie()}),H.continue=G,H.continuePrimaryKey=X,H.advance=Y,Ie(),Vn},I(H)):I(null)},C)})},count:function(_){var b=_.query,k=_.trans,A=b.index,E=b.range;return new Promise(function(O,I){var C=k.objectStore(v),M=A.isPrimaryKey?C:C.index(A.name),C=i(E),M=C?M.count(C):M.count();M.onsuccess=fe(function(T){return O(T.target.result)}),M.onerror=Xe(I)})}}}var l,f,d,w=(f=m,d=no((l=e).objectStoreNames),{schema:{name:l.name,tables:d.map(function(x){return f.objectStore(x)}).map(function(x){var g=x.keyPath,b=x.autoIncrement,v=P(g),_={},b={name:x.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:g==null,compound:v,keyPath:g,autoIncrement:b,unique:!0,extractKey:Ur(g)},indexes:no(x.indexNames).map(function(k){return x.index(k)}).map(function(O){var A=O.name,E=O.unique,I=O.multiEntry,O=O.keyPath,I={name:A,compound:P(O),keyPath:O,unique:E,multiEntry:I,extractKey:Ur(O)};return _[sn(O)]=I}),getIndexByKeyPath:function(k){return _[sn(k)]}};return _[":id"]=b.primaryKey,g!=null&&(_[sn(g)]=b.primaryKey),b})},hasGetAll:0<d.length&&"getAll"in f.objectStore(d[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),m=w.schema,y=w.hasGetAll,w=m.tables.map(u),p={};return w.forEach(function(x){return p[x.name]=x}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(x){if(!p[x])throw new Error("Table '".concat(x,"' not found"));return p[x]},MIN_KEY:-1/0,MAX_KEY:rn(t),schema:m}}function ki(e,t,s,i){var u=s.IDBKeyRange;return s.indexedDB,{dbcore:(i=Si(t,u,i),e.dbcore.reduce(function(l,f){return f=f.create,o(o({},l),f(l))},i))}}function Kn(e,i){var s=i.db,i=ki(e._middlewares,s,e._deps,i);e.core=i.dbcore,e.tables.forEach(function(u){var l=u.name;e.core.schema.tables.some(function(f){return f.name===l})&&(u.core=e.core.table(l),e[l]instanceof e.Table&&(e[l].core=u.core))})}function jn(e,t,s,i){s.forEach(function(u){var l=i[u];t.forEach(function(f){var d=function m(y,w){return ye(y,w)||(y=B(y))&&m(y,w)}(f,u);(!d||"value"in d&&d.value===void 0)&&(f===e.Transaction.prototype||f instanceof e.Transaction?oe(f,u,{get:function(){return this.table(u)},set:function(m){V(this,u,{value:m,writable:!0,configurable:!0,enumerable:!0})}}):f[u]=new e.Table(u,l))})})}function Lr(e,t){t.forEach(function(s){for(var i in s)s[i]instanceof e.Table&&delete s[i]})}function Ai(e,t){return e._cfg.version-t._cfg.version}function Ei(e,t,s,i){var u=e._dbSchema;s.objectStoreNames.contains("$meta")&&!u.$meta&&(u.$meta=Fr("$meta",so("")[0],[]),e._storeNames.push("$meta"));var l=e._createTransaction("readwrite",e._storeNames,u);l.create(s),l._completion.catch(i);var f=l._reject.bind(l),d=F.transless||F;ct(function(){return F.trans=l,F.transless=d,t!==0?(Kn(e,s),y=t,((m=l).storeNames.includes("$meta")?m.table("$meta").get("version").then(function(w){return w??y}):j.resolve(y)).then(function(w){return x=w,g=l,v=s,_=[],w=(p=e)._versions,b=p._dbSchema=qn(0,p.idbdb,v),(w=w.filter(function(k){return k._cfg.version>=x})).length!==0?(w.forEach(function(k){_.push(function(){var A=b,E=k._cfg.dbschema;Nn(p,A,v),Nn(p,E,v),b=p._dbSchema=E;var O=Wr(A,E);O.add.forEach(function(K){Hr(v,K[0],K[1].primKey,K[1].indexes)}),O.change.forEach(function(K){if(K.recreate)throw new q.Upgrade("Not yet support for changing primary key");var R=v.objectStore(K.name);K.add.forEach(function(N){return Bn(R,N)}),K.change.forEach(function(N){R.deleteIndex(N.name),Bn(R,N)}),K.del.forEach(function(N){return R.deleteIndex(N)})});var I=k._cfg.contentUpgrade;if(I&&k._cfg.version>x){Kn(p,v),g._memoizedTables={};var C=Ae(E);O.del.forEach(function(K){C[K]=A[K]}),Lr(p,[p.Transaction.prototype]),jn(p,[p.Transaction.prototype],S(C),C),g.schema=C;var M,T=Ee(I);return T&&jt(),O=j.follow(function(){var K;(M=I(g))&&T&&(K=lt.bind(null,null),M.then(K,K))}),M&&typeof M.then=="function"?j.resolve(M):O.then(function(){return M})}}),_.push(function(A){var E,O,I=k._cfg.dbschema;E=I,O=A,[].slice.call(O.db.objectStoreNames).forEach(function(C){return E[C]==null&&O.db.deleteObjectStore(C)}),Lr(p,[p.Transaction.prototype]),jn(p,[p.Transaction.prototype],p._storeNames,p._dbSchema),g.schema=p._dbSchema}),_.push(function(A){p.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(p.idbdb.version/10)===k._cfg.version?(p.idbdb.deleteObjectStore("$meta"),delete p._dbSchema.$meta,p._storeNames=p._storeNames.filter(function(E){return E!=="$meta"})):A.objectStore("$meta").put(k._cfg.version,"version"))})}),function k(){return _.length?j.resolve(_.shift()(g.idbtrans)).then(k):j.resolve()}().then(function(){ro(b,v)})):j.resolve();var p,x,g,v,_,b}).catch(f)):(S(u).forEach(function(w){Hr(s,w,u[w].primKey,u[w].indexes)}),Kn(e,s),void j.follow(function(){return e.on.populate.fire(l)}).catch(f));var m,y})}function Pi(e,t){ro(e._dbSchema,t),t.db.version%10!=0||t.objectStoreNames.contains("$meta")||t.db.createObjectStore("$meta").add(Math.ceil(t.db.version/10-1),"version");var s=qn(0,e.idbdb,t);Nn(e,e._dbSchema,t);for(var i=0,u=Wr(s,e._dbSchema).change;i<u.length;i++){var l=function(f){if(f.change.length||f.recreate)return console.warn("Unable to patch indexes of table ".concat(f.name," because it has changes on the type of index or primary key.")),{value:void 0};var d=t.objectStore(f.name);f.add.forEach(function(m){ze&&console.debug("Dexie upgrade patch: Creating missing index ".concat(f.name,".").concat(m.src)),Bn(d,m)})}(u[i]);if(typeof l=="object")return l.value}}function Wr(e,t){var s,i={del:[],add:[],change:[]};for(s in e)t[s]||i.del.push(s);for(s in t){var u=e[s],l=t[s];if(u){var f={name:s,def:l,recreate:!1,del:[],add:[],change:[]};if(""+(u.primKey.keyPath||"")!=""+(l.primKey.keyPath||"")||u.primKey.auto!==l.primKey.auto)f.recreate=!0,i.change.push(f);else{var d=u.idxByName,m=l.idxByName,y=void 0;for(y in d)m[y]||f.del.push(y);for(y in m){var w=d[y],p=m[y];w?w.src!==p.src&&f.change.push(p):f.add.push(p)}(0<f.del.length||0<f.add.length||0<f.change.length)&&i.change.push(f)}}else i.add.push([s,l])}return i}function Hr(e,t,s,i){var u=e.db.createObjectStore(t,s.keyPath?{keyPath:s.keyPath,autoIncrement:s.auto}:{autoIncrement:s.auto});return i.forEach(function(l){return Bn(u,l)}),u}function ro(e,t){S(e).forEach(function(s){t.db.objectStoreNames.contains(s)||(ze&&console.debug("Dexie: Creating missing table",s),Hr(t,s,e[s].primKey,e[s].indexes))})}function Bn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function qn(e,t,s){var i={};return ee(t.objectStoreNames,0).forEach(function(u){for(var l=s.objectStore(u),f=$r(to(y=l.keyPath),y||"",!0,!1,!!l.autoIncrement,y&&typeof y!="string",!0),d=[],m=0;m<l.indexNames.length;++m){var w=l.index(l.indexNames[m]),y=w.keyPath,w=$r(w.name,y,!!w.unique,!!w.multiEntry,!1,y&&typeof y!="string",!1);d.push(w)}i[u]=Fr(u,f,d)}),i}function Nn(e,t,s){for(var i=s.db.objectStoreNames,u=0;u<i.length;++u){var l=i[u],f=s.objectStore(l);e._hasGetAll="getAll"in f;for(var d=0;d<f.indexNames.length;++d){var m=f.indexNames[d],y=f.index(m).keyPath,w=typeof y=="string"?y:"["+ee(y).join("+")+"]";!t[l]||(y=t[l].idxByName[w])&&(y.name=m,delete t[l].idxByName[w],t[l].idxByName[m]=y)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&h.WorkerGlobalScope&&h instanceof h.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}function so(e){return e.split(",").map(function(t,s){var i=(t=t.trim()).replace(/([&*]|\+\+)/g,""),u=/^\[/.test(i)?i.match(/^\[(.*)\]$/)[1].split("+"):i;return $r(i,u||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),P(u),s===0)})}var Oi=($n.prototype._parseStoresSpec=function(e,t){S(e).forEach(function(s){if(e[s]!==null){var i=so(e[s]),u=i.shift();if(u.unique=!0,u.multi)throw new q.Schema("Primary key cannot be multi-valued");i.forEach(function(l){if(l.auto)throw new q.Schema("Only primary key can be marked as autoIncrement (++)");if(!l.keyPath)throw new q.Schema("Index must have a name and cannot be an empty string")}),t[s]=Fr(s,u,i)}})},$n.prototype.stores=function(s){var t=this.db;this._cfg.storesSource=this._cfg.storesSource?D(this._cfg.storesSource,s):s;var s=t._versions,i={},u={};return s.forEach(function(l){D(i,l._cfg.storesSource),u=l._cfg.dbschema={},l._parseStoresSpec(i,u)}),t._dbSchema=u,Lr(t,[t._allTables,t,t.Transaction.prototype]),jn(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],S(u),u),t._storeNames=S(u),this},$n.prototype.upgrade=function(e){return this._cfg.contentUpgrade=Ar(this._cfg.contentUpgrade||U,e),this},$n);function $n(){}function Gr(e,t){var s=e._dbNamesDB;return s||(s=e._dbNamesDB=new rt(Mn,{addons:[],indexedDB:e,IDBKeyRange:t})).version(1).stores({dbnames:"name"}),s.table("dbnames")}function Vr(e){return e&&typeof e.databases=="function"}function Jr(e){return ct(function(){return F.letThrough=!0,e()})}function zr(e){return!("from"in e)}var Pe=function(e,t){if(!this){var s=new Pe;return e&&"d"in e&&D(s,e),s}D(this,arguments.length?{d:1,from:e,to:1<arguments.length?t:e}:{d:0})};function on(e,t,s){var i=Q(t,s);if(!isNaN(i)){if(0<i)throw RangeError();if(zr(e))return D(e,{from:t,to:s,d:1});var u=e.l,i=e.r;if(Q(s,e.from)<0)return u?on(u,t,s):e.l={from:t,to:s,d:1,l:null,r:null},io(e);if(0<Q(t,e.to))return i?on(i,t,s):e.r={from:t,to:s,d:1,l:null,r:null},io(e);Q(t,e.from)<0&&(e.from=t,e.l=null,e.d=i?i.d+1:1),0<Q(s,e.to)&&(e.to=s,e.r=null,e.d=e.l?e.l.d+1:1),s=!e.r,u&&!e.l&&an(e,u),i&&s&&an(e,i)}}function an(e,t){zr(t)||function s(i,m){var l=m.from,f=m.to,d=m.l,m=m.r;on(i,l,f),d&&s(i,d),m&&s(i,m)}(e,t)}function oo(e,t){var s=Fn(t),i=s.next();if(i.done)return!1;for(var u=i.value,l=Fn(e),f=l.next(u.from),d=f.value;!i.done&&!f.done;){if(Q(d.from,u.to)<=0&&0<=Q(d.to,u.from))return!0;Q(u.from,d.from)<0?u=(i=s.next(d.from)).value:d=(f=l.next(u.from)).value}return!1}function Fn(e){var t=zr(e)?null:{s:0,n:e};return{next:function(s){for(var i=0<arguments.length;t;)switch(t.s){case 0:if(t.s=1,i)for(;t.n.l&&Q(s,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!i||Q(s,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function io(e){var t,s,i=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((s=e.l)===null||s===void 0?void 0:s.d)||0),u=1<i?"r":i<-1?"l":"";u&&(t=u=="r"?"l":"r",s=o({},e),i=e[u],e.from=i.from,e.to=i.to,e[u]=i[u],s[u]=i[t],(e[t]=s).d=ao(s)),e.d=ao(e)}function ao(s){var t=s.r,s=s.l;return(t?s?Math.max(t.d,s.d):t.d:s?s.d:0)+1}function Un(e,t){return S(t).forEach(function(s){e[s]?an(e[s],t[s]):e[s]=function i(u){var l,f,d={};for(l in u)$(u,l)&&(f=u[l],d[l]=!f||typeof f!="object"||Ze.has(f.constructor)?f:i(f));return d}(t[s])}),e}function Xr(e,t){return e.all||t.all||Object.keys(e).some(function(s){return t[s]&&oo(t[s],e[s])})}W(Pe.prototype,((Ue={add:function(e){return an(this,e),this},addKey:function(e){return on(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(s){return on(t,s,s)}),this},hasKey:function(e){var t=Fn(this).next(e).value;return t&&Q(t.from,e)<=0&&0<=Q(t.to,e)}})[et]=function(){return Fn(this)},Ue));var Ot={},Yr={},Qr=!1;function Ln(e){Un(Yr,e),Qr||(Qr=!0,setTimeout(function(){Qr=!1,Zr(Yr,!(Yr={}))},0))}function Zr(e,t){t===void 0&&(t=!1);var s=new Set;if(e.all)for(var i=0,u=Object.values(Ot);i<u.length;i++)uo(f=u[i],e,s,t);else for(var l in e){var f,d=/^idb\:\/\/(.*)\/(.*)\//.exec(l);d&&(l=d[1],d=d[2],(f=Ot["idb://".concat(l,"/").concat(d)])&&uo(f,e,s,t))}s.forEach(function(m){return m()})}function uo(e,t,s,i){for(var u=[],l=0,f=Object.entries(e.queries.query);l<f.length;l++){for(var d=f[l],m=d[0],y=[],w=0,p=d[1];w<p.length;w++){var x=p[w];Xr(t,x.obsSet)?x.subscribers.forEach(function(b){return s.add(b)}):i&&y.push(x)}i&&u.push([m,y])}if(i)for(var g=0,v=u;g<v.length;g++){var _=v[g],m=_[0],y=_[1];e.queries.query[m]=y}}function Ii(e){var t=e._state,s=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?pe(t.dbOpenError):e});t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var i=t.openCanceller,u=Math.round(10*e.verno),l=!1;function f(){if(t.openCanceller!==i)throw new q.DatabaseClosed("db.open() was cancelled")}function d(){return new j(function(x,g){if(f(),!s)throw new q.MissingAPI;var v=e.name,_=t.autoSchema||!u?s.open(v):s.open(v,u);if(!_)throw new q.MissingAPI;_.onerror=Xe(g),_.onblocked=fe(e._fireOnBlocked),_.onupgradeneeded=fe(function(b){var k;w=_.transaction,t.autoSchema&&!e._options.allowEmptyDB?(_.onerror=tn,w.abort(),_.result.close(),(k=s.deleteDatabase(v)).onsuccess=k.onerror=fe(function(){g(new q.NoSuchDatabase("Database ".concat(v," doesnt exist")))})):(w.onerror=Xe(g),b=b.oldVersion>Math.pow(2,62)?0:b.oldVersion,p=b<1,e.idbdb=_.result,l&&Pi(e,w),Ei(e,b/10,w,g))},g),_.onsuccess=fe(function(){w=null;var b,k,A,E,O,I=e.idbdb=_.result,C=ee(I.objectStoreNames);if(0<C.length)try{var M=I.transaction((E=C).length===1?E[0]:E,"readonly");if(t.autoSchema)k=I,A=M,(b=e).verno=k.version/10,A=b._dbSchema=qn(0,k,A),b._storeNames=ee(k.objectStoreNames,0),jn(b,[b._allTables],S(A),A);else if(Nn(e,e._dbSchema,M),((O=Wr(qn(0,(O=e).idbdb,M),O._dbSchema)).add.length||O.change.some(function(T){return T.add.length||T.change.length}))&&!l)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),I.close(),u=I.version+1,l=!0,x(d());Kn(e,M)}catch{}Bt.push(e),I.onversionchange=fe(function(T){t.vcFired=!0,e.on("versionchange").fire(T)}),I.onclose=fe(function(T){e.on("close").fire(T)}),p&&(O=e._deps,M=v,I=O.indexedDB,O=O.IDBKeyRange,Vr(I)||M===Mn||Gr(I,O).put({name:M}).catch(U)),x()},g)}).catch(function(x){switch(x==null?void 0:x.name){case"UnknownError":if(0<t.PR1398_maxLoop)return t.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),d();break;case"VersionError":if(0<u)return u=0,d()}return j.reject(x)})}var m,y=t.dbReadyResolve,w=null,p=!1;return j.race([i,(typeof navigator>"u"?j.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(x){function g(){return indexedDB.databases().finally(x)}m=setInterval(g,100),g()}).finally(function(){return clearInterval(m)}):Promise.resolve()).then(d)]).then(function(){return f(),t.onReadyBeingFired=[],j.resolve(Jr(function(){return e.on.ready.fire(e.vip)})).then(function x(){if(0<t.onReadyBeingFired.length){var g=t.onReadyBeingFired.reduce(Ar,U);return t.onReadyBeingFired=[],j.resolve(Jr(function(){return g(e.vip)})).then(x)}})}).finally(function(){t.openCanceller===i&&(t.onReadyBeingFired=null,t.isBeingOpened=!1)}).catch(function(x){t.dbOpenError=x;try{w&&w.abort()}catch{}return i===t.openCanceller&&e._close(),pe(x)}).finally(function(){t.openComplete=!0,y()}).then(function(){var x;return p&&(x={},e.tables.forEach(function(g){g.schema.indexes.forEach(function(v){v.name&&(x["idb://".concat(e.name,"/").concat(g.name,"/").concat(v.name)]=new Pe(-1/0,[[[]]]))}),x["idb://".concat(e.name,"/").concat(g.name,"/")]=x["idb://".concat(e.name,"/").concat(g.name,"/:dels")]=new Pe(-1/0,[[[]]])}),dt(nn).fire(x),Zr(x,!0)),e})}function es(e){function t(l){return e.next(l)}var s=u(t),i=u(function(l){return e.throw(l)});function u(l){return function(m){var d=l(m),m=d.value;return d.done?m:m&&typeof m.then=="function"?m.then(s,i):P(m)?Promise.all(m).then(s,i):s(m)}}return u(t)()}function Wn(e,t,s){for(var i=P(e)?e.slice():[e],u=0;u<s;++u)i.push(t);return i}var Mi={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return o(o({},e),{table:function(t){var s=e.table(t),i=s.schema,u={},l=[];function f(p,x,g){var v=sn(p),_=u[v]=u[v]||[],b=p==null?0:typeof p=="string"?1:p.length,k=0<x,k=o(o({},g),{name:k?"".concat(v,"(virtual-from:").concat(g.name,")"):g.name,lowLevelIndex:g,isVirtual:k,keyTail:x,keyLength:b,extractKey:Ur(p),unique:!k&&g.unique});return _.push(k),k.isPrimaryKey||l.push(k),1<b&&f(b===2?p[0]:p.slice(0,b-1),x+1,g),_.sort(function(A,E){return A.keyTail-E.keyTail}),k}t=f(i.primaryKey.keyPath,0,i.primaryKey),u[":id"]=[t];for(var d=0,m=i.indexes;d<m.length;d++){var y=m[d];f(y.keyPath,0,y)}function w(p){var x,g=p.query.index;return g.isVirtual?o(o({},p),{query:{index:g.lowLevelIndex,range:(x=p.query.range,g=g.keyTail,{type:x.type===1?2:x.type,lower:Wn(x.lower,x.lowerOpen?e.MAX_KEY:e.MIN_KEY,g),lowerOpen:!0,upper:Wn(x.upper,x.upperOpen?e.MIN_KEY:e.MAX_KEY,g),upperOpen:!0})}}):p}return o(o({},s),{schema:o(o({},i),{primaryKey:t,indexes:l,getIndexByKeyPath:function(p){return(p=u[sn(p)])&&p[0]}}),count:function(p){return s.count(w(p))},query:function(p){return s.query(w(p))},openCursor:function(p){var x=p.query.index,g=x.keyTail,v=x.isVirtual,_=x.keyLength;return v?s.openCursor(w(p)).then(function(k){return k&&b(k)}):s.openCursor(p);function b(k){return Object.create(k,{continue:{value:function(A){A!=null?k.continue(Wn(A,p.reverse?e.MAX_KEY:e.MIN_KEY,g)):p.unique?k.continue(k.key.slice(0,_).concat(p.reverse?e.MIN_KEY:e.MAX_KEY,g)):k.continue()}},continuePrimaryKey:{value:function(A,E){k.continuePrimaryKey(Wn(A,e.MAX_KEY,g),E)}},primaryKey:{get:function(){return k.primaryKey}},key:{get:function(){var A=k.key;return _===1?A[0]:A.slice(0,_)}},value:{get:function(){return k.value}}})}}})}})}};function ts(e,t,s,i){return s=s||{},i=i||"",S(e).forEach(function(u){var l,f,d;$(t,u)?(l=e[u],f=t[u],typeof l=="object"&&typeof f=="object"&&l&&f?(d=Rt(l))!==Rt(f)?s[i+u]=t[u]:d==="Object"?ts(l,f,s,i+u+"."):l!==f&&(s[i+u]=t[u]):l!==f&&(s[i+u]=t[u])):s[i+u]=void 0}),S(t).forEach(function(u){$(e,u)||(s[i+u]=t[u])}),s}function ns(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var Ti={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return o(o({},e),{table:function(t){var s=e.table(t),i=s.schema.primaryKey;return o(o({},s),{mutate:function(u){var l=F.trans,f=l.table(t).hook,d=f.deleting,m=f.creating,y=f.updating;switch(u.type){case"add":if(m.fire===U)break;return l._promise("readwrite",function(){return w(u)},!0);case"put":if(m.fire===U&&y.fire===U)break;return l._promise("readwrite",function(){return w(u)},!0);case"delete":if(d.fire===U)break;return l._promise("readwrite",function(){return w(u)},!0);case"deleteRange":if(d.fire===U)break;return l._promise("readwrite",function(){return function p(x,g,v){return s.query({trans:x,values:!1,query:{index:i,range:g},limit:v}).then(function(_){var b=_.result;return w({type:"delete",keys:b,trans:x}).then(function(k){return 0<k.numFailures?Promise.reject(k.failures[0]):b.length<v?{failures:[],numFailures:0,lastResult:void 0}:p(x,o(o({},g),{lower:b[b.length-1],lowerOpen:!0}),v)})})}(u.trans,u.range,1e4)},!0)}return s.mutate(u);function w(p){var x,g,v,_=F.trans,b=p.keys||ns(i,p);if(!b)throw new Error("Keys missing");return(p=p.type==="add"||p.type==="put"?o(o({},p),{keys:b}):o({},p)).type!=="delete"&&(p.values=c([],p.values)),p.keys&&(p.keys=c([],p.keys)),x=s,v=b,((g=p).type==="add"?Promise.resolve([]):x.getMany({trans:g.trans,keys:v,cache:"immutable"})).then(function(k){var A=b.map(function(E,O){var I,C,M,T=k[O],K={onerror:null,onsuccess:null};return p.type==="delete"?d.fire.call(K,E,T,_):p.type==="add"||T===void 0?(I=m.fire.call(K,E,p.values[O],_),E==null&&I!=null&&(p.keys[O]=E=I,i.outbound||ie(p.values[O],i.keyPath,E))):(I=ts(T,p.values[O]),(C=y.fire.call(K,I,E,T,_))&&(M=p.values[O],Object.keys(C).forEach(function(R){$(M,R)?M[R]=C[R]:ie(M,R,C[R])}))),K});return s.mutate(p).then(function(E){for(var O=E.failures,I=E.results,C=E.numFailures,E=E.lastResult,M=0;M<b.length;++M){var T=(I||b)[M],K=A[M];T==null?K.onerror&&K.onerror(O[M]):K.onsuccess&&K.onsuccess(p.type==="put"&&k[M]?p.values[M]:T)}return{failures:O,results:I,numFailures:C,lastResult:E}}).catch(function(E){return A.forEach(function(O){return O.onerror&&O.onerror(E)}),Promise.reject(E)})})}}})}})}};function co(e,t,s){try{if(!t||t.keys.length<e.length)return null;for(var i=[],u=0,l=0;u<t.keys.length&&l<e.length;++u)Q(t.keys[u],e[l])===0&&(i.push(s?He(t.values[u]):t.values[u]),++l);return i.length===e.length?i:null}catch{return null}}var Ri={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var s=e.table(t);return o(o({},s),{getMany:function(i){if(!i.cache)return s.getMany(i);var u=co(i.keys,i.trans._cache,i.cache==="clone");return u?j.resolve(u):s.getMany(i).then(function(l){return i.trans._cache={keys:i.keys,values:i.cache==="clone"?He(l):l},l})},mutate:function(i){return i.type!=="add"&&(i.trans._cache=null),s.mutate(i)}})}}}};function lo(e,t){return e.trans.mode==="readonly"&&!!e.subscr&&!e.trans.explicit&&e.trans.db._options.cache!=="disabled"&&!t.schema.primaryKey.outbound}function fo(e,t){switch(e){case"query":return t.values&&!t.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Ci={stack:"dbcore",level:0,name:"Observability",create:function(e){var t=e.schema.name,s=new Pe(e.MIN_KEY,e.MAX_KEY);return o(o({},e),{transaction:function(i,u,l){if(F.subscr&&u!=="readonly")throw new q.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(F.querier));return e.transaction(i,u,l)},table:function(i){var u=e.table(i),l=u.schema,f=l.primaryKey,p=l.indexes,d=f.extractKey,m=f.outbound,y=f.autoIncrement&&p.filter(function(g){return g.compound&&g.keyPath.includes(f.keyPath)}),w=o(o({},u),{mutate:function(g){function v(R){return R="idb://".concat(t,"/").concat(i,"/").concat(R),E[R]||(E[R]=new Pe)}var _,b,k,A=g.trans,E=g.mutatedParts||(g.mutatedParts={}),O=v(""),I=v(":dels"),C=g.type,K=g.type==="deleteRange"?[g.range]:g.type==="delete"?[g.keys]:g.values.length<50?[ns(f,g).filter(function(R){return R}),g.values]:[],M=K[0],T=K[1],K=g.trans._cache;return P(M)?(O.addKeys(M),(K=C==="delete"||M.length===T.length?co(M,K):null)||I.addKeys(M),(K||T)&&(_=v,b=K,k=T,l.indexes.forEach(function(R){var N=_(R.name||"");function G(Y){return Y!=null?R.extractKey(Y):null}function X(Y){return R.multiEntry&&P(Y)?Y.forEach(function($e){return N.addKey($e)}):N.addKey(Y)}(b||k).forEach(function(Y,Oe){var H=b&&G(b[Oe]),Oe=k&&G(k[Oe]);Q(H,Oe)!==0&&(H!=null&&X(H),Oe!=null&&X(Oe))})}))):M?(T={from:(T=M.lower)!==null&&T!==void 0?T:e.MIN_KEY,to:(T=M.upper)!==null&&T!==void 0?T:e.MAX_KEY},I.add(T),O.add(T)):(O.add(s),I.add(s),l.indexes.forEach(function(R){return v(R.name).add(s)})),u.mutate(g).then(function(R){return!M||g.type!=="add"&&g.type!=="put"||(O.addKeys(R.results),y&&y.forEach(function(N){for(var G=g.values.map(function(H){return N.extractKey(H)}),X=N.keyPath.findIndex(function(H){return H===f.keyPath}),Y=0,$e=R.results.length;Y<$e;++Y)G[Y][X]=R.results[Y];v(N.name).addKeys(G)})),A.mutatedParts=Un(A.mutatedParts||{},E),R})}}),p=function(v){var _=v.query,v=_.index,_=_.range;return[v,new Pe((v=_.lower)!==null&&v!==void 0?v:e.MIN_KEY,(_=_.upper)!==null&&_!==void 0?_:e.MAX_KEY)]},x={get:function(g){return[f,new Pe(g.key)]},getMany:function(g){return[f,new Pe().addKeys(g.keys)]},count:p,query:p,openCursor:p};return S(x).forEach(function(g){w[g]=function(v){var _=F.subscr,b=!!_,k=lo(F,u)&&fo(g,v)?v.obsSet={}:_;if(b){var A=function(T){return T="idb://".concat(t,"/").concat(i,"/").concat(T),k[T]||(k[T]=new Pe)},E=A(""),O=A(":dels"),_=x[g](v),b=_[0],_=_[1];if((g==="query"&&b.isPrimaryKey&&!v.values?O:A(b.name||"")).add(_),!b.isPrimaryKey){if(g!=="count"){var I=g==="query"&&m&&v.values&&u.query(o(o({},v),{values:!1}));return u[g].apply(this,arguments).then(function(T){if(g==="query"){if(m&&v.values)return I.then(function(G){return G=G.result,E.addKeys(G),T});var K=v.values?T.result.map(d):T.result;(v.values?E:O).addKeys(K)}else if(g==="openCursor"){var R=T,N=v.values;return R&&Object.create(R,{key:{get:function(){return O.addKey(R.primaryKey),R.key}},primaryKey:{get:function(){var G=R.primaryKey;return O.addKey(G),G}},value:{get:function(){return N&&E.addKey(R.primaryKey),R.value}}})}return T})}O.add(s)}}return u[g].apply(this,arguments)}}),w}})}};function ho(e,t,s){if(s.numFailures===0)return t;if(t.type==="deleteRange")return null;var i=t.keys?t.keys.length:"values"in t&&t.values?t.values.length:1;return s.numFailures===i?null:(t=o({},t),P(t.keys)&&(t.keys=t.keys.filter(function(u,l){return!(l in s.failures)})),"values"in t&&P(t.values)&&(t.values=t.values.filter(function(u,l){return!(l in s.failures)})),t)}function rs(e,t){return s=e,((i=t).lower===void 0||(i.lowerOpen?0<Q(s,i.lower):0<=Q(s,i.lower)))&&(e=e,(t=t).upper===void 0||(t.upperOpen?Q(e,t.upper)<0:Q(e,t.upper)<=0));var s,i}function po(e,t,x,i,u,l){if(!x||x.length===0)return e;var f=t.query.index,d=f.multiEntry,m=t.query.range,y=i.schema.primaryKey.extractKey,w=f.extractKey,p=(f.lowLevelIndex||f).extractKey,x=x.reduce(function(g,v){var _=g,b=[];if(v.type==="add"||v.type==="put")for(var k=new Pe,A=v.values.length-1;0<=A;--A){var E,O=v.values[A],I=y(O);k.hasKey(I)||(E=w(O),(d&&P(E)?E.some(function(R){return rs(R,m)}):rs(E,m))&&(k.addKey(I),b.push(O)))}switch(v.type){case"add":var C=new Pe().addKeys(t.values?g.map(function(N){return y(N)}):g),_=g.concat(t.values?b.filter(function(N){return N=y(N),!C.hasKey(N)&&(C.addKey(N),!0)}):b.map(function(N){return y(N)}).filter(function(N){return!C.hasKey(N)&&(C.addKey(N),!0)}));break;case"put":var M=new Pe().addKeys(v.values.map(function(N){return y(N)}));_=g.filter(function(N){return!M.hasKey(t.values?y(N):N)}).concat(t.values?b:b.map(function(N){return y(N)}));break;case"delete":var T=new Pe().addKeys(v.keys);_=g.filter(function(N){return!T.hasKey(t.values?y(N):N)});break;case"deleteRange":var K=v.range;_=g.filter(function(N){return!rs(y(N),K)})}return _},e);return x===e?e:(x.sort(function(g,v){return Q(p(g),p(v))||Q(y(g),y(v))}),t.limit&&t.limit<1/0&&(x.length>t.limit?x.length=t.limit:e.length===t.limit&&x.length<t.limit&&(u.dirty=!0)),l?Object.freeze(x):x)}function mo(e,t){return Q(e.lower,t.lower)===0&&Q(e.upper,t.upper)===0&&!!e.lowerOpen==!!t.lowerOpen&&!!e.upperOpen==!!t.upperOpen}function Di(e,t){return function(s,i,u,l){if(s===void 0)return i!==void 0?-1:0;if(i===void 0)return 1;if((i=Q(s,i))===0){if(u&&l)return 0;if(u)return 1;if(l)return-1}return i}(e.lower,t.lower,e.lowerOpen,t.lowerOpen)<=0&&0<=function(s,i,u,l){if(s===void 0)return i!==void 0?1:0;if(i===void 0)return-1;if((i=Q(s,i))===0){if(u&&l)return 0;if(u)return-1;if(l)return 1}return i}(e.upper,t.upper,e.upperOpen,t.upperOpen)}function Ki(e,t,s,i){e.subscribers.add(s),i.addEventListener("abort",function(){var u,l;e.subscribers.delete(s),e.subscribers.size===0&&(u=e,l=t,setTimeout(function(){u.subscribers.size===0&&tt(l,u)},3e3))})}var ji={stack:"dbcore",level:0,name:"Cache",create:function(e){var t=e.schema.name;return o(o({},e),{transaction:function(s,i,u){var l,f,d=e.transaction(s,i,u);return i==="readwrite"&&(f=(l=new AbortController).signal,u=function(m){return function(){if(l.abort(),i==="readwrite"){for(var y=new Set,w=0,p=s;w<p.length;w++){var x=p[w],g=Ot["idb://".concat(t,"/").concat(x)];if(g){var v=e.table(x),_=g.optimisticOps.filter(function(N){return N.trans===d});if(d._explicit&&m&&d.mutatedParts)for(var b=0,k=Object.values(g.queries.query);b<k.length;b++)for(var A=0,E=(C=k[b]).slice();A<E.length;A++)Xr((M=E[A]).obsSet,d.mutatedParts)&&(tt(C,M),M.subscribers.forEach(function(N){return y.add(N)}));else if(0<_.length){g.optimisticOps=g.optimisticOps.filter(function(N){return N.trans!==d});for(var O=0,I=Object.values(g.queries.query);O<I.length;O++)for(var C,M,T,K=0,R=(C=I[O]).slice();K<R.length;K++)(M=R[K]).res!=null&&d.mutatedParts&&(m&&!M.dirty?(T=Object.isFrozen(M.res),T=po(M.res,M.req,_,v,M,T),M.dirty?(tt(C,M),M.subscribers.forEach(function(N){return y.add(N)})):T!==M.res&&(M.res=T,M.promise=j.resolve({result:T}))):(M.dirty&&tt(C,M),M.subscribers.forEach(function(N){return y.add(N)})))}}}y.forEach(function(N){return N()})}}},d.addEventListener("abort",u(!1),{signal:f}),d.addEventListener("error",u(!1),{signal:f}),d.addEventListener("complete",u(!0),{signal:f})),d},table:function(s){var i=e.table(s),u=i.schema.primaryKey;return o(o({},i),{mutate:function(l){var f=F.trans;if(u.outbound||f.db._options.cache==="disabled"||f.explicit||f.idbtrans.mode!=="readwrite")return i.mutate(l);var d=Ot["idb://".concat(t,"/").concat(s)];return d?(f=i.mutate(l),l.type!=="add"&&l.type!=="put"||!(50<=l.values.length||ns(u,l).some(function(m){return m==null}))?(d.optimisticOps.push(l),l.mutatedParts&&Ln(l.mutatedParts),f.then(function(m){0<m.numFailures&&(tt(d.optimisticOps,l),(m=ho(0,l,m))&&d.optimisticOps.push(m),l.mutatedParts&&Ln(l.mutatedParts))}),f.catch(function(){tt(d.optimisticOps,l),l.mutatedParts&&Ln(l.mutatedParts)})):f.then(function(m){var y=ho(0,o(o({},l),{values:l.values.map(function(w,p){var x;return m.failures[p]?w:(w=(x=u.keyPath)!==null&&x!==void 0&&x.includes(".")?He(w):o({},w),ie(w,u.keyPath,m.results[p]),w)})}),m);d.optimisticOps.push(y),queueMicrotask(function(){return l.mutatedParts&&Ln(l.mutatedParts)})}),f):i.mutate(l)},query:function(l){if(!lo(F,i)||!fo("query",l))return i.query(l);var f=((y=F.trans)===null||y===void 0?void 0:y.db._options.cache)==="immutable",p=F,d=p.requery,m=p.signal,y=function(v,_,b,k){var A=Ot["idb://".concat(v,"/").concat(_)];if(!A)return[];if(!(_=A.queries[b]))return[null,!1,A,null];var E=_[(k.query?k.query.index.name:null)||""];if(!E)return[null,!1,A,null];switch(b){case"query":var O=E.find(function(I){return I.req.limit===k.limit&&I.req.values===k.values&&mo(I.req.query.range,k.query.range)});return O?[O,!0,A,E]:[E.find(function(I){return("limit"in I.req?I.req.limit:1/0)>=k.limit&&(!k.values||I.req.values)&&Di(I.req.query.range,k.query.range)}),!1,A,E];case"count":return O=E.find(function(I){return mo(I.req.query.range,k.query.range)}),[O,!!O,A,E]}}(t,s,"query",l),w=y[0],p=y[1],x=y[2],g=y[3];return w&&p?w.obsSet=l.obsSet:(p=i.query(l).then(function(v){var _=v.result;if(w&&(w.res=_),f){for(var b=0,k=_.length;b<k;++b)Object.freeze(_[b]);Object.freeze(_)}else v.result=He(_);return v}).catch(function(v){return g&&w&&tt(g,w),Promise.reject(v)}),w={obsSet:l.obsSet,promise:p,subscribers:new Set,type:"query",req:l,dirty:!1},g?g.push(w):(g=[w],(x=x||(Ot["idb://".concat(t,"/").concat(s)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[l.query.index.name||""]=g)),Ki(w,g,d,m),w.promise.then(function(v){return{result:po(v.result,l,x==null?void 0:x.optimisticOps,i,w,f)}})}})}})}};function Hn(e,t){return new Proxy(e,{get:function(s,i,u){return i==="db"?t:Reflect.get(s,i,u)}})}var rt=(me.prototype.version=function(e){if(isNaN(e)||e<.1)throw new q.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new q.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,s=t.filter(function(i){return i._cfg.version===e})[0];return s||(s=new this.Version(e),t.push(s),t.sort(Ai),s.stores({}),this._state.autoSchema=!1,s)},me.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||F.letThrough||this._vip)?e():new j(function(s,i){if(t._state.openComplete)return i(new q.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._state.autoOpen)return void i(new q.DatabaseClosed);t.open().catch(U)}t._state.dbReadyPromise.then(s,i)}).then(e)},me.prototype.use=function(e){var t=e.stack,s=e.create,i=e.level,u=e.name;return u&&this.unuse({stack:t,name:u}),e=this._middlewares[t]||(this._middlewares[t]=[]),e.push({stack:t,create:s,level:i??10,name:u}),e.sort(function(l,f){return l.level-f.level}),this},me.prototype.unuse=function(e){var t=e.stack,s=e.name,i=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(function(u){return i?u.create!==i:!!s&&u.name!==s})),this},me.prototype.open=function(){var e=this;return At(ut,function(){return Ii(e)})},me.prototype._close=function(){var e=this._state,t=Bt.indexOf(this);if(0<=t&&Bt.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}e.isBeingOpened||(e.dbReadyPromise=new j(function(s){e.dbReadyResolve=s}),e.openCanceller=new j(function(s,i){e.cancelOpen=i}))},me.prototype.close=function(s){var t=(s===void 0?{disableAutoOpen:!0}:s).disableAutoOpen,s=this._state;t?(s.isBeingOpened&&s.cancelOpen(new q.DatabaseClosed),this._close(),s.autoOpen=!1,s.dbOpenError=new q.DatabaseClosed):(this._close(),s.autoOpen=this._options.autoOpen||s.isBeingOpened,s.openComplete=!1,s.dbOpenError=null)},me.prototype.delete=function(e){var t=this;e===void 0&&(e={disableAutoOpen:!0});var s=0<arguments.length&&typeof arguments[0]!="object",i=this._state;return new j(function(u,l){function f(){t.close(e);var d=t._deps.indexedDB.deleteDatabase(t.name);d.onsuccess=fe(function(){var m,y,w;m=t._deps,y=t.name,w=m.indexedDB,m=m.IDBKeyRange,Vr(w)||y===Mn||Gr(w,m).delete(y).catch(U),u()}),d.onerror=Xe(l),d.onblocked=t._fireOnBlocked}if(s)throw new q.InvalidArgument("Invalid closeOptions argument to db.delete()");i.isBeingOpened?i.dbReadyPromise.then(f):f()})},me.prototype.backendDB=function(){return this.idbdb},me.prototype.isOpen=function(){return this.idbdb!==null},me.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"},me.prototype.hasFailed=function(){return this._state.dbOpenError!==null},me.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(me.prototype,"tables",{get:function(){var e=this;return S(this._allTables).map(function(t){return e._allTables[t]})},enumerable:!1,configurable:!0}),me.prototype.transaction=function(){var e=(function(t,s,i){var u=arguments.length;if(u<2)throw new q.InvalidArgument("Too few arguments");for(var l=new Array(u-1);--u;)l[u-1]=arguments[u];return i=l.pop(),[t,Ve(l),i]}).apply(this,arguments);return this._transaction.apply(this,e)},me.prototype._transaction=function(e,t,s){var i=this,u=F.trans;u&&u.db===this&&e.indexOf("!")===-1||(u=null);var l,f,d=e.indexOf("?")!==-1;e=e.replace("!","").replace("?","");try{if(f=t.map(function(y){if(y=y instanceof i.Table?y.name:y,typeof y!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return y}),e=="r"||e===Dr)l=Dr;else{if(e!="rw"&&e!=Kr)throw new q.InvalidArgument("Invalid transaction mode: "+e);l=Kr}if(u){if(u.mode===Dr&&l===Kr){if(!d)throw new q.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");u=null}u&&f.forEach(function(y){if(u&&u.storeNames.indexOf(y)===-1){if(!d)throw new q.SubTransaction("Table "+y+" not included in parent transaction.");u=null}}),d&&u&&!u.active&&(u=null)}}catch(y){return u?u._promise(null,function(w,p){p(y)}):pe(y)}var m=(function y(w,p,x,g,v){return j.resolve().then(function(){var _=F.transless||F,b=w._createTransaction(p,x,w._dbSchema,g);if(b.explicit=!0,_={trans:b,transless:_},g)b.idbtrans=g.idbtrans;else try{b.create(),b.idbtrans._explicit=!0,w._state.PR1398_maxLoop=3}catch(E){return E.name===we.InvalidState&&w.isOpen()&&0<--w._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),w.close({disableAutoOpen:!1}),w.open().then(function(){return y(w,p,x,null,v)})):pe(E)}var k,A=Ee(v);return A&&jt(),_=j.follow(function(){var E;(k=v.call(b,b))&&(A?(E=lt.bind(null,null),k.then(E,E)):typeof k.next=="function"&&typeof k.throw=="function"&&(k=es(k)))},_),(k&&typeof k.then=="function"?j.resolve(k).then(function(E){return b.active?E:pe(new q.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):_.then(function(){return k})).then(function(E){return g&&b._resolve(),b._completion.then(function(){return E})}).catch(function(E){return b._reject(E),pe(E)})})}).bind(null,this,l,f,u,s);return u?u._promise(l,m,"lock"):F.trans?At(F.transless,function(){return i._whenReady(m)}):this._whenReady(m)},me.prototype.table=function(e){if(!$(this._allTables,e))throw new q.InvalidTable("Table ".concat(e," does not exist"));return this._allTables[e]},me);function me(e,t){var s=this;this._middlewares={},this.verno=0;var i=me.dependencies;this._options=t=o({addons:me.addons,autoOpen:!0,indexedDB:i.indexedDB,IDBKeyRange:i.IDBKeyRange,cache:"cloned"},t),this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange},i=t.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var u,l,f,d,m,y={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:U,dbReadyPromise:null,cancelOpen:U,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:t.autoOpen};y.dbReadyPromise=new j(function(p){y.dbReadyResolve=p}),y.openCanceller=new j(function(p,x){y.cancelOpen=x}),this._state=y,this.name=e,this.on=Qt(this,"populate","blocked","versionchange","close",{ready:[Ar,U]}),this.on.ready.subscribe=de(this.on.ready.subscribe,function(p){return function(x,g){me.vip(function(){var v,_=s._state;_.openComplete?(_.dbOpenError||j.resolve().then(x),g&&p(x)):_.onReadyBeingFired?(_.onReadyBeingFired.push(x),g&&p(x)):(p(x),v=s,g||p(function b(){v.on.ready.unsubscribe(x),v.on.ready.unsubscribe(b)}))})}}),this.Collection=(u=this,Zt(bi.prototype,function(k,b){this.db=u;var g=Hs,v=null;if(b)try{g=b()}catch(A){v=A}var _=k._ctx,b=_.table,k=b.hook.reading.fire;this._ctx={table:b,index:_.index,isPrimKey:!_.index||b.schema.primKey.keyPath&&_.index===b.schema.primKey.name,range:g,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:v,or:_.or,valueMapper:k!==le?k:null}})),this.Table=(l=this,Zt(zs.prototype,function(p,x,g){this.db=l,this._tx=g,this.name=p,this.schema=x,this.hook=l._allTables[p]?l._allTables[p].hook:Qt(null,{creating:[ci,U],reading:[qe,le],updating:[fi,U],deleting:[li,U]})})),this.Transaction=(f=this,Zt(_i.prototype,function(p,x,g,v,_){var b=this;this.db=f,this.mode=p,this.storeNames=x,this.schema=g,this.chromeTransactionDurability=v,this.idbtrans=null,this.on=Qt(this,"complete","error","abort"),this.parent=_||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new j(function(k,A){b._resolve=k,b._reject=A}),this._completion.then(function(){b.active=!1,b.on.complete.fire()},function(k){var A=b.active;return b.active=!1,b.on.error.fire(k),b.parent?b.parent._reject(k):A&&b.idbtrans&&b.idbtrans.abort(),pe(k)})})),this.Version=(d=this,Zt(Oi.prototype,function(p){this.db=d,this._cfg={version:p,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(m=this,Zt(eo.prototype,function(p,x,g){if(this.db=m,this._ctx={table:p,index:x===":id"?null:x,or:g},this._cmp=this._ascending=Q,this._descending=function(v,_){return Q(_,v)},this._max=function(v,_){return 0<Q(v,_)?v:_},this._min=function(v,_){return Q(v,_)<0?v:_},this._IDBKeyRange=m._deps.IDBKeyRange,!this._IDBKeyRange)throw new q.MissingAPI})),this.on("versionchange",function(p){0<p.newVersion?console.warn("Another connection wants to upgrade database '".concat(s.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(s.name,"'. Closing db now to resume the delete request.")),s.close({disableAutoOpen:!1})}),this.on("blocked",function(p){!p.newVersion||p.newVersion<p.oldVersion?console.warn("Dexie.delete('".concat(s.name,"') was blocked")):console.warn("Upgrade '".concat(s.name,"' blocked by other connection holding version ").concat(p.oldVersion/10))}),this._maxKey=rn(t.IDBKeyRange),this._createTransaction=function(p,x,g,v){return new s.Transaction(p,x,g,s._options.chromeTransactionDurability,v)},this._fireOnBlocked=function(p){s.on("blocked").fire(p),Bt.filter(function(x){return x.name===s.name&&x!==s&&!x._state.vcFired}).map(function(x){return x.on("versionchange").fire(p)})},this.use(Ri),this.use(ji),this.use(Ci),this.use(Mi),this.use(Ti);var w=new Proxy(this,{get:function(p,x,g){if(x==="_vip")return!0;if(x==="table")return function(_){return Hn(s.table(_),w)};var v=Reflect.get(p,x,g);return v instanceof zs?Hn(v,w):x==="tables"?v.map(function(_){return Hn(_,w)}):x==="_createTransaction"?function(){return Hn(v.apply(this,arguments),w)}:v}});this.vip=w,i.forEach(function(p){return p(s)})}var Gn,Ue=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Bi=(ss.prototype.subscribe=function(e,t,s){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:s})},ss.prototype[Ue]=function(){return this},ss);function ss(e){this._subscribe=e}try{Gn={indexedDB:h.indexedDB||h.mozIndexedDB||h.webkitIndexedDB||h.msIndexedDB,IDBKeyRange:h.IDBKeyRange||h.webkitIDBKeyRange}}catch{Gn={indexedDB:null,IDBKeyRange:null}}function go(e){var t,s=!1,i=new Bi(function(u){var l=Ee(e),f,d=!1,m={},y={},w={get closed(){return d},unsubscribe:function(){d||(d=!0,f&&f.abort(),p&&dt.storagemutated.unsubscribe(g))}};u.start&&u.start(w);var p=!1,x=function(){return Cr(v)},g=function(_){Un(m,_),Xr(y,m)&&x()},v=function(){var _,b,k;!d&&Gn.indexedDB&&(m={},_={},f&&f.abort(),f=new AbortController,k=function(A){var E=Dt();try{l&&jt();var O=ct(e,A);return O=l?O.finally(lt):O}finally{E&&Kt()}}(b={subscr:_,signal:f.signal,requery:x,querier:e,trans:null}),Promise.resolve(k).then(function(A){s=!0,t=A,d||b.signal.aborted||(m={},function(E){for(var O in E)if($(E,O))return;return 1}(y=_)||p||(dt(nn,g),p=!0),Cr(function(){return!d&&u.next&&u.next(A)}))},function(A){s=!1,["DatabaseClosedError","AbortError"].includes(A==null?void 0:A.name)||d||Cr(function(){d||u.error&&u.error(A)})}))};return setTimeout(x,0),w});return i.hasValue=function(){return s},i.getValue=function(){return t},i}var It=rt;function os(e){var t=pt;try{pt=!0,dt.storagemutated.fire(e),Zr(e,!0)}finally{pt=t}}W(It,o(o({},re),{delete:function(e){return new It(e,{addons:[]}).delete()},exists:function(e){return new It(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return t=It.dependencies,s=t.indexedDB,t=t.IDBKeyRange,(Vr(s)?Promise.resolve(s.databases()).then(function(i){return i.map(function(u){return u.name}).filter(function(u){return u!==Mn})}):Gr(s,t).toCollection().primaryKeys()).then(e)}catch{return pe(new q.MissingAPI)}var t,s},defineClass:function(){return function(e){D(this,e)}},ignoreTransaction:function(e){return F.trans?At(F.transless,e):e()},vip:Jr,async:function(e){return function(){try{var t=es(e.apply(this,arguments));return t&&typeof t.then=="function"?t:j.resolve(t)}catch(s){return pe(s)}}},spawn:function(e,t,s){try{var i=es(e.apply(s,t||[]));return i&&typeof i.then=="function"?i:j.resolve(i)}catch(u){return pe(u)}},currentTransaction:{get:function(){return F.trans||null}},waitFor:function(e,t){return t=j.resolve(typeof e=="function"?It.ignoreTransaction(e):e).timeout(t||6e4),F.trans?F.trans.waitFor(t):t},Promise:j,debug:{get:function(){return ze},set:function(e){qs(e)}},derive:ge,extend:D,props:W,override:de,Events:Qt,on:dt,liveQuery:go,extendObservabilitySet:Un,getByKeyPath:be,setByKeyPath:ie,delByKeyPath:function(e,t){typeof t=="string"?ie(e,t,void 0):"length"in t&&[].map.call(t,function(s){ie(e,s,void 0)})},shallowClone:Ae,deepClone:He,getObjectDiff:ts,cmp:Q,asap:je,minKey:-1/0,addons:[],connections:Bt,errnames:we,dependencies:Gn,cache:Ot,semVer:"4.0.11",version:"4.0.11".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,s){return e+t/Math.pow(10,2*s)})})),It.maxKey=rn(It.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(dt(nn,function(e){pt||(e=new CustomEvent(Nr,{detail:e}),pt=!0,dispatchEvent(e),pt=!1)}),addEventListener(Nr,function(e){e=e.detail,pt||os(e)}));var $t,pt=!1,yo=function(){};return typeof BroadcastChannel<"u"&&((yo=function(){($t=new BroadcastChannel(Nr)).onmessage=function(e){return e.data&&os(e.data)}})(),typeof $t.unref=="function"&&$t.unref(),dt(nn,function(e){pt||$t.postMessage(e)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(e){if(!rt.disableBfCache&&e.persisted){ze&&console.debug("Dexie: handling persisted pagehide"),$t!=null&&$t.close();for(var t=0,s=Bt;t<s.length;t++)s[t].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(e){!rt.disableBfCache&&e.persisted&&(ze&&console.debug("Dexie: handling persisted pageshow"),yo(),os({all:new Pe(-1/0,[[]])}))})),j.rejectionMapper=function(e,t){return!e||e instanceof Be||e instanceof TypeError||e instanceof SyntaxError||!e.name||!_e[e.name]?e:(t=new _e[e.name](t||e.message,e),"stack"in e&&oe(t,"stack",{get:function(){return this.inner.stack}}),t)},qs(ze),o(rt,Object.freeze({__proto__:null,Dexie:rt,liveQuery:go,Entity:Gs,cmp:Q,PropModification:en,replacePrefix:function(e,t){return new en({replacePrefix:[e,t]})},add:function(e){return new en({add:e})},remove:function(e){return new en({remove:e})},default:rt,RangeSet:Pe,mergeRanges:an,rangesOverlap:oo}),{default:rt}),rt})}(hr)),hr.exports}var Li=Ui();const Ss=$i(Li),vo=Symbol.for("Dexie"),dr=globalThis[vo]||(globalThis[vo]=Ss);if(Ss.semVer!==dr.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${Ss.semVer} and ${dr.semVer}`);const{liveQuery:nu,mergeRanges:ru,rangesOverlap:su,RangeSet:ou,cmp:iu,Entity:au,PropModification:uu,replacePrefix:cu,add:lu,remove:fu}=dr,ks={theme:"system",apiKeys:{anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434"},videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1,preserveKeyFormat:!1},{subscribe:Wi,set:as,update:us}=Bo(ks),Ht={subscribe:Wi,async loadSettings(){try{const a=await fr.settings.get("user-settings");a?(console.log("Loaded settings from IndexedDB:",a),a.apiKeys?Object.entries(a.apiKeys).forEach(([n,r])=>{r&&typeof r=="string"&&r.length>0?console.log(`Found ${n} API key (length: ${r.length}, starts with: ${r.substring(0,4)}...)`):console.log(`No ${n} API key found in settings`)}):(console.warn("No API keys object found in loaded settings"),a.apiKeys={anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434"}),as(a)):(console.log("Creating default settings in IndexedDB"),await fr.settings.add({...ks,id:"user-settings"}),as(ks))}catch(a){console.error("Failed to load settings from IndexedDB:",a);try{const n=localStorage.getItem("gervais-settings");if(n){console.log("Found settings in localStorage, migrating to IndexedDB");const r=JSON.parse(n);as(r),await fr.settings.add({...r,id:"user-settings"}),localStorage.removeItem("gervais-settings")}}catch(n){console.error("Failed to load settings from localStorage:",n)}}},async saveSettings(a){try{console.log("Saving settings to IndexedDB:",a),await fr.settings.put({...a,id:"user-settings"})}catch(n){console.error("Failed to save settings to IndexedDB:",n);try{localStorage.setItem("gervais-settings",JSON.stringify(a)),console.log("Saved settings to localStorage as fallback")}catch(r){console.error("Failed to save settings to localStorage:",r)}}},async updateApiKeys(a){us(n=>{const r={...n,apiKeys:{...n.apiKeys,...a}};return this.saveSettings(r).catch(console.error),r})},async updateSettings(a){us(n=>{const r={...n,...a,apiKeys:{...n.apiKeys,...a.apiKeys||{}}};return this.saveSettings(r).catch(console.error),r})},updateTheme(a){us(n=>{const r={...n,theme:a};return this.saveSettings(r).catch(console.error),r})},async init(){await this.loadSettings()}},Lt="0.39.0";let wo=!1,bn,qo,As,No,$o,Fo;function Hi(a,n={auto:!1}){if(wo)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${a.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(bn)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${a.kind}'\` after \`import '@anthropic-ai/sdk/shims/${bn}'\``);wo=n.auto,bn=a.kind,qo=a.fetch,As=a.File,No=a.ReadableStream,$o=a.getDefaultAgent,Fo=a.fileFromPath}class Gi{constructor(n){this.body=n}get[Symbol.toStringTag](){return"MultipartBody"}}function Vi({manuallyImported:a}={}){const n=a?"You may need to use polyfills":"Add one of these imports before your first `import â¦ from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let r,o,c,h;try{r=fetch,o=Request,c=Response,h=Headers}catch(S){throw new Error(`this environment is missing the following Web Fetch API type: ${S.message}. ${n}`)}return{kind:"web",fetch:r,Request:o,Response:c,Headers:h,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${n}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${n}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${n}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${n}`)}},getMultipartRequestOptions:async(S,P)=>({...P,body:new Gi(S)}),getDefaultAgent:S=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:S=>!1}}bn||Hi(Vi(),{auto:!0});class Z extends Error{}class Re extends Z{constructor(n,r,o,c){super(`${Re.makeMessage(n,r,o)}`),this.status=n,this.headers=c,this.request_id=c==null?void 0:c["request-id"],this.error=r}static makeMessage(n,r,o){const c=r!=null&&r.message?typeof r.message=="string"?r.message:JSON.stringify(r.message):r?JSON.stringify(r):o;return n&&c?`${n} ${c}`:n?`${n} status code (no body)`:c||"(no status code or body)"}static generate(n,r,o,c){if(!n||!c)return new br({message:o,cause:Es(r)});const h=r;return n===400?new Lo(n,h,o,c):n===401?new Wo(n,h,o,c):n===403?new Ho(n,h,o,c):n===404?new Go(n,h,o,c):n===409?new Vo(n,h,o,c):n===422?new Jo(n,h,o,c):n===429?new zo(n,h,o,c):n>=500?new Xo(n,h,o,c):new Re(n,h,o,c)}}class Ge extends Re{constructor({message:n}={}){super(void 0,void 0,n||"Request was aborted.",void 0)}}class br extends Re{constructor({message:n,cause:r}){super(void 0,void 0,n||"Connection error.",void 0),r&&(this.cause=r)}}class Uo extends br{constructor({message:n}={}){super({message:n??"Request timed out."})}}class Lo extends Re{}class Wo extends Re{}class Ho extends Re{}class Go extends Re{}class Vo extends Re{}class Jo extends Re{}class zo extends Re{}class Xo extends Re{}var Jn=function(a,n,r,o,c){if(o==="m")throw new TypeError("Private method is not writable");if(o==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?a!==n||!c:!n.has(a))throw new TypeError("Cannot write private member to an object whose class did not declare it");return o==="a"?c.call(a,r):c?c.value=r:n.set(a,r),r},Tt=function(a,n,r,o){if(r==="a"&&!o)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?a!==n||!o:!n.has(a))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?o:r==="a"?o.call(a):o?o.value:n.get(a)},Fe;class vn{constructor(){Fe.set(this,void 0),this.buffer=new Uint8Array,Jn(this,Fe,null,"f")}decode(n){if(n==null)return[];const r=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?new TextEncoder().encode(n):n;let o=new Uint8Array(this.buffer.length+r.length);o.set(this.buffer),o.set(r,this.buffer.length),this.buffer=o;const c=[];let h;for(;(h=Ji(this.buffer,Tt(this,Fe,"f")))!=null;){if(h.carriage&&Tt(this,Fe,"f")==null){Jn(this,Fe,h.index,"f");continue}if(Tt(this,Fe,"f")!=null&&(h.index!==Tt(this,Fe,"f")+1||h.carriage)){c.push(this.decodeText(this.buffer.slice(0,Tt(this,Fe,"f")-1))),this.buffer=this.buffer.slice(Tt(this,Fe,"f")),Jn(this,Fe,null,"f");continue}const S=Tt(this,Fe,"f")!==null?h.preceding-1:h.preceding,P=this.decodeText(this.buffer.slice(0,S));c.push(P),this.buffer=this.buffer.slice(h.index),Jn(this,Fe,null,"f")}return c}decodeText(n){if(n==null)return"";if(typeof n=="string")return n;if(typeof Buffer<"u"){if(n instanceof Buffer)return n.toString();if(n instanceof Uint8Array)return Buffer.from(n).toString();throw new Z(`Unexpected: received non-Uint8Array (${n.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(n instanceof Uint8Array||n instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(n);throw new Z(`Unexpected: received non-Uint8Array/ArrayBuffer (${n.constructor.name}) in a web platform. Please report this error.`)}throw new Z("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}Fe=new WeakMap;vn.NEWLINE_CHARS=new Set([`
`,"\r"]);vn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Ji(a,n){for(let c=n??0;c<a.length;c++){if(a[c]===10)return{preceding:c,index:c+1,carriage:!1};if(a[c]===13)return{preceding:c,index:c+1,carriage:!0}}return null}function zi(a){for(let o=0;o<a.length-1;o++){if(a[o]===10&&a[o+1]===10||a[o]===13&&a[o+1]===13)return o+2;if(a[o]===13&&a[o+1]===10&&o+3<a.length&&a[o+2]===13&&a[o+3]===10)return o+4}return-1}function Ps(a){if(a[Symbol.asyncIterator])return a;const n=a.getReader();return{async next(){try{const r=await n.read();return r!=null&&r.done&&n.releaseLock(),r}catch(r){throw n.releaseLock(),r}},async return(){const r=n.cancel();return n.releaseLock(),await r,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Qe{constructor(n,r){this.iterator=n,this.controller=r}static fromSSEResponse(n,r){let o=!1;async function*c(){if(o)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");o=!0;let h=!1;try{for await(const S of Xi(n,r)){if(S.event==="completion")try{yield JSON.parse(S.data)}catch(P){throw console.error("Could not parse message into JSON:",S.data),console.error("From chunk:",S.raw),P}if(S.event==="message_start"||S.event==="message_delta"||S.event==="message_stop"||S.event==="content_block_start"||S.event==="content_block_delta"||S.event==="content_block_stop")try{yield JSON.parse(S.data)}catch(P){throw console.error("Could not parse message into JSON:",S.data),console.error("From chunk:",S.raw),P}if(S.event!=="ping"&&S.event==="error")throw Re.generate(void 0,`SSE Error: ${S.data}`,S.data,Zo(n.headers))}h=!0}catch(S){if(S instanceof Error&&S.name==="AbortError")return;throw S}finally{h||r.abort()}}return new Qe(c,r)}static fromReadableStream(n,r){let o=!1;async function*c(){const S=new vn,P=Ps(n);for await(const D of P)for(const B of S.decode(D))yield B;for(const D of S.flush())yield D}async function*h(){if(o)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");o=!0;let S=!1;try{for await(const P of c())S||P&&(yield JSON.parse(P));S=!0}catch(P){if(P instanceof Error&&P.name==="AbortError")return;throw P}finally{S||r.abort()}}return new Qe(h,r)}[Symbol.asyncIterator](){return this.iterator()}tee(){const n=[],r=[],o=this.iterator(),c=h=>({next:()=>{if(h.length===0){const S=o.next();n.push(S),r.push(S)}return h.shift()}});return[new Qe(()=>c(n),this.controller),new Qe(()=>c(r),this.controller)]}toReadableStream(){const n=this;let r;const o=new TextEncoder;return new No({async start(){r=n[Symbol.asyncIterator]()},async pull(c){try{const{value:h,done:S}=await r.next();if(S)return c.close();const P=o.encode(JSON.stringify(h)+`
`);c.enqueue(P)}catch(h){c.error(h)}},async cancel(){var c;await((c=r.return)==null?void 0:c.call(r))}})}}async function*Xi(a,n){if(!a.body)throw n.abort(),new Z("Attempted to iterate over a response with no body");const r=new Qi,o=new vn,c=Ps(a.body);for await(const h of Yi(c))for(const S of o.decode(h)){const P=r.decode(S);P&&(yield P)}for(const h of o.flush()){const S=r.decode(h);S&&(yield S)}}async function*Yi(a){let n=new Uint8Array;for await(const r of a){if(r==null)continue;const o=r instanceof ArrayBuffer?new Uint8Array(r):typeof r=="string"?new TextEncoder().encode(r):r;let c=new Uint8Array(n.length+o.length);c.set(n),c.set(o,n.length),n=c;let h;for(;(h=zi(n))!==-1;)yield n.slice(0,h),n=n.slice(h)}n.length>0&&(yield n)}class Qi{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(n){if(n.endsWith("\r")&&(n=n.substring(0,n.length-1)),!n){if(!this.event&&!this.data.length)return null;const h={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],h}if(this.chunks.push(n),n.startsWith(":"))return null;let[r,o,c]=Zi(n,":");return c.startsWith(" ")&&(c=c.substring(1)),r==="event"?this.event=c:r==="data"&&this.data.push(c),null}}function Zi(a,n){const r=a.indexOf(n);return r!==-1?[a.substring(0,r),n,a.substring(r+n.length)]:[a,"",""]}const ea=a=>a!=null&&typeof a=="object"&&typeof a.url=="string"&&typeof a.blob=="function",ta=a=>a!=null&&typeof a=="object"&&typeof a.name=="string"&&typeof a.lastModified=="number"&&vr(a),vr=a=>a!=null&&typeof a=="object"&&typeof a.size=="number"&&typeof a.type=="string"&&typeof a.text=="function"&&typeof a.slice=="function"&&typeof a.arrayBuffer=="function";async function na(a,n,r){var c;if(a=await a,ta(a))return a;if(ea(a)){const h=await a.blob();n||(n=new URL(a.url).pathname.split(/[\\/]/).pop()??"unknown_file");const S=vr(h)?[await h.arrayBuffer()]:[h];return new As(S,n,r)}const o=await ra(a);if(n||(n=oa(a)??"unknown_file"),!(r!=null&&r.type)){const h=(c=o[0])==null?void 0:c.type;typeof h=="string"&&(r={...r,type:h})}return new As(o,n,r)}async function ra(a){var r;let n=[];if(typeof a=="string"||ArrayBuffer.isView(a)||a instanceof ArrayBuffer)n.push(a);else if(vr(a))n.push(await a.arrayBuffer());else if(ia(a))for await(const o of a)n.push(o);else throw new Error(`Unexpected data type: ${typeof a}; constructor: ${(r=a==null?void 0:a.constructor)==null?void 0:r.name}; props: ${sa(a)}`);return n}function sa(a){return`[${Object.getOwnPropertyNames(a).map(r=>`"${r}"`).join(", ")}]`}function oa(a){var n;return cs(a.name)||cs(a.filename)||((n=cs(a.path))==null?void 0:n.split(/[\\/]/).pop())}const cs=a=>{if(typeof a=="string")return a;if(typeof Buffer<"u"&&a instanceof Buffer)return String(a)},ia=a=>a!=null&&typeof a=="object"&&typeof a[Symbol.asyncIterator]=="function",_o=a=>a&&typeof a=="object"&&a.body&&a[Symbol.toStringTag]==="MultipartBody";var Gt={},aa=function(a,n,r,o,c){if(typeof n=="function"?a!==n||!0:!n.has(a))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n.set(a,r),r},ua=function(a,n,r,o){if(typeof n=="function"?a!==n||!0:!n.has(a))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?o:r==="a"?o.call(a):o?o.value:n.get(a)},zn;async function Yo(a){const{response:n}=a;if(a.options.stream)return Vt("response",n.status,n.url,n.headers,n.body),a.options.__streamClass?a.options.__streamClass.fromSSEResponse(n,a.controller):Qe.fromSSEResponse(n,a.controller);if(n.status===204)return null;if(a.options.__binaryResponse)return n;const r=n.headers.get("content-type");if((r==null?void 0:r.includes("application/json"))||(r==null?void 0:r.includes("application/vnd.api+json"))){const h=await n.json();return Vt("response",n.status,n.url,n.headers,h),Qo(h,n)}const c=await n.text();return Vt("response",n.status,n.url,n.headers,c),c}function Qo(a,n){return!a||typeof a!="object"||Array.isArray(a)?a:Object.defineProperty(a,"_request_id",{value:n.headers.get("request-id"),enumerable:!1})}class wr extends Promise{constructor(n,r=Yo){super(o=>{o(null)}),this.responsePromise=n,this.parseResponse=r}_thenUnwrap(n){return new wr(this.responsePromise,async r=>Qo(n(await this.parseResponse(r),r),r.response))}asResponse(){return this.responsePromise.then(n=>n.response)}async withResponse(){const[n,r]=await Promise.all([this.parse(),this.asResponse()]);return{data:n,response:r,request_id:r.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(n,r){return this.parse().then(n,r)}catch(n){return this.parse().catch(n)}finally(n){return this.parse().finally(n)}}class ca{constructor({baseURL:n,maxRetries:r=2,timeout:o=6e5,httpAgent:c,fetch:h}){this.baseURL=n,this.maxRetries=ls("maxRetries",r),this.timeout=ls("timeout",o),this.httpAgent=c,this.fetch=h??qo}authHeaders(n){return{}}defaultHeaders(n){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...ma(),...this.authHeaders(n)}}validateHeaders(n,r){}defaultIdempotencyKey(){return`stainless-node-retry-${wa()}`}get(n,r){return this.methodRequest("get",n,r)}post(n,r){return this.methodRequest("post",n,r)}patch(n,r){return this.methodRequest("patch",n,r)}put(n,r){return this.methodRequest("put",n,r)}delete(n,r){return this.methodRequest("delete",n,r)}methodRequest(n,r,o){return this.request(Promise.resolve(o).then(async c=>{const h=c&&vr(c==null?void 0:c.body)?new DataView(await c.body.arrayBuffer()):(c==null?void 0:c.body)instanceof DataView?c.body:(c==null?void 0:c.body)instanceof ArrayBuffer?new DataView(c.body):c&&ArrayBuffer.isView(c==null?void 0:c.body)?new DataView(c.body.buffer):c==null?void 0:c.body;return{method:n,path:r,...c,body:h}}))}getAPIList(n,r,o){return this.requestAPIList(r,{method:"get",path:n,...o})}calculateContentLength(n){if(typeof n=="string"){if(typeof Buffer<"u")return Buffer.byteLength(n,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(n).length.toString()}else if(ArrayBuffer.isView(n))return n.byteLength.toString();return null}buildRequest(n,{retryCount:r=0}={}){var oe;n={...n};const{method:o,path:c,query:h,headers:S={}}=n,P=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:_o(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,D=this.calculateContentLength(P),B=this.buildURL(c,h);"timeout"in n&&ls("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const L=n.httpAgent??this.httpAgent??$o(B),$=n.timeout+1e3;typeof((oe=L==null?void 0:L.options)==null?void 0:oe.timeout)=="number"&&$>(L.options.timeout??0)&&(L.options.timeout=$),this.idempotencyHeader&&o!=="get"&&(n.idempotencyKey||(n.idempotencyKey=this.defaultIdempotencyKey()),S[this.idempotencyHeader]=n.idempotencyKey);const W=this.buildHeaders({options:n,headers:S,contentLength:D,retryCount:r});return{req:{method:o,...P&&{body:P},headers:W,...L&&{agent:L},signal:n.signal??null},url:B,timeout:n.timeout}}buildHeaders({options:n,headers:r,contentLength:o,retryCount:c}){const h={};o&&(h["content-length"]=o);const S=this.defaultHeaders(n);return Ao(h,S),Ao(h,r),_o(n.body)&&bn!=="node"&&delete h["content-type"],Xn(S,"x-stainless-retry-count")===void 0&&Xn(r,"x-stainless-retry-count")===void 0&&(h["x-stainless-retry-count"]=String(c)),Xn(S,"x-stainless-timeout")===void 0&&Xn(r,"x-stainless-timeout")===void 0&&n.timeout&&(h["x-stainless-timeout"]=String(n.timeout)),this.validateHeaders(h,r),h}_calculateNonstreamingTimeout(n){if(3600*n/128e3>600)throw new Z("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(n){}async prepareRequest(n,{url:r,options:o}){}parseHeaders(n){return n?Symbol.iterator in n?Object.fromEntries(Array.from(n).map(r=>[...r])):{...n}:{}}makeStatusError(n,r,o,c){return Re.generate(n,r,o,c)}request(n,r=null){return new wr(this.makeRequest(n,r))}async makeRequest(n,r){var $,W;const o=await n,c=o.maxRetries??this.maxRetries;r==null&&(r=c),await this.prepareOptions(o);const{req:h,url:S,timeout:P}=this.buildRequest(o,{retryCount:c-r});if(await this.prepareRequest(h,{url:S,options:o}),Vt("request",S,o,h.headers),($=o.signal)!=null&&$.aborted)throw new Ge;const D=new AbortController,B=await this.fetchWithTimeout(S,h,P,D).catch(Es);if(B instanceof Error){if((W=o.signal)!=null&&W.aborted)throw new Ge;if(r)return this.retryRequest(o,r);throw B.name==="AbortError"?new Uo:new br({cause:B})}const L=Zo(B.headers);if(!B.ok){if(r&&this.shouldRetry(B)){const ee=`retrying, ${r} attempts remaining`;return Vt(`response (error; ${ee})`,B.status,S,L),this.retryRequest(o,r,L)}const V=await B.text().catch(ee=>Es(ee).message),oe=ga(V),ge=oe?void 0:V;throw Vt(`response (error; ${r?"(error; no more retries left)":"(error; not retryable)"})`,B.status,S,L,ge),this.makeStatusError(B.status,oe,ge,L)}return{response:B,options:o,controller:D}}requestAPIList(n,r){const o=this.makeRequest(r,null);return new fa(this,o,n)}buildURL(n,r){const o=ba(n)?new URL(n):new URL(this.baseURL+(this.baseURL.endsWith("/")&&n.startsWith("/")?n.slice(1):n)),c=this.defaultQuery();return pr(c)||(r={...c,...r}),typeof r=="object"&&r&&!Array.isArray(r)&&(o.search=this.stringifyQuery(r)),o.toString()}stringifyQuery(n){return Object.entries(n).filter(([r,o])=>typeof o<"u").map(([r,o])=>{if(typeof o=="string"||typeof o=="number"||typeof o=="boolean")return`${encodeURIComponent(r)}=${encodeURIComponent(o)}`;if(o===null)return`${encodeURIComponent(r)}=`;throw new Z(`Cannot stringify type ${typeof o}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(n,r,o,c){const{signal:h,...S}=r||{};h&&h.addEventListener("abort",()=>c.abort());const P=setTimeout(()=>c.abort(),o),D={signal:c.signal,...S};D.method&&(D.method=D.method.toUpperCase());const B=60*1e3,L=setTimeout(()=>{var $,W;if(D&&(($=D==null?void 0:D.agent)!=null&&$.sockets))for(const V of Object.values((W=D==null?void 0:D.agent)==null?void 0:W.sockets).flat())V!=null&&V.setKeepAlive&&V.setKeepAlive(!0,B)},B);return this.fetch.call(void 0,n,D).finally(()=>{clearTimeout(P),clearTimeout(L)})}shouldRetry(n){const r=n.headers.get("x-should-retry");return r==="true"?!0:r==="false"?!1:n.status===408||n.status===409||n.status===429||n.status>=500}async retryRequest(n,r,o){let c;const h=o==null?void 0:o["retry-after-ms"];if(h){const P=parseFloat(h);Number.isNaN(P)||(c=P)}const S=o==null?void 0:o["retry-after"];if(S&&!c){const P=parseFloat(S);Number.isNaN(P)?c=Date.parse(S)-Date.now():c=P*1e3}if(!(c&&0<=c&&c<60*1e3)){const P=n.maxRetries??this.maxRetries;c=this.calculateDefaultRetryTimeoutMillis(r,P)}return await va(c),this.makeRequest(n,r-1)}calculateDefaultRetryTimeoutMillis(n,r){const h=r-n,S=Math.min(.5*Math.pow(2,h),8),P=1-Math.random()*.25;return S*P*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Lt}`}}class la{constructor(n,r,o,c){zn.set(this,void 0),aa(this,zn,n),this.options=c,this.response=r,this.body=o}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const n=this.nextPageInfo();if(!n)throw new Z("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const r={...this.options};if("params"in n&&typeof r.query=="object")r.query={...r.query,...n.params};else if("url"in n){const o=[...Object.entries(r.query||{}),...n.url.searchParams.entries()];for(const[c,h]of o)n.url.searchParams.set(c,h);r.query=void 0,r.path=n.url.toString()}return await ua(this,zn,"f").requestAPIList(this.constructor,r)}async*iterPages(){let n=this;for(yield n;n.hasNextPage();)n=await n.getNextPage(),yield n}async*[(zn=new WeakMap,Symbol.asyncIterator)](){for await(const n of this.iterPages())for(const r of n.getPaginatedItems())yield r}}class fa extends wr{constructor(n,r,o){super(r,async c=>new o(n,c.response,await Yo(c),c.options))}async*[Symbol.asyncIterator](){const n=await this;for await(const r of n)yield r}}const Zo=a=>new Proxy(Object.fromEntries(a.entries()),{get(n,r){const o=r.toString();return n[o.toLowerCase()]||n[o]}}),ha={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},yt=a=>typeof a=="object"&&a!==null&&!pr(a)&&Object.keys(a).every(n=>ei(ha,n)),da=()=>{var n;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lt,"X-Stainless-OS":So(Deno.build.os),"X-Stainless-Arch":xo(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((n=Deno.version)==null?void 0:n.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lt,"X-Stainless-OS":So(process.platform),"X-Stainless-Arch":xo(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const a=pa();return a?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${a.browser}`,"X-Stainless-Runtime-Version":a.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Lt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function pa(){if(typeof navigator>"u"||!navigator)return null;const a=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:n,pattern:r}of a){const o=r.exec(navigator.userAgent);if(o){const c=o[1]||0,h=o[2]||0,S=o[3]||0;return{browser:n,version:`${c}.${h}.${S}`}}}return null}const xo=a=>a==="x32"?"x32":a==="x86_64"||a==="x64"?"x64":a==="arm"?"arm":a==="aarch64"||a==="arm64"?"arm64":a?`other:${a}`:"unknown",So=a=>(a=a.toLowerCase(),a.includes("ios")?"iOS":a==="android"?"Android":a==="darwin"?"MacOS":a==="win32"?"Windows":a==="freebsd"?"FreeBSD":a==="openbsd"?"OpenBSD":a==="linux"?"Linux":a?`Other:${a}`:"Unknown");let ko;const ma=()=>ko??(ko=da()),ga=a=>{try{return JSON.parse(a)}catch{return}},ya=/^[a-z][a-z0-9+.-]*:/i,ba=a=>ya.test(a),va=a=>new Promise(n=>setTimeout(n,a)),ls=(a,n)=>{if(typeof n!="number"||!Number.isInteger(n))throw new Z(`${a} must be an integer`);if(n<0)throw new Z(`${a} must be a positive integer`);return n},Es=a=>{if(a instanceof Error)return a;if(typeof a=="object"&&a!==null)try{return new Error(JSON.stringify(a))}catch{}return new Error(String(a))},fs=a=>{var n,r,o,c;if(typeof process<"u")return((n=Gt==null?void 0:Gt[a])==null?void 0:n.trim())??void 0;if(typeof Deno<"u")return(c=(o=(r=Deno.env)==null?void 0:r.get)==null?void 0:o.call(r,a))==null?void 0:c.trim()};function pr(a){if(!a)return!0;for(const n in a)return!1;return!0}function ei(a,n){return Object.prototype.hasOwnProperty.call(a,n)}function Ao(a,n){for(const r in n){if(!ei(n,r))continue;const o=r.toLowerCase();if(!o)continue;const c=n[r];c===null?delete a[o]:c!==void 0&&(a[o]=c)}}function Vt(a,...n){typeof process<"u"&&(Gt==null?void 0:Gt.DEBUG)==="true"&&console.log(`Anthropic:DEBUG:${a}`,...n)}const wa=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const n=Math.random()*16|0;return(a==="x"?n:n&3|8).toString(16)}),_a=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",xa=a=>typeof(a==null?void 0:a.get)=="function",Xn=(a,n)=>{var o;const r=n.toLowerCase();if(xa(a)){const c=((o=n[0])==null?void 0:o.toUpperCase())+n.substring(1).replace(/([^\w])(\w)/g,(h,S,P)=>S+P.toUpperCase());for(const h of[n,r,n.toUpperCase(),c]){const S=a.get(h);if(S)return S}}for(const[c,h]of Object.entries(a))if(c.toLowerCase()===r)return Array.isArray(h)?(h.length<=1||console.warn(`Received ${h.length} entries for the ${n} header, using the first entry.`),h[0]):h};class _r extends la{constructor(n,r,o,c){super(n,r,o,c),this.data=o.data||[],this.has_more=o.has_more||!1,this.first_id=o.first_id||null,this.last_id=o.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const n=this.nextPageInfo();if(!n)return null;if("params"in n)return n.params;const r=Object.fromEntries(n.url.searchParams);return Object.keys(r).length?r:null}nextPageInfo(){var r;if((r=this.options.query)!=null&&r.before_id){const o=this.first_id;return o?{params:{before_id:o}}:null}const n=this.last_id;return n?{params:{after_id:n}}:null}}class bt{constructor(n){this._client=n}}let Os=class extends bt{retrieve(n,r){return this._client.get(`/v1/models/${n}?beta=true`,r)}list(n={},r){return yt(n)?this.list({},n):this._client.getAPIList("/v1/models?beta=true",Is,{query:n,...r})}};class Is extends _r{}Os.BetaModelInfosPage=Is;class xr{constructor(n,r){this.iterator=n,this.controller=r}async*decoder(){const n=new vn;for await(const r of this.iterator)for(const o of n.decode(r))yield JSON.parse(o);for(const r of n.flush())yield JSON.parse(r)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(n,r){if(!n.body)throw r.abort(),new Z("Attempted to iterate over a response with no body");return new xr(Ps(n.body),r)}}let Ms=class extends bt{create(n,r){const{betas:o,...c}=n;return this._client.post("/v1/messages/batches?beta=true",{body:c,...r,headers:{"anthropic-beta":[...o??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}retrieve(n,r={},o){if(yt(r))return this.retrieve(n,{},r);const{betas:c}=r;return this._client.get(`/v1/messages/batches/${n}?beta=true`,{...o,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...o==null?void 0:o.headers}})}list(n={},r){if(yt(n))return this.list({},n);const{betas:o,...c}=n;return this._client.getAPIList("/v1/messages/batches?beta=true",Ts,{query:c,...r,headers:{"anthropic-beta":[...o??[],"message-batches-2024-09-24"].toString(),...r==null?void 0:r.headers}})}delete(n,r={},o){if(yt(r))return this.delete(n,{},r);const{betas:c}=r;return this._client.delete(`/v1/messages/batches/${n}?beta=true`,{...o,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...o==null?void 0:o.headers}})}cancel(n,r={},o){if(yt(r))return this.cancel(n,{},r);const{betas:c}=r;return this._client.post(`/v1/messages/batches/${n}/cancel?beta=true`,{...o,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...o==null?void 0:o.headers}})}async results(n,r={},o){if(yt(r))return this.results(n,{},r);const c=await this.retrieve(n);if(!c.results_url)throw new Z(`No batch \`results_url\`; Has it finished processing? ${c.processing_status} - ${c.id}`);const{betas:h}=r;return this._client.get(c.results_url,{...o,headers:{"anthropic-beta":[...h??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...o==null?void 0:o.headers},__binaryResponse:!0})._thenUnwrap((S,P)=>xr.fromResponse(P.response,P.controller))}};class Ts extends _r{}Ms.BetaMessageBatchesPage=Ts;const Sa=a=>{let n=0,r=[];for(;n<a.length;){let o=a[n];if(o==="\\"){n++;continue}if(o==="{"){r.push({type:"brace",value:"{"}),n++;continue}if(o==="}"){r.push({type:"brace",value:"}"}),n++;continue}if(o==="["){r.push({type:"paren",value:"["}),n++;continue}if(o==="]"){r.push({type:"paren",value:"]"}),n++;continue}if(o===":"){r.push({type:"separator",value:":"}),n++;continue}if(o===","){r.push({type:"delimiter",value:","}),n++;continue}if(o==='"'){let P="",D=!1;for(o=a[++n];o!=='"';){if(n===a.length){D=!0;break}if(o==="\\"){if(n++,n===a.length){D=!0;break}P+=o+a[n],o=a[++n]}else P+=o,o=a[++n]}o=a[++n],D||r.push({type:"string",value:P});continue}if(o&&/\s/.test(o)){n++;continue}let h=/[0-9]/;if(o&&h.test(o)||o==="-"||o==="."){let P="";for(o==="-"&&(P+=o,o=a[++n]);o&&h.test(o)||o===".";)P+=o,o=a[++n];r.push({type:"number",value:P});continue}let S=/[a-z]/i;if(o&&S.test(o)){let P="";for(;o&&S.test(o)&&n!==a.length;)P+=o,o=a[++n];if(P=="true"||P=="false"||P==="null")r.push({type:"name",value:P});else{n++;continue}continue}n++}return r},Wt=a=>{if(a.length===0)return a;let n=a[a.length-1];switch(n.type){case"separator":return a=a.slice(0,a.length-1),Wt(a);case"number":let r=n.value[n.value.length-1];if(r==="."||r==="-")return a=a.slice(0,a.length-1),Wt(a);case"string":let o=a[a.length-2];if((o==null?void 0:o.type)==="delimiter")return a=a.slice(0,a.length-1),Wt(a);if((o==null?void 0:o.type)==="brace"&&o.value==="{")return a=a.slice(0,a.length-1),Wt(a);break;case"delimiter":return a=a.slice(0,a.length-1),Wt(a)}return a},ka=a=>{let n=[];return a.map(r=>{r.type==="brace"&&(r.value==="{"?n.push("}"):n.splice(n.lastIndexOf("}"),1)),r.type==="paren"&&(r.value==="["?n.push("]"):n.splice(n.lastIndexOf("]"),1))}),n.length>0&&n.reverse().map(r=>{r==="}"?a.push({type:"brace",value:"}"}):r==="]"&&a.push({type:"paren",value:"]"})}),a},Aa=a=>{let n="";return a.map(r=>{switch(r.type){case"string":n+='"'+r.value+'"';break;default:n+=r.value;break}}),n},ti=a=>JSON.parse(Aa(ka(Wt(Sa(a)))));var Me=function(a,n,r,o,c){if(o==="m")throw new TypeError("Private method is not writable");if(o==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?a!==n||!c:!n.has(a))throw new TypeError("Cannot write private member to an object whose class did not declare it");return o==="a"?c.call(a,r):c?c.value=r:n.set(a,r),r},J=function(a,n,r,o){if(r==="a"&&!o)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?a!==n||!o:!n.has(a))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?o:r==="a"?o.call(a):o?o.value:n.get(a)},Le,mt,un,Yn,cn,ln,Qn,fn,st,hn,Zn,er,Ft,tr,nr,hs,Eo,ds,ps,ms,gs,Po;const Oo="__json_buf";class mr{constructor(){Le.add(this),this.messages=[],this.receivedMessages=[],mt.set(this,void 0),this.controller=new AbortController,un.set(this,void 0),Yn.set(this,()=>{}),cn.set(this,()=>{}),ln.set(this,void 0),Qn.set(this,()=>{}),fn.set(this,()=>{}),st.set(this,{}),hn.set(this,!1),Zn.set(this,!1),er.set(this,!1),Ft.set(this,!1),tr.set(this,void 0),nr.set(this,void 0),ds.set(this,n=>{if(Me(this,Zn,!0,"f"),n instanceof Error&&n.name==="AbortError"&&(n=new Ge),n instanceof Ge)return Me(this,er,!0,"f"),this._emit("abort",n);if(n instanceof Z)return this._emit("error",n);if(n instanceof Error){const r=new Z(n.message);return r.cause=n,this._emit("error",r)}return this._emit("error",new Z(String(n)))}),Me(this,un,new Promise((n,r)=>{Me(this,Yn,n,"f"),Me(this,cn,r,"f")}),"f"),Me(this,ln,new Promise((n,r)=>{Me(this,Qn,n,"f"),Me(this,fn,r,"f")}),"f"),J(this,un,"f").catch(()=>{}),J(this,ln,"f").catch(()=>{})}get response(){return J(this,tr,"f")}get request_id(){return J(this,nr,"f")}async withResponse(){const n=await J(this,un,"f");if(!n)throw new Error("Could not resolve a `Response` object");return{data:this,response:n,request_id:n.headers.get("request-id")}}static fromReadableStream(n){const r=new mr;return r._run(()=>r._fromReadableStream(n)),r}static createMessage(n,r,o){const c=new mr;for(const h of r.messages)c._addMessageParam(h);return c._run(()=>c._createMessage(n,{...r,stream:!0},{...o,headers:{...o==null?void 0:o.headers,"X-Stainless-Helper-Method":"stream"}})),c}_run(n){n().then(()=>{this._emitFinal(),this._emit("end")},J(this,ds,"f"))}_addMessageParam(n){this.messages.push(n)}_addMessage(n,r=!0){this.receivedMessages.push(n),r&&this._emit("message",n)}async _createMessage(n,r,o){var P;const c=o==null?void 0:o.signal;c&&(c.aborted&&this.controller.abort(),c.addEventListener("abort",()=>this.controller.abort())),J(this,Le,"m",ps).call(this);const{response:h,data:S}=await n.create({...r,stream:!0},{...o,signal:this.controller.signal}).withResponse();this._connected(h);for await(const D of S)J(this,Le,"m",ms).call(this,D);if((P=S.controller.signal)!=null&&P.aborted)throw new Ge;J(this,Le,"m",gs).call(this)}_connected(n){this.ended||(Me(this,tr,n,"f"),Me(this,nr,n==null?void 0:n.headers.get("request-id"),"f"),J(this,Yn,"f").call(this,n),this._emit("connect"))}get ended(){return J(this,hn,"f")}get errored(){return J(this,Zn,"f")}get aborted(){return J(this,er,"f")}abort(){this.controller.abort()}on(n,r){return(J(this,st,"f")[n]||(J(this,st,"f")[n]=[])).push({listener:r}),this}off(n,r){const o=J(this,st,"f")[n];if(!o)return this;const c=o.findIndex(h=>h.listener===r);return c>=0&&o.splice(c,1),this}once(n,r){return(J(this,st,"f")[n]||(J(this,st,"f")[n]=[])).push({listener:r,once:!0}),this}emitted(n){return new Promise((r,o)=>{Me(this,Ft,!0,"f"),n!=="error"&&this.once("error",o),this.once(n,r)})}async done(){Me(this,Ft,!0,"f"),await J(this,ln,"f")}get currentMessage(){return J(this,mt,"f")}async finalMessage(){return await this.done(),J(this,Le,"m",hs).call(this)}async finalText(){return await this.done(),J(this,Le,"m",Eo).call(this)}_emit(n,...r){if(J(this,hn,"f"))return;n==="end"&&(Me(this,hn,!0,"f"),J(this,Qn,"f").call(this));const o=J(this,st,"f")[n];if(o&&(J(this,st,"f")[n]=o.filter(c=>!c.once),o.forEach(({listener:c})=>c(...r))),n==="abort"){const c=r[0];!J(this,Ft,"f")&&!(o!=null&&o.length)&&Promise.reject(c),J(this,cn,"f").call(this,c),J(this,fn,"f").call(this,c),this._emit("end");return}if(n==="error"){const c=r[0];!J(this,Ft,"f")&&!(o!=null&&o.length)&&Promise.reject(c),J(this,cn,"f").call(this,c),J(this,fn,"f").call(this,c),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",J(this,Le,"m",hs).call(this))}async _fromReadableStream(n,r){var h;const o=r==null?void 0:r.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort())),J(this,Le,"m",ps).call(this),this._connected(null);const c=Qe.fromReadableStream(n,this.controller);for await(const S of c)J(this,Le,"m",ms).call(this,S);if((h=c.controller.signal)!=null&&h.aborted)throw new Ge;J(this,Le,"m",gs).call(this)}[(mt=new WeakMap,un=new WeakMap,Yn=new WeakMap,cn=new WeakMap,ln=new WeakMap,Qn=new WeakMap,fn=new WeakMap,st=new WeakMap,hn=new WeakMap,Zn=new WeakMap,er=new WeakMap,Ft=new WeakMap,tr=new WeakMap,nr=new WeakMap,ds=new WeakMap,Le=new WeakSet,hs=function(){if(this.receivedMessages.length===0)throw new Z("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Eo=function(){if(this.receivedMessages.length===0)throw new Z("stream ended without producing a Message with role=assistant");const r=this.receivedMessages.at(-1).content.filter(o=>o.type==="text").map(o=>o.text);if(r.length===0)throw new Z("stream ended without producing a content block with type=text");return r.join(" ")},ps=function(){this.ended||Me(this,mt,void 0,"f")},ms=function(r){if(this.ended)return;const o=J(this,Le,"m",Po).call(this,r);switch(this._emit("streamEvent",r,o),r.type){case"content_block_delta":{const c=o.content.at(-1);switch(r.delta.type){case"text_delta":{c.type==="text"&&this._emit("text",r.delta.text,c.text||"");break}case"citations_delta":{c.type==="text"&&this._emit("citation",r.delta.citation,c.citations??[]);break}case"input_json_delta":{c.type==="tool_use"&&c.input&&this._emit("inputJson",r.delta.partial_json,c.input);break}case"thinking_delta":{c.type==="thinking"&&this._emit("thinking",r.delta.thinking,c.thinking);break}case"signature_delta":{c.type==="thinking"&&this._emit("signature",c.signature);break}default:r.delta}break}case"message_stop":{this._addMessageParam(o),this._addMessage(o,!0);break}case"content_block_stop":{this._emit("contentBlock",o.content.at(-1));break}case"message_start":{Me(this,mt,o,"f");break}}},gs=function(){if(this.ended)throw new Z("stream has ended, this shouldn't happen");const r=J(this,mt,"f");if(!r)throw new Z("request ended without sending any chunks");return Me(this,mt,void 0,"f"),r},Po=function(r){let o=J(this,mt,"f");if(r.type==="message_start"){if(o)throw new Z(`Unexpected event order, got ${r.type} before receiving "message_stop"`);return r.message}if(!o)throw new Z(`Unexpected event order, got ${r.type} before "message_start"`);switch(r.type){case"message_stop":return o;case"message_delta":return o.stop_reason=r.delta.stop_reason,o.stop_sequence=r.delta.stop_sequence,o.usage.output_tokens=r.usage.output_tokens,o;case"content_block_start":return o.content.push(r.content_block),o;case"content_block_delta":{const c=o.content.at(r.index);switch(r.delta.type){case"text_delta":{(c==null?void 0:c.type)==="text"&&(c.text+=r.delta.text);break}case"citations_delta":{(c==null?void 0:c.type)==="text"&&(c.citations??(c.citations=[]),c.citations.push(r.delta.citation));break}case"input_json_delta":{if((c==null?void 0:c.type)==="tool_use"){let h=c[Oo]||"";h+=r.delta.partial_json,Object.defineProperty(c,Oo,{value:h,enumerable:!1,writable:!0}),h&&(c.input=ti(h))}break}case"thinking_delta":{(c==null?void 0:c.type)==="thinking"&&(c.thinking+=r.delta.thinking);break}case"signature_delta":{(c==null?void 0:c.type)==="thinking"&&(c.signature=r.delta.signature);break}default:r.delta}return o}case"content_block_stop":return o}},Symbol.asyncIterator)](){const n=[],r=[];let o=!1;return this.on("streamEvent",c=>{const h=r.shift();h?h.resolve(c):n.push(c)}),this.on("end",()=>{o=!0;for(const c of r)c.resolve(void 0);r.length=0}),this.on("abort",c=>{o=!0;for(const h of r)h.reject(c);r.length=0}),this.on("error",c=>{o=!0;for(const h of r)h.reject(c);r.length=0}),{next:async()=>n.length?{value:n.shift(),done:!1}:o?{value:void 0,done:!0}:new Promise((h,S)=>r.push({resolve:h,reject:S})).then(h=>h?{value:h,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Qe(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}const Io={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};let Sr=class extends bt{constructor(){super(...arguments),this.batches=new Ms(this._client)}create(n,r){const{betas:o,...c}=n;return c.model in Io&&console.warn(`The model '${c.model}' is deprecated and will reach end-of-life on ${Io[c.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:c,timeout:this._client._options.timeout??(c.stream?6e5:this._client._calculateNonstreamingTimeout(c.max_tokens)),...r,headers:{...(o==null?void 0:o.toString())!=null?{"anthropic-beta":o==null?void 0:o.toString()}:void 0,...r==null?void 0:r.headers},stream:n.stream??!1})}stream(n,r){return mr.createMessage(this,n,r)}countTokens(n,r){const{betas:o,...c}=n;return this._client.post("/v1/messages/count_tokens?beta=true",{body:c,...r,headers:{"anthropic-beta":[...o??[],"token-counting-2024-11-01"].toString(),...r==null?void 0:r.headers}})}};Sr.Batches=Ms;Sr.BetaMessageBatchesPage=Ts;class wn extends bt{constructor(){super(...arguments),this.models=new Os(this._client),this.messages=new Sr(this._client)}}wn.Models=Os;wn.BetaModelInfosPage=Is;wn.Messages=Sr;class ni extends bt{create(n,r){return this._client.post("/v1/complete",{body:n,timeout:this._client._options.timeout??6e5,...r,stream:n.stream??!1})}}class Rs extends bt{create(n,r){return this._client.post("/v1/messages/batches",{body:n,...r})}retrieve(n,r){return this._client.get(`/v1/messages/batches/${n}`,r)}list(n={},r){return yt(n)?this.list({},n):this._client.getAPIList("/v1/messages/batches",Cs,{query:n,...r})}delete(n,r){return this._client.delete(`/v1/messages/batches/${n}`,r)}cancel(n,r){return this._client.post(`/v1/messages/batches/${n}/cancel`,r)}async results(n,r){const o=await this.retrieve(n);if(!o.results_url)throw new Z(`No batch \`results_url\`; Has it finished processing? ${o.processing_status} - ${o.id}`);return this._client.get(o.results_url,{...r,headers:{Accept:"application/binary",...r==null?void 0:r.headers},__binaryResponse:!0})._thenUnwrap((c,h)=>xr.fromResponse(h.response,h.controller))}}class Cs extends _r{}Rs.MessageBatchesPage=Cs;var Te=function(a,n,r,o,c){if(o==="m")throw new TypeError("Private method is not writable");if(o==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?a!==n||!c:!n.has(a))throw new TypeError("Cannot write private member to an object whose class did not declare it");return o==="a"?c.call(a,r):c?c.value=r:n.set(a,r),r},z=function(a,n,r,o){if(r==="a"&&!o)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?a!==n||!o:!n.has(a))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?o:r==="a"?o.call(a):o?o.value:n.get(a)},We,gt,dn,rr,pn,mn,sr,gn,ot,yn,or,ir,Ut,ar,ur,ys,Mo,bs,vs,ws,_s,To;const Ro="__json_buf";class gr{constructor(){We.add(this),this.messages=[],this.receivedMessages=[],gt.set(this,void 0),this.controller=new AbortController,dn.set(this,void 0),rr.set(this,()=>{}),pn.set(this,()=>{}),mn.set(this,void 0),sr.set(this,()=>{}),gn.set(this,()=>{}),ot.set(this,{}),yn.set(this,!1),or.set(this,!1),ir.set(this,!1),Ut.set(this,!1),ar.set(this,void 0),ur.set(this,void 0),bs.set(this,n=>{if(Te(this,or,!0,"f"),n instanceof Error&&n.name==="AbortError"&&(n=new Ge),n instanceof Ge)return Te(this,ir,!0,"f"),this._emit("abort",n);if(n instanceof Z)return this._emit("error",n);if(n instanceof Error){const r=new Z(n.message);return r.cause=n,this._emit("error",r)}return this._emit("error",new Z(String(n)))}),Te(this,dn,new Promise((n,r)=>{Te(this,rr,n,"f"),Te(this,pn,r,"f")}),"f"),Te(this,mn,new Promise((n,r)=>{Te(this,sr,n,"f"),Te(this,gn,r,"f")}),"f"),z(this,dn,"f").catch(()=>{}),z(this,mn,"f").catch(()=>{})}get response(){return z(this,ar,"f")}get request_id(){return z(this,ur,"f")}async withResponse(){const n=await z(this,dn,"f");if(!n)throw new Error("Could not resolve a `Response` object");return{data:this,response:n,request_id:n.headers.get("request-id")}}static fromReadableStream(n){const r=new gr;return r._run(()=>r._fromReadableStream(n)),r}static createMessage(n,r,o){const c=new gr;for(const h of r.messages)c._addMessageParam(h);return c._run(()=>c._createMessage(n,{...r,stream:!0},{...o,headers:{...o==null?void 0:o.headers,"X-Stainless-Helper-Method":"stream"}})),c}_run(n){n().then(()=>{this._emitFinal(),this._emit("end")},z(this,bs,"f"))}_addMessageParam(n){this.messages.push(n)}_addMessage(n,r=!0){this.receivedMessages.push(n),r&&this._emit("message",n)}async _createMessage(n,r,o){var P;const c=o==null?void 0:o.signal;c&&(c.aborted&&this.controller.abort(),c.addEventListener("abort",()=>this.controller.abort())),z(this,We,"m",vs).call(this);const{response:h,data:S}=await n.create({...r,stream:!0},{...o,signal:this.controller.signal}).withResponse();this._connected(h);for await(const D of S)z(this,We,"m",ws).call(this,D);if((P=S.controller.signal)!=null&&P.aborted)throw new Ge;z(this,We,"m",_s).call(this)}_connected(n){this.ended||(Te(this,ar,n,"f"),Te(this,ur,n==null?void 0:n.headers.get("request-id"),"f"),z(this,rr,"f").call(this,n),this._emit("connect"))}get ended(){return z(this,yn,"f")}get errored(){return z(this,or,"f")}get aborted(){return z(this,ir,"f")}abort(){this.controller.abort()}on(n,r){return(z(this,ot,"f")[n]||(z(this,ot,"f")[n]=[])).push({listener:r}),this}off(n,r){const o=z(this,ot,"f")[n];if(!o)return this;const c=o.findIndex(h=>h.listener===r);return c>=0&&o.splice(c,1),this}once(n,r){return(z(this,ot,"f")[n]||(z(this,ot,"f")[n]=[])).push({listener:r,once:!0}),this}emitted(n){return new Promise((r,o)=>{Te(this,Ut,!0,"f"),n!=="error"&&this.once("error",o),this.once(n,r)})}async done(){Te(this,Ut,!0,"f"),await z(this,mn,"f")}get currentMessage(){return z(this,gt,"f")}async finalMessage(){return await this.done(),z(this,We,"m",ys).call(this)}async finalText(){return await this.done(),z(this,We,"m",Mo).call(this)}_emit(n,...r){if(z(this,yn,"f"))return;n==="end"&&(Te(this,yn,!0,"f"),z(this,sr,"f").call(this));const o=z(this,ot,"f")[n];if(o&&(z(this,ot,"f")[n]=o.filter(c=>!c.once),o.forEach(({listener:c})=>c(...r))),n==="abort"){const c=r[0];!z(this,Ut,"f")&&!(o!=null&&o.length)&&Promise.reject(c),z(this,pn,"f").call(this,c),z(this,gn,"f").call(this,c),this._emit("end");return}if(n==="error"){const c=r[0];!z(this,Ut,"f")&&!(o!=null&&o.length)&&Promise.reject(c),z(this,pn,"f").call(this,c),z(this,gn,"f").call(this,c),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",z(this,We,"m",ys).call(this))}async _fromReadableStream(n,r){var h;const o=r==null?void 0:r.signal;o&&(o.aborted&&this.controller.abort(),o.addEventListener("abort",()=>this.controller.abort())),z(this,We,"m",vs).call(this),this._connected(null);const c=Qe.fromReadableStream(n,this.controller);for await(const S of c)z(this,We,"m",ws).call(this,S);if((h=c.controller.signal)!=null&&h.aborted)throw new Ge;z(this,We,"m",_s).call(this)}[(gt=new WeakMap,dn=new WeakMap,rr=new WeakMap,pn=new WeakMap,mn=new WeakMap,sr=new WeakMap,gn=new WeakMap,ot=new WeakMap,yn=new WeakMap,or=new WeakMap,ir=new WeakMap,Ut=new WeakMap,ar=new WeakMap,ur=new WeakMap,bs=new WeakMap,We=new WeakSet,ys=function(){if(this.receivedMessages.length===0)throw new Z("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Mo=function(){if(this.receivedMessages.length===0)throw new Z("stream ended without producing a Message with role=assistant");const r=this.receivedMessages.at(-1).content.filter(o=>o.type==="text").map(o=>o.text);if(r.length===0)throw new Z("stream ended without producing a content block with type=text");return r.join(" ")},vs=function(){this.ended||Te(this,gt,void 0,"f")},ws=function(r){if(this.ended)return;const o=z(this,We,"m",To).call(this,r);switch(this._emit("streamEvent",r,o),r.type){case"content_block_delta":{const c=o.content.at(-1);switch(r.delta.type){case"text_delta":{c.type==="text"&&this._emit("text",r.delta.text,c.text||"");break}case"citations_delta":{c.type==="text"&&this._emit("citation",r.delta.citation,c.citations??[]);break}case"input_json_delta":{c.type==="tool_use"&&c.input&&this._emit("inputJson",r.delta.partial_json,c.input);break}case"thinking_delta":{c.type==="thinking"&&this._emit("thinking",r.delta.thinking,c.thinking);break}case"signature_delta":{c.type==="thinking"&&this._emit("signature",c.signature);break}default:r.delta}break}case"message_stop":{this._addMessageParam(o),this._addMessage(o,!0);break}case"content_block_stop":{this._emit("contentBlock",o.content.at(-1));break}case"message_start":{Te(this,gt,o,"f");break}}},_s=function(){if(this.ended)throw new Z("stream has ended, this shouldn't happen");const r=z(this,gt,"f");if(!r)throw new Z("request ended without sending any chunks");return Te(this,gt,void 0,"f"),r},To=function(r){let o=z(this,gt,"f");if(r.type==="message_start"){if(o)throw new Z(`Unexpected event order, got ${r.type} before receiving "message_stop"`);return r.message}if(!o)throw new Z(`Unexpected event order, got ${r.type} before "message_start"`);switch(r.type){case"message_stop":return o;case"message_delta":return o.stop_reason=r.delta.stop_reason,o.stop_sequence=r.delta.stop_sequence,o.usage.output_tokens=r.usage.output_tokens,o;case"content_block_start":return o.content.push(r.content_block),o;case"content_block_delta":{const c=o.content.at(r.index);switch(r.delta.type){case"text_delta":{(c==null?void 0:c.type)==="text"&&(c.text+=r.delta.text);break}case"citations_delta":{(c==null?void 0:c.type)==="text"&&(c.citations??(c.citations=[]),c.citations.push(r.delta.citation));break}case"input_json_delta":{if((c==null?void 0:c.type)==="tool_use"){let h=c[Ro]||"";h+=r.delta.partial_json,Object.defineProperty(c,Ro,{value:h,enumerable:!1,writable:!0}),h&&(c.input=ti(h))}break}case"thinking_delta":{(c==null?void 0:c.type)==="thinking"&&(c.thinking+=r.delta.thinking);break}case"signature_delta":{(c==null?void 0:c.type)==="thinking"&&(c.signature=r.delta.signature);break}default:r.delta}return o}case"content_block_stop":return o}},Symbol.asyncIterator)](){const n=[],r=[];let o=!1;return this.on("streamEvent",c=>{const h=r.shift();h?h.resolve(c):n.push(c)}),this.on("end",()=>{o=!0;for(const c of r)c.resolve(void 0);r.length=0}),this.on("abort",c=>{o=!0;for(const h of r)h.reject(c);r.length=0}),this.on("error",c=>{o=!0;for(const h of r)h.reject(c);r.length=0}),{next:async()=>n.length?{value:n.shift(),done:!1}:o?{value:void 0,done:!0}:new Promise((h,S)=>r.push({resolve:h,reject:S})).then(h=>h?{value:h,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Qe(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}class kr extends bt{constructor(){super(...arguments),this.batches=new Rs(this._client)}create(n,r){return n.model in Co&&console.warn(`The model '${n.model}' is deprecated and will reach end-of-life on ${Co[n.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:n,timeout:this._client._options.timeout??(n.stream?6e5:this._client._calculateNonstreamingTimeout(n.max_tokens)),...r,stream:n.stream??!1})}stream(n,r){return gr.createMessage(this,n,r)}countTokens(n,r){return this._client.post("/v1/messages/count_tokens",{body:n,...r})}}const Co={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};kr.Batches=Rs;kr.MessageBatchesPage=Cs;class Ds extends bt{retrieve(n,r){return this._client.get(`/v1/models/${n}`,r)}list(n={},r){return yt(n)?this.list({},n):this._client.getAPIList("/v1/models",Ks,{query:n,...r})}}class Ks extends _r{}Ds.ModelInfosPage=Ks;var ri;class se extends ca{constructor({baseURL:n=fs("ANTHROPIC_BASE_URL"),apiKey:r=fs("ANTHROPIC_API_KEY")??null,authToken:o=fs("ANTHROPIC_AUTH_TOKEN")??null,...c}={}){const h={apiKey:r,authToken:o,...c,baseURL:n||"https://api.anthropic.com"};if(!h.dangerouslyAllowBrowser&&_a())throw new Z(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:h.baseURL,timeout:h.timeout??6e5,httpAgent:h.httpAgent,maxRetries:h.maxRetries,fetch:h.fetch}),this.completions=new ni(this),this.messages=new kr(this),this.models=new Ds(this),this.beta=new wn(this),this._options=h,this.apiKey=r,this.authToken=o}defaultQuery(){return this._options.defaultQuery}defaultHeaders(n){return{...super.defaultHeaders(n),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(n,r){if(!(this.apiKey&&n["x-api-key"])&&r["x-api-key"]!==null&&!(this.authToken&&n.authorization)&&r.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(n){const r=this.apiKeyAuth(n),o=this.bearerAuth(n);return r!=null&&!pr(r)?r:o!=null&&!pr(o)?o:{}}apiKeyAuth(n){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(n){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}}ri=se;se.Anthropic=ri;se.HUMAN_PROMPT=`

Human:`;se.AI_PROMPT=`

Assistant:`;se.DEFAULT_TIMEOUT=6e5;se.AnthropicError=Z;se.APIError=Re;se.APIConnectionError=br;se.APIConnectionTimeoutError=Uo;se.APIUserAbortError=Ge;se.NotFoundError=Go;se.ConflictError=Vo;se.RateLimitError=zo;se.BadRequestError=Lo;se.AuthenticationError=Wo;se.InternalServerError=Xo;se.PermissionDeniedError=Ho;se.UnprocessableEntityError=Jo;se.toFile=na;se.fileFromPath=Fo;se.Completions=ni;se.Messages=kr;se.Models=Ds;se.ModelInfosPage=Ks;se.Beta=wn;const{HUMAN_PROMPT:vu,AI_PROMPT:wu}=se,Ea=[{id:"claude-3-7-sonnet-20250219",name:"Claude 3.7 Sonnet",provider:"anthropic",description:"Latest and most capable model",isLocal:!1,maxTokens:2e5,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!0},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",provider:"anthropic",description:"Fastest model for quick responses",isLocal:!1,maxTokens:1e5,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!1}];function Pa(a){return a.split(",")[1]}function Oa(a){const n=a.match(/^data:([^;]+);base64,/);return n?n[1]:"application/octet-stream"}function Ia(a){const n=a.filter(h=>h.role==="system"),r=n.length>0?n.map(h=>h.content).join(`

`):void 0;return{messages:a.filter(h=>h.role==="user"||h.role==="assistant").map(h=>{if(!h.media||h.media.length===0)return{role:h.role,content:h.content};const S=[];return h.content.trim()&&S.push({type:"text",text:h.content}),h.media.forEach(P=>{P.type==="image"&&P.preview&&S.push({type:"image",source:{type:"base64",media_type:Oa(P.preview),data:Pa(P.preview)}})}),{role:h.role,content:S}}),systemPrompt:r}}function Ma(){const n=yr(Ht).apiKeys.anthropic;if(!n)throw new Error("Anthropic API key not found. Please add your API key in Settings.");return n}async function _u(a,n,r,o,c,h){var S,P,D,B;try{const L=Ma(),{messages:$,systemPrompt:W}=Ia(n);console.log("Sending request to Anthropic API with model:",a);try{console.log("Attempting to use Anthropic SDK..."),await Ta(L,a,$,W,r,o,c,h);return}catch(ee){console.error("Error using Anthropic SDK, falling back to fetch:",ee)}const V=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"content-type":"application/json","x-api-key":L,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:a,messages:$,system:W,dangerouslyAllowBrowser:"true",stream:!0,temperature:.7,max_tokens:4e3})});if(!V.ok){let ee=`Status code: ${V.status}`;try{ee=((S=(await V.json()).error)==null?void 0:S.message)||ee}catch{ee=V.statusText||ee}throw new Error(`Anthropic API error: ${ee}`)}const oe=(P=V.body)==null?void 0:P.getReader();if(!oe)throw new Error("Failed to get response reader");const ge=new TextDecoder("utf-8");let ye="",he="";for(;;){const{done:ee,value:de}=await oe.read();if(ee)break;ye+=ge.decode(de,{stream:!0});const ce=ye.split(`
`);ye=ce.pop()||"";for(const je of ce){const be=je.trim();if(!(!be||be==="data: [DONE]"))try{const ie=be.replace(/^data: /,"");if(ie==="")continue;const Ae=JSON.parse(ie);if(Ae.type==="thinking"&&h&&((D=Ae.delta)!=null&&D.text)){h(Ae.delta.text);continue}if(Ae.type==="content_block_delta"&&((B=Ae.delta)!=null&&B.text)&&(he+=Ae.delta.text,r(he)),Ae.type==="message_stop")return o(),he}catch(ie){console.warn("Error parsing chunk:",ie)}}}return o(),he}catch(L){throw c(L instanceof Error?L:new Error(String(L))),L}}async function Ta(a,n,r,o,c,h,S,P){try{const D=new se({apiKey:a,dangerouslyAllowBrowser:!0}),B=r.map(W=>({role:W.role,content:typeof W.content=="string"?W.content:W.content.filter(V=>V.type==="text").map(V=>V.text||"").join(`
`)}));console.log("Using Anthropic SDK with model:",n);const L=await D.messages.create({model:n,max_tokens:1024,messages:[{role:"user",content:"Hello, Claude"}],system:o,stream:!0});let $="";for await(const W of L)if(W.type==="content_block_delta"&&"text"in W.delta&&($+=W.delta.text,c($)),W.type==="message_stop")return h(),$;return h(),$}catch(D){throw console.error("Error using Anthropic SDK:",D),D}}const Ra=[{id:"gpt-4o",name:"GPT-4o",provider:"openai",description:"Most capable model for a wide range of tasks",isLocal:!1,maxTokens:8192,supportsStreaming:!0,supportsFiles:!0},{id:"gpt-4-turbo",name:"GPT-4 Turbo",provider:"openai",description:"Improved version of GPT-4",isLocal:!1,maxTokens:4096,supportsStreaming:!0,supportsFiles:!0},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",provider:"openai",description:"Fast and efficient for most tasks",isLocal:!1,maxTokens:4096,supportsStreaming:!0,supportsFiles:!0}];function si(a){return a.map(n=>{if(!n.media||n.media.length===0)return{role:n.role,content:n.content};const r=[];return n.content.trim()&&r.push({type:"text",text:n.content}),n.media.forEach(o=>{if(console.log(`Processing media item for OpenAI: ${o.type} ${o.name}`),o.type==="image"&&o.preview)r.push({type:"image_url",image_url:{url:o.preview,detail:"auto"}}),console.log(`Added image to OpenAI message: ${o.name}`);else if(o.type==="document")if(o.fileId)r.push({type:"text",text:`I've analyzed the document: ${o.name}. The file has been processed.`}),console.log(`Referenced uploaded document in message: ${o.name} (file ID: ${o.fileId})`);else if(o.preview)try{const c=o.preview.match(/^data:([^;]+);base64,/),h=c?c[1]:"application/octet-stream";console.log(`Processing document: ${o.name}, MIME type: ${h}`),h.startsWith("image/")?(r.push({type:"image_url",image_url:{url:o.preview,detail:"high"}}),console.log(`Added document with image MIME type to OpenAI message: ${o.name}`)):(console.warn(`Document type ${h} not supported via chat API: ${o.name}`),r.push({type:"text",text:`[Note: I attempted to analyze your document "${o.name}" but couldn't process it directly in the chat. For better document support, please try uploading it again.]`}))}catch(c){console.error(`Error processing document ${o.name}:`,c),r.push({type:"text",text:`[Error: Could not process document "${o.name}" due to technical error]`})}else console.log(`Document ${o.name} has no preview or fileId, cannot send to OpenAI`);else console.log(`Unsupported media type: ${o.type} for ${o.name}`)}),r.length===0?{role:n.role,content:n.content||"I've attached some files, but they couldn't be processed."}:{role:n.role,content:r}})}function Ca(){try{const a=yr(Ht);if(console.log("Retrieving OpenAI API key from settings store"),!a||!a.apiKeys)throw console.error("Settings or apiKeys object is undefined:",a),new Error("OpenAI API key not found. Settings store may not be initialized properly.");const n=a.apiKeys.openai;if(!n)throw console.error("OpenAI API key is empty or undefined"),new Error("OpenAI API key not found. Please add your API key in Settings.");if(console.log("FULL API KEY FROM SETTINGS: ",n),!n.startsWith("sk-")||n.length<20)throw console.error("Invalid OpenAI API key format"),new Error('Invalid OpenAI API key format. Keys should start with "sk-" and be at least 20 characters long.');return console.log(`Retrieved OpenAI API key (length: ${n.length}, starts with: ${n.substring(0,4)}...)`),n}catch(a){throw console.error("Error retrieving OpenAI API key:",a),a}}async function js(a=3,n=500){let r=0;for(;r<a;)try{return Ca()}catch(o){if(console.warn(`Failed to get API key (attempt ${r+1}/${a}):`,o),r===a-1)throw o;await new Promise(c=>setTimeout(c,n)),r++}throw new Error("Failed to retrieve API key after multiple attempts")}async function xu(a,n,r,o,c){var h,S,P,D;try{const B=await js();console.log("SECURITY WARNING: Printing full API key for debugging: ",B),console.log("EXACT KEY SENT TO OPENAI: ",B),console.log(`Key format check: length=${B.length}, starts with=${B.substring(0,4)}, contains "sk-"=${B.includes("sk-")}`);const L=[...B.substring(0,10)].map(ee=>ee.charCodeAt(0));console.log(`First 10 character codes: ${L.join(", ")}`);const $=`Bearer ${B.trim()}`;console.log(`Authorization header format: Bearer ${B.trim()}`);const W=si(n),V=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:$},body:JSON.stringify({model:a,messages:W,stream:!0,temperature:.7})});if(!V.ok){const ee=await V.text();let de=`OpenAI API error (${V.status}): ${V.statusText}`;try{const ce=JSON.parse(ee);ce.error&&(V.status===401?de="Authentication error with OpenAI. Please check your API key in Settings.":ce.error.message&&(de=`OpenAI API error: ${ce.error.message}`))}catch{V.status===401?de="Authentication error with OpenAI. Please check your API key in Settings.":ee&&(de=`OpenAI API error: ${ee}`)}throw new Error(de)}const oe=(h=V.body)==null?void 0:h.getReader();if(!oe)throw new Error("Failed to get response reader");const ge=new TextDecoder("utf-8");let ye="",he="";for(;;){const{done:ee,value:de}=await oe.read();if(ee)break;ye+=ge.decode(de,{stream:!0});const ce=ye.split(`
`);ye=ce.pop()||"";for(const je of ce){const be=je.trim();if(!(!be||be==="data: [DONE]"))try{const ie=be.replace(/^data: /,""),Ae=JSON.parse(ie),vt=(P=(S=Ae.choices[0])==null?void 0:S.delta)==null?void 0:P.content;if(vt&&(he+=vt,r(he)),(D=Ae.choices[0])!=null&&D.finish_reason)return o(),he}catch(ie){console.warn("Error parsing chunk:",ie)}}}return o(),he}catch(B){throw console.error("OpenAI stream completion error:",B),c(B instanceof Error?B:new Error(String(B))),B}}async function Su(a,n){var r,o;try{const c=await js();console.log(`Processing ${n.length} messages for OpenAI non-streaming completion`),n.some($=>$.media&&$.media.length>0)&&console.log("Messages contain media - ensuring proper conversion");const S=`Bearer ${c.trim()}`,P=si(n),D=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:S},body:JSON.stringify({model:a,messages:P,stream:!1,temperature:.7})});if(!D.ok){const $=await D.text();let W=`OpenAI API error (${D.status}): ${D.statusText}`;try{const V=JSON.parse($);V.error&&(D.status===401?W="Authentication error with OpenAI. Please check your API key in Settings.":V.error.message&&(W=`OpenAI API error: ${V.error.message}`))}catch{D.status===401?W="Authentication error with OpenAI. Please check your API key in Settings.":$&&(W=`OpenAI API error: ${$}`)}throw new Error(W)}const L=(o=(r=(await D.json()).choices[0])==null?void 0:r.message)==null?void 0:o.content;return typeof L=="string"?L:Array.isArray(L)?L.filter($=>$.type==="text"&&$.text).map($=>$.text).join(`

`):""}catch(c){throw console.error("OpenAI completion error:",c),c}}async function ku(a){try{const n=await js(),r=new FormData;r.append("file",a),r.append("purpose","assistants"),console.log(`Uploading file to OpenAI: ${a.name}, type: ${a.type}, size: ${a.size} bytes`);const o=await fetch("https://api.openai.com/v1/files",{method:"POST",headers:{Authorization:`Bearer ${n.trim()}`},body:r});if(!o.ok){const h=await o.text();let S=`OpenAI API error (${o.status}): ${o.statusText}`;try{const P=JSON.parse(h);P.error&&P.error.message&&(S=`OpenAI API error: ${P.error.message}`)}catch{h&&(S=`OpenAI API error: ${h}`)}throw new Error(S)}const c=await o.json();return console.log(`File uploaded successfully to OpenAI: ${c.id}`),c.id}catch(n){throw console.error("Error uploading file to OpenAI:",n),n}}const ke=[];for(let a=0;a<256;++a)ke.push((a+256).toString(16).slice(1));function Da(a,n=0){return(ke[a[n+0]]+ke[a[n+1]]+ke[a[n+2]]+ke[a[n+3]]+"-"+ke[a[n+4]]+ke[a[n+5]]+"-"+ke[a[n+6]]+ke[a[n+7]]+"-"+ke[a[n+8]]+ke[a[n+9]]+"-"+ke[a[n+10]]+ke[a[n+11]]+ke[a[n+12]]+ke[a[n+13]]+ke[a[n+14]]+ke[a[n+15]]).toLowerCase()}let xs;const Ka=new Uint8Array(16);function ja(){if(!xs){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");xs=crypto.getRandomValues.bind(crypto)}return xs(Ka)}const Ba=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Do={randomUUID:Ba};function qa(a,n,r){var c;if(Do.randomUUID&&!a)return Do.randomUUID();a=a||{};const o=a.random??((c=a.rng)==null?void 0:c.call(a))??ja();if(o.length<16)throw new Error("Random bytes length must be >= 16");return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Da(o)}const Na={function_declarations:[{name:"google_search",description:"Performs a google search and returns the result. Use this whenever you need to search for current information or facts that you don't know or might be outdated.",parameters:{type:"OBJECT",properties:{query:{type:"STRING",description:"The search query."}},required:["query"]}}]},oi=[{id:"gemini-2.0-flash-exp",name:"Gemini 2.0 Flash",provider:"google",description:"Fast and efficient model with enhanced thinking capabilities",isLocal:!1,maxTokens:32768,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!0,supportsMultimodal:!0,supportsImageGeneration:!0}],Ko="AIzaSyDu7iMRbtRAycUVnpim9eXKq8PZIp-uHlU",$a="f7a30c9eb4cc04573";async function cr(a){var n;try{console.log("Performing Google search for:",a);const r=`https://www.googleapis.com/customsearch/v1?key=${Ko}&cx=${$a}&q=${encodeURIComponent(a)}`;console.log("Search API URL (without key):",r.replace(Ko,"API_KEY_HIDDEN"));const o=await fetch(r),c=await o.json();if(console.log("Search response status:",o.status),!o.ok)throw console.error("Google search API error:",c),new Error(`Google Search API error: ${((n=c.error)==null?void 0:n.message)||o.statusText}`);let h=`Search results for "${a}":

`;return c.items&&c.items.length>0?c.items.slice(0,5).forEach((S,P)=>{h+=`${P+1}. ${S.title}
`,h+=`   ${S.link}
`,h+=`   ${S.snippet||"No description available"}

`}):h+=`No results found for this query.

`,h}catch(r){return console.error("Error performing Google search:",r),`Error performing search: ${r.message}

Please check that your Google Custom Search Engine is correctly configured.`}}function Fa(a){return a.split(",")[1]}function Ua(a,n){return`data:${n};base64,${a}`}function La(a){const n=a.match(/^data:([^;]+);base64,/);return n?n[1]:"application/octet-stream"}function Wa(a){return a.map(n=>{const r=[];return n.content.trim()&&r.push({text:n.content}),n.media&&n.media.length>0&&n.media.forEach(o=>{o.type==="image"&&o.preview&&r.push({inlineData:{mimeType:La(o.preview),data:Fa(o.preview)}})}),r.length>0?{role:n.role==="assistant"?"model":"user",parts:r}:null}).filter(n=>n!==null)}function jo(a){if(!a.data||a.data.trim()==="")return console.warn("Empty or invalid base64 data received from Google Gemini API"),null;const n=a.mimeType.startsWith("image/")?"image":"document",r=Ua(a.data,a.mimeType);return{id:qa(),type:n,name:`${n}_${new Date().getTime()}`,preview:r,timestamp:Date.now(),size:a.data.length*.75}}function ii(){var r;let n=yr(Ht).apiKeys.google;if(!n&&typeof window<"u")try{const o=localStorage.getItem("gervais-api-backup");if(o){const c=JSON.parse(o);(r=c==null?void 0:c.apiKeys)!=null&&r.google&&(console.log("Retrieved Google API key from localStorage backup"),n=c.apiKeys.google,Ht.updateApiKeys({google:n}).catch(h=>console.error("Failed to update settings store with recovered key:",h)))}}catch(o){console.error("Error retrieving backup API key from localStorage:",o)}return n||(console.log("Using default fallback Google API key"),n="AIzaSyCRI2T6ONhGuUAwjdoCzR6jAJXIs_ZCTHI",Ht.updateApiKeys({google:n}).catch(o=>console.error("Failed to update settings store with default key:",o)),n)}function Ha(a){if(a!=null&&a.error){const n=a.error;let r=n.message||"Unknown Google API error";if(n.code&&(r=`[${n.code}] ${r}`),n.details&&n.details.length>0){const o=n.details.filter(c=>c["@type"]&&c["@type"].includes("BadRequest")).flatMap(c=>c.fieldViolations||[]).map(c=>`- ${c.field}: ${c.description}`).join(`
`);o&&(r+=`

Details:
`+o)}return r}return a instanceof Error?a.message:String(a)}async function Au(a,n,r,o,c,h,S=!1){var P,D,B,L,$,W,V,oe,ge,ye,he,ee,de,ce,je,be,ie,Ae,vt;try{const Ve=ii(),Ze=Wa(n);let Ce=a;S&&a==="gemini-2.0-flash-exp"&&(console.log("Switching to gemini-2.0-flash for search capability"),Ce="gemini-2.0-flash"),console.log("Using model:",Ce),console.log("Sending request to Google Gemini API with model:",Ce),console.log("Messages after conversion:",JSON.stringify(Ze,null,2)),console.log("Web search enabled:",S);const He=Ce==="gemini-2.0-flash-exp";console.log("Image generation requested:",He);const it={contents:Ze,generationConfig:{temperature:.7,maxOutputTokens:2048},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}]};He&&(it.generationConfig.responseModalities=["TEXT","IMAGE"]),S&&(console.log("Adding Google search tool to request"),it.tools=[Na]),console.log("Request configuration:",JSON.stringify({responseModalities:it.generationConfig.responseModalities,temperature:it.generationConfig.temperature,maxOutputTokens:it.generationConfig.maxOutputTokens},null,2));const Rt=`https://generativelanguage.googleapis.com/v1beta/models/${Ce}:streamGenerateContent?key=${Ve}`;console.log("API URL (without key):",Rt.replace(Ve,"API_KEY_HIDDEN"));const et=await fetch(Rt,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(it)});if(!et.ok){let Ct;try{Ct=await et.json()}catch{throw new Error(`Google API error: ${et.statusText||et.status}`)}const Be=Ha(Ct);throw He&&Be.includes("responseModalities")?new Error(`Failed to generate image: The model doesn't support the requested image generation features.

API Error: ${Be}`):Be.includes("rate limit")?new Error(`Rate limit exceeded: Please try again later or reduce the frequency of requests.

API Error: ${Be}`):new Error(`Google API error: ${Be}`)}const _n=(P=et.body)==null?void 0:P.getReader();if(!_n)throw new Error("Failed to get response reader");const tt=new TextDecoder("utf-8");let De="",ne="",Ee=[];for(console.log("Starting to read the stream...");;){const{done:Ct,value:Be}=await _n.read();if(Ct){console.log("Stream reading complete");break}const wt=tt.decode(Be,{stream:!0});console.log("Received chunk length:",wt.length),console.log("Raw chunk data:",wt),De+=wt;let at=!1,ve=null;try{ve=JSON.parse(De),at=!0,console.log("Successfully parsed complete JSON"),De=""}catch{if(console.log("Failed to parse complete buffer, looking for array content"),De.trim().startsWith("[")){console.log("Buffer starts with array indicator [");try{const ae=De.lastIndexOf("]");if(ae>0){const q=De.substring(0,ae+1);try{ve=JSON.parse(q),at=!0,console.log("Successfully parsed array portion"),De=De.substring(ae+1)}catch{console.log("Failed to parse array portion")}}}catch(ae){console.log("Error handling array:",ae)}}}if(at&&ve)if(console.log("Processing valid JSON data"),Array.isArray(ve))for(const we of ve){if(we.error){const ae=`Google API error: ${we.error.message||"Unknown error"}`;return console.error(ae),c(new Error(ae)),""}if((L=(B=(D=we.candidates)==null?void 0:D[0])==null?void 0:B.content)!=null&&L.parts){const ae=we.candidates[0].content.parts;let q="";const _e=[];for(const re of ae){if(re.text)q+=re.text;else if(re.inlineData){console.log(`Received inlineData with mimeType: ${re.inlineData.mimeType}, data length: ${(($=re.inlineData.data)==null?void 0:$.length)||0}`);const U=jo(re.inlineData);U?(_e.push(U),Ee.push(U)):(console.warn("Failed to create media item from inlineData"),q+=`

**Note**: Attempted to generate an image, but received invalid data. This might be due to content restrictions or a technical issue.`)}if(re.functionCall&&(console.log("Found functionCall in parts array (JSON object):",re.functionCall),re.functionCall.name==="google_search")){const U=re.functionCall.args.query;console.log("Google search requested with query (from parts):",U),q+=`

[ð Searching for: ${U}]

`,r(ne+q,Ee);try{const le=await cr(U);console.log("Search results received:",le.substring(0,100)+"...");const qe=await lr(Ce,[...Ze,{role:"model",parts:[{text:q}]}],le,r,c,ne,Ee);qe&&(ne=qe);continue}catch(le){console.error("Error performing search:",le),q+=`

Error performing search: ${le.message}

`}}}if((oe=(V=(W=we.candidates)==null?void 0:W[0])==null?void 0:V.content)!=null&&oe.functionCalls){console.log("Found functionCalls array in content:",we.candidates[0].content.functionCalls);const re=we.candidates[0].content.functionCalls;for(const U of re)if(U.name==="google_search"){const le=U.args.query;console.log("Google search requested with query (from functionCalls):",le),q+=`

[ð Searching for: ${le}]

`,r(ne+q,Ee);try{const qe=await cr(le);console.log("Search results received:",qe.substring(0,100)+"...");const Je=await lr(Ce,[...Ze,{role:"model",parts:[{text:q}]}],qe,r,c,ne,Ee);Je&&(ne=Je);continue}catch(qe){console.error("Error performing search:",qe),q+=`

Error performing search: ${qe.message}

`}}}q&&(ne+=q),r(ne,Ee)}if(((ye=(ge=we.candidates)==null?void 0:ge[0])==null?void 0:ye.finishReason)==="STOP")return console.log("Received completion signal (STOP) in array"),o(),ne}else{if(ve.error){const we=`Google API error: ${ve.error.message||"Unknown error"}`;return console.error(we),c(new Error(we)),""}if((de=(ee=(he=ve.candidates)==null?void 0:he[0])==null?void 0:ee.content)!=null&&de.parts){const we=ve.candidates[0].content.parts;let ae="";const q=[];for(const _e of we){if(_e.text)ae+=_e.text;else if(_e.inlineData){console.log(`Received inlineData with mimeType: ${_e.inlineData.mimeType}, data length: ${((ce=_e.inlineData.data)==null?void 0:ce.length)||0}`);const re=jo(_e.inlineData);re?(q.push(re),Ee.push(re)):(console.warn("Failed to create media item from inlineData"),ae+=`

**Note**: Attempted to generate an image, but received invalid data. This might be due to content restrictions or a technical issue.`)}if(_e.functionCall&&(console.log("Found functionCall in parts array (JSON object):",_e.functionCall),_e.functionCall.name==="google_search")){const re=_e.functionCall.args.query;console.log("Google search requested with query (from parts):",re),ae+=`

[ð Searching for: ${re}]

`,r(ne+ae,Ee);try{const U=await cr(re);console.log("Search results received:",U.substring(0,100)+"...");const le=await lr(Ce,[...Ze,{role:"model",parts:[{text:ae}]}],U,r,c,ne,Ee);le&&(ne=le);continue}catch(U){console.error("Error performing search:",U),ae+=`

Error performing search: ${U.message}

`}}}if((ie=(be=(je=ve.candidates)==null?void 0:je[0])==null?void 0:be.content)!=null&&ie.functionCalls){console.log("Found functionCalls array in content:",ve.candidates[0].content.functionCalls);const _e=ve.candidates[0].content.functionCalls;for(const re of _e)if(re.name==="google_search"){const U=re.args.query;console.log("Google search requested with query (from functionCalls):",U),ae+=`

[ð Searching for: ${U}]

`,r(ne+ae,Ee);try{const le=await cr(U);console.log("Search results received:",le.substring(0,100)+"...");const qe=await lr(Ce,[...Ze,{role:"model",parts:[{text:ae}]}],le,r,c,ne,Ee);qe&&(ne=qe);continue}catch(le){console.error("Error performing search:",le),ae+=`

Error performing search: ${le.message}

`}}}ae&&(ne+=ae),r(ne,Ee)}if(((vt=(Ae=ve.candidates)==null?void 0:Ae[0])==null?void 0:vt.finishReason)==="STOP")return console.log("Received completion signal (STOP) in single object"),o(),ne}}return o(),ne}catch(Ve){throw c(Ve instanceof Error?Ve:new Error(String(Ve))),Ve}}async function lr(a,n,r,o,c,h,S=[]){var P,D;try{const B=r.split('"')[1]||"unknown query";console.log("Handling search results for query:",B),console.log("Search results (first 100 chars):",r.substring(0,100)),console.log("Current text before update (last 100 chars):",h.substring(Math.max(0,h.length-100)));const L=`

[ð Searching for: ${B}]

`;h.includes(L)||(console.log("Warning: Could not find the search indicator text in the current text."),console.log("Expected to find:",L),console.log("Current text contains search indicator:",h.includes("[ð Searching for:")));let $;if(h.includes(L))$=h.replace(L,`

[ð Search results for "${B}"]

${r}

[Analyzing search results...]

`);else{const ce=new RegExp("\\n\\n\\[ð Searching for: [^\\]]+\\]\\n\\n"),je=h.match(ce);je&&je.length>0?(console.log("Found alternative search indicator:",je[0]),$=h.replace(je[0],`

[ð Search results for "${B}"]

${r}

[Analyzing search results...]

`)):(console.log("No search indicator found, appending search results at the end"),$=h+`

[ð Search results for "${B}"]

${r}

[Analyzing search results...]

`)}console.log("Updated text with search results (last 100 chars):",$.substring(Math.max(0,$.length-100))),o($,S);const W=[...n,{role:"user",parts:[{text:`Search results:

${r}

Please incorporate this information into your response.`}]}],V=ii(),oe={contents:W,generationConfig:{temperature:.7,maxOutputTokens:2048},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}]},ge=`https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent?key=${V}`,ye=await fetch(ge,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(oe)});if(!ye.ok)throw new Error(`Failed to get search-informed response: ${ye.statusText}`);const he=await ye.json();let ee="";for(const ce of((D=(P=he.candidates[0])==null?void 0:P.content)==null?void 0:D.parts)||[])ce.text&&(ee+=ce.text);console.log("Got model response (first 100 chars):",ee.substring(0,100));const de=$.replace(`[Analyzing search results...]

`,`**Response based on search results:**

${ee}

`);return console.log("Final text with model response (last 100 chars):",de.substring(Math.max(0,de.length-100))),o(de,S),de}catch(B){return console.error("Error handling search results:",B),c(B instanceof Error?B:new Error(String(B))),h+`

Error incorporating search results: ${B.message}

`}}function ai(){const n=yr(Ht).apiKeys.ollamaHost||"http://localhost:11434";return n.endsWith("/")?n.slice(0,-1):n}async function Ga(){try{const a=ai(),n=await fetch(`${a}/api/tags`);if(!n.ok)throw new Error(`Failed to fetch Ollama models: ${n.statusText}`);return(await n.json()).models.map(o=>({id:o.name,name:Va(o.name),provider:"ollama",description:Ja(o),isLocal:!0,maxTokens:4096,supportsStreaming:!0,supportsFiles:!1}))}catch(a){return console.error("Error fetching Ollama models:",a),[]}}function Va(a){let n=a.split(":")[0];return n=n.split("-").map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join(" "),n}function Ja(a){const n=a.details;return n&&n.parameter_size?`${n.family||"Open source"} model (${n.parameter_size})`:"Local LLM model"}function za(a){let n="";for(const r of a)r.role==="system"?n+=`SYSTEM: ${r.content}

`:r.role==="user"?n+=`USER: ${r.content}

`:r.role==="assistant"&&(n+=`ASSISTANT: ${r.content}

`);return n+="ASSISTANT: ",n}async function Eu(a,n,r,o,c){var h;try{const S=ai(),P=za(n),D=await fetch(`${S}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:a,prompt:P,stream:!0,options:{temperature:.7}})});if(!D.ok){const W=await D.text();throw new Error(`Ollama API error: ${W||D.statusText}`)}const B=(h=D.body)==null?void 0:h.getReader();if(!B)throw new Error("Failed to get response reader");const L=new TextDecoder("utf-8");let $="";for(;;){const{done:W,value:V}=await B.read();if(W)break;const ge=L.decode(V,{stream:!0}).split(`
`);for(const ye of ge)if(ye.trim())try{const he=JSON.parse(ye);if(he.response&&($+=he.response,r($)),he.done)return o(),$}catch(he){console.warn("Error parsing Ollama chunk:",he)}}return o(),$}catch(S){throw c(S instanceof Error?S:new Error(String(S))),S}}const Bs=[...Ea,...Ra,...oi],ui=Bo([]),Pu=qi(ui,a=>[...Bs,...a]);let Xa=[],Ya=[...Bs];const Qa=oi[0];async function Ou(){try{const a=await Ga();return Xa=a,ui.set(a),Ya=[...Bs,...a],a}catch(a){return console.error("Failed to initialize models:",a),[]}}class Za extends dr{constructor(){super("gervaisDB"),this.version(1).stores({chats:"id, title, updatedAt, createdAt",messages:"id, chatId, role, timestamp",mediaItems:"id, messageId, type, timestamp",settings:"id"}),this.chats.mapToClass(eu)}async initialize(){{try{const r=await this.settings.get("user-settings");if(r){console.log("Found existing settings in IndexedDB:",r);return}const o=localStorage.getItem("settings");if(o)try{const c=JSON.parse(o);await this.settings.put({...c,id:"user-settings"}),console.log("Settings migrated from localStorage to IndexedDB:",c)}catch(c){console.error("Failed to migrate settings:",c)}else{const c={id:"user-settings",apiKeys:{anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434",localHost:"http://localhost:8000"},theme:"system",videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1};await this.settings.put(c),console.log("Created default settings in IndexedDB:",c)}}catch(r){console.error("Error initializing settings:",r)}const n=localStorage.getItem("chats");if(n)try{const r=JSON.parse(n);await this.transaction("rw",this.chats,this.messages,this.mediaItems,async()=>{for(const o of r){const c=[...o.messages],h={...o};delete h.messages,await this.chats.put(h);for(const S of c){const P=S.media||[],D={...S,chatId:o.id};delete D.media,await this.messages.put(D);for(const B of P)await this.mediaItems.put({...B,messageId:S.id})}}console.log("Chats migrated from localStorage to IndexedDB")})}catch(r){console.error("Failed to migrate chats:",r)}}}async getAllChats(){return(await this.chats.orderBy("updatedAt").reverse().toArray()).map(r=>({...r,messages:[]}))}async getChat(n){const r=await this.chats.get(n);if(!r)return null;const o=await this.messages.where("chatId").equals(n).sortBy("timestamp");for(const c of o){const h=await this.mediaItems.where("messageId").equals(c.id).toArray();h.length>0&&(c.media=h)}return{...r,messages:o}}async createChat(n=Qa){const r={id:crypto.randomUUID(),title:"New Chat",messages:[],createdAt:Date.now(),updatedAt:Date.now(),model:n},o={...r};return delete o.messages,await this.chats.put(o),r}async updateChat(n,r){const o={...r};"messages"in o&&delete o.messages,o.updatedAt=Date.now(),await this.chats.update(n,o)}async deleteChat(n){await this.transaction("rw",this.chats,this.messages,this.mediaItems,async()=>{const r=await this.messages.where("chatId").equals(n).toArray();for(const o of r)await this.mediaItems.where("messageId").equals(o.id).delete();await this.messages.where("chatId").equals(n).delete(),await this.chats.delete(n)})}async addMessage(n,r){const o=crypto.randomUUID(),c=Date.now(),h={...r,id:o,chatId:n,timestamp:c};return await this.transaction("rw",this.messages,this.mediaItems,this.chats,async()=>{const S=h.media||[],P={...h};delete P.media,await this.messages.put(P);for(const B of S){const L={...B,id:B.id||crypto.randomUUID(),messageId:o,timestamp:B.timestamp||Date.now()};await this.mediaItems.put(L)}const D=await this.chats.get(n);if(D&&D.title==="New Chat"&&r.role==="user"){const B=r.content.slice(0,30)+(r.content.length>30?"...":"");await this.chats.update(n,{title:B,updatedAt:Date.now()})}else await this.chats.update(n,{updatedAt:Date.now()})}),o}async updateMessage(n,r){try{const o=await this.messages.get(n);if(!o){console.error(`Cannot update message ${n} - not found in database`);return}await this.transaction("rw",this.messages,this.mediaItems,this.chats,async()=>{const c={...r};if("media"in c&&c.media!==void 0){const h=c.media||[];delete c.media,await this.mediaItems.where("messageId").equals(n).delete();for(const S of h){const P={...S,id:S.id||crypto.randomUUID(),messageId:n,timestamp:S.timestamp||Date.now()};await this.mediaItems.put(P)}}"chatId"in c&&delete c.chatId,Object.keys(c).forEach(h=>{c[h]===void 0&&delete c[h]}),Object.keys(c).length>0&&await this.messages.update(n,c),o.chatId&&await this.chats.update(o.chatId,{updatedAt:Date.now()})})}catch(o){throw console.error("Error updating message:",o),o}}async getSettings(){let n=await this.settings.get("user-settings");if(!n){const r={id:"user-settings",apiKeys:{},theme:"system",videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1};await this.settings.put(r),n=r}return n}async updateSettings(n){const r=await this.getSettings();await this.settings.update("user-settings",{...r,...n})}async updateApiKeys(n){const o={...(await this.getSettings()).apiKeys,...n};await this.settings.update("user-settings",{apiKeys:o})}}class eu{constructor(n){n&&Object.assign(this,n),this.messages=this.messages||[]}}const fr=new Za;export{fr as a,Ea as b,Pu as c,Qa as d,_u as e,xu as f,oi as g,Su as h,Ou as i,Au as j,Eu as k,ui as l,$i as m,Ra as o,Ht as s,ku as u,qa as v};
