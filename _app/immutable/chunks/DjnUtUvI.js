import{aC as Ts,F as lr,aB as Da}from"./BSv_i5Hy.js";var ja=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ba(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var sr={exports:{}},Ka=sr.exports,ds;function Ca(){return ds||(ds=1,function(o,n){(function(i,s){o.exports=s()})(Ka,function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,a){r.__proto__=a}||function(r,a){for(var u in a)Object.prototype.hasOwnProperty.call(a,u)&&(r[u]=a[u])})(e,t)},s=function(){return(s=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var u in t=arguments[r])Object.prototype.hasOwnProperty.call(t,u)&&(e[u]=t[u]);return e}).apply(this,arguments)};function c(e,t,r){for(var a,u=0,l=t.length;u<l;u++)!a&&u in t||((a=a||Array.prototype.slice.call(t,0,u))[u]=t[u]);return e.concat(a||Array.prototype.slice.call(t))}var d=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:ja,S=Object.keys,O=Array.isArray;function B(e,t){return typeof t!="object"||S(t).forEach(function(r){e[r]=t[r]}),e}typeof Promise>"u"||d.Promise||(d.Promise=Promise);var q=Object.getPrototypeOf,H={}.hasOwnProperty;function F(e,t){return H.call(e,t)}function L(e,t){typeof t=="function"&&(t=t(q(e))),(typeof Reflect>"u"?S:Reflect.ownKeys)(t).forEach(function(r){ae(e,r,t[r])})}var V=Object.defineProperty;function ae(e,t,r,a){V(e,t,B(r&&F(r,"get")&&typeof r.get=="function"?{get:r.get,set:r.set,configurable:!0}:{value:r,configurable:!0,writable:!0},a))}function me(e){return{from:function(t){return e.prototype=Object.create(t.prototype),ae(e.prototype,"constructor",e),{extend:L.bind(null,e.prototype)}}}}var Se=Object.getOwnPropertyDescriptor,ce=[].slice;function ee(e,t,r){return ce.call(e,t,r)}function ue(e,t){return t(e)}function he(e){if(!e)throw new Error("Assertion Failed")}function Je(e){d.setImmediate?setImmediate(e):setTimeout(e,0)}function de(e,t){if(typeof t=="string"&&F(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var r=[],a=0,u=t.length;a<u;++a){var l=de(e,t[a]);r.push(l)}return r}var f=t.indexOf(".");if(f!==-1){var h=e[t.substr(0,f)];return h==null?void 0:de(h,t.substr(f+1))}}function re(e,t,r){if(e&&t!==void 0&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){he(typeof r!="string"&&"length"in r);for(var a=0,u=t.length;a<u;++a)re(e,t[a],r[a])}else{var l,f,h=t.indexOf(".");h!==-1?(l=t.substr(0,h),(f=t.substr(h+1))===""?r===void 0?O(e)&&!isNaN(parseInt(l))?e.splice(l,1):delete e[l]:e[l]=r:re(h=!(h=e[l])||!F(e,l)?e[l]={}:h,f,r)):r===void 0?O(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=r}}function pe(e){var t,r={};for(t in e)F(e,t)&&(r[t]=e[t]);return r}var lt=[].concat;function pn(e){return lt.apply([],e)}var dt="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(pn([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return d[e]}),Fe=new Set(dt.map(function(e){return d[e]})),Te=null;function Be(e){return Te=new WeakMap,e=function t(r){if(!r||typeof r!="object")return r;var a=Te.get(r);if(a)return a;if(O(r)){a=[],Te.set(r,a);for(var u=0,l=r.length;u<l;++u)a.push(t(r[u]))}else if(Fe.has(r.constructor))a=r;else{var f,h=q(r);for(f in a=h===Object.prototype?{}:Object.create(h),Te.set(r,a),r)F(r,f)&&(a[f]=t(r[f]))}return a}(e),Te=null,e}var Ge={}.toString;function we(e){return Ge.call(e).slice(8,-1)}var ft=typeof Symbol<"u"?Symbol.iterator:"@@iterator",Nt=typeof ft=="symbol"?function(e){var t;return e!=null&&(t=e[ft])&&t.apply(e)}:function(){return null};function ye(e,t){return t=e.indexOf(t),0<=t&&e.splice(t,1),0<=t}var ge={};function ie(e){var t,r,a,u;if(arguments.length===1){if(O(e))return e.slice();if(this===ge&&typeof e=="string")return[e];if(u=Nt(e)){for(r=[];!(a=u.next()).done;)r.push(a.value);return r}if(e==null)return[e];if(typeof(t=e.length)!="number")return[e];for(r=new Array(t);t--;)r[t]=e[t];return r}for(t=arguments.length,r=new Array(t);t--;)r[t]=arguments[t];return r}var Ke=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},Ut=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Ce=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat(Ut),$e={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function _e(e,t){this.name=e,this.message=t}function kt(e,t){return e+". Errors: "+Object.keys(t).map(function(r){return t[r].toString()}).filter(function(r,a,u){return u.indexOf(r)===a}).join(`
`)}function mn(e,t,r,a){this.failures=t,this.failedKeys=a,this.successCount=r,this.message=kt(e,t)}function Pt(e,t){this.name="BulkError",this.failures=Object.keys(t).map(function(r){return t[r]}),this.failuresByPos=t,this.message=kt(e,this.failures)}me(_e).from(Error).extend({toString:function(){return this.name+": "+this.message}}),me(mn).from(_e),me(Pt).from(_e);var br=Ce.reduce(function(e,t){return e[t]=t+"Error",e},{}),na=_e,$=Ce.reduce(function(e,t){var r=t+"Error";function a(u,l){this.name=r,u?typeof u=="string"?(this.message="".concat(u).concat(l?`
 `+l:""),this.inner=l||null):typeof u=="object"&&(this.message="".concat(u.name," ").concat(u.message),this.inner=u):(this.message=$e[t]||r,this.inner=null)}return me(a).from(na),e[t]=a,e},{});$.Syntax=SyntaxError,$.Type=TypeError,$.Range=RangeError;var Di=Ut.reduce(function(e,t){return e[t+"Error"]=$[t],e},{}),yn=Ce.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=$[t]),e},{});function te(){}function Ft(e){return e}function ra(e,t){return e==null||e===Ft?t:function(r){return t(e(r))}}function ht(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function ia(e,t){return e===te?t:function(){var r=e.apply(this,arguments);r!==void 0&&(arguments[0]=r);var a=this.onsuccess,u=this.onerror;this.onsuccess=null,this.onerror=null;var l=t.apply(this,arguments);return a&&(this.onsuccess=this.onsuccess?ht(a,this.onsuccess):a),u&&(this.onerror=this.onerror?ht(u,this.onerror):u),l!==void 0?l:r}}function sa(e,t){return e===te?t:function(){e.apply(this,arguments);var r=this.onsuccess,a=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),r&&(this.onsuccess=this.onsuccess?ht(r,this.onsuccess):r),a&&(this.onerror=this.onerror?ht(a,this.onerror):a)}}function aa(e,t){return e===te?t:function(r){var a=e.apply(this,arguments);B(r,a);var u=this.onsuccess,l=this.onerror;return this.onsuccess=null,this.onerror=null,r=t.apply(this,arguments),u&&(this.onsuccess=this.onsuccess?ht(u,this.onsuccess):u),l&&(this.onerror=this.onerror?ht(l,this.onerror):l),a===void 0?r===void 0?void 0:r:B(a,r)}}function oa(e,t){return e===te?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function wr(e,t){return e===te?t:function(){var r=e.apply(this,arguments);if(r&&typeof r.then=="function"){for(var a=this,u=arguments.length,l=new Array(u);u--;)l[u]=arguments[u];return r.then(function(){return t.apply(a,l)})}return t.apply(this,arguments)}}yn.ModifyError=mn,yn.DexieError=_e,yn.BulkError=Pt;var Le=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function ji(e){Le=e}var $t={},Bi=100,dt=typeof Promise>"u"?[]:function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,q(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,q(t),e]}(),Ut=dt[0],Ce=dt[1],dt=dt[2],Ce=Ce&&Ce.then,pt=Ut&&Ut.constructor,_r=!!dt,Lt=function(e,t){Wt.push([e,t]),gn&&(queueMicrotask(ca),gn=!1)},xr=!0,gn=!0,mt=[],vn=[],Sr=Ft,Ze={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:te,pgp:!1,env:{},finalize:te},N=Ze,Wt=[],yt=0,bn=[];function K(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var t=this._PSD=N;if(typeof e!="function"){if(e!==$t)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&Pr(this,this._value))}this._state=null,this._value=null,++t.ref,function r(a,u){try{u(function(l){if(a._state===null){if(l===a)throw new TypeError("A promise cannot be resolved with itself.");var f=a._lib&&At();l&&typeof l.then=="function"?r(a,function(h,m){l instanceof K?l._then(h,m):l.then(h,m)}):(a._state=!0,a._value=l,Ci(a)),f&&Et()}},Pr.bind(null,a))}catch(l){Pr(a,l)}}(this,e)}var kr={get:function(){var e=N,t=Sn;function r(a,u){var l=this,f=!e.global&&(e!==N||t!==Sn),h=f&&!tt(),m=new K(function(g,w){Ar(l,new Ki(Ni(a,e,f,h),Ni(u,e,f,h),g,w,e))});return this._consoleTask&&(m._consoleTask=this._consoleTask),m}return r.prototype=$t,r},set:function(e){ae(this,"then",e&&e.prototype===$t?kr:{get:function(){return e},set:kr.set})}};function Ki(e,t,r,a,u){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=r,this.reject=a,this.psd=u}function Pr(e,t){var r,a;vn.push(t),e._state===null&&(r=e._lib&&At(),t=Sr(t),e._state=!1,e._value=t,a=e,mt.some(function(u){return u._value===a._value})||mt.push(a),Ci(e),r&&Et())}function Ci(e){var t=e._listeners;e._listeners=[];for(var r=0,a=t.length;r<a;++r)Ar(e,t[r]);var u=e._PSD;--u.ref||u.finalize(),yt===0&&(++yt,Lt(function(){--yt==0&&Er()},[]))}function Ar(e,t){if(e._state!==null){var r=e._state?t.onFulfilled:t.onRejected;if(r===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++yt,Lt(ua,[r,e,t])}else e._listeners.push(t)}function ua(e,t,r){try{var a,u=t._value;!t._state&&vn.length&&(vn=[]),a=Le&&t._consoleTask?t._consoleTask.run(function(){return e(u)}):e(u),t._state||vn.indexOf(u)!==-1||function(l){for(var f=mt.length;f;)if(mt[--f]._value===l._value)return mt.splice(f,1)}(t),r.resolve(a)}catch(l){r.reject(l)}finally{--yt==0&&Er(),--r.psd.ref||r.psd.finalize()}}function ca(){gt(Ze,function(){At()&&Et()})}function At(){var e=xr;return gn=xr=!1,e}function Et(){var e,t,r;do for(;0<Wt.length;)for(e=Wt,Wt=[],r=e.length,t=0;t<r;++t){var a=e[t];a[0].apply(null,a[1])}while(0<Wt.length);gn=xr=!0}function Er(){var e=mt;mt=[],e.forEach(function(a){a._PSD.onunhandled.call(null,a._value,a)});for(var t=bn.slice(0),r=t.length;r;)t[--r]()}function wn(e){return new K($t,!1,e)}function oe(e,t){var r=N;return function(){var a=At(),u=N;try{return nt(r,!0),e.apply(this,arguments)}catch(l){t&&t(l)}finally{nt(u,!1),a&&Et()}}}L(K.prototype,{then:kr,_then:function(e,t){Ar(this,new Ki(null,null,e,t,N))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=e,r=arguments[1];return typeof t=="function"?this.then(null,function(a){return(a instanceof t?r:wn)(a)}):this.then(null,function(a){return(a&&a.name===t?r:wn)(a)})},finally:function(e){return this.then(function(t){return K.resolve(e()).then(function(){return t})},function(t){return K.resolve(e()).then(function(){return wn(t)})})},timeout:function(e,t){var r=this;return e<1/0?new K(function(a,u){var l=setTimeout(function(){return u(new $.Timeout(t))},e);r.then(a,u).finally(clearTimeout.bind(null,l))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&ae(K.prototype,Symbol.toStringTag,"Dexie.Promise"),Ze.env=qi(),L(K,{all:function(){var e=ie.apply(null,arguments).map(kn);return new K(function(t,r){e.length===0&&t([]);var a=e.length;e.forEach(function(u,l){return K.resolve(u).then(function(f){e[l]=f,--a||t(e)},r)})})},resolve:function(e){return e instanceof K?e:e&&typeof e.then=="function"?new K(function(t,r){e.then(t,r)}):new K($t,!0,e)},reject:wn,race:function(){var e=ie.apply(null,arguments).map(kn);return new K(function(t,r){e.map(function(a){return K.resolve(a).then(t,r)})})},PSD:{get:function(){return N},set:function(e){return N=e}},totalEchoes:{get:function(){return Sn}},newPSD:et,usePSD:gt,scheduler:{get:function(){return Lt},set:function(e){Lt=e}},rejectionMapper:{get:function(){return Sr},set:function(e){Sr=e}},follow:function(e,t){return new K(function(r,a){return et(function(u,l){var f=N;f.unhandleds=[],f.onunhandled=l,f.finalize=ht(function(){var h,m=this;h=function(){m.unhandleds.length===0?u():l(m.unhandleds[0])},bn.push(function g(){h(),bn.splice(bn.indexOf(g),1)}),++yt,Lt(function(){--yt==0&&Er()},[])},f.finalize),e()},t,r,a)})}}),pt&&(pt.allSettled&&ae(K,"allSettled",function(){var e=ie.apply(null,arguments).map(kn);return new K(function(t){e.length===0&&t([]);var r=e.length,a=new Array(r);e.forEach(function(u,l){return K.resolve(u).then(function(f){return a[l]={status:"fulfilled",value:f}},function(f){return a[l]={status:"rejected",reason:f}}).then(function(){return--r||t(a)})})})}),pt.any&&typeof AggregateError<"u"&&ae(K,"any",function(){var e=ie.apply(null,arguments).map(kn);return new K(function(t,r){e.length===0&&r(new AggregateError([]));var a=e.length,u=new Array(a);e.forEach(function(l,f){return K.resolve(l).then(function(h){return t(h)},function(h){u[f]=h,--a||r(new AggregateError(u))})})})}),pt.withResolvers&&(K.withResolvers=pt.withResolvers));var ve={awaits:0,echoes:0,id:0},la=0,_n=[],xn=0,Sn=0,fa=0;function et(e,t,r,a){var u=N,l=Object.create(u);return l.parent=u,l.ref=0,l.global=!1,l.id=++fa,Ze.env,l.env=_r?{Promise:K,PromiseProp:{value:K,configurable:!0,writable:!0},all:K.all,race:K.race,allSettled:K.allSettled,any:K.any,resolve:K.resolve,reject:K.reject}:{},t&&B(l,t),++u.ref,l.finalize=function(){--this.parent.ref||this.parent.finalize()},a=gt(l,e,r,a),l.ref===0&&l.finalize(),a}function Ot(){return ve.id||(ve.id=++la),++ve.awaits,ve.echoes+=Bi,ve.id}function tt(){return!!ve.awaits&&(--ve.awaits==0&&(ve.id=0),ve.echoes=ve.awaits*Bi,!0)}function kn(e){return ve.echoes&&e&&e.constructor===pt?(Ot(),e.then(function(t){return tt(),t},function(t){return tt(),le(t)})):e}function ha(){var e=_n[_n.length-1];_n.pop(),nt(e,!1)}function nt(e,t){var r,a=N;(t?!ve.echoes||xn++&&e===N:!xn||--xn&&e===N)||queueMicrotask(t?(function(u){++Sn,ve.echoes&&--ve.echoes!=0||(ve.echoes=ve.awaits=ve.id=0),_n.push(N),nt(u,!0)}).bind(null,e):ha),e!==N&&(N=e,a===Ze&&(Ze.env=qi()),_r&&(r=Ze.env.Promise,t=e.env,(a.global||e.global)&&(Object.defineProperty(d,"Promise",t.PromiseProp),r.all=t.all,r.race=t.race,r.resolve=t.resolve,r.reject=t.reject,t.allSettled&&(r.allSettled=t.allSettled),t.any&&(r.any=t.any))))}function qi(){var e=d.Promise;return _r?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(d,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject}:{}}function gt(e,t,r,a,u){var l=N;try{return nt(e,!0),t(r,a,u)}finally{nt(l,!1)}}function Ni(e,t,r,a){return typeof e!="function"?e:function(){var u=N;r&&Ot(),nt(t,!0);try{return e.apply(this,arguments)}finally{nt(u,!1),a&&queueMicrotask(tt)}}}function Or(e){Promise===pt&&ve.echoes===0?xn===0?e():enqueueNativeMicroTask(e):setTimeout(e,0)}(""+Ce).indexOf("[native code]")===-1&&(Ot=tt=te);var le=K.reject,vt="ï¿¿",ze="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Fi="String expected.",Mt=[],Pn="__dbnames",Mr="readonly",Ir="readwrite";function bt(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var $i={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function An(e){return typeof e!="string"||/\./.test(e)?function(t){return t}:function(t){return t[e]===void 0&&e in t&&delete(t=Be(t))[e],t}}function Ui(){throw $.Type()}function Y(e,t){try{var r=Li(e),a=Li(t);if(r!==a)return r==="Array"?1:a==="Array"?-1:r==="binary"?1:a==="binary"?-1:r==="string"?1:a==="string"?-1:r==="Date"?1:a!=="Date"?NaN:-1;switch(r){case"number":case"Date":case"string":return t<e?1:e<t?-1:0;case"binary":return function(u,l){for(var f=u.length,h=l.length,m=f<h?f:h,g=0;g<m;++g)if(u[g]!==l[g])return u[g]<l[g]?-1:1;return f===h?0:f<h?-1:1}(Wi(e),Wi(t));case"Array":return function(u,l){for(var f=u.length,h=l.length,m=f<h?f:h,g=0;g<m;++g){var w=Y(u[g],l[g]);if(w!==0)return w}return f===h?0:f<h?-1:1}(e,t)}}catch{}return NaN}function Li(e){var t=typeof e;return t!="object"?t:ArrayBuffer.isView(e)?"binary":(e=we(e),e==="ArrayBuffer"?"binary":e)}function Wi(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var Hi=(se.prototype._trans=function(e,t,r){var a=this._tx||N.trans,u=this.name,l=Le&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(e==="readonly"?"read":"write"," ").concat(this.name));function f(g,w,p){if(!p.schema[u])throw new $.NotFound("Table "+u+" not part of transaction");return t(p.idbtrans,p)}var h=At();try{var m=a&&a.db._novip===this.db._novip?a===N.trans?a._promise(e,f,r):et(function(){return a._promise(e,f,r)},{trans:a,transless:N.transless||N}):function g(w,p,x,y){if(w.idbdb&&(w._state.openComplete||N.letThrough||w._vip)){var b=w._createTransaction(p,x,w._dbSchema);try{b.create(),w._state.PR1398_maxLoop=3}catch(_){return _.name===br.InvalidState&&w.isOpen()&&0<--w._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),w.close({disableAutoOpen:!1}),w.open().then(function(){return g(w,p,x,y)})):le(_)}return b._promise(p,function(_,v){return et(function(){return N.trans=b,y(_,v,b)})}).then(function(_){if(p==="readwrite")try{b.idbtrans.commit()}catch{}return p==="readonly"?_:b._completion.then(function(){return _})})}if(w._state.openComplete)return le(new $.DatabaseClosed(w._state.dbOpenError));if(!w._state.isBeingOpened){if(!w._state.autoOpen)return le(new $.DatabaseClosed);w.open().catch(te)}return w._state.dbReadyPromise.then(function(){return g(w,p,x,y)})}(this.db,e,[this.name],f);return l&&(m._consoleTask=l,m=m.catch(function(g){return console.trace(g),le(g)})),m}finally{h&&Et()}},se.prototype.get=function(e,t){var r=this;return e&&e.constructor===Object?this.where(e).first(t):e==null?le(new $.Type("Invalid argument to Table.get()")):this._trans("readonly",function(a){return r.core.get({trans:a,key:e}).then(function(u){return r.hook.reading.fire(u)})}).then(t)},se.prototype.where=function(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(O(e))return new this.db.WhereClause(this,"[".concat(e.join("+"),"]"));var t=S(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);var r=this.schema.indexes.concat(this.schema.primKey).filter(function(h){if(h.compound&&t.every(function(g){return 0<=h.keyPath.indexOf(g)})){for(var m=0;m<t.length;++m)if(t.indexOf(h.keyPath[m])===-1)return!1;return!0}return!1}).sort(function(h,m){return h.keyPath.length-m.keyPath.length})[0];if(r&&this.db._maxKey!==vt){var l=r.keyPath.slice(0,t.length);return this.where(l).equals(l.map(function(m){return e[m]}))}!r&&Le&&console.warn("The query ".concat(JSON.stringify(e)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(t.join("+"),"]"));var a=this.schema.idxByName;function u(h,m){return Y(h,m)===0}var f=t.reduce(function(p,m){var g=p[0],w=p[1],p=a[m],x=e[m];return[g||p,g||!p?bt(w,p&&p.multi?function(y){return y=de(y,m),O(y)&&y.some(function(b){return u(x,b)})}:function(y){return u(x,de(y,m))}):w]},[null,null]),l=f[0],f=f[1];return l?this.where(l.name).equals(e[l.keyPath]).filter(f):r?this.filter(f):this.where(t).equals("")},se.prototype.filter=function(e){return this.toCollection().and(e)},se.prototype.count=function(e){return this.toCollection().count(e)},se.prototype.offset=function(e){return this.toCollection().offset(e)},se.prototype.limit=function(e){return this.toCollection().limit(e)},se.prototype.each=function(e){return this.toCollection().each(e)},se.prototype.toArray=function(e){return this.toCollection().toArray(e)},se.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},se.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,O(e)?"[".concat(e.join("+"),"]"):e))},se.prototype.reverse=function(){return this.toCollection().reverse()},se.prototype.mapToClass=function(e){var t,r=this.db,a=this.name;function u(){return t!==null&&t.apply(this,arguments)||this}(this.schema.mappedClass=e).prototype instanceof Ui&&(function(m,g){if(typeof g!="function"&&g!==null)throw new TypeError("Class extends value "+String(g)+" is not a constructor or null");function w(){this.constructor=m}i(m,g),m.prototype=g===null?Object.create(g):(w.prototype=g.prototype,new w)}(u,t=e),Object.defineProperty(u.prototype,"db",{get:function(){return r},enumerable:!1,configurable:!0}),u.prototype.table=function(){return a},e=u);for(var l=new Set,f=e.prototype;f;f=q(f))Object.getOwnPropertyNames(f).forEach(function(m){return l.add(m)});function h(m){if(!m)return m;var g,w=Object.create(e.prototype);for(g in m)if(!l.has(g))try{w[g]=m[g]}catch{}return w}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=h,this.hook("reading",h),e},se.prototype.defineClass=function(){return this.mapToClass(function(e){B(this,e)})},se.prototype.add=function(e,t){var r=this,a=this.schema.primKey,u=a.auto,l=a.keyPath,f=e;return l&&u&&(f=An(l)(e)),this._trans("readwrite",function(h){return r.core.mutate({trans:h,type:"add",keys:t!=null?[t]:null,values:[f]})}).then(function(h){return h.numFailures?K.reject(h.failures[0]):h.lastResult}).then(function(h){if(l)try{re(e,l,h)}catch{}return h})},se.prototype.update=function(e,t){return typeof e!="object"||O(e)?this.where(":id").equals(e).modify(t):(e=de(e,this.schema.primKey.keyPath),e===void 0?le(new $.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(e).modify(t))},se.prototype.put=function(e,t){var r=this,a=this.schema.primKey,u=a.auto,l=a.keyPath,f=e;return l&&u&&(f=An(l)(e)),this._trans("readwrite",function(h){return r.core.mutate({trans:h,type:"put",values:[f],keys:t!=null?[t]:null})}).then(function(h){return h.numFailures?K.reject(h.failures[0]):h.lastResult}).then(function(h){if(l)try{re(e,l,h)}catch{}return h})},se.prototype.delete=function(e){var t=this;return this._trans("readwrite",function(r){return t.core.mutate({trans:r,type:"delete",keys:[e]})}).then(function(r){return r.numFailures?K.reject(r.failures[0]):void 0})},se.prototype.clear=function(){var e=this;return this._trans("readwrite",function(t){return e.core.mutate({trans:t,type:"deleteRange",range:$i})}).then(function(t){return t.numFailures?K.reject(t.failures[0]):void 0})},se.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",function(r){return t.core.getMany({keys:e,trans:r}).then(function(a){return a.map(function(u){return t.hook.reading.fire(u)})})})},se.prototype.bulkAdd=function(e,t,r){var a=this,u=Array.isArray(t)?t:void 0,l=(r=r||(u?void 0:t))?r.allKeys:void 0;return this._trans("readwrite",function(f){var g=a.schema.primKey,h=g.auto,g=g.keyPath;if(g&&u)throw new $.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(u&&u.length!==e.length)throw new $.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,g=g&&h?e.map(An(g)):e;return a.core.mutate({trans:f,type:"add",keys:u,values:g,wantResults:l}).then(function(b){var p=b.numFailures,x=b.results,y=b.lastResult,b=b.failures;if(p===0)return l?x:y;throw new Pt("".concat(a.name,".bulkAdd(): ").concat(p," of ").concat(m," operations failed"),b)})})},se.prototype.bulkPut=function(e,t,r){var a=this,u=Array.isArray(t)?t:void 0,l=(r=r||(u?void 0:t))?r.allKeys:void 0;return this._trans("readwrite",function(f){var g=a.schema.primKey,h=g.auto,g=g.keyPath;if(g&&u)throw new $.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(u&&u.length!==e.length)throw new $.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,g=g&&h?e.map(An(g)):e;return a.core.mutate({trans:f,type:"put",keys:u,values:g,wantResults:l}).then(function(b){var p=b.numFailures,x=b.results,y=b.lastResult,b=b.failures;if(p===0)return l?x:y;throw new Pt("".concat(a.name,".bulkPut(): ").concat(p," of ").concat(m," operations failed"),b)})})},se.prototype.bulkUpdate=function(e){var t=this,r=this.core,a=e.map(function(f){return f.key}),u=e.map(function(f){return f.changes}),l=[];return this._trans("readwrite",function(f){return r.getMany({trans:f,keys:a,cache:"clone"}).then(function(h){var m=[],g=[];e.forEach(function(p,x){var y=p.key,b=p.changes,_=h[x];if(_){for(var v=0,k=Object.keys(b);v<k.length;v++){var P=k[v],A=b[P];if(P===t.schema.primKey.keyPath){if(Y(A,y)!==0)throw new $.Constraint("Cannot update primary key in bulkUpdate()")}else re(_,P,A)}l.push(x),m.push(y),g.push(_)}});var w=m.length;return r.mutate({trans:f,type:"put",keys:m,values:g,updates:{keys:a,changeSpecs:u}}).then(function(p){var x=p.numFailures,y=p.failures;if(x===0)return w;for(var b=0,_=Object.keys(y);b<_.length;b++){var v,k=_[b],P=l[Number(k)];P!=null&&(v=y[k],delete y[k],y[P]=v)}throw new Pt("".concat(t.name,".bulkUpdate(): ").concat(x," of ").concat(w," operations failed"),y)})})})},se.prototype.bulkDelete=function(e){var t=this,r=e.length;return this._trans("readwrite",function(a){return t.core.mutate({trans:a,type:"delete",keys:e})}).then(function(f){var u=f.numFailures,l=f.lastResult,f=f.failures;if(u===0)return l;throw new Pt("".concat(t.name,".bulkDelete(): ").concat(u," of ").concat(r," operations failed"),f)})},se);function se(){}function Ht(e){function t(f,h){if(h){for(var m=arguments.length,g=new Array(m-1);--m;)g[m-1]=arguments[m];return r[f].subscribe.apply(null,g),e}if(typeof f=="string")return r[f]}var r={};t.addEventType=l;for(var a=1,u=arguments.length;a<u;++a)l(arguments[a]);return t;function l(f,h,m){if(typeof f!="object"){var g;h=h||oa;var w={subscribers:[],fire:m=m||te,subscribe:function(p){w.subscribers.indexOf(p)===-1&&(w.subscribers.push(p),w.fire=h(w.fire,p))},unsubscribe:function(p){w.subscribers=w.subscribers.filter(function(x){return x!==p}),w.fire=w.subscribers.reduce(h,m)}};return r[f]=t[f]=w}S(g=f).forEach(function(p){var x=g[p];if(O(x))l(p,g[p][0],g[p][1]);else{if(x!=="asap")throw new $.InvalidArgument("Invalid event config");var y=l(p,Ft,function(){for(var b=arguments.length,_=new Array(b);b--;)_[b]=arguments[b];y.subscribers.forEach(function(v){Je(function(){v.apply(null,_)})})})}})}}function Vt(e,t){return me(t).from({prototype:e}),t}function It(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Tr(e,t){e.filter=bt(e.filter,t)}function Rr(e,t,r){var a=e.replayFilter;e.replayFilter=a?function(){return bt(a(),t())}:t,e.justLimit=r&&!a}function En(e,t){if(e.isPrimKey)return t.primaryKey;var r=t.getIndexByKeyPath(e.index);if(!r)throw new $.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return r}function Vi(e,t,r){var a=En(e,t.schema);return t.openCursor({trans:r,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:a,range:e.range}})}function On(e,t,r,a){var u=e.replayFilter?bt(e.filter,e.replayFilter()):e.filter;if(e.or){var l={},f=function(h,m,g){var w,p;u&&!u(m,g,function(x){return m.stop(x)},function(x){return m.fail(x)})||((p=""+(w=m.primaryKey))=="[object ArrayBuffer]"&&(p=""+new Uint8Array(w)),F(l,p)||(l[p]=!0,t(h,m,g)))};return Promise.all([e.or._iterate(f,r),Ji(Vi(e,a,r),e.algorithm,f,!e.keysOnly&&e.valueMapper)])}return Ji(Vi(e,a,r),bt(e.algorithm,u),t,!e.keysOnly&&e.valueMapper)}function Ji(e,t,r,a){var u=oe(a?function(l,f,h){return r(a(l),f,h)}:r);return e.then(function(l){if(l)return l.start(function(){var f=function(){return l.continue()};t&&!t(l,function(h){return f=h},function(h){l.stop(h),f=te},function(h){l.fail(h),f=te})||u(l.value,l,function(h){return f=h}),f()})})}var Jt=(Gi.prototype.execute=function(e){var t=this["@@propmod"];if(t.add!==void 0){var r=t.add;if(O(r))return c(c([],O(e)?e:[],!0),r).sort();if(typeof r=="number")return(Number(e)||0)+r;if(typeof r=="bigint")try{return BigInt(e)+r}catch{return BigInt(0)+r}throw new TypeError("Invalid term ".concat(r))}if(t.remove!==void 0){var a=t.remove;if(O(a))return O(e)?e.filter(function(u){return!a.includes(u)}).sort():[];if(typeof a=="number")return Number(e)-a;if(typeof a=="bigint")try{return BigInt(e)-a}catch{return BigInt(0)-a}throw new TypeError("Invalid subtrahend ".concat(a))}return r=(r=t.replacePrefix)===null||r===void 0?void 0:r[0],r&&typeof e=="string"&&e.startsWith(r)?t.replacePrefix[1]+e.substring(r.length):e},Gi);function Gi(e){this["@@propmod"]=e}var da=(Z.prototype._read=function(e,t){var r=this._ctx;return r.error?r.table._trans(null,le.bind(null,r.error)):r.table._trans("readonly",e).then(t)},Z.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,le.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},Z.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=bt(t.algorithm,e)},Z.prototype._iterate=function(e,t){return On(this._ctx,e,t,this._ctx.table.core)},Z.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return e&&B(r,e),t._ctx=r,t},Z.prototype.raw=function(){return this._ctx.valueMapper=null,this},Z.prototype.each=function(e){var t=this._ctx;return this._read(function(r){return On(t,e,r,t.table.core)})},Z.prototype.count=function(e){var t=this;return this._read(function(r){var a=t._ctx,u=a.table.core;if(It(a,!0))return u.count({trans:r,query:{index:En(a,u.schema),range:a.range}}).then(function(f){return Math.min(f,a.limit)});var l=0;return On(a,function(){return++l,!1},r,u).then(function(){return l})}).then(e)},Z.prototype.sortBy=function(e,t){var r=e.split(".").reverse(),a=r[0],u=r.length-1;function l(m,g){return g?l(m[r[g]],g-1):m[a]}var f=this._ctx.dir==="next"?1:-1;function h(m,g){return Y(l(m,u),l(g,u))*f}return this.toArray(function(m){return m.sort(h)}).then(t)},Z.prototype.toArray=function(e){var t=this;return this._read(function(r){var a=t._ctx;if(a.dir==="next"&&It(a,!0)&&0<a.limit){var u=a.valueMapper,l=En(a,a.table.core.schema);return a.table.core.query({trans:r,limit:a.limit,values:!0,query:{index:l,range:a.range}}).then(function(h){return h=h.result,u?h.map(u):h})}var f=[];return On(a,function(h){return f.push(h)},r,a.table.core).then(function(){return f})},e)},Z.prototype.offset=function(e){var t=this._ctx;return e<=0||(t.offset+=e,It(t)?Rr(t,function(){var r=e;return function(a,u){return r===0||(r===1?--r:u(function(){a.advance(r),r=0}),!1)}}):Rr(t,function(){var r=e;return function(){return--r<0}})),this},Z.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Rr(this._ctx,function(){var t=e;return function(r,a,u){return--t<=0&&a(u),0<=t}},!0),this},Z.prototype.until=function(e,t){return Tr(this._ctx,function(r,a,u){return!e(r.value)||(a(u),t)}),this},Z.prototype.first=function(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)},Z.prototype.last=function(e){return this.reverse().first(e)},Z.prototype.filter=function(e){var t;return Tr(this._ctx,function(r){return e(r.value)}),(t=this._ctx).isMatch=bt(t.isMatch,e),this},Z.prototype.and=function(e){return this.filter(e)},Z.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},Z.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Z.prototype.desc=function(){return this.reverse()},Z.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(r,a){e(a.key,a)})},Z.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},Z.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(r,a){e(a.primaryKey,a)})},Z.prototype.keys=function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var r=[];return this.each(function(a,u){r.push(u.key)}).then(function(){return r}).then(e)},Z.prototype.primaryKeys=function(e){var t=this._ctx;if(t.dir==="next"&&It(t,!0)&&0<t.limit)return this._read(function(a){var u=En(t,t.table.core.schema);return t.table.core.query({trans:a,values:!1,limit:t.limit,query:{index:u,range:t.range}})}).then(function(a){return a.result}).then(e);t.keysOnly=!t.isMatch;var r=[];return this.each(function(a,u){r.push(u.primaryKey)}).then(function(){return r}).then(e)},Z.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},Z.prototype.firstKey=function(e){return this.limit(1).keys(function(t){return t[0]}).then(e)},Z.prototype.lastKey=function(e){return this.reverse().firstKey(e)},Z.prototype.distinct=function(){var e=this._ctx,e=e.index&&e.table.schema.idxByName[e.index];if(!e||!e.multi)return this;var t={};return Tr(this._ctx,function(u){var a=u.primaryKey.toString(),u=F(t,a);return t[a]=!0,!u}),this},Z.prototype.modify=function(e){var t=this,r=this._ctx;return this._write(function(a){var u,l,f;f=typeof e=="function"?e:(u=S(e),l=u.length,function(v){for(var k=!1,P=0;P<l;++P){var A=u[P],E=e[A],M=de(v,A);E instanceof Jt?(re(v,A,E.execute(M)),k=!0):M!==E&&(re(v,A,E),k=!0)}return k});var h=r.table.core,p=h.schema.primaryKey,m=p.outbound,g=p.extractKey,w=200,p=t.db._options.modifyChunkSize;p&&(w=typeof p=="object"?p[h.name]||p["*"]||200:p);function x(v,A){var P=A.failures,A=A.numFailures;b+=v-A;for(var E=0,M=S(P);E<M.length;E++){var D=M[E];y.push(P[D])}}var y=[],b=0,_=[];return t.clone().primaryKeys().then(function(v){function k(A){var E=Math.min(w,v.length-A);return h.getMany({trans:a,keys:v.slice(A,A+E),cache:"immutable"}).then(function(M){for(var D=[],I=[],T=m?[]:null,j=[],R=0;R<E;++R){var C=M[R],W={value:Be(C),primKey:v[A+R]};f.call(W,W.value,W)!==!1&&(W.value==null?j.push(v[A+R]):m||Y(g(C),g(W.value))===0?(I.push(W.value),m&&T.push(v[A+R])):(j.push(v[A+R]),D.push(W.value)))}return Promise.resolve(0<D.length&&h.mutate({trans:a,type:"add",values:D}).then(function(z){for(var X in z.failures)j.splice(parseInt(X),1);x(D.length,z)})).then(function(){return(0<I.length||P&&typeof e=="object")&&h.mutate({trans:a,type:"put",keys:T,values:I,criteria:P,changeSpec:typeof e!="function"&&e,isAdditionalChunk:0<A}).then(function(z){return x(I.length,z)})}).then(function(){return(0<j.length||P&&e===Dr)&&h.mutate({trans:a,type:"delete",keys:j,criteria:P,isAdditionalChunk:0<A}).then(function(z){return x(j.length,z)})}).then(function(){return v.length>A+E&&k(A+w)})})}var P=It(r)&&r.limit===1/0&&(typeof e!="function"||e===Dr)&&{index:r.index,range:r.range};return k(0).then(function(){if(0<y.length)throw new mn("Error modifying one or more objects",y,b,_);return v.length})})})},Z.prototype.delete=function(){var e=this._ctx,t=e.range;return It(e)&&(e.isPrimKey||t.type===3)?this._write(function(r){var a=e.table.core.schema.primaryKey,u=t;return e.table.core.count({trans:r,query:{index:a,range:u}}).then(function(l){return e.table.core.mutate({trans:r,type:"deleteRange",range:u}).then(function(f){var h=f.failures;if(f.lastResult,f.results,f=f.numFailures,f)throw new mn("Could not delete some values",Object.keys(h).map(function(m){return h[m]}),l-f);return l-f})})}):this.modify(Dr)},Z);function Z(){}var Dr=function(e,t){return t.value=null};function pa(e,t){return e<t?-1:e===t?0:1}function ma(e,t){return t<e?-1:e===t?0:1}function Re(e,t,r){return e=e instanceof Xi?new e.Collection(e):e,e._ctx.error=new(r||TypeError)(t),e}function Tt(e){return new e.Collection(e,function(){return zi("")}).limit(0)}function Mn(e,t,r,a){var u,l,f,h,m,g,w,p=r.length;if(!r.every(function(b){return typeof b=="string"}))return Re(e,Fi);function x(b){u=b==="next"?function(v){return v.toUpperCase()}:function(v){return v.toLowerCase()},l=b==="next"?function(v){return v.toLowerCase()}:function(v){return v.toUpperCase()},f=b==="next"?pa:ma;var _=r.map(function(v){return{lower:l(v),upper:u(v)}}).sort(function(v,k){return f(v.lower,k.lower)});h=_.map(function(v){return v.upper}),m=_.map(function(v){return v.lower}),w=(g=b)==="next"?"":a}x("next"),e=new e.Collection(e,function(){return rt(h[0],m[p-1]+a)}),e._ondirectionchange=function(b){x(b)};var y=0;return e._addAlgorithm(function(b,_,v){var k=b.key;if(typeof k!="string")return!1;var P=l(k);if(t(P,m,y))return!0;for(var A=null,E=y;E<p;++E){var M=function(D,I,T,j,R,C){for(var W=Math.min(D.length,j.length),z=-1,X=0;X<W;++X){var De=I[X];if(De!==j[X])return R(D[X],T[X])<0?D.substr(0,X)+T[X]+T.substr(X+1):R(D[X],j[X])<0?D.substr(0,X)+j[X]+T.substr(X+1):0<=z?D.substr(0,z)+I[z]+T.substr(z+1):null;R(D[X],De)<0&&(z=X)}return W<j.length&&C==="next"?D+T.substr(D.length):W<D.length&&C==="prev"?D.substr(0,T.length):z<0?null:D.substr(0,z)+j[z]+T.substr(z+1)}(k,P,h[E],m[E],f,g);M===null&&A===null?y=E+1:(A===null||0<f(A,M))&&(A=M)}return _(A!==null?function(){b.continue(A+w)}:v),!1}),e}function rt(e,t,r,a){return{type:2,lower:e,upper:t,lowerOpen:r,upperOpen:a}}function zi(e){return{type:1,lower:e,upper:e}}var Xi=(Object.defineProperty(be.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),be.prototype.between=function(e,t,r,a){r=r!==!1,a=a===!0;try{return 0<this._cmp(e,t)||this._cmp(e,t)===0&&(r||a)&&(!r||!a)?Tt(this):new this.Collection(this,function(){return rt(e,t,!r,!a)})}catch{return Re(this,ze)}},be.prototype.equals=function(e){return e==null?Re(this,ze):new this.Collection(this,function(){return zi(e)})},be.prototype.above=function(e){return e==null?Re(this,ze):new this.Collection(this,function(){return rt(e,void 0,!0)})},be.prototype.aboveOrEqual=function(e){return e==null?Re(this,ze):new this.Collection(this,function(){return rt(e,void 0,!1)})},be.prototype.below=function(e){return e==null?Re(this,ze):new this.Collection(this,function(){return rt(void 0,e,!1,!0)})},be.prototype.belowOrEqual=function(e){return e==null?Re(this,ze):new this.Collection(this,function(){return rt(void 0,e)})},be.prototype.startsWith=function(e){return typeof e!="string"?Re(this,Fi):this.between(e,e+vt,!0,!0)},be.prototype.startsWithIgnoreCase=function(e){return e===""?this.startsWith(e):Mn(this,function(t,r){return t.indexOf(r[0])===0},[e],vt)},be.prototype.equalsIgnoreCase=function(e){return Mn(this,function(t,r){return t===r[0]},[e],"")},be.prototype.anyOfIgnoreCase=function(){var e=ie.apply(ge,arguments);return e.length===0?Tt(this):Mn(this,function(t,r){return r.indexOf(t)!==-1},e,"")},be.prototype.startsWithAnyOfIgnoreCase=function(){var e=ie.apply(ge,arguments);return e.length===0?Tt(this):Mn(this,function(t,r){return r.some(function(a){return t.indexOf(a)===0})},e,vt)},be.prototype.anyOf=function(){var e=this,t=ie.apply(ge,arguments),r=this._cmp;try{t.sort(r)}catch{return Re(this,ze)}if(t.length===0)return Tt(this);var a=new this.Collection(this,function(){return rt(t[0],t[t.length-1])});a._ondirectionchange=function(l){r=l==="next"?e._ascending:e._descending,t.sort(r)};var u=0;return a._addAlgorithm(function(l,f,h){for(var m=l.key;0<r(m,t[u]);)if(++u===t.length)return f(h),!1;return r(m,t[u])===0||(f(function(){l.continue(t[u])}),!1)}),a},be.prototype.notEqual=function(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},be.prototype.noneOf=function(){var e=ie.apply(ge,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return Re(this,ze)}var t=e.reduce(function(r,a){return r?r.concat([[r[r.length-1][1],a]]):[[-1/0,a]]},null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},be.prototype.inAnyRange=function(k,t){var r=this,a=this._cmp,u=this._ascending,l=this._descending,f=this._min,h=this._max;if(k.length===0)return Tt(this);if(!k.every(function(P){return P[0]!==void 0&&P[1]!==void 0&&u(P[0],P[1])<=0}))return Re(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",$.InvalidArgument);var m=!t||t.includeLowers!==!1,g=t&&t.includeUppers===!0,w,p=u;function x(P,A){return p(P[0],A[0])}try{(w=k.reduce(function(P,A){for(var E=0,M=P.length;E<M;++E){var D=P[E];if(a(A[0],D[1])<0&&0<a(A[1],D[0])){D[0]=f(D[0],A[0]),D[1]=h(D[1],A[1]);break}}return E===M&&P.push(A),P},[])).sort(x)}catch{return Re(this,ze)}var y=0,b=g?function(P){return 0<u(P,w[y][1])}:function(P){return 0<=u(P,w[y][1])},_=m?function(P){return 0<l(P,w[y][0])}:function(P){return 0<=l(P,w[y][0])},v=b,k=new this.Collection(this,function(){return rt(w[0][0],w[w.length-1][1],!m,!g)});return k._ondirectionchange=function(P){p=P==="next"?(v=b,u):(v=_,l),w.sort(x)},k._addAlgorithm(function(P,A,E){for(var M,D=P.key;v(D);)if(++y===w.length)return A(E),!1;return!b(M=D)&&!_(M)||(r._cmp(D,w[y][1])===0||r._cmp(D,w[y][0])===0||A(function(){p===u?P.continue(w[y][0]):P.continue(w[y][1])}),!1)}),k},be.prototype.startsWithAnyOf=function(){var e=ie.apply(ge,arguments);return e.every(function(t){return typeof t=="string"})?e.length===0?Tt(this):this.inAnyRange(e.map(function(t){return[t,t+vt]})):Re(this,"startsWithAnyOf() only works with strings")},be);function be(){}function We(e){return oe(function(t){return Gt(t),e(t.target.error),!1})}function Gt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var zt="storagemutated",jr="x-storagemutated-1",it=Ht(null,zt),ya=(He.prototype._lock=function(){return he(!N.global),++this._reculock,this._reculock!==1||N.global||(N.lockOwnerFor=this),this},He.prototype._unlock=function(){if(he(!N.global),--this._reculock==0)for(N.global||(N.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var e=this._blockedFuncs.shift();try{gt(e[1],e[0])}catch{}}return this},He.prototype._locked=function(){return this._reculock&&N.lockOwnerFor!==this},He.prototype.create=function(e){var t=this;if(!this.mode)return this;var r=this.db.idbdb,a=this.db._state.dbOpenError;if(he(!this.idbtrans),!e&&!r)switch(a&&a.name){case"DatabaseClosedError":throw new $.DatabaseClosed(a);case"MissingAPIError":throw new $.MissingAPI(a.message,a);default:throw new $.OpenFailed(a)}if(!this.active)throw new $.TransactionInactive;return he(this._completion._state===null),(e=this.idbtrans=e||(this.db.core||r).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=oe(function(u){Gt(u),t._reject(e.error)}),e.onabort=oe(function(u){Gt(u),t.active&&t._reject(new $.Abort(e.error)),t.active=!1,t.on("abort").fire(u)}),e.oncomplete=oe(function(){t.active=!1,t._resolve(),"mutatedParts"in e&&it.storagemutated.fire(e.mutatedParts)}),this},He.prototype._promise=function(e,t,r){var a=this;if(e==="readwrite"&&this.mode!=="readwrite")return le(new $.ReadOnly("Transaction is readonly"));if(!this.active)return le(new $.TransactionInactive);if(this._locked())return new K(function(l,f){a._blockedFuncs.push([function(){a._promise(e,t,r).then(l,f)},N])});if(r)return et(function(){var l=new K(function(f,h){a._lock();var m=t(f,h,a);m&&m.then&&m.then(f,h)});return l.finally(function(){return a._unlock()}),l._lib=!0,l});var u=new K(function(l,f){var h=t(l,f,a);h&&h.then&&h.then(l,f)});return u._lib=!0,u},He.prototype._root=function(){return this.parent?this.parent._root():this},He.prototype.waitFor=function(e){var t,r=this._root(),a=K.resolve(e);r._waitingFor?r._waitingFor=r._waitingFor.then(function(){return a}):(r._waitingFor=a,r._waitingQueue=[],t=r.idbtrans.objectStore(r.storeNames[0]),function l(){for(++r._spinCount;r._waitingQueue.length;)r._waitingQueue.shift()();r._waitingFor&&(t.get(-1/0).onsuccess=l)}());var u=r._waitingFor;return new K(function(l,f){a.then(function(h){return r._waitingQueue.push(oe(l.bind(null,h)))},function(h){return r._waitingQueue.push(oe(f.bind(null,h)))}).finally(function(){r._waitingFor===u&&(r._waitingFor=null)})})},He.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new $.Abort))},He.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if(F(t,e))return t[e];var r=this.schema[e];if(!r)throw new $.NotFound("Table "+e+" not part of transaction");return r=new this.db.Table(e,r,this),r.core=this.db.core.table(e),t[e]=r},He);function He(){}function Br(e,t,r,a,u,l,f){return{name:e,keyPath:t,unique:r,multi:a,auto:u,compound:l,src:(r&&!f?"&":"")+(a?"*":"")+(u?"++":"")+Yi(t)}}function Yi(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Kr(e,t,r){return{name:e,primKey:t,indexes:r,mappedClass:null,idxByName:(a=function(u){return[u.name,u]},r.reduce(function(u,l,f){return f=a(l,f),f&&(u[f[0]]=f[1]),u},{}))};var a}var Xt=function(e){try{return e.only([[]]),Xt=function(){return[[]]},[[]]}catch{return Xt=function(){return vt},vt}};function Cr(e){return e==null?function(){}:typeof e=="string"?(t=e).split(".").length===1?function(r){return r[t]}:function(r){return de(r,t)}:function(r){return de(r,e)};var t}function Qi(e){return[].slice.call(e)}var ga=0;function Yt(e){return e==null?":id":typeof e=="string"?e:"[".concat(e.join("+"),"]")}function va(e,t,m){function a(v){if(v.type===3)return null;if(v.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var y=v.lower,b=v.upper,_=v.lowerOpen,v=v.upperOpen;return y===void 0?b===void 0?null:t.upperBound(b,!!v):b===void 0?t.lowerBound(y,!!_):t.bound(y,b,!!_,!!v)}function u(x){var y,b=x.name;return{name:b,schema:x,mutate:function(_){var v=_.trans,k=_.type,P=_.keys,A=_.values,E=_.range;return new Promise(function(M,D){M=oe(M);var I=v.objectStore(b),T=I.keyPath==null,j=k==="put"||k==="add";if(!j&&k!=="delete"&&k!=="deleteRange")throw new Error("Invalid operation type: "+k);var R,C=(P||A||{length:1}).length;if(P&&A&&P.length!==A.length)throw new Error("Given keys array must have same length as given values array.");if(C===0)return M({numFailures:0,failures:{},results:[],lastResult:void 0});function W(Ie){++De,Gt(Ie)}var z=[],X=[],De=0;if(k==="deleteRange"){if(E.type===4)return M({numFailures:De,failures:X,results:[],lastResult:void 0});E.type===3?z.push(R=I.clear()):z.push(R=I.delete(a(E)))}else{var T=j?T?[A,P]:[A,null]:[P,null],U=T[0],Pe=T[1];if(j)for(var Ae=0;Ae<C;++Ae)z.push(R=Pe&&Pe[Ae]!==void 0?I[k](U[Ae],Pe[Ae]):I[k](U[Ae])),R.onerror=W;else for(Ae=0;Ae<C;++Ae)z.push(R=I[k](U[Ae])),R.onerror=W}function Un(Ie){Ie=Ie.target.result,z.forEach(function(xt,ti){return xt.error!=null&&(X[ti]=xt.error)}),M({numFailures:De,failures:X,results:k==="delete"?P:z.map(function(xt){return xt.result}),lastResult:Ie})}R.onerror=function(Ie){W(Ie),Un(Ie)},R.onsuccess=Un})},getMany:function(_){var v=_.trans,k=_.keys;return new Promise(function(P,A){P=oe(P);for(var E,M=v.objectStore(b),D=k.length,I=new Array(D),T=0,j=0,R=function(z){z=z.target,I[z._pos]=z.result,++j===T&&P(I)},C=We(A),W=0;W<D;++W)k[W]!=null&&((E=M.get(k[W]))._pos=W,E.onsuccess=R,E.onerror=C,++T);T===0&&P(I)})},get:function(_){var v=_.trans,k=_.key;return new Promise(function(P,A){P=oe(P);var E=v.objectStore(b).get(k);E.onsuccess=function(M){return P(M.target.result)},E.onerror=We(A)})},query:(y=g,function(_){return new Promise(function(v,k){v=oe(v);var P,A,E,T=_.trans,M=_.values,D=_.limit,R=_.query,I=D===1/0?void 0:D,j=R.index,R=R.range,T=T.objectStore(b),j=j.isPrimaryKey?T:T.index(j.name),R=a(R);if(D===0)return v({result:[]});y?((I=M?j.getAll(R,I):j.getAllKeys(R,I)).onsuccess=function(C){return v({result:C.target.result})},I.onerror=We(k)):(P=0,A=!M&&"openKeyCursor"in j?j.openKeyCursor(R):j.openCursor(R),E=[],A.onsuccess=function(C){var W=A.result;return W?(E.push(M?W.value:W.primaryKey),++P===D?v({result:E}):void W.continue()):v({result:E})},A.onerror=We(k))})}),openCursor:function(_){var v=_.trans,k=_.values,P=_.query,A=_.reverse,E=_.unique;return new Promise(function(M,D){M=oe(M);var j=P.index,I=P.range,T=v.objectStore(b),T=j.isPrimaryKey?T:T.index(j.name),j=A?E?"prevunique":"prev":E?"nextunique":"next",R=!k&&"openKeyCursor"in T?T.openKeyCursor(a(I),j):T.openCursor(a(I),j);R.onerror=We(D),R.onsuccess=oe(function(C){var W,z,X,De,U=R.result;U?(U.___id=++ga,U.done=!1,W=U.continue.bind(U),z=(z=U.continuePrimaryKey)&&z.bind(U),X=U.advance.bind(U),De=function(){throw new Error("Cursor not stopped")},U.trans=v,U.stop=U.continue=U.continuePrimaryKey=U.advance=function(){throw new Error("Cursor not started")},U.fail=oe(D),U.next=function(){var Pe=this,Ae=1;return this.start(function(){return Ae--?Pe.continue():Pe.stop()}).then(function(){return Pe})},U.start=function(Pe){function Ae(){if(R.result)try{Pe()}catch(Ie){U.fail(Ie)}else U.done=!0,U.start=function(){throw new Error("Cursor behind last entry")},U.stop()}var Un=new Promise(function(Ie,xt){Ie=oe(Ie),R.onerror=We(xt),U.fail=xt,U.stop=function(ti){U.stop=U.continue=U.continuePrimaryKey=U.advance=De,Ie(ti)}});return R.onsuccess=oe(function(Ie){R.onsuccess=Ae,Ae()}),U.continue=W,U.continuePrimaryKey=z,U.advance=X,Ae(),Un},M(U)):M(null)},D)})},count:function(_){var v=_.query,k=_.trans,P=v.index,A=v.range;return new Promise(function(E,M){var D=k.objectStore(b),I=P.isPrimaryKey?D:D.index(P.name),D=a(A),I=D?I.count(D):I.count();I.onsuccess=oe(function(T){return E(T.target.result)}),I.onerror=We(M)})}}}var l,f,h,w=(f=m,h=Qi((l=e).objectStoreNames),{schema:{name:l.name,tables:h.map(function(x){return f.objectStore(x)}).map(function(x){var y=x.keyPath,v=x.autoIncrement,b=O(y),_={},v={name:x.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:y==null,compound:b,keyPath:y,autoIncrement:v,unique:!0,extractKey:Cr(y)},indexes:Qi(x.indexNames).map(function(k){return x.index(k)}).map(function(E){var P=E.name,A=E.unique,M=E.multiEntry,E=E.keyPath,M={name:P,compound:O(E),keyPath:E,unique:A,multiEntry:M,extractKey:Cr(E)};return _[Yt(E)]=M}),getIndexByKeyPath:function(k){return _[Yt(k)]}};return _[":id"]=v.primaryKey,y!=null&&(_[Yt(y)]=v.primaryKey),v})},hasGetAll:0<h.length&&"getAll"in f.objectStore(h[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),m=w.schema,g=w.hasGetAll,w=m.tables.map(u),p={};return w.forEach(function(x){return p[x.name]=x}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(x){if(!p[x])throw new Error("Table '".concat(x,"' not found"));return p[x]},MIN_KEY:-1/0,MAX_KEY:Xt(t),schema:m}}function ba(e,t,r,a){var u=r.IDBKeyRange;return r.indexedDB,{dbcore:(a=va(t,u,a),e.dbcore.reduce(function(l,f){return f=f.create,s(s({},l),f(l))},a))}}function In(e,a){var r=a.db,a=ba(e._middlewares,r,e._deps,a);e.core=a.dbcore,e.tables.forEach(function(u){var l=u.name;e.core.schema.tables.some(function(f){return f.name===l})&&(u.core=e.core.table(l),e[l]instanceof e.Table&&(e[l].core=u.core))})}function Tn(e,t,r,a){r.forEach(function(u){var l=a[u];t.forEach(function(f){var h=function m(g,w){return Se(g,w)||(g=q(g))&&m(g,w)}(f,u);(!h||"value"in h&&h.value===void 0)&&(f===e.Transaction.prototype||f instanceof e.Transaction?ae(f,u,{get:function(){return this.table(u)},set:function(m){V(this,u,{value:m,writable:!0,configurable:!0,enumerable:!0})}}):f[u]=new e.Table(u,l))})})}function qr(e,t){t.forEach(function(r){for(var a in r)r[a]instanceof e.Table&&delete r[a]})}function wa(e,t){return e._cfg.version-t._cfg.version}function _a(e,t,r,a){var u=e._dbSchema;r.objectStoreNames.contains("$meta")&&!u.$meta&&(u.$meta=Kr("$meta",es("")[0],[]),e._storeNames.push("$meta"));var l=e._createTransaction("readwrite",e._storeNames,u);l.create(r),l._completion.catch(a);var f=l._reject.bind(l),h=N.transless||N;et(function(){return N.trans=l,N.transless=h,t!==0?(In(e,r),g=t,((m=l).storeNames.includes("$meta")?m.table("$meta").get("version").then(function(w){return w??g}):K.resolve(g)).then(function(w){return x=w,y=l,b=r,_=[],w=(p=e)._versions,v=p._dbSchema=Dn(0,p.idbdb,b),(w=w.filter(function(k){return k._cfg.version>=x})).length!==0?(w.forEach(function(k){_.push(function(){var P=v,A=k._cfg.dbschema;jn(p,P,b),jn(p,A,b),v=p._dbSchema=A;var E=Nr(P,A);E.add.forEach(function(j){Fr(b,j[0],j[1].primKey,j[1].indexes)}),E.change.forEach(function(j){if(j.recreate)throw new $.Upgrade("Not yet support for changing primary key");var R=b.objectStore(j.name);j.add.forEach(function(C){return Rn(R,C)}),j.change.forEach(function(C){R.deleteIndex(C.name),Rn(R,C)}),j.del.forEach(function(C){return R.deleteIndex(C)})});var M=k._cfg.contentUpgrade;if(M&&k._cfg.version>x){In(p,b),y._memoizedTables={};var D=pe(A);E.del.forEach(function(j){D[j]=P[j]}),qr(p,[p.Transaction.prototype]),Tn(p,[p.Transaction.prototype],S(D),D),y.schema=D;var I,T=Ke(M);return T&&Ot(),E=K.follow(function(){var j;(I=M(y))&&T&&(j=tt.bind(null,null),I.then(j,j))}),I&&typeof I.then=="function"?K.resolve(I):E.then(function(){return I})}}),_.push(function(P){var A,E,M=k._cfg.dbschema;A=M,E=P,[].slice.call(E.db.objectStoreNames).forEach(function(D){return A[D]==null&&E.db.deleteObjectStore(D)}),qr(p,[p.Transaction.prototype]),Tn(p,[p.Transaction.prototype],p._storeNames,p._dbSchema),y.schema=p._dbSchema}),_.push(function(P){p.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(p.idbdb.version/10)===k._cfg.version?(p.idbdb.deleteObjectStore("$meta"),delete p._dbSchema.$meta,p._storeNames=p._storeNames.filter(function(A){return A!=="$meta"})):P.objectStore("$meta").put(k._cfg.version,"version"))})}),function k(){return _.length?K.resolve(_.shift()(y.idbtrans)).then(k):K.resolve()}().then(function(){Zi(v,b)})):K.resolve();var p,x,y,b,_,v}).catch(f)):(S(u).forEach(function(w){Fr(r,w,u[w].primKey,u[w].indexes)}),In(e,r),void K.follow(function(){return e.on.populate.fire(l)}).catch(f));var m,g})}function xa(e,t){Zi(e._dbSchema,t),t.db.version%10!=0||t.objectStoreNames.contains("$meta")||t.db.createObjectStore("$meta").add(Math.ceil(t.db.version/10-1),"version");var r=Dn(0,e.idbdb,t);jn(e,e._dbSchema,t);for(var a=0,u=Nr(r,e._dbSchema).change;a<u.length;a++){var l=function(f){if(f.change.length||f.recreate)return console.warn("Unable to patch indexes of table ".concat(f.name," because it has changes on the type of index or primary key.")),{value:void 0};var h=t.objectStore(f.name);f.add.forEach(function(m){Le&&console.debug("Dexie upgrade patch: Creating missing index ".concat(f.name,".").concat(m.src)),Rn(h,m)})}(u[a]);if(typeof l=="object")return l.value}}function Nr(e,t){var r,a={del:[],add:[],change:[]};for(r in e)t[r]||a.del.push(r);for(r in t){var u=e[r],l=t[r];if(u){var f={name:r,def:l,recreate:!1,del:[],add:[],change:[]};if(""+(u.primKey.keyPath||"")!=""+(l.primKey.keyPath||"")||u.primKey.auto!==l.primKey.auto)f.recreate=!0,a.change.push(f);else{var h=u.idxByName,m=l.idxByName,g=void 0;for(g in h)m[g]||f.del.push(g);for(g in m){var w=h[g],p=m[g];w?w.src!==p.src&&f.change.push(p):f.add.push(p)}(0<f.del.length||0<f.add.length||0<f.change.length)&&a.change.push(f)}}else a.add.push([r,l])}return a}function Fr(e,t,r,a){var u=e.db.createObjectStore(t,r.keyPath?{keyPath:r.keyPath,autoIncrement:r.auto}:{autoIncrement:r.auto});return a.forEach(function(l){return Rn(u,l)}),u}function Zi(e,t){S(e).forEach(function(r){t.db.objectStoreNames.contains(r)||(Le&&console.debug("Dexie: Creating missing table",r),Fr(t,r,e[r].primKey,e[r].indexes))})}function Rn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function Dn(e,t,r){var a={};return ee(t.objectStoreNames,0).forEach(function(u){for(var l=r.objectStore(u),f=Br(Yi(g=l.keyPath),g||"",!0,!1,!!l.autoIncrement,g&&typeof g!="string",!0),h=[],m=0;m<l.indexNames.length;++m){var w=l.index(l.indexNames[m]),g=w.keyPath,w=Br(w.name,g,!!w.unique,!!w.multiEntry,!1,g&&typeof g!="string",!1);h.push(w)}a[u]=Kr(u,f,h)}),a}function jn(e,t,r){for(var a=r.db.objectStoreNames,u=0;u<a.length;++u){var l=a[u],f=r.objectStore(l);e._hasGetAll="getAll"in f;for(var h=0;h<f.indexNames.length;++h){var m=f.indexNames[h],g=f.index(m).keyPath,w=typeof g=="string"?g:"["+ee(g).join("+")+"]";!t[l]||(g=t[l].idxByName[w])&&(g.name=m,delete t[l].idxByName[w],t[l].idxByName[m]=g)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&d.WorkerGlobalScope&&d instanceof d.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}function es(e){return e.split(",").map(function(t,r){var a=(t=t.trim()).replace(/([&*]|\+\+)/g,""),u=/^\[/.test(a)?a.match(/^\[(.*)\]$/)[1].split("+"):a;return Br(a,u||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),O(u),r===0)})}var Sa=(Bn.prototype._parseStoresSpec=function(e,t){S(e).forEach(function(r){if(e[r]!==null){var a=es(e[r]),u=a.shift();if(u.unique=!0,u.multi)throw new $.Schema("Primary key cannot be multi-valued");a.forEach(function(l){if(l.auto)throw new $.Schema("Only primary key can be marked as autoIncrement (++)");if(!l.keyPath)throw new $.Schema("Index must have a name and cannot be an empty string")}),t[r]=Kr(r,u,a)}})},Bn.prototype.stores=function(r){var t=this.db;this._cfg.storesSource=this._cfg.storesSource?B(this._cfg.storesSource,r):r;var r=t._versions,a={},u={};return r.forEach(function(l){B(a,l._cfg.storesSource),u=l._cfg.dbschema={},l._parseStoresSpec(a,u)}),t._dbSchema=u,qr(t,[t._allTables,t,t.Transaction.prototype]),Tn(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],S(u),u),t._storeNames=S(u),this},Bn.prototype.upgrade=function(e){return this._cfg.contentUpgrade=wr(this._cfg.contentUpgrade||te,e),this},Bn);function Bn(){}function $r(e,t){var r=e._dbNamesDB;return r||(r=e._dbNamesDB=new Xe(Pn,{addons:[],indexedDB:e,IDBKeyRange:t})).version(1).stores({dbnames:"name"}),r.table("dbnames")}function Ur(e){return e&&typeof e.databases=="function"}function Lr(e){return et(function(){return N.letThrough=!0,e()})}function Wr(e){return!("from"in e)}var ke=function(e,t){if(!this){var r=new ke;return e&&"d"in e&&B(r,e),r}B(this,arguments.length?{d:1,from:e,to:1<arguments.length?t:e}:{d:0})};function Qt(e,t,r){var a=Y(t,r);if(!isNaN(a)){if(0<a)throw RangeError();if(Wr(e))return B(e,{from:t,to:r,d:1});var u=e.l,a=e.r;if(Y(r,e.from)<0)return u?Qt(u,t,r):e.l={from:t,to:r,d:1,l:null,r:null},ns(e);if(0<Y(t,e.to))return a?Qt(a,t,r):e.r={from:t,to:r,d:1,l:null,r:null},ns(e);Y(t,e.from)<0&&(e.from=t,e.l=null,e.d=a?a.d+1:1),0<Y(r,e.to)&&(e.to=r,e.r=null,e.d=e.l?e.l.d+1:1),r=!e.r,u&&!e.l&&Zt(e,u),a&&r&&Zt(e,a)}}function Zt(e,t){Wr(t)||function r(a,m){var l=m.from,f=m.to,h=m.l,m=m.r;Qt(a,l,f),h&&r(a,h),m&&r(a,m)}(e,t)}function ts(e,t){var r=Kn(t),a=r.next();if(a.done)return!1;for(var u=a.value,l=Kn(e),f=l.next(u.from),h=f.value;!a.done&&!f.done;){if(Y(h.from,u.to)<=0&&0<=Y(h.to,u.from))return!0;Y(u.from,h.from)<0?u=(a=r.next(h.from)).value:h=(f=l.next(u.from)).value}return!1}function Kn(e){var t=Wr(e)?null:{s:0,n:e};return{next:function(r){for(var a=0<arguments.length;t;)switch(t.s){case 0:if(t.s=1,a)for(;t.n.l&&Y(r,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!a||Y(r,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function ns(e){var t,r,a=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((r=e.l)===null||r===void 0?void 0:r.d)||0),u=1<a?"r":a<-1?"l":"";u&&(t=u=="r"?"l":"r",r=s({},e),a=e[u],e.from=a.from,e.to=a.to,e[u]=a[u],r[u]=a[t],(e[t]=r).d=rs(r)),e.d=rs(e)}function rs(r){var t=r.r,r=r.l;return(t?r?Math.max(t.d,r.d):t.d:r?r.d:0)+1}function Cn(e,t){return S(t).forEach(function(r){e[r]?Zt(e[r],t[r]):e[r]=function a(u){var l,f,h={};for(l in u)F(u,l)&&(f=u[l],h[l]=!f||typeof f!="object"||Fe.has(f.constructor)?f:a(f));return h}(t[r])}),e}function Hr(e,t){return e.all||t.all||Object.keys(e).some(function(r){return t[r]&&ts(t[r],e[r])})}L(ke.prototype,((Ce={add:function(e){return Zt(this,e),this},addKey:function(e){return Qt(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(r){return Qt(t,r,r)}),this},hasKey:function(e){var t=Kn(this).next(e).value;return t&&Y(t.from,e)<=0&&0<=Y(t.to,e)}})[ft]=function(){return Kn(this)},Ce));var wt={},Vr={},Jr=!1;function qn(e){Cn(Vr,e),Jr||(Jr=!0,setTimeout(function(){Jr=!1,Gr(Vr,!(Vr={}))},0))}function Gr(e,t){t===void 0&&(t=!1);var r=new Set;if(e.all)for(var a=0,u=Object.values(wt);a<u.length;a++)is(f=u[a],e,r,t);else for(var l in e){var f,h=/^idb\:\/\/(.*)\/(.*)\//.exec(l);h&&(l=h[1],h=h[2],(f=wt["idb://".concat(l,"/").concat(h)])&&is(f,e,r,t))}r.forEach(function(m){return m()})}function is(e,t,r,a){for(var u=[],l=0,f=Object.entries(e.queries.query);l<f.length;l++){for(var h=f[l],m=h[0],g=[],w=0,p=h[1];w<p.length;w++){var x=p[w];Hr(t,x.obsSet)?x.subscribers.forEach(function(v){return r.add(v)}):a&&g.push(x)}a&&u.push([m,g])}if(a)for(var y=0,b=u;y<b.length;y++){var _=b[y],m=_[0],g=_[1];e.queries.query[m]=g}}function ka(e){var t=e._state,r=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?le(t.dbOpenError):e});t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var a=t.openCanceller,u=Math.round(10*e.verno),l=!1;function f(){if(t.openCanceller!==a)throw new $.DatabaseClosed("db.open() was cancelled")}function h(){return new K(function(x,y){if(f(),!r)throw new $.MissingAPI;var b=e.name,_=t.autoSchema||!u?r.open(b):r.open(b,u);if(!_)throw new $.MissingAPI;_.onerror=We(y),_.onblocked=oe(e._fireOnBlocked),_.onupgradeneeded=oe(function(v){var k;w=_.transaction,t.autoSchema&&!e._options.allowEmptyDB?(_.onerror=Gt,w.abort(),_.result.close(),(k=r.deleteDatabase(b)).onsuccess=k.onerror=oe(function(){y(new $.NoSuchDatabase("Database ".concat(b," doesnt exist")))})):(w.onerror=We(y),v=v.oldVersion>Math.pow(2,62)?0:v.oldVersion,p=v<1,e.idbdb=_.result,l&&xa(e,w),_a(e,v/10,w,y))},y),_.onsuccess=oe(function(){w=null;var v,k,P,A,E,M=e.idbdb=_.result,D=ee(M.objectStoreNames);if(0<D.length)try{var I=M.transaction((A=D).length===1?A[0]:A,"readonly");if(t.autoSchema)k=M,P=I,(v=e).verno=k.version/10,P=v._dbSchema=Dn(0,k,P),v._storeNames=ee(k.objectStoreNames,0),Tn(v,[v._allTables],S(P),P);else if(jn(e,e._dbSchema,I),((E=Nr(Dn(0,(E=e).idbdb,I),E._dbSchema)).add.length||E.change.some(function(T){return T.add.length||T.change.length}))&&!l)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),M.close(),u=M.version+1,l=!0,x(h());In(e,I)}catch{}Mt.push(e),M.onversionchange=oe(function(T){t.vcFired=!0,e.on("versionchange").fire(T)}),M.onclose=oe(function(T){e.on("close").fire(T)}),p&&(E=e._deps,I=b,M=E.indexedDB,E=E.IDBKeyRange,Ur(M)||I===Pn||$r(M,E).put({name:I}).catch(te)),x()},y)}).catch(function(x){switch(x==null?void 0:x.name){case"UnknownError":if(0<t.PR1398_maxLoop)return t.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),h();break;case"VersionError":if(0<u)return u=0,h()}return K.reject(x)})}var m,g=t.dbReadyResolve,w=null,p=!1;return K.race([a,(typeof navigator>"u"?K.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(x){function y(){return indexedDB.databases().finally(x)}m=setInterval(y,100),y()}).finally(function(){return clearInterval(m)}):Promise.resolve()).then(h)]).then(function(){return f(),t.onReadyBeingFired=[],K.resolve(Lr(function(){return e.on.ready.fire(e.vip)})).then(function x(){if(0<t.onReadyBeingFired.length){var y=t.onReadyBeingFired.reduce(wr,te);return t.onReadyBeingFired=[],K.resolve(Lr(function(){return y(e.vip)})).then(x)}})}).finally(function(){t.openCanceller===a&&(t.onReadyBeingFired=null,t.isBeingOpened=!1)}).catch(function(x){t.dbOpenError=x;try{w&&w.abort()}catch{}return a===t.openCanceller&&e._close(),le(x)}).finally(function(){t.openComplete=!0,g()}).then(function(){var x;return p&&(x={},e.tables.forEach(function(y){y.schema.indexes.forEach(function(b){b.name&&(x["idb://".concat(e.name,"/").concat(y.name,"/").concat(b.name)]=new ke(-1/0,[[[]]]))}),x["idb://".concat(e.name,"/").concat(y.name,"/")]=x["idb://".concat(e.name,"/").concat(y.name,"/:dels")]=new ke(-1/0,[[[]]])}),it(zt).fire(x),Gr(x,!0)),e})}function zr(e){function t(l){return e.next(l)}var r=u(t),a=u(function(l){return e.throw(l)});function u(l){return function(m){var h=l(m),m=h.value;return h.done?m:m&&typeof m.then=="function"?m.then(r,a):O(m)?Promise.all(m).then(r,a):r(m)}}return u(t)()}function Nn(e,t,r){for(var a=O(e)?e.slice():[e],u=0;u<r;++u)a.push(t);return a}var Pa={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return s(s({},e),{table:function(t){var r=e.table(t),a=r.schema,u={},l=[];function f(p,x,y){var b=Yt(p),_=u[b]=u[b]||[],v=p==null?0:typeof p=="string"?1:p.length,k=0<x,k=s(s({},y),{name:k?"".concat(b,"(virtual-from:").concat(y.name,")"):y.name,lowLevelIndex:y,isVirtual:k,keyTail:x,keyLength:v,extractKey:Cr(p),unique:!k&&y.unique});return _.push(k),k.isPrimaryKey||l.push(k),1<v&&f(v===2?p[0]:p.slice(0,v-1),x+1,y),_.sort(function(P,A){return P.keyTail-A.keyTail}),k}t=f(a.primaryKey.keyPath,0,a.primaryKey),u[":id"]=[t];for(var h=0,m=a.indexes;h<m.length;h++){var g=m[h];f(g.keyPath,0,g)}function w(p){var x,y=p.query.index;return y.isVirtual?s(s({},p),{query:{index:y.lowLevelIndex,range:(x=p.query.range,y=y.keyTail,{type:x.type===1?2:x.type,lower:Nn(x.lower,x.lowerOpen?e.MAX_KEY:e.MIN_KEY,y),lowerOpen:!0,upper:Nn(x.upper,x.upperOpen?e.MIN_KEY:e.MAX_KEY,y),upperOpen:!0})}}):p}return s(s({},r),{schema:s(s({},a),{primaryKey:t,indexes:l,getIndexByKeyPath:function(p){return(p=u[Yt(p)])&&p[0]}}),count:function(p){return r.count(w(p))},query:function(p){return r.query(w(p))},openCursor:function(p){var x=p.query.index,y=x.keyTail,b=x.isVirtual,_=x.keyLength;return b?r.openCursor(w(p)).then(function(k){return k&&v(k)}):r.openCursor(p);function v(k){return Object.create(k,{continue:{value:function(P){P!=null?k.continue(Nn(P,p.reverse?e.MAX_KEY:e.MIN_KEY,y)):p.unique?k.continue(k.key.slice(0,_).concat(p.reverse?e.MIN_KEY:e.MAX_KEY,y)):k.continue()}},continuePrimaryKey:{value:function(P,A){k.continuePrimaryKey(Nn(P,e.MAX_KEY,y),A)}},primaryKey:{get:function(){return k.primaryKey}},key:{get:function(){var P=k.key;return _===1?P[0]:P.slice(0,_)}},value:{get:function(){return k.value}}})}}})}})}};function Xr(e,t,r,a){return r=r||{},a=a||"",S(e).forEach(function(u){var l,f,h;F(t,u)?(l=e[u],f=t[u],typeof l=="object"&&typeof f=="object"&&l&&f?(h=we(l))!==we(f)?r[a+u]=t[u]:h==="Object"?Xr(l,f,r,a+u+"."):l!==f&&(r[a+u]=t[u]):l!==f&&(r[a+u]=t[u])):r[a+u]=void 0}),S(t).forEach(function(u){F(e,u)||(r[a+u]=t[u])}),r}function Yr(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var Aa={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return s(s({},e),{table:function(t){var r=e.table(t),a=r.schema.primaryKey;return s(s({},r),{mutate:function(u){var l=N.trans,f=l.table(t).hook,h=f.deleting,m=f.creating,g=f.updating;switch(u.type){case"add":if(m.fire===te)break;return l._promise("readwrite",function(){return w(u)},!0);case"put":if(m.fire===te&&g.fire===te)break;return l._promise("readwrite",function(){return w(u)},!0);case"delete":if(h.fire===te)break;return l._promise("readwrite",function(){return w(u)},!0);case"deleteRange":if(h.fire===te)break;return l._promise("readwrite",function(){return function p(x,y,b){return r.query({trans:x,values:!1,query:{index:a,range:y},limit:b}).then(function(_){var v=_.result;return w({type:"delete",keys:v,trans:x}).then(function(k){return 0<k.numFailures?Promise.reject(k.failures[0]):v.length<b?{failures:[],numFailures:0,lastResult:void 0}:p(x,s(s({},y),{lower:v[v.length-1],lowerOpen:!0}),b)})})}(u.trans,u.range,1e4)},!0)}return r.mutate(u);function w(p){var x,y,b,_=N.trans,v=p.keys||Yr(a,p);if(!v)throw new Error("Keys missing");return(p=p.type==="add"||p.type==="put"?s(s({},p),{keys:v}):s({},p)).type!=="delete"&&(p.values=c([],p.values)),p.keys&&(p.keys=c([],p.keys)),x=r,b=v,((y=p).type==="add"?Promise.resolve([]):x.getMany({trans:y.trans,keys:b,cache:"immutable"})).then(function(k){var P=v.map(function(A,E){var M,D,I,T=k[E],j={onerror:null,onsuccess:null};return p.type==="delete"?h.fire.call(j,A,T,_):p.type==="add"||T===void 0?(M=m.fire.call(j,A,p.values[E],_),A==null&&M!=null&&(p.keys[E]=A=M,a.outbound||re(p.values[E],a.keyPath,A))):(M=Xr(T,p.values[E]),(D=g.fire.call(j,M,A,T,_))&&(I=p.values[E],Object.keys(D).forEach(function(R){F(I,R)?I[R]=D[R]:re(I,R,D[R])}))),j});return r.mutate(p).then(function(A){for(var E=A.failures,M=A.results,D=A.numFailures,A=A.lastResult,I=0;I<v.length;++I){var T=(M||v)[I],j=P[I];T==null?j.onerror&&j.onerror(E[I]):j.onsuccess&&j.onsuccess(p.type==="put"&&k[I]?p.values[I]:T)}return{failures:E,results:M,numFailures:D,lastResult:A}}).catch(function(A){return P.forEach(function(E){return E.onerror&&E.onerror(A)}),Promise.reject(A)})})}}})}})}};function ss(e,t,r){try{if(!t||t.keys.length<e.length)return null;for(var a=[],u=0,l=0;u<t.keys.length&&l<e.length;++u)Y(t.keys[u],e[l])===0&&(a.push(r?Be(t.values[u]):t.values[u]),++l);return a.length===e.length?a:null}catch{return null}}var Ea={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var r=e.table(t);return s(s({},r),{getMany:function(a){if(!a.cache)return r.getMany(a);var u=ss(a.keys,a.trans._cache,a.cache==="clone");return u?K.resolve(u):r.getMany(a).then(function(l){return a.trans._cache={keys:a.keys,values:a.cache==="clone"?Be(l):l},l})},mutate:function(a){return a.type!=="add"&&(a.trans._cache=null),r.mutate(a)}})}}}};function as(e,t){return e.trans.mode==="readonly"&&!!e.subscr&&!e.trans.explicit&&e.trans.db._options.cache!=="disabled"&&!t.schema.primaryKey.outbound}function os(e,t){switch(e){case"query":return t.values&&!t.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Oa={stack:"dbcore",level:0,name:"Observability",create:function(e){var t=e.schema.name,r=new ke(e.MIN_KEY,e.MAX_KEY);return s(s({},e),{transaction:function(a,u,l){if(N.subscr&&u!=="readonly")throw new $.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(N.querier));return e.transaction(a,u,l)},table:function(a){var u=e.table(a),l=u.schema,f=l.primaryKey,p=l.indexes,h=f.extractKey,m=f.outbound,g=f.autoIncrement&&p.filter(function(y){return y.compound&&y.keyPath.includes(f.keyPath)}),w=s(s({},u),{mutate:function(y){function b(R){return R="idb://".concat(t,"/").concat(a,"/").concat(R),A[R]||(A[R]=new ke)}var _,v,k,P=y.trans,A=y.mutatedParts||(y.mutatedParts={}),E=b(""),M=b(":dels"),D=y.type,j=y.type==="deleteRange"?[y.range]:y.type==="delete"?[y.keys]:y.values.length<50?[Yr(f,y).filter(function(R){return R}),y.values]:[],I=j[0],T=j[1],j=y.trans._cache;return O(I)?(E.addKeys(I),(j=D==="delete"||I.length===T.length?ss(I,j):null)||M.addKeys(I),(j||T)&&(_=b,v=j,k=T,l.indexes.forEach(function(R){var C=_(R.name||"");function W(X){return X!=null?R.extractKey(X):null}function z(X){return R.multiEntry&&O(X)?X.forEach(function(De){return C.addKey(De)}):C.addKey(X)}(v||k).forEach(function(X,Pe){var U=v&&W(v[Pe]),Pe=k&&W(k[Pe]);Y(U,Pe)!==0&&(U!=null&&z(U),Pe!=null&&z(Pe))})}))):I?(T={from:(T=I.lower)!==null&&T!==void 0?T:e.MIN_KEY,to:(T=I.upper)!==null&&T!==void 0?T:e.MAX_KEY},M.add(T),E.add(T)):(E.add(r),M.add(r),l.indexes.forEach(function(R){return b(R.name).add(r)})),u.mutate(y).then(function(R){return!I||y.type!=="add"&&y.type!=="put"||(E.addKeys(R.results),g&&g.forEach(function(C){for(var W=y.values.map(function(U){return C.extractKey(U)}),z=C.keyPath.findIndex(function(U){return U===f.keyPath}),X=0,De=R.results.length;X<De;++X)W[X][z]=R.results[X];b(C.name).addKeys(W)})),P.mutatedParts=Cn(P.mutatedParts||{},A),R})}}),p=function(b){var _=b.query,b=_.index,_=_.range;return[b,new ke((b=_.lower)!==null&&b!==void 0?b:e.MIN_KEY,(_=_.upper)!==null&&_!==void 0?_:e.MAX_KEY)]},x={get:function(y){return[f,new ke(y.key)]},getMany:function(y){return[f,new ke().addKeys(y.keys)]},count:p,query:p,openCursor:p};return S(x).forEach(function(y){w[y]=function(b){var _=N.subscr,v=!!_,k=as(N,u)&&os(y,b)?b.obsSet={}:_;if(v){var P=function(T){return T="idb://".concat(t,"/").concat(a,"/").concat(T),k[T]||(k[T]=new ke)},A=P(""),E=P(":dels"),_=x[y](b),v=_[0],_=_[1];if((y==="query"&&v.isPrimaryKey&&!b.values?E:P(v.name||"")).add(_),!v.isPrimaryKey){if(y!=="count"){var M=y==="query"&&m&&b.values&&u.query(s(s({},b),{values:!1}));return u[y].apply(this,arguments).then(function(T){if(y==="query"){if(m&&b.values)return M.then(function(W){return W=W.result,A.addKeys(W),T});var j=b.values?T.result.map(h):T.result;(b.values?A:E).addKeys(j)}else if(y==="openCursor"){var R=T,C=b.values;return R&&Object.create(R,{key:{get:function(){return E.addKey(R.primaryKey),R.key}},primaryKey:{get:function(){var W=R.primaryKey;return E.addKey(W),W}},value:{get:function(){return C&&A.addKey(R.primaryKey),R.value}}})}return T})}E.add(r)}}return u[y].apply(this,arguments)}}),w}})}};function us(e,t,r){if(r.numFailures===0)return t;if(t.type==="deleteRange")return null;var a=t.keys?t.keys.length:"values"in t&&t.values?t.values.length:1;return r.numFailures===a?null:(t=s({},t),O(t.keys)&&(t.keys=t.keys.filter(function(u,l){return!(l in r.failures)})),"values"in t&&O(t.values)&&(t.values=t.values.filter(function(u,l){return!(l in r.failures)})),t)}function Qr(e,t){return r=e,((a=t).lower===void 0||(a.lowerOpen?0<Y(r,a.lower):0<=Y(r,a.lower)))&&(e=e,(t=t).upper===void 0||(t.upperOpen?Y(e,t.upper)<0:Y(e,t.upper)<=0));var r,a}function cs(e,t,x,a,u,l){if(!x||x.length===0)return e;var f=t.query.index,h=f.multiEntry,m=t.query.range,g=a.schema.primaryKey.extractKey,w=f.extractKey,p=(f.lowLevelIndex||f).extractKey,x=x.reduce(function(y,b){var _=y,v=[];if(b.type==="add"||b.type==="put")for(var k=new ke,P=b.values.length-1;0<=P;--P){var A,E=b.values[P],M=g(E);k.hasKey(M)||(A=w(E),(h&&O(A)?A.some(function(R){return Qr(R,m)}):Qr(A,m))&&(k.addKey(M),v.push(E)))}switch(b.type){case"add":var D=new ke().addKeys(t.values?y.map(function(C){return g(C)}):y),_=y.concat(t.values?v.filter(function(C){return C=g(C),!D.hasKey(C)&&(D.addKey(C),!0)}):v.map(function(C){return g(C)}).filter(function(C){return!D.hasKey(C)&&(D.addKey(C),!0)}));break;case"put":var I=new ke().addKeys(b.values.map(function(C){return g(C)}));_=y.filter(function(C){return!I.hasKey(t.values?g(C):C)}).concat(t.values?v:v.map(function(C){return g(C)}));break;case"delete":var T=new ke().addKeys(b.keys);_=y.filter(function(C){return!T.hasKey(t.values?g(C):C)});break;case"deleteRange":var j=b.range;_=y.filter(function(C){return!Qr(g(C),j)})}return _},e);return x===e?e:(x.sort(function(y,b){return Y(p(y),p(b))||Y(g(y),g(b))}),t.limit&&t.limit<1/0&&(x.length>t.limit?x.length=t.limit:e.length===t.limit&&x.length<t.limit&&(u.dirty=!0)),l?Object.freeze(x):x)}function ls(e,t){return Y(e.lower,t.lower)===0&&Y(e.upper,t.upper)===0&&!!e.lowerOpen==!!t.lowerOpen&&!!e.upperOpen==!!t.upperOpen}function Ma(e,t){return function(r,a,u,l){if(r===void 0)return a!==void 0?-1:0;if(a===void 0)return 1;if((a=Y(r,a))===0){if(u&&l)return 0;if(u)return 1;if(l)return-1}return a}(e.lower,t.lower,e.lowerOpen,t.lowerOpen)<=0&&0<=function(r,a,u,l){if(r===void 0)return a!==void 0?1:0;if(a===void 0)return-1;if((a=Y(r,a))===0){if(u&&l)return 0;if(u)return-1;if(l)return 1}return a}(e.upper,t.upper,e.upperOpen,t.upperOpen)}function Ia(e,t,r,a){e.subscribers.add(r),a.addEventListener("abort",function(){var u,l;e.subscribers.delete(r),e.subscribers.size===0&&(u=e,l=t,setTimeout(function(){u.subscribers.size===0&&ye(l,u)},3e3))})}var Ta={stack:"dbcore",level:0,name:"Cache",create:function(e){var t=e.schema.name;return s(s({},e),{transaction:function(r,a,u){var l,f,h=e.transaction(r,a,u);return a==="readwrite"&&(f=(l=new AbortController).signal,u=function(m){return function(){if(l.abort(),a==="readwrite"){for(var g=new Set,w=0,p=r;w<p.length;w++){var x=p[w],y=wt["idb://".concat(t,"/").concat(x)];if(y){var b=e.table(x),_=y.optimisticOps.filter(function(C){return C.trans===h});if(h._explicit&&m&&h.mutatedParts)for(var v=0,k=Object.values(y.queries.query);v<k.length;v++)for(var P=0,A=(D=k[v]).slice();P<A.length;P++)Hr((I=A[P]).obsSet,h.mutatedParts)&&(ye(D,I),I.subscribers.forEach(function(C){return g.add(C)}));else if(0<_.length){y.optimisticOps=y.optimisticOps.filter(function(C){return C.trans!==h});for(var E=0,M=Object.values(y.queries.query);E<M.length;E++)for(var D,I,T,j=0,R=(D=M[E]).slice();j<R.length;j++)(I=R[j]).res!=null&&h.mutatedParts&&(m&&!I.dirty?(T=Object.isFrozen(I.res),T=cs(I.res,I.req,_,b,I,T),I.dirty?(ye(D,I),I.subscribers.forEach(function(C){return g.add(C)})):T!==I.res&&(I.res=T,I.promise=K.resolve({result:T}))):(I.dirty&&ye(D,I),I.subscribers.forEach(function(C){return g.add(C)})))}}}g.forEach(function(C){return C()})}}},h.addEventListener("abort",u(!1),{signal:f}),h.addEventListener("error",u(!1),{signal:f}),h.addEventListener("complete",u(!0),{signal:f})),h},table:function(r){var a=e.table(r),u=a.schema.primaryKey;return s(s({},a),{mutate:function(l){var f=N.trans;if(u.outbound||f.db._options.cache==="disabled"||f.explicit||f.idbtrans.mode!=="readwrite")return a.mutate(l);var h=wt["idb://".concat(t,"/").concat(r)];return h?(f=a.mutate(l),l.type!=="add"&&l.type!=="put"||!(50<=l.values.length||Yr(u,l).some(function(m){return m==null}))?(h.optimisticOps.push(l),l.mutatedParts&&qn(l.mutatedParts),f.then(function(m){0<m.numFailures&&(ye(h.optimisticOps,l),(m=us(0,l,m))&&h.optimisticOps.push(m),l.mutatedParts&&qn(l.mutatedParts))}),f.catch(function(){ye(h.optimisticOps,l),l.mutatedParts&&qn(l.mutatedParts)})):f.then(function(m){var g=us(0,s(s({},l),{values:l.values.map(function(w,p){var x;return m.failures[p]?w:(w=(x=u.keyPath)!==null&&x!==void 0&&x.includes(".")?Be(w):s({},w),re(w,u.keyPath,m.results[p]),w)})}),m);h.optimisticOps.push(g),queueMicrotask(function(){return l.mutatedParts&&qn(l.mutatedParts)})}),f):a.mutate(l)},query:function(l){if(!as(N,a)||!os("query",l))return a.query(l);var f=((g=N.trans)===null||g===void 0?void 0:g.db._options.cache)==="immutable",p=N,h=p.requery,m=p.signal,g=function(b,_,v,k){var P=wt["idb://".concat(b,"/").concat(_)];if(!P)return[];if(!(_=P.queries[v]))return[null,!1,P,null];var A=_[(k.query?k.query.index.name:null)||""];if(!A)return[null,!1,P,null];switch(v){case"query":var E=A.find(function(M){return M.req.limit===k.limit&&M.req.values===k.values&&ls(M.req.query.range,k.query.range)});return E?[E,!0,P,A]:[A.find(function(M){return("limit"in M.req?M.req.limit:1/0)>=k.limit&&(!k.values||M.req.values)&&Ma(M.req.query.range,k.query.range)}),!1,P,A];case"count":return E=A.find(function(M){return ls(M.req.query.range,k.query.range)}),[E,!!E,P,A]}}(t,r,"query",l),w=g[0],p=g[1],x=g[2],y=g[3];return w&&p?w.obsSet=l.obsSet:(p=a.query(l).then(function(b){var _=b.result;if(w&&(w.res=_),f){for(var v=0,k=_.length;v<k;++v)Object.freeze(_[v]);Object.freeze(_)}else b.result=Be(_);return b}).catch(function(b){return y&&w&&ye(y,w),Promise.reject(b)}),w={obsSet:l.obsSet,promise:p,subscribers:new Set,type:"query",req:l,dirty:!1},y?y.push(w):(y=[w],(x=x||(wt["idb://".concat(t,"/").concat(r)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[l.query.index.name||""]=y)),Ia(w,y,h,m),w.promise.then(function(b){return{result:cs(b.result,l,x==null?void 0:x.optimisticOps,a,w,f)}})}})}})}};function Fn(e,t){return new Proxy(e,{get:function(r,a,u){return a==="db"?t:Reflect.get(r,a,u)}})}var Xe=(fe.prototype.version=function(e){if(isNaN(e)||e<.1)throw new $.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new $.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,r=t.filter(function(a){return a._cfg.version===e})[0];return r||(r=new this.Version(e),t.push(r),t.sort(wa),r.stores({}),this._state.autoSchema=!1,r)},fe.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||N.letThrough||this._vip)?e():new K(function(r,a){if(t._state.openComplete)return a(new $.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._state.autoOpen)return void a(new $.DatabaseClosed);t.open().catch(te)}t._state.dbReadyPromise.then(r,a)}).then(e)},fe.prototype.use=function(e){var t=e.stack,r=e.create,a=e.level,u=e.name;return u&&this.unuse({stack:t,name:u}),e=this._middlewares[t]||(this._middlewares[t]=[]),e.push({stack:t,create:r,level:a??10,name:u}),e.sort(function(l,f){return l.level-f.level}),this},fe.prototype.unuse=function(e){var t=e.stack,r=e.name,a=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(function(u){return a?u.create!==a:!!r&&u.name!==r})),this},fe.prototype.open=function(){var e=this;return gt(Ze,function(){return ka(e)})},fe.prototype._close=function(){var e=this._state,t=Mt.indexOf(this);if(0<=t&&Mt.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}e.isBeingOpened||(e.dbReadyPromise=new K(function(r){e.dbReadyResolve=r}),e.openCanceller=new K(function(r,a){e.cancelOpen=a}))},fe.prototype.close=function(r){var t=(r===void 0?{disableAutoOpen:!0}:r).disableAutoOpen,r=this._state;t?(r.isBeingOpened&&r.cancelOpen(new $.DatabaseClosed),this._close(),r.autoOpen=!1,r.dbOpenError=new $.DatabaseClosed):(this._close(),r.autoOpen=this._options.autoOpen||r.isBeingOpened,r.openComplete=!1,r.dbOpenError=null)},fe.prototype.delete=function(e){var t=this;e===void 0&&(e={disableAutoOpen:!0});var r=0<arguments.length&&typeof arguments[0]!="object",a=this._state;return new K(function(u,l){function f(){t.close(e);var h=t._deps.indexedDB.deleteDatabase(t.name);h.onsuccess=oe(function(){var m,g,w;m=t._deps,g=t.name,w=m.indexedDB,m=m.IDBKeyRange,Ur(w)||g===Pn||$r(w,m).delete(g).catch(te),u()}),h.onerror=We(l),h.onblocked=t._fireOnBlocked}if(r)throw new $.InvalidArgument("Invalid closeOptions argument to db.delete()");a.isBeingOpened?a.dbReadyPromise.then(f):f()})},fe.prototype.backendDB=function(){return this.idbdb},fe.prototype.isOpen=function(){return this.idbdb!==null},fe.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"},fe.prototype.hasFailed=function(){return this._state.dbOpenError!==null},fe.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(fe.prototype,"tables",{get:function(){var e=this;return S(this._allTables).map(function(t){return e._allTables[t]})},enumerable:!1,configurable:!0}),fe.prototype.transaction=function(){var e=(function(t,r,a){var u=arguments.length;if(u<2)throw new $.InvalidArgument("Too few arguments");for(var l=new Array(u-1);--u;)l[u-1]=arguments[u];return a=l.pop(),[t,pn(l),a]}).apply(this,arguments);return this._transaction.apply(this,e)},fe.prototype._transaction=function(e,t,r){var a=this,u=N.trans;u&&u.db===this&&e.indexOf("!")===-1||(u=null);var l,f,h=e.indexOf("?")!==-1;e=e.replace("!","").replace("?","");try{if(f=t.map(function(g){if(g=g instanceof a.Table?g.name:g,typeof g!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return g}),e=="r"||e===Mr)l=Mr;else{if(e!="rw"&&e!=Ir)throw new $.InvalidArgument("Invalid transaction mode: "+e);l=Ir}if(u){if(u.mode===Mr&&l===Ir){if(!h)throw new $.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");u=null}u&&f.forEach(function(g){if(u&&u.storeNames.indexOf(g)===-1){if(!h)throw new $.SubTransaction("Table "+g+" not included in parent transaction.");u=null}}),h&&u&&!u.active&&(u=null)}}catch(g){return u?u._promise(null,function(w,p){p(g)}):le(g)}var m=(function g(w,p,x,y,b){return K.resolve().then(function(){var _=N.transless||N,v=w._createTransaction(p,x,w._dbSchema,y);if(v.explicit=!0,_={trans:v,transless:_},y)v.idbtrans=y.idbtrans;else try{v.create(),v.idbtrans._explicit=!0,w._state.PR1398_maxLoop=3}catch(A){return A.name===br.InvalidState&&w.isOpen()&&0<--w._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),w.close({disableAutoOpen:!1}),w.open().then(function(){return g(w,p,x,null,b)})):le(A)}var k,P=Ke(b);return P&&Ot(),_=K.follow(function(){var A;(k=b.call(v,v))&&(P?(A=tt.bind(null,null),k.then(A,A)):typeof k.next=="function"&&typeof k.throw=="function"&&(k=zr(k)))},_),(k&&typeof k.then=="function"?K.resolve(k).then(function(A){return v.active?A:le(new $.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):_.then(function(){return k})).then(function(A){return y&&v._resolve(),v._completion.then(function(){return A})}).catch(function(A){return v._reject(A),le(A)})})}).bind(null,this,l,f,u,r);return u?u._promise(l,m,"lock"):N.trans?gt(N.transless,function(){return a._whenReady(m)}):this._whenReady(m)},fe.prototype.table=function(e){if(!F(this._allTables,e))throw new $.InvalidTable("Table ".concat(e," does not exist"));return this._allTables[e]},fe);function fe(e,t){var r=this;this._middlewares={},this.verno=0;var a=fe.dependencies;this._options=t=s({addons:fe.addons,autoOpen:!0,indexedDB:a.indexedDB,IDBKeyRange:a.IDBKeyRange,cache:"cloned"},t),this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange},a=t.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var u,l,f,h,m,g={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:te,dbReadyPromise:null,cancelOpen:te,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:t.autoOpen};g.dbReadyPromise=new K(function(p){g.dbReadyResolve=p}),g.openCanceller=new K(function(p,x){g.cancelOpen=x}),this._state=g,this.name=e,this.on=Ht(this,"populate","blocked","versionchange","close",{ready:[wr,te]}),this.on.ready.subscribe=ue(this.on.ready.subscribe,function(p){return function(x,y){fe.vip(function(){var b,_=r._state;_.openComplete?(_.dbOpenError||K.resolve().then(x),y&&p(x)):_.onReadyBeingFired?(_.onReadyBeingFired.push(x),y&&p(x)):(p(x),b=r,y||p(function v(){b.on.ready.unsubscribe(x),b.on.ready.unsubscribe(v)}))})}}),this.Collection=(u=this,Vt(da.prototype,function(k,v){this.db=u;var y=$i,b=null;if(v)try{y=v()}catch(P){b=P}var _=k._ctx,v=_.table,k=v.hook.reading.fire;this._ctx={table:v,index:_.index,isPrimKey:!_.index||v.schema.primKey.keyPath&&_.index===v.schema.primKey.name,range:y,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:b,or:_.or,valueMapper:k!==Ft?k:null}})),this.Table=(l=this,Vt(Hi.prototype,function(p,x,y){this.db=l,this._tx=y,this.name=p,this.schema=x,this.hook=l._allTables[p]?l._allTables[p].hook:Ht(null,{creating:[ia,te],reading:[ra,Ft],updating:[aa,te],deleting:[sa,te]})})),this.Transaction=(f=this,Vt(ya.prototype,function(p,x,y,b,_){var v=this;this.db=f,this.mode=p,this.storeNames=x,this.schema=y,this.chromeTransactionDurability=b,this.idbtrans=null,this.on=Ht(this,"complete","error","abort"),this.parent=_||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new K(function(k,P){v._resolve=k,v._reject=P}),this._completion.then(function(){v.active=!1,v.on.complete.fire()},function(k){var P=v.active;return v.active=!1,v.on.error.fire(k),v.parent?v.parent._reject(k):P&&v.idbtrans&&v.idbtrans.abort(),le(k)})})),this.Version=(h=this,Vt(Sa.prototype,function(p){this.db=h,this._cfg={version:p,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(m=this,Vt(Xi.prototype,function(p,x,y){if(this.db=m,this._ctx={table:p,index:x===":id"?null:x,or:y},this._cmp=this._ascending=Y,this._descending=function(b,_){return Y(_,b)},this._max=function(b,_){return 0<Y(b,_)?b:_},this._min=function(b,_){return Y(b,_)<0?b:_},this._IDBKeyRange=m._deps.IDBKeyRange,!this._IDBKeyRange)throw new $.MissingAPI})),this.on("versionchange",function(p){0<p.newVersion?console.warn("Another connection wants to upgrade database '".concat(r.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(r.name,"'. Closing db now to resume the delete request.")),r.close({disableAutoOpen:!1})}),this.on("blocked",function(p){!p.newVersion||p.newVersion<p.oldVersion?console.warn("Dexie.delete('".concat(r.name,"') was blocked")):console.warn("Upgrade '".concat(r.name,"' blocked by other connection holding version ").concat(p.oldVersion/10))}),this._maxKey=Xt(t.IDBKeyRange),this._createTransaction=function(p,x,y,b){return new r.Transaction(p,x,y,r._options.chromeTransactionDurability,b)},this._fireOnBlocked=function(p){r.on("blocked").fire(p),Mt.filter(function(x){return x.name===r.name&&x!==r&&!x._state.vcFired}).map(function(x){return x.on("versionchange").fire(p)})},this.use(Ea),this.use(Ta),this.use(Oa),this.use(Pa),this.use(Aa);var w=new Proxy(this,{get:function(p,x,y){if(x==="_vip")return!0;if(x==="table")return function(_){return Fn(r.table(_),w)};var b=Reflect.get(p,x,y);return b instanceof Hi?Fn(b,w):x==="tables"?b.map(function(_){return Fn(_,w)}):x==="_createTransaction"?function(){return Fn(b.apply(this,arguments),w)}:b}});this.vip=w,a.forEach(function(p){return p(r)})}var $n,Ce=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Ra=(Zr.prototype.subscribe=function(e,t,r){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:r})},Zr.prototype[Ce]=function(){return this},Zr);function Zr(e){this._subscribe=e}try{$n={indexedDB:d.indexedDB||d.mozIndexedDB||d.webkitIndexedDB||d.msIndexedDB,IDBKeyRange:d.IDBKeyRange||d.webkitIDBKeyRange}}catch{$n={indexedDB:null,IDBKeyRange:null}}function fs(e){var t,r=!1,a=new Ra(function(u){var l=Ke(e),f,h=!1,m={},g={},w={get closed(){return h},unsubscribe:function(){h||(h=!0,f&&f.abort(),p&&it.storagemutated.unsubscribe(y))}};u.start&&u.start(w);var p=!1,x=function(){return Or(b)},y=function(_){Cn(m,_),Hr(g,m)&&x()},b=function(){var _,v,k;!h&&$n.indexedDB&&(m={},_={},f&&f.abort(),f=new AbortController,k=function(P){var A=At();try{l&&Ot();var E=et(e,P);return E=l?E.finally(tt):E}finally{A&&Et()}}(v={subscr:_,signal:f.signal,requery:x,querier:e,trans:null}),Promise.resolve(k).then(function(P){r=!0,t=P,h||v.signal.aborted||(m={},function(A){for(var E in A)if(F(A,E))return;return 1}(g=_)||p||(it(zt,y),p=!0),Or(function(){return!h&&u.next&&u.next(P)}))},function(P){r=!1,["DatabaseClosedError","AbortError"].includes(P==null?void 0:P.name)||h||Or(function(){h||u.error&&u.error(P)})}))};return setTimeout(x,0),w});return a.hasValue=function(){return r},a.getValue=function(){return t},a}var _t=Xe;function ei(e){var t=st;try{st=!0,it.storagemutated.fire(e),Gr(e,!0)}finally{st=t}}L(_t,s(s({},yn),{delete:function(e){return new _t(e,{addons:[]}).delete()},exists:function(e){return new _t(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return t=_t.dependencies,r=t.indexedDB,t=t.IDBKeyRange,(Ur(r)?Promise.resolve(r.databases()).then(function(a){return a.map(function(u){return u.name}).filter(function(u){return u!==Pn})}):$r(r,t).toCollection().primaryKeys()).then(e)}catch{return le(new $.MissingAPI)}var t,r},defineClass:function(){return function(e){B(this,e)}},ignoreTransaction:function(e){return N.trans?gt(N.transless,e):e()},vip:Lr,async:function(e){return function(){try{var t=zr(e.apply(this,arguments));return t&&typeof t.then=="function"?t:K.resolve(t)}catch(r){return le(r)}}},spawn:function(e,t,r){try{var a=zr(e.apply(r,t||[]));return a&&typeof a.then=="function"?a:K.resolve(a)}catch(u){return le(u)}},currentTransaction:{get:function(){return N.trans||null}},waitFor:function(e,t){return t=K.resolve(typeof e=="function"?_t.ignoreTransaction(e):e).timeout(t||6e4),N.trans?N.trans.waitFor(t):t},Promise:K,debug:{get:function(){return Le},set:function(e){ji(e)}},derive:me,extend:B,props:L,override:ue,Events:Ht,on:it,liveQuery:fs,extendObservabilitySet:Cn,getByKeyPath:de,setByKeyPath:re,delByKeyPath:function(e,t){typeof t=="string"?re(e,t,void 0):"length"in t&&[].map.call(t,function(r){re(e,r,void 0)})},shallowClone:pe,deepClone:Be,getObjectDiff:Xr,cmp:Y,asap:Je,minKey:-1/0,addons:[],connections:Mt,errnames:br,dependencies:$n,cache:wt,semVer:"4.0.11",version:"4.0.11".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,r){return e+t/Math.pow(10,2*r)})})),_t.maxKey=Xt(_t.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(it(zt,function(e){st||(e=new CustomEvent(jr,{detail:e}),st=!0,dispatchEvent(e),st=!1)}),addEventListener(jr,function(e){e=e.detail,st||ei(e)}));var Rt,st=!1,hs=function(){};return typeof BroadcastChannel<"u"&&((hs=function(){(Rt=new BroadcastChannel(jr)).onmessage=function(e){return e.data&&ei(e.data)}})(),typeof Rt.unref=="function"&&Rt.unref(),it(zt,function(e){st||Rt.postMessage(e)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(e){if(!Xe.disableBfCache&&e.persisted){Le&&console.debug("Dexie: handling persisted pagehide"),Rt!=null&&Rt.close();for(var t=0,r=Mt;t<r.length;t++)r[t].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(e){!Xe.disableBfCache&&e.persisted&&(Le&&console.debug("Dexie: handling persisted pageshow"),hs(),ei({all:new ke(-1/0,[[]])}))})),K.rejectionMapper=function(e,t){return!e||e instanceof _e||e instanceof TypeError||e instanceof SyntaxError||!e.name||!Di[e.name]?e:(t=new Di[e.name](t||e.message,e),"stack"in e&&ae(t,"stack",{get:function(){return this.inner.stack}}),t)},ji(Le),s(Xe,Object.freeze({__proto__:null,Dexie:Xe,liveQuery:fs,Entity:Ui,cmp:Y,PropModification:Jt,replacePrefix:function(e,t){return new Jt({replacePrefix:[e,t]})},add:function(e){return new Jt({add:e})},remove:function(e){return new Jt({remove:e})},default:Xe,RangeSet:ke,mergeRanges:Zt,rangesOverlap:ts}),{default:Xe}),Xe})}(sr)),sr.exports}var qa=Ca();const vi=Ba(qa),ps=Symbol.for("Dexie"),ar=globalThis[ps]||(globalThis[ps]=vi);if(vi.semVer!==ar.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${vi.semVer} and ${ar.semVer}`);const{liveQuery:Yo,mergeRanges:Qo,rangesOverlap:Zo,RangeSet:eu,cmp:tu,Entity:nu,PropModification:ru,replacePrefix:iu,add:su,remove:au}=ar,bi={theme:"system",apiKeys:{anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434"},videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1,preserveKeyFormat:!1},{subscribe:Na,set:ni,update:ri}=Ts(bi),fr={subscribe:Na,async loadSettings(){try{const o=await ir.settings.get("user-settings");o?(console.log("Loaded settings from IndexedDB:",o),o.apiKeys?Object.entries(o.apiKeys).forEach(([n,i])=>{i&&typeof i=="string"&&i.length>0?console.log(`Found ${n} API key (length: ${i.length}, starts with: ${i.substring(0,4)}...)`):console.log(`No ${n} API key found in settings`)}):(console.warn("No API keys object found in loaded settings"),o.apiKeys={anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434"}),ni(o)):(console.log("Creating default settings in IndexedDB"),await ir.settings.add({...bi,id:"user-settings"}),ni(bi))}catch(o){console.error("Failed to load settings from IndexedDB:",o);try{const n=localStorage.getItem("gervais-settings");if(n){console.log("Found settings in localStorage, migrating to IndexedDB");const i=JSON.parse(n);ni(i),await ir.settings.add({...i,id:"user-settings"}),localStorage.removeItem("gervais-settings")}}catch(n){console.error("Failed to load settings from localStorage:",n)}}},async saveSettings(o){try{console.log("Saving settings to IndexedDB:",o),await ir.settings.put({...o,id:"user-settings"})}catch(n){console.error("Failed to save settings to IndexedDB:",n);try{localStorage.setItem("gervais-settings",JSON.stringify(o)),console.log("Saved settings to localStorage as fallback")}catch(i){console.error("Failed to save settings to localStorage:",i)}}},async updateApiKeys(o){ri(n=>{const i={...n,apiKeys:{...n.apiKeys,...o}};return this.saveSettings(i).catch(console.error),i})},async updateSettings(o){ri(n=>{const i={...n,...o,apiKeys:{...n.apiKeys,...o.apiKeys||{}}};return this.saveSettings(i).catch(console.error),i})},updateTheme(o){ri(n=>{const i={...n,theme:o};return this.saveSettings(i).catch(console.error),i})},async init(){await this.loadSettings()}},Bt="0.39.0";let ms=!1,fn,Rs,wi,Ds,js,Bs;function Fa(o,n={auto:!1}){if(ms)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${o.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(fn)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${o.kind}'\` after \`import '@anthropic-ai/sdk/shims/${fn}'\``);ms=n.auto,fn=o.kind,Rs=o.fetch,wi=o.File,Ds=o.ReadableStream,js=o.getDefaultAgent,Bs=o.fileFromPath}class $a{constructor(n){this.body=n}get[Symbol.toStringTag](){return"MultipartBody"}}function Ua({manuallyImported:o}={}){const n=o?"You may need to use polyfills":"Add one of these imports before your first `import â¦ from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let i,s,c,d;try{i=fetch,s=Request,c=Response,d=Headers}catch(S){throw new Error(`this environment is missing the following Web Fetch API type: ${S.message}. ${n}`)}return{kind:"web",fetch:i,Request:s,Response:c,Headers:d,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${n}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${n}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${n}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${n}`)}},getMultipartRequestOptions:async(S,O)=>({...O,body:new $a(S)}),getDefaultAgent:S=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:S=>!1}}fn||Fa(Ua(),{auto:!0});class Q extends Error{}class Me extends Q{constructor(n,i,s,c){super(`${Me.makeMessage(n,i,s)}`),this.status=n,this.headers=c,this.request_id=c==null?void 0:c["request-id"],this.error=i}static makeMessage(n,i,s){const c=i!=null&&i.message?typeof i.message=="string"?i.message:JSON.stringify(i.message):i?JSON.stringify(i):s;return n&&c?`${n} ${c}`:n?`${n} status code (no body)`:c||"(no status code or body)"}static generate(n,i,s,c){if(!n||!c)return new hr({message:s,cause:_i(i)});const d=i;return n===400?new Cs(n,d,s,c):n===401?new qs(n,d,s,c):n===403?new Ns(n,d,s,c):n===404?new Fs(n,d,s,c):n===409?new $s(n,d,s,c):n===422?new Us(n,d,s,c):n===429?new Ls(n,d,s,c):n>=500?new Ws(n,d,s,c):new Me(n,d,s,c)}}class Ue extends Me{constructor({message:n}={}){super(void 0,void 0,n||"Request was aborted.",void 0)}}class hr extends Me{constructor({message:n,cause:i}){super(void 0,void 0,n||"Connection error.",void 0),i&&(this.cause=i)}}class Ks extends hr{constructor({message:n}={}){super({message:n??"Request timed out."})}}class Cs extends Me{}class qs extends Me{}class Ns extends Me{}class Fs extends Me{}class $s extends Me{}class Us extends Me{}class Ls extends Me{}class Ws extends Me{}var Ln=function(o,n,i,s,c){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?o!==n||!c:!n.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?c.call(o,i):c?c.value=i:n.set(o,i),i},St=function(o,n,i,s){if(i==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?o!==n||!s:!n.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return i==="m"?s:i==="a"?s.call(o):s?s.value:n.get(o)},je;class hn{constructor(){je.set(this,void 0),this.buffer=new Uint8Array,Ln(this,je,null,"f")}decode(n){if(n==null)return[];const i=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?new TextEncoder().encode(n):n;let s=new Uint8Array(this.buffer.length+i.length);s.set(this.buffer),s.set(i,this.buffer.length),this.buffer=s;const c=[];let d;for(;(d=La(this.buffer,St(this,je,"f")))!=null;){if(d.carriage&&St(this,je,"f")==null){Ln(this,je,d.index,"f");continue}if(St(this,je,"f")!=null&&(d.index!==St(this,je,"f")+1||d.carriage)){c.push(this.decodeText(this.buffer.slice(0,St(this,je,"f")-1))),this.buffer=this.buffer.slice(St(this,je,"f")),Ln(this,je,null,"f");continue}const S=St(this,je,"f")!==null?d.preceding-1:d.preceding,O=this.decodeText(this.buffer.slice(0,S));c.push(O),this.buffer=this.buffer.slice(d.index),Ln(this,je,null,"f")}return c}decodeText(n){if(n==null)return"";if(typeof n=="string")return n;if(typeof Buffer<"u"){if(n instanceof Buffer)return n.toString();if(n instanceof Uint8Array)return Buffer.from(n).toString();throw new Q(`Unexpected: received non-Uint8Array (${n.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(n instanceof Uint8Array||n instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(n);throw new Q(`Unexpected: received non-Uint8Array/ArrayBuffer (${n.constructor.name}) in a web platform. Please report this error.`)}throw new Q("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}je=new WeakMap;hn.NEWLINE_CHARS=new Set([`
`,"\r"]);hn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function La(o,n){for(let c=n??0;c<o.length;c++){if(o[c]===10)return{preceding:c,index:c+1,carriage:!1};if(o[c]===13)return{preceding:c,index:c+1,carriage:!0}}return null}function Wa(o){for(let s=0;s<o.length-1;s++){if(o[s]===10&&o[s+1]===10||o[s]===13&&o[s+1]===13)return s+2;if(o[s]===13&&o[s+1]===10&&s+3<o.length&&o[s+2]===13&&o[s+3]===10)return s+4}return-1}function xi(o){if(o[Symbol.asyncIterator])return o;const n=o.getReader();return{async next(){try{const i=await n.read();return i!=null&&i.done&&n.releaseLock(),i}catch(i){throw n.releaseLock(),i}},async return(){const i=n.cancel();return n.releaseLock(),await i,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Ve{constructor(n,i){this.iterator=n,this.controller=i}static fromSSEResponse(n,i){let s=!1;async function*c(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let d=!1;try{for await(const S of Ha(n,i)){if(S.event==="completion")try{yield JSON.parse(S.data)}catch(O){throw console.error("Could not parse message into JSON:",S.data),console.error("From chunk:",S.raw),O}if(S.event==="message_start"||S.event==="message_delta"||S.event==="message_stop"||S.event==="content_block_start"||S.event==="content_block_delta"||S.event==="content_block_stop")try{yield JSON.parse(S.data)}catch(O){throw console.error("Could not parse message into JSON:",S.data),console.error("From chunk:",S.raw),O}if(S.event!=="ping"&&S.event==="error")throw Me.generate(void 0,`SSE Error: ${S.data}`,S.data,Js(n.headers))}d=!0}catch(S){if(S instanceof Error&&S.name==="AbortError")return;throw S}finally{d||i.abort()}}return new Ve(c,i)}static fromReadableStream(n,i){let s=!1;async function*c(){const S=new hn,O=xi(n);for await(const B of O)for(const q of S.decode(B))yield q;for(const B of S.flush())yield B}async function*d(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let S=!1;try{for await(const O of c())S||O&&(yield JSON.parse(O));S=!0}catch(O){if(O instanceof Error&&O.name==="AbortError")return;throw O}finally{S||i.abort()}}return new Ve(d,i)}[Symbol.asyncIterator](){return this.iterator()}tee(){const n=[],i=[],s=this.iterator(),c=d=>({next:()=>{if(d.length===0){const S=s.next();n.push(S),i.push(S)}return d.shift()}});return[new Ve(()=>c(n),this.controller),new Ve(()=>c(i),this.controller)]}toReadableStream(){const n=this;let i;const s=new TextEncoder;return new Ds({async start(){i=n[Symbol.asyncIterator]()},async pull(c){try{const{value:d,done:S}=await i.next();if(S)return c.close();const O=s.encode(JSON.stringify(d)+`
`);c.enqueue(O)}catch(d){c.error(d)}},async cancel(){var c;await((c=i.return)==null?void 0:c.call(i))}})}}async function*Ha(o,n){if(!o.body)throw n.abort(),new Q("Attempted to iterate over a response with no body");const i=new Ja,s=new hn,c=xi(o.body);for await(const d of Va(c))for(const S of s.decode(d)){const O=i.decode(S);O&&(yield O)}for(const d of s.flush()){const S=i.decode(d);S&&(yield S)}}async function*Va(o){let n=new Uint8Array;for await(const i of o){if(i==null)continue;const s=i instanceof ArrayBuffer?new Uint8Array(i):typeof i=="string"?new TextEncoder().encode(i):i;let c=new Uint8Array(n.length+s.length);c.set(n),c.set(s,n.length),n=c;let d;for(;(d=Wa(n))!==-1;)yield n.slice(0,d),n=n.slice(d)}n.length>0&&(yield n)}class Ja{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(n){if(n.endsWith("\r")&&(n=n.substring(0,n.length-1)),!n){if(!this.event&&!this.data.length)return null;const d={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],d}if(this.chunks.push(n),n.startsWith(":"))return null;let[i,s,c]=Ga(n,":");return c.startsWith(" ")&&(c=c.substring(1)),i==="event"?this.event=c:i==="data"&&this.data.push(c),null}}function Ga(o,n){const i=o.indexOf(n);return i!==-1?[o.substring(0,i),n,o.substring(i+n.length)]:[o,"",""]}const za=o=>o!=null&&typeof o=="object"&&typeof o.url=="string"&&typeof o.blob=="function",Xa=o=>o!=null&&typeof o=="object"&&typeof o.name=="string"&&typeof o.lastModified=="number"&&dr(o),dr=o=>o!=null&&typeof o=="object"&&typeof o.size=="number"&&typeof o.type=="string"&&typeof o.text=="function"&&typeof o.slice=="function"&&typeof o.arrayBuffer=="function";async function Ya(o,n,i){var c;if(o=await o,Xa(o))return o;if(za(o)){const d=await o.blob();n||(n=new URL(o.url).pathname.split(/[\\/]/).pop()??"unknown_file");const S=dr(d)?[await d.arrayBuffer()]:[d];return new wi(S,n,i)}const s=await Qa(o);if(n||(n=eo(o)??"unknown_file"),!(i!=null&&i.type)){const d=(c=s[0])==null?void 0:c.type;typeof d=="string"&&(i={...i,type:d})}return new wi(s,n,i)}async function Qa(o){var i;let n=[];if(typeof o=="string"||ArrayBuffer.isView(o)||o instanceof ArrayBuffer)n.push(o);else if(dr(o))n.push(await o.arrayBuffer());else if(to(o))for await(const s of o)n.push(s);else throw new Error(`Unexpected data type: ${typeof o}; constructor: ${(i=o==null?void 0:o.constructor)==null?void 0:i.name}; props: ${Za(o)}`);return n}function Za(o){return`[${Object.getOwnPropertyNames(o).map(i=>`"${i}"`).join(", ")}]`}function eo(o){var n;return ii(o.name)||ii(o.filename)||((n=ii(o.path))==null?void 0:n.split(/[\\/]/).pop())}const ii=o=>{if(typeof o=="string")return o;if(typeof Buffer<"u"&&o instanceof Buffer)return String(o)},to=o=>o!=null&&typeof o=="object"&&typeof o[Symbol.asyncIterator]=="function",ys=o=>o&&typeof o=="object"&&o.body&&o[Symbol.toStringTag]==="MultipartBody";var Ct={},no=function(o,n,i,s,c){if(typeof n=="function"?o!==n||!0:!n.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n.set(o,i),i},ro=function(o,n,i,s){if(typeof n=="function"?o!==n||!0:!n.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return i==="m"?s:i==="a"?s.call(o):s?s.value:n.get(o)},Wn;async function Hs(o){const{response:n}=o;if(o.options.stream)return qt("response",n.status,n.url,n.headers,n.body),o.options.__streamClass?o.options.__streamClass.fromSSEResponse(n,o.controller):Ve.fromSSEResponse(n,o.controller);if(n.status===204)return null;if(o.options.__binaryResponse)return n;const i=n.headers.get("content-type");if((i==null?void 0:i.includes("application/json"))||(i==null?void 0:i.includes("application/vnd.api+json"))){const d=await n.json();return qt("response",n.status,n.url,n.headers,d),Vs(d,n)}const c=await n.text();return qt("response",n.status,n.url,n.headers,c),c}function Vs(o,n){return!o||typeof o!="object"||Array.isArray(o)?o:Object.defineProperty(o,"_request_id",{value:n.headers.get("request-id"),enumerable:!1})}class pr extends Promise{constructor(n,i=Hs){super(s=>{s(null)}),this.responsePromise=n,this.parseResponse=i}_thenUnwrap(n){return new pr(this.responsePromise,async i=>Vs(n(await this.parseResponse(i),i),i.response))}asResponse(){return this.responsePromise.then(n=>n.response)}async withResponse(){const[n,i]=await Promise.all([this.parse(),this.asResponse()]);return{data:n,response:i,request_id:i.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(n,i){return this.parse().then(n,i)}catch(n){return this.parse().catch(n)}finally(n){return this.parse().finally(n)}}class io{constructor({baseURL:n,maxRetries:i=2,timeout:s=6e5,httpAgent:c,fetch:d}){this.baseURL=n,this.maxRetries=si("maxRetries",i),this.timeout=si("timeout",s),this.httpAgent=c,this.fetch=d??Rs}authHeaders(n){return{}}defaultHeaders(n){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...lo(),...this.authHeaders(n)}}validateHeaders(n,i){}defaultIdempotencyKey(){return`stainless-node-retry-${yo()}`}get(n,i){return this.methodRequest("get",n,i)}post(n,i){return this.methodRequest("post",n,i)}patch(n,i){return this.methodRequest("patch",n,i)}put(n,i){return this.methodRequest("put",n,i)}delete(n,i){return this.methodRequest("delete",n,i)}methodRequest(n,i,s){return this.request(Promise.resolve(s).then(async c=>{const d=c&&dr(c==null?void 0:c.body)?new DataView(await c.body.arrayBuffer()):(c==null?void 0:c.body)instanceof DataView?c.body:(c==null?void 0:c.body)instanceof ArrayBuffer?new DataView(c.body):c&&ArrayBuffer.isView(c==null?void 0:c.body)?new DataView(c.body.buffer):c==null?void 0:c.body;return{method:n,path:i,...c,body:d}}))}getAPIList(n,i,s){return this.requestAPIList(i,{method:"get",path:n,...s})}calculateContentLength(n){if(typeof n=="string"){if(typeof Buffer<"u")return Buffer.byteLength(n,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(n).length.toString()}else if(ArrayBuffer.isView(n))return n.byteLength.toString();return null}buildRequest(n,{retryCount:i=0}={}){var ae;n={...n};const{method:s,path:c,query:d,headers:S={}}=n,O=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:ys(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,B=this.calculateContentLength(O),q=this.buildURL(c,d);"timeout"in n&&si("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const H=n.httpAgent??this.httpAgent??js(q),F=n.timeout+1e3;typeof((ae=H==null?void 0:H.options)==null?void 0:ae.timeout)=="number"&&F>(H.options.timeout??0)&&(H.options.timeout=F),this.idempotencyHeader&&s!=="get"&&(n.idempotencyKey||(n.idempotencyKey=this.defaultIdempotencyKey()),S[this.idempotencyHeader]=n.idempotencyKey);const L=this.buildHeaders({options:n,headers:S,contentLength:B,retryCount:i});return{req:{method:s,...O&&{body:O},headers:L,...H&&{agent:H},signal:n.signal??null},url:q,timeout:n.timeout}}buildHeaders({options:n,headers:i,contentLength:s,retryCount:c}){const d={};s&&(d["content-length"]=s);const S=this.defaultHeaders(n);return ws(d,S),ws(d,i),ys(n.body)&&fn!=="node"&&delete d["content-type"],Hn(S,"x-stainless-retry-count")===void 0&&Hn(i,"x-stainless-retry-count")===void 0&&(d["x-stainless-retry-count"]=String(c)),Hn(S,"x-stainless-timeout")===void 0&&Hn(i,"x-stainless-timeout")===void 0&&n.timeout&&(d["x-stainless-timeout"]=String(n.timeout)),this.validateHeaders(d,i),d}_calculateNonstreamingTimeout(n){if(3600*n/128e3>600)throw new Q("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(n){}async prepareRequest(n,{url:i,options:s}){}parseHeaders(n){return n?Symbol.iterator in n?Object.fromEntries(Array.from(n).map(i=>[...i])):{...n}:{}}makeStatusError(n,i,s,c){return Me.generate(n,i,s,c)}request(n,i=null){return new pr(this.makeRequest(n,i))}async makeRequest(n,i){var F,L;const s=await n,c=s.maxRetries??this.maxRetries;i==null&&(i=c),await this.prepareOptions(s);const{req:d,url:S,timeout:O}=this.buildRequest(s,{retryCount:c-i});if(await this.prepareRequest(d,{url:S,options:s}),qt("request",S,s,d.headers),(F=s.signal)!=null&&F.aborted)throw new Ue;const B=new AbortController,q=await this.fetchWithTimeout(S,d,O,B).catch(_i);if(q instanceof Error){if((L=s.signal)!=null&&L.aborted)throw new Ue;if(i)return this.retryRequest(s,i);throw q.name==="AbortError"?new Ks:new hr({cause:q})}const H=Js(q.headers);if(!q.ok){if(i&&this.shouldRetry(q)){const ee=`retrying, ${i} attempts remaining`;return qt(`response (error; ${ee})`,q.status,S,H),this.retryRequest(s,i,H)}const V=await q.text().catch(ee=>_i(ee).message),ae=fo(V),me=ae?void 0:V;throw qt(`response (error; ${i?"(error; no more retries left)":"(error; not retryable)"})`,q.status,S,H,me),this.makeStatusError(q.status,ae,me,H)}return{response:q,options:s,controller:B}}requestAPIList(n,i){const s=this.makeRequest(i,null);return new ao(this,s,n)}buildURL(n,i){const s=po(n)?new URL(n):new URL(this.baseURL+(this.baseURL.endsWith("/")&&n.startsWith("/")?n.slice(1):n)),c=this.defaultQuery();return or(c)||(i={...c,...i}),typeof i=="object"&&i&&!Array.isArray(i)&&(s.search=this.stringifyQuery(i)),s.toString()}stringifyQuery(n){return Object.entries(n).filter(([i,s])=>typeof s<"u").map(([i,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(i)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(i)}=`;throw new Q(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(n,i,s,c){const{signal:d,...S}=i||{};d&&d.addEventListener("abort",()=>c.abort());const O=setTimeout(()=>c.abort(),s),B={signal:c.signal,...S};B.method&&(B.method=B.method.toUpperCase());const q=60*1e3,H=setTimeout(()=>{var F,L;if(B&&((F=B==null?void 0:B.agent)!=null&&F.sockets))for(const V of Object.values((L=B==null?void 0:B.agent)==null?void 0:L.sockets).flat())V!=null&&V.setKeepAlive&&V.setKeepAlive(!0,q)},q);return this.fetch.call(void 0,n,B).finally(()=>{clearTimeout(O),clearTimeout(H)})}shouldRetry(n){const i=n.headers.get("x-should-retry");return i==="true"?!0:i==="false"?!1:n.status===408||n.status===409||n.status===429||n.status>=500}async retryRequest(n,i,s){let c;const d=s==null?void 0:s["retry-after-ms"];if(d){const O=parseFloat(d);Number.isNaN(O)||(c=O)}const S=s==null?void 0:s["retry-after"];if(S&&!c){const O=parseFloat(S);Number.isNaN(O)?c=Date.parse(S)-Date.now():c=O*1e3}if(!(c&&0<=c&&c<60*1e3)){const O=n.maxRetries??this.maxRetries;c=this.calculateDefaultRetryTimeoutMillis(i,O)}return await mo(c),this.makeRequest(n,i-1)}calculateDefaultRetryTimeoutMillis(n,i){const d=i-n,S=Math.min(.5*Math.pow(2,d),8),O=1-Math.random()*.25;return S*O*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Bt}`}}class so{constructor(n,i,s,c){Wn.set(this,void 0),no(this,Wn,n),this.options=c,this.response=i,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const n=this.nextPageInfo();if(!n)throw new Q("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const i={...this.options};if("params"in n&&typeof i.query=="object")i.query={...i.query,...n.params};else if("url"in n){const s=[...Object.entries(i.query||{}),...n.url.searchParams.entries()];for(const[c,d]of s)n.url.searchParams.set(c,d);i.query=void 0,i.path=n.url.toString()}return await ro(this,Wn,"f").requestAPIList(this.constructor,i)}async*iterPages(){let n=this;for(yield n;n.hasNextPage();)n=await n.getNextPage(),yield n}async*[(Wn=new WeakMap,Symbol.asyncIterator)](){for await(const n of this.iterPages())for(const i of n.getPaginatedItems())yield i}}class ao extends pr{constructor(n,i,s){super(i,async c=>new s(n,c.response,await Hs(c),c.options))}async*[Symbol.asyncIterator](){const n=await this;for await(const i of n)yield i}}const Js=o=>new Proxy(Object.fromEntries(o.entries()),{get(n,i){const s=i.toString();return n[s.toLowerCase()]||n[s]}}),oo={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ut=o=>typeof o=="object"&&o!==null&&!or(o)&&Object.keys(o).every(n=>Gs(oo,n)),uo=()=>{var n;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bt,"X-Stainless-OS":vs(Deno.build.os),"X-Stainless-Arch":gs(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((n=Deno.version)==null?void 0:n.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bt,"X-Stainless-OS":vs(process.platform),"X-Stainless-Arch":gs(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const o=co();return o?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${o.browser}`,"X-Stainless-Runtime-Version":o.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Bt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function co(){if(typeof navigator>"u"||!navigator)return null;const o=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:n,pattern:i}of o){const s=i.exec(navigator.userAgent);if(s){const c=s[1]||0,d=s[2]||0,S=s[3]||0;return{browser:n,version:`${c}.${d}.${S}`}}}return null}const gs=o=>o==="x32"?"x32":o==="x86_64"||o==="x64"?"x64":o==="arm"?"arm":o==="aarch64"||o==="arm64"?"arm64":o?`other:${o}`:"unknown",vs=o=>(o=o.toLowerCase(),o.includes("ios")?"iOS":o==="android"?"Android":o==="darwin"?"MacOS":o==="win32"?"Windows":o==="freebsd"?"FreeBSD":o==="openbsd"?"OpenBSD":o==="linux"?"Linux":o?`Other:${o}`:"Unknown");let bs;const lo=()=>bs??(bs=uo()),fo=o=>{try{return JSON.parse(o)}catch{return}},ho=/^[a-z][a-z0-9+.-]*:/i,po=o=>ho.test(o),mo=o=>new Promise(n=>setTimeout(n,o)),si=(o,n)=>{if(typeof n!="number"||!Number.isInteger(n))throw new Q(`${o} must be an integer`);if(n<0)throw new Q(`${o} must be a positive integer`);return n},_i=o=>{if(o instanceof Error)return o;if(typeof o=="object"&&o!==null)try{return new Error(JSON.stringify(o))}catch{}return new Error(String(o))},ai=o=>{var n,i,s,c;if(typeof process<"u")return((n=Ct==null?void 0:Ct[o])==null?void 0:n.trim())??void 0;if(typeof Deno<"u")return(c=(s=(i=Deno.env)==null?void 0:i.get)==null?void 0:s.call(i,o))==null?void 0:c.trim()};function or(o){if(!o)return!0;for(const n in o)return!1;return!0}function Gs(o,n){return Object.prototype.hasOwnProperty.call(o,n)}function ws(o,n){for(const i in n){if(!Gs(n,i))continue;const s=i.toLowerCase();if(!s)continue;const c=n[i];c===null?delete o[s]:c!==void 0&&(o[s]=c)}}function qt(o,...n){typeof process<"u"&&(Ct==null?void 0:Ct.DEBUG)==="true"&&console.log(`Anthropic:DEBUG:${o}`,...n)}const yo=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const n=Math.random()*16|0;return(o==="x"?n:n&3|8).toString(16)}),go=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",vo=o=>typeof(o==null?void 0:o.get)=="function",Hn=(o,n)=>{var s;const i=n.toLowerCase();if(vo(o)){const c=((s=n[0])==null?void 0:s.toUpperCase())+n.substring(1).replace(/([^\w])(\w)/g,(d,S,O)=>S+O.toUpperCase());for(const d of[n,i,n.toUpperCase(),c]){const S=o.get(d);if(S)return S}}for(const[c,d]of Object.entries(o))if(c.toLowerCase()===i)return Array.isArray(d)?(d.length<=1||console.warn(`Received ${d.length} entries for the ${n} header, using the first entry.`),d[0]):d};class mr extends so{constructor(n,i,s,c){super(n,i,s,c),this.data=s.data||[],this.has_more=s.has_more||!1,this.first_id=s.first_id||null,this.last_id=s.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const n=this.nextPageInfo();if(!n)return null;if("params"in n)return n.params;const i=Object.fromEntries(n.url.searchParams);return Object.keys(i).length?i:null}nextPageInfo(){var i;if((i=this.options.query)!=null&&i.before_id){const s=this.first_id;return s?{params:{before_id:s}}:null}const n=this.last_id;return n?{params:{after_id:n}}:null}}class ct{constructor(n){this._client=n}}let Si=class extends ct{retrieve(n,i){return this._client.get(`/v1/models/${n}?beta=true`,i)}list(n={},i){return ut(n)?this.list({},n):this._client.getAPIList("/v1/models?beta=true",ki,{query:n,...i})}};class ki extends mr{}Si.BetaModelInfosPage=ki;class yr{constructor(n,i){this.iterator=n,this.controller=i}async*decoder(){const n=new hn;for await(const i of this.iterator)for(const s of n.decode(i))yield JSON.parse(s);for(const i of n.flush())yield JSON.parse(i)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(n,i){if(!n.body)throw i.abort(),new Q("Attempted to iterate over a response with no body");return new yr(xi(n.body),i)}}let Pi=class extends ct{create(n,i){const{betas:s,...c}=n;return this._client.post("/v1/messages/batches?beta=true",{body:c,...i,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...i==null?void 0:i.headers}})}retrieve(n,i={},s){if(ut(i))return this.retrieve(n,{},i);const{betas:c}=i;return this._client.get(`/v1/messages/batches/${n}?beta=true`,{...s,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...s==null?void 0:s.headers}})}list(n={},i){if(ut(n))return this.list({},n);const{betas:s,...c}=n;return this._client.getAPIList("/v1/messages/batches?beta=true",Ai,{query:c,...i,headers:{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString(),...i==null?void 0:i.headers}})}delete(n,i={},s){if(ut(i))return this.delete(n,{},i);const{betas:c}=i;return this._client.delete(`/v1/messages/batches/${n}?beta=true`,{...s,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...s==null?void 0:s.headers}})}cancel(n,i={},s){if(ut(i))return this.cancel(n,{},i);const{betas:c}=i;return this._client.post(`/v1/messages/batches/${n}/cancel?beta=true`,{...s,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...s==null?void 0:s.headers}})}async results(n,i={},s){if(ut(i))return this.results(n,{},i);const c=await this.retrieve(n);if(!c.results_url)throw new Q(`No batch \`results_url\`; Has it finished processing? ${c.processing_status} - ${c.id}`);const{betas:d}=i;return this._client.get(c.results_url,{...s,headers:{"anthropic-beta":[...d??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...s==null?void 0:s.headers},__binaryResponse:!0})._thenUnwrap((S,O)=>yr.fromResponse(O.response,O.controller))}};class Ai extends mr{}Pi.BetaMessageBatchesPage=Ai;const bo=o=>{let n=0,i=[];for(;n<o.length;){let s=o[n];if(s==="\\"){n++;continue}if(s==="{"){i.push({type:"brace",value:"{"}),n++;continue}if(s==="}"){i.push({type:"brace",value:"}"}),n++;continue}if(s==="["){i.push({type:"paren",value:"["}),n++;continue}if(s==="]"){i.push({type:"paren",value:"]"}),n++;continue}if(s===":"){i.push({type:"separator",value:":"}),n++;continue}if(s===","){i.push({type:"delimiter",value:","}),n++;continue}if(s==='"'){let O="",B=!1;for(s=o[++n];s!=='"';){if(n===o.length){B=!0;break}if(s==="\\"){if(n++,n===o.length){B=!0;break}O+=s+o[n],s=o[++n]}else O+=s,s=o[++n]}s=o[++n],B||i.push({type:"string",value:O});continue}if(s&&/\s/.test(s)){n++;continue}let d=/[0-9]/;if(s&&d.test(s)||s==="-"||s==="."){let O="";for(s==="-"&&(O+=s,s=o[++n]);s&&d.test(s)||s===".";)O+=s,s=o[++n];i.push({type:"number",value:O});continue}let S=/[a-z]/i;if(s&&S.test(s)){let O="";for(;s&&S.test(s)&&n!==o.length;)O+=s,s=o[++n];if(O=="true"||O=="false"||O==="null")i.push({type:"name",value:O});else{n++;continue}continue}n++}return i},Kt=o=>{if(o.length===0)return o;let n=o[o.length-1];switch(n.type){case"separator":return o=o.slice(0,o.length-1),Kt(o);case"number":let i=n.value[n.value.length-1];if(i==="."||i==="-")return o=o.slice(0,o.length-1),Kt(o);case"string":let s=o[o.length-2];if((s==null?void 0:s.type)==="delimiter")return o=o.slice(0,o.length-1),Kt(o);if((s==null?void 0:s.type)==="brace"&&s.value==="{")return o=o.slice(0,o.length-1),Kt(o);break;case"delimiter":return o=o.slice(0,o.length-1),Kt(o)}return o},wo=o=>{let n=[];return o.map(i=>{i.type==="brace"&&(i.value==="{"?n.push("}"):n.splice(n.lastIndexOf("}"),1)),i.type==="paren"&&(i.value==="["?n.push("]"):n.splice(n.lastIndexOf("]"),1))}),n.length>0&&n.reverse().map(i=>{i==="}"?o.push({type:"brace",value:"}"}):i==="]"&&o.push({type:"paren",value:"]"})}),o},_o=o=>{let n="";return o.map(i=>{switch(i.type){case"string":n+='"'+i.value+'"';break;default:n+=i.value;break}}),n},zs=o=>JSON.parse(_o(wo(Kt(bo(o)))));var Ee=function(o,n,i,s,c){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?o!==n||!c:!n.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?c.call(o,i):c?c.value=i:n.set(o,i),i},J=function(o,n,i,s){if(i==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?o!==n||!s:!n.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return i==="m"?s:i==="a"?s.call(o):s?s.value:n.get(o)},qe,at,en,Vn,tn,nn,Jn,rn,Ye,sn,Gn,zn,Dt,Xn,Yn,oi,_s,ui,ci,li,fi,xs;const Ss="__json_buf";class ur{constructor(){qe.add(this),this.messages=[],this.receivedMessages=[],at.set(this,void 0),this.controller=new AbortController,en.set(this,void 0),Vn.set(this,()=>{}),tn.set(this,()=>{}),nn.set(this,void 0),Jn.set(this,()=>{}),rn.set(this,()=>{}),Ye.set(this,{}),sn.set(this,!1),Gn.set(this,!1),zn.set(this,!1),Dt.set(this,!1),Xn.set(this,void 0),Yn.set(this,void 0),ui.set(this,n=>{if(Ee(this,Gn,!0,"f"),n instanceof Error&&n.name==="AbortError"&&(n=new Ue),n instanceof Ue)return Ee(this,zn,!0,"f"),this._emit("abort",n);if(n instanceof Q)return this._emit("error",n);if(n instanceof Error){const i=new Q(n.message);return i.cause=n,this._emit("error",i)}return this._emit("error",new Q(String(n)))}),Ee(this,en,new Promise((n,i)=>{Ee(this,Vn,n,"f"),Ee(this,tn,i,"f")}),"f"),Ee(this,nn,new Promise((n,i)=>{Ee(this,Jn,n,"f"),Ee(this,rn,i,"f")}),"f"),J(this,en,"f").catch(()=>{}),J(this,nn,"f").catch(()=>{})}get response(){return J(this,Xn,"f")}get request_id(){return J(this,Yn,"f")}async withResponse(){const n=await J(this,en,"f");if(!n)throw new Error("Could not resolve a `Response` object");return{data:this,response:n,request_id:n.headers.get("request-id")}}static fromReadableStream(n){const i=new ur;return i._run(()=>i._fromReadableStream(n)),i}static createMessage(n,i,s){const c=new ur;for(const d of i.messages)c._addMessageParam(d);return c._run(()=>c._createMessage(n,{...i,stream:!0},{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),c}_run(n){n().then(()=>{this._emitFinal(),this._emit("end")},J(this,ui,"f"))}_addMessageParam(n){this.messages.push(n)}_addMessage(n,i=!0){this.receivedMessages.push(n),i&&this._emit("message",n)}async _createMessage(n,i,s){var O;const c=s==null?void 0:s.signal;c&&(c.aborted&&this.controller.abort(),c.addEventListener("abort",()=>this.controller.abort())),J(this,qe,"m",ci).call(this);const{response:d,data:S}=await n.create({...i,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(d);for await(const B of S)J(this,qe,"m",li).call(this,B);if((O=S.controller.signal)!=null&&O.aborted)throw new Ue;J(this,qe,"m",fi).call(this)}_connected(n){this.ended||(Ee(this,Xn,n,"f"),Ee(this,Yn,n==null?void 0:n.headers.get("request-id"),"f"),J(this,Vn,"f").call(this,n),this._emit("connect"))}get ended(){return J(this,sn,"f")}get errored(){return J(this,Gn,"f")}get aborted(){return J(this,zn,"f")}abort(){this.controller.abort()}on(n,i){return(J(this,Ye,"f")[n]||(J(this,Ye,"f")[n]=[])).push({listener:i}),this}off(n,i){const s=J(this,Ye,"f")[n];if(!s)return this;const c=s.findIndex(d=>d.listener===i);return c>=0&&s.splice(c,1),this}once(n,i){return(J(this,Ye,"f")[n]||(J(this,Ye,"f")[n]=[])).push({listener:i,once:!0}),this}emitted(n){return new Promise((i,s)=>{Ee(this,Dt,!0,"f"),n!=="error"&&this.once("error",s),this.once(n,i)})}async done(){Ee(this,Dt,!0,"f"),await J(this,nn,"f")}get currentMessage(){return J(this,at,"f")}async finalMessage(){return await this.done(),J(this,qe,"m",oi).call(this)}async finalText(){return await this.done(),J(this,qe,"m",_s).call(this)}_emit(n,...i){if(J(this,sn,"f"))return;n==="end"&&(Ee(this,sn,!0,"f"),J(this,Jn,"f").call(this));const s=J(this,Ye,"f")[n];if(s&&(J(this,Ye,"f")[n]=s.filter(c=>!c.once),s.forEach(({listener:c})=>c(...i))),n==="abort"){const c=i[0];!J(this,Dt,"f")&&!(s!=null&&s.length)&&Promise.reject(c),J(this,tn,"f").call(this,c),J(this,rn,"f").call(this,c),this._emit("end");return}if(n==="error"){const c=i[0];!J(this,Dt,"f")&&!(s!=null&&s.length)&&Promise.reject(c),J(this,tn,"f").call(this,c),J(this,rn,"f").call(this,c),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",J(this,qe,"m",oi).call(this))}async _fromReadableStream(n,i){var d;const s=i==null?void 0:i.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),J(this,qe,"m",ci).call(this),this._connected(null);const c=Ve.fromReadableStream(n,this.controller);for await(const S of c)J(this,qe,"m",li).call(this,S);if((d=c.controller.signal)!=null&&d.aborted)throw new Ue;J(this,qe,"m",fi).call(this)}[(at=new WeakMap,en=new WeakMap,Vn=new WeakMap,tn=new WeakMap,nn=new WeakMap,Jn=new WeakMap,rn=new WeakMap,Ye=new WeakMap,sn=new WeakMap,Gn=new WeakMap,zn=new WeakMap,Dt=new WeakMap,Xn=new WeakMap,Yn=new WeakMap,ui=new WeakMap,qe=new WeakSet,oi=function(){if(this.receivedMessages.length===0)throw new Q("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},_s=function(){if(this.receivedMessages.length===0)throw new Q("stream ended without producing a Message with role=assistant");const i=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(i.length===0)throw new Q("stream ended without producing a content block with type=text");return i.join(" ")},ci=function(){this.ended||Ee(this,at,void 0,"f")},li=function(i){if(this.ended)return;const s=J(this,qe,"m",xs).call(this,i);switch(this._emit("streamEvent",i,s),i.type){case"content_block_delta":{const c=s.content.at(-1);switch(i.delta.type){case"text_delta":{c.type==="text"&&this._emit("text",i.delta.text,c.text||"");break}case"citations_delta":{c.type==="text"&&this._emit("citation",i.delta.citation,c.citations??[]);break}case"input_json_delta":{c.type==="tool_use"&&c.input&&this._emit("inputJson",i.delta.partial_json,c.input);break}case"thinking_delta":{c.type==="thinking"&&this._emit("thinking",i.delta.thinking,c.thinking);break}case"signature_delta":{c.type==="thinking"&&this._emit("signature",c.signature);break}default:i.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{Ee(this,at,s,"f");break}}},fi=function(){if(this.ended)throw new Q("stream has ended, this shouldn't happen");const i=J(this,at,"f");if(!i)throw new Q("request ended without sending any chunks");return Ee(this,at,void 0,"f"),i},xs=function(i){let s=J(this,at,"f");if(i.type==="message_start"){if(s)throw new Q(`Unexpected event order, got ${i.type} before receiving "message_stop"`);return i.message}if(!s)throw new Q(`Unexpected event order, got ${i.type} before "message_start"`);switch(i.type){case"message_stop":return s;case"message_delta":return s.stop_reason=i.delta.stop_reason,s.stop_sequence=i.delta.stop_sequence,s.usage.output_tokens=i.usage.output_tokens,s;case"content_block_start":return s.content.push(i.content_block),s;case"content_block_delta":{const c=s.content.at(i.index);switch(i.delta.type){case"text_delta":{(c==null?void 0:c.type)==="text"&&(c.text+=i.delta.text);break}case"citations_delta":{(c==null?void 0:c.type)==="text"&&(c.citations??(c.citations=[]),c.citations.push(i.delta.citation));break}case"input_json_delta":{if((c==null?void 0:c.type)==="tool_use"){let d=c[Ss]||"";d+=i.delta.partial_json,Object.defineProperty(c,Ss,{value:d,enumerable:!1,writable:!0}),d&&(c.input=zs(d))}break}case"thinking_delta":{(c==null?void 0:c.type)==="thinking"&&(c.thinking+=i.delta.thinking);break}case"signature_delta":{(c==null?void 0:c.type)==="thinking"&&(c.signature=i.delta.signature);break}default:i.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){const n=[],i=[];let s=!1;return this.on("streamEvent",c=>{const d=i.shift();d?d.resolve(c):n.push(c)}),this.on("end",()=>{s=!0;for(const c of i)c.resolve(void 0);i.length=0}),this.on("abort",c=>{s=!0;for(const d of i)d.reject(c);i.length=0}),this.on("error",c=>{s=!0;for(const d of i)d.reject(c);i.length=0}),{next:async()=>n.length?{value:n.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((d,S)=>i.push({resolve:d,reject:S})).then(d=>d?{value:d,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ve(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}const ks={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};let gr=class extends ct{constructor(){super(...arguments),this.batches=new Pi(this._client)}create(n,i){const{betas:s,...c}=n;return c.model in ks&&console.warn(`The model '${c.model}' is deprecated and will reach end-of-life on ${ks[c.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:c,timeout:this._client._options.timeout??(c.stream?6e5:this._client._calculateNonstreamingTimeout(c.max_tokens)),...i,headers:{...(s==null?void 0:s.toString())!=null?{"anthropic-beta":s==null?void 0:s.toString()}:void 0,...i==null?void 0:i.headers},stream:n.stream??!1})}stream(n,i){return ur.createMessage(this,n,i)}countTokens(n,i){const{betas:s,...c}=n;return this._client.post("/v1/messages/count_tokens?beta=true",{body:c,...i,headers:{"anthropic-beta":[...s??[],"token-counting-2024-11-01"].toString(),...i==null?void 0:i.headers}})}};gr.Batches=Pi;gr.BetaMessageBatchesPage=Ai;class dn extends ct{constructor(){super(...arguments),this.models=new Si(this._client),this.messages=new gr(this._client)}}dn.Models=Si;dn.BetaModelInfosPage=ki;dn.Messages=gr;class Xs extends ct{create(n,i){return this._client.post("/v1/complete",{body:n,timeout:this._client._options.timeout??6e5,...i,stream:n.stream??!1})}}class Ei extends ct{create(n,i){return this._client.post("/v1/messages/batches",{body:n,...i})}retrieve(n,i){return this._client.get(`/v1/messages/batches/${n}`,i)}list(n={},i){return ut(n)?this.list({},n):this._client.getAPIList("/v1/messages/batches",Oi,{query:n,...i})}delete(n,i){return this._client.delete(`/v1/messages/batches/${n}`,i)}cancel(n,i){return this._client.post(`/v1/messages/batches/${n}/cancel`,i)}async results(n,i){const s=await this.retrieve(n);if(!s.results_url)throw new Q(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);return this._client.get(s.results_url,{...i,headers:{Accept:"application/binary",...i==null?void 0:i.headers},__binaryResponse:!0})._thenUnwrap((c,d)=>yr.fromResponse(d.response,d.controller))}}class Oi extends mr{}Ei.MessageBatchesPage=Oi;var Oe=function(o,n,i,s,c){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?o!==n||!c:!n.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?c.call(o,i):c?c.value=i:n.set(o,i),i},G=function(o,n,i,s){if(i==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?o!==n||!s:!n.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return i==="m"?s:i==="a"?s.call(o):s?s.value:n.get(o)},Ne,ot,an,Qn,on,un,Zn,cn,Qe,ln,er,tr,jt,nr,rr,hi,Ps,di,pi,mi,yi,As;const Es="__json_buf";class cr{constructor(){Ne.add(this),this.messages=[],this.receivedMessages=[],ot.set(this,void 0),this.controller=new AbortController,an.set(this,void 0),Qn.set(this,()=>{}),on.set(this,()=>{}),un.set(this,void 0),Zn.set(this,()=>{}),cn.set(this,()=>{}),Qe.set(this,{}),ln.set(this,!1),er.set(this,!1),tr.set(this,!1),jt.set(this,!1),nr.set(this,void 0),rr.set(this,void 0),di.set(this,n=>{if(Oe(this,er,!0,"f"),n instanceof Error&&n.name==="AbortError"&&(n=new Ue),n instanceof Ue)return Oe(this,tr,!0,"f"),this._emit("abort",n);if(n instanceof Q)return this._emit("error",n);if(n instanceof Error){const i=new Q(n.message);return i.cause=n,this._emit("error",i)}return this._emit("error",new Q(String(n)))}),Oe(this,an,new Promise((n,i)=>{Oe(this,Qn,n,"f"),Oe(this,on,i,"f")}),"f"),Oe(this,un,new Promise((n,i)=>{Oe(this,Zn,n,"f"),Oe(this,cn,i,"f")}),"f"),G(this,an,"f").catch(()=>{}),G(this,un,"f").catch(()=>{})}get response(){return G(this,nr,"f")}get request_id(){return G(this,rr,"f")}async withResponse(){const n=await G(this,an,"f");if(!n)throw new Error("Could not resolve a `Response` object");return{data:this,response:n,request_id:n.headers.get("request-id")}}static fromReadableStream(n){const i=new cr;return i._run(()=>i._fromReadableStream(n)),i}static createMessage(n,i,s){const c=new cr;for(const d of i.messages)c._addMessageParam(d);return c._run(()=>c._createMessage(n,{...i,stream:!0},{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),c}_run(n){n().then(()=>{this._emitFinal(),this._emit("end")},G(this,di,"f"))}_addMessageParam(n){this.messages.push(n)}_addMessage(n,i=!0){this.receivedMessages.push(n),i&&this._emit("message",n)}async _createMessage(n,i,s){var O;const c=s==null?void 0:s.signal;c&&(c.aborted&&this.controller.abort(),c.addEventListener("abort",()=>this.controller.abort())),G(this,Ne,"m",pi).call(this);const{response:d,data:S}=await n.create({...i,stream:!0},{...s,signal:this.controller.signal}).withResponse();this._connected(d);for await(const B of S)G(this,Ne,"m",mi).call(this,B);if((O=S.controller.signal)!=null&&O.aborted)throw new Ue;G(this,Ne,"m",yi).call(this)}_connected(n){this.ended||(Oe(this,nr,n,"f"),Oe(this,rr,n==null?void 0:n.headers.get("request-id"),"f"),G(this,Qn,"f").call(this,n),this._emit("connect"))}get ended(){return G(this,ln,"f")}get errored(){return G(this,er,"f")}get aborted(){return G(this,tr,"f")}abort(){this.controller.abort()}on(n,i){return(G(this,Qe,"f")[n]||(G(this,Qe,"f")[n]=[])).push({listener:i}),this}off(n,i){const s=G(this,Qe,"f")[n];if(!s)return this;const c=s.findIndex(d=>d.listener===i);return c>=0&&s.splice(c,1),this}once(n,i){return(G(this,Qe,"f")[n]||(G(this,Qe,"f")[n]=[])).push({listener:i,once:!0}),this}emitted(n){return new Promise((i,s)=>{Oe(this,jt,!0,"f"),n!=="error"&&this.once("error",s),this.once(n,i)})}async done(){Oe(this,jt,!0,"f"),await G(this,un,"f")}get currentMessage(){return G(this,ot,"f")}async finalMessage(){return await this.done(),G(this,Ne,"m",hi).call(this)}async finalText(){return await this.done(),G(this,Ne,"m",Ps).call(this)}_emit(n,...i){if(G(this,ln,"f"))return;n==="end"&&(Oe(this,ln,!0,"f"),G(this,Zn,"f").call(this));const s=G(this,Qe,"f")[n];if(s&&(G(this,Qe,"f")[n]=s.filter(c=>!c.once),s.forEach(({listener:c})=>c(...i))),n==="abort"){const c=i[0];!G(this,jt,"f")&&!(s!=null&&s.length)&&Promise.reject(c),G(this,on,"f").call(this,c),G(this,cn,"f").call(this,c),this._emit("end");return}if(n==="error"){const c=i[0];!G(this,jt,"f")&&!(s!=null&&s.length)&&Promise.reject(c),G(this,on,"f").call(this,c),G(this,cn,"f").call(this,c),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",G(this,Ne,"m",hi).call(this))}async _fromReadableStream(n,i){var d;const s=i==null?void 0:i.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),G(this,Ne,"m",pi).call(this),this._connected(null);const c=Ve.fromReadableStream(n,this.controller);for await(const S of c)G(this,Ne,"m",mi).call(this,S);if((d=c.controller.signal)!=null&&d.aborted)throw new Ue;G(this,Ne,"m",yi).call(this)}[(ot=new WeakMap,an=new WeakMap,Qn=new WeakMap,on=new WeakMap,un=new WeakMap,Zn=new WeakMap,cn=new WeakMap,Qe=new WeakMap,ln=new WeakMap,er=new WeakMap,tr=new WeakMap,jt=new WeakMap,nr=new WeakMap,rr=new WeakMap,di=new WeakMap,Ne=new WeakSet,hi=function(){if(this.receivedMessages.length===0)throw new Q("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Ps=function(){if(this.receivedMessages.length===0)throw new Q("stream ended without producing a Message with role=assistant");const i=this.receivedMessages.at(-1).content.filter(s=>s.type==="text").map(s=>s.text);if(i.length===0)throw new Q("stream ended without producing a content block with type=text");return i.join(" ")},pi=function(){this.ended||Oe(this,ot,void 0,"f")},mi=function(i){if(this.ended)return;const s=G(this,Ne,"m",As).call(this,i);switch(this._emit("streamEvent",i,s),i.type){case"content_block_delta":{const c=s.content.at(-1);switch(i.delta.type){case"text_delta":{c.type==="text"&&this._emit("text",i.delta.text,c.text||"");break}case"citations_delta":{c.type==="text"&&this._emit("citation",i.delta.citation,c.citations??[]);break}case"input_json_delta":{c.type==="tool_use"&&c.input&&this._emit("inputJson",i.delta.partial_json,c.input);break}case"thinking_delta":{c.type==="thinking"&&this._emit("thinking",i.delta.thinking,c.thinking);break}case"signature_delta":{c.type==="thinking"&&this._emit("signature",c.signature);break}default:i.delta}break}case"message_stop":{this._addMessageParam(s),this._addMessage(s,!0);break}case"content_block_stop":{this._emit("contentBlock",s.content.at(-1));break}case"message_start":{Oe(this,ot,s,"f");break}}},yi=function(){if(this.ended)throw new Q("stream has ended, this shouldn't happen");const i=G(this,ot,"f");if(!i)throw new Q("request ended without sending any chunks");return Oe(this,ot,void 0,"f"),i},As=function(i){let s=G(this,ot,"f");if(i.type==="message_start"){if(s)throw new Q(`Unexpected event order, got ${i.type} before receiving "message_stop"`);return i.message}if(!s)throw new Q(`Unexpected event order, got ${i.type} before "message_start"`);switch(i.type){case"message_stop":return s;case"message_delta":return s.stop_reason=i.delta.stop_reason,s.stop_sequence=i.delta.stop_sequence,s.usage.output_tokens=i.usage.output_tokens,s;case"content_block_start":return s.content.push(i.content_block),s;case"content_block_delta":{const c=s.content.at(i.index);switch(i.delta.type){case"text_delta":{(c==null?void 0:c.type)==="text"&&(c.text+=i.delta.text);break}case"citations_delta":{(c==null?void 0:c.type)==="text"&&(c.citations??(c.citations=[]),c.citations.push(i.delta.citation));break}case"input_json_delta":{if((c==null?void 0:c.type)==="tool_use"){let d=c[Es]||"";d+=i.delta.partial_json,Object.defineProperty(c,Es,{value:d,enumerable:!1,writable:!0}),d&&(c.input=zs(d))}break}case"thinking_delta":{(c==null?void 0:c.type)==="thinking"&&(c.thinking+=i.delta.thinking);break}case"signature_delta":{(c==null?void 0:c.type)==="thinking"&&(c.signature=i.delta.signature);break}default:i.delta}return s}case"content_block_stop":return s}},Symbol.asyncIterator)](){const n=[],i=[];let s=!1;return this.on("streamEvent",c=>{const d=i.shift();d?d.resolve(c):n.push(c)}),this.on("end",()=>{s=!0;for(const c of i)c.resolve(void 0);i.length=0}),this.on("abort",c=>{s=!0;for(const d of i)d.reject(c);i.length=0}),this.on("error",c=>{s=!0;for(const d of i)d.reject(c);i.length=0}),{next:async()=>n.length?{value:n.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((d,S)=>i.push({resolve:d,reject:S})).then(d=>d?{value:d,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ve(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}class vr extends ct{constructor(){super(...arguments),this.batches=new Ei(this._client)}create(n,i){return n.model in Os&&console.warn(`The model '${n.model}' is deprecated and will reach end-of-life on ${Os[n.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:n,timeout:this._client._options.timeout??(n.stream?6e5:this._client._calculateNonstreamingTimeout(n.max_tokens)),...i,stream:n.stream??!1})}stream(n,i){return cr.createMessage(this,n,i)}countTokens(n,i){return this._client.post("/v1/messages/count_tokens",{body:n,...i})}}const Os={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};vr.Batches=Ei;vr.MessageBatchesPage=Oi;class Mi extends ct{retrieve(n,i){return this._client.get(`/v1/models/${n}`,i)}list(n={},i){return ut(n)?this.list({},n):this._client.getAPIList("/v1/models",Ii,{query:n,...i})}}class Ii extends mr{}Mi.ModelInfosPage=Ii;var Ys;class ne extends io{constructor({baseURL:n=ai("ANTHROPIC_BASE_URL"),apiKey:i=ai("ANTHROPIC_API_KEY")??null,authToken:s=ai("ANTHROPIC_AUTH_TOKEN")??null,...c}={}){const d={apiKey:i,authToken:s,...c,baseURL:n||"https://api.anthropic.com"};if(!d.dangerouslyAllowBrowser&&go())throw new Q(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:d.baseURL,timeout:d.timeout??6e5,httpAgent:d.httpAgent,maxRetries:d.maxRetries,fetch:d.fetch}),this.completions=new Xs(this),this.messages=new vr(this),this.models=new Mi(this),this.beta=new dn(this),this._options=d,this.apiKey=i,this.authToken=s}defaultQuery(){return this._options.defaultQuery}defaultHeaders(n){return{...super.defaultHeaders(n),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(n,i){if(!(this.apiKey&&n["x-api-key"])&&i["x-api-key"]!==null&&!(this.authToken&&n.authorization)&&i.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(n){const i=this.apiKeyAuth(n),s=this.bearerAuth(n);return i!=null&&!or(i)?i:s!=null&&!or(s)?s:{}}apiKeyAuth(n){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(n){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}}Ys=ne;ne.Anthropic=Ys;ne.HUMAN_PROMPT=`

Human:`;ne.AI_PROMPT=`

Assistant:`;ne.DEFAULT_TIMEOUT=6e5;ne.AnthropicError=Q;ne.APIError=Me;ne.APIConnectionError=hr;ne.APIConnectionTimeoutError=Ks;ne.APIUserAbortError=Ue;ne.NotFoundError=Fs;ne.ConflictError=$s;ne.RateLimitError=Ls;ne.BadRequestError=Cs;ne.AuthenticationError=qs;ne.InternalServerError=Ws;ne.PermissionDeniedError=Ns;ne.UnprocessableEntityError=Us;ne.toFile=Ya;ne.fileFromPath=Bs;ne.Completions=Xs;ne.Messages=vr;ne.Models=Mi;ne.ModelInfosPage=Ii;ne.Beta=dn;const{HUMAN_PROMPT:pu,AI_PROMPT:mu}=ne,xo=[{id:"claude-3-7-sonnet-20250219",name:"Claude 3.7 Sonnet",provider:"anthropic",description:"Latest and most capable model",isLocal:!1,maxTokens:2e5,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!0},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",provider:"anthropic",description:"Fastest model for quick responses",isLocal:!1,maxTokens:1e5,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!1}];function So(o){return o.split(",")[1]}function ko(o){const n=o.match(/^data:([^;]+);base64,/);return n?n[1]:"application/octet-stream"}function Po(o){const n=o.filter(d=>d.role==="system"),i=n.length>0?n.map(d=>d.content).join(`

`):void 0;return{messages:o.filter(d=>d.role==="user"||d.role==="assistant").map(d=>{if(!d.media||d.media.length===0)return{role:d.role,content:d.content};const S=[];return d.content.trim()&&S.push({type:"text",text:d.content}),d.media.forEach(O=>{O.type==="image"&&O.preview&&S.push({type:"image",source:{type:"base64",media_type:ko(O.preview),data:So(O.preview)}})}),{role:d.role,content:S}}),systemPrompt:i}}function Ao(){const n=lr(fr).apiKeys.anthropic;if(!n)throw new Error("Anthropic API key not found. Please add your API key in Settings.");return n}async function yu(o,n,i,s,c,d){var S,O,B,q;try{const H=Ao(),{messages:F,systemPrompt:L}=Po(n);console.log("Sending request to Anthropic API with model:",o);try{console.log("Attempting to use Anthropic SDK..."),await Eo(H,o,F,L,i,s,c,d);return}catch(ee){console.error("Error using Anthropic SDK, falling back to fetch:",ee)}const V=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"content-type":"application/json","x-api-key":H,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:o,messages:F,system:L,dangerouslyAllowBrowser:"true",stream:!0,temperature:.7,max_tokens:4e3})});if(!V.ok){let ee=`Status code: ${V.status}`;try{ee=((S=(await V.json()).error)==null?void 0:S.message)||ee}catch{ee=V.statusText||ee}throw new Error(`Anthropic API error: ${ee}`)}const ae=(O=V.body)==null?void 0:O.getReader();if(!ae)throw new Error("Failed to get response reader");const me=new TextDecoder("utf-8");let Se="",ce="";for(;;){const{done:ee,value:ue}=await ae.read();if(ee)break;Se+=me.decode(ue,{stream:!0});const he=Se.split(`
`);Se=he.pop()||"";for(const Je of he){const de=Je.trim();if(!(!de||de==="data: [DONE]"))try{const re=de.replace(/^data: /,"");if(re==="")continue;const pe=JSON.parse(re);if(pe.type==="thinking"&&d&&((B=pe.delta)!=null&&B.text)){d(pe.delta.text);continue}if(pe.type==="content_block_delta"&&((q=pe.delta)!=null&&q.text)&&(ce+=pe.delta.text,i(ce)),pe.type==="message_stop")return s(),ce}catch(re){console.warn("Error parsing chunk:",re)}}}return s(),ce}catch(H){throw c(H instanceof Error?H:new Error(String(H))),H}}async function Eo(o,n,i,s,c,d,S,O){try{const B=new ne({apiKey:o,dangerouslyAllowBrowser:!0}),q=i.map(L=>({role:L.role,content:typeof L.content=="string"?L.content:L.content.filter(V=>V.type==="text").map(V=>V.text||"").join(`
`)}));console.log("Using Anthropic SDK with model:",n);const H=await B.messages.create({model:n,max_tokens:1024,messages:[{role:"user",content:"Hello, Claude"}],system:s,stream:!0});let F="";for await(const L of H)if(L.type==="content_block_delta"&&"text"in L.delta&&(F+=L.delta.text,c(F)),L.type==="message_stop")return d(),F;return d(),F}catch(B){throw console.error("Error using Anthropic SDK:",B),B}}const Oo=[{id:"gpt-4o",name:"GPT-4o",provider:"openai",description:"Most capable model for a wide range of tasks",isLocal:!1,maxTokens:8192,supportsStreaming:!0,supportsFiles:!0},{id:"gpt-4-turbo",name:"GPT-4 Turbo",provider:"openai",description:"Improved version of GPT-4",isLocal:!1,maxTokens:4096,supportsStreaming:!0,supportsFiles:!0},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",provider:"openai",description:"Fast and efficient for most tasks",isLocal:!1,maxTokens:4096,supportsStreaming:!0,supportsFiles:!0}];function Qs(o){return o.map(n=>{if(!n.media||n.media.length===0)return{role:n.role,content:n.content};const i=[];return n.content.trim()&&i.push({type:"text",text:n.content}),n.media.forEach(s=>{if(console.log(`Processing media item for OpenAI: ${s.type} ${s.name}`),s.type==="image"&&s.preview)i.push({type:"image_url",image_url:{url:s.preview,detail:"auto"}}),console.log(`Added image to OpenAI message: ${s.name}`);else if(s.type==="document")if(s.fileId)i.push({type:"text",text:`I've analyzed the document: ${s.name}. The file has been processed.`}),console.log(`Referenced uploaded document in message: ${s.name} (file ID: ${s.fileId})`);else if(s.preview)try{const c=s.preview.match(/^data:([^;]+);base64,/),d=c?c[1]:"application/octet-stream";console.log(`Processing document: ${s.name}, MIME type: ${d}`),d.startsWith("image/")?(i.push({type:"image_url",image_url:{url:s.preview,detail:"high"}}),console.log(`Added document with image MIME type to OpenAI message: ${s.name}`)):(console.warn(`Document type ${d} not supported via chat API: ${s.name}`),i.push({type:"text",text:`[Note: I attempted to analyze your document "${s.name}" but couldn't process it directly in the chat. For better document support, please try uploading it again.]`}))}catch(c){console.error(`Error processing document ${s.name}:`,c),i.push({type:"text",text:`[Error: Could not process document "${s.name}" due to technical error]`})}else console.log(`Document ${s.name} has no preview or fileId, cannot send to OpenAI`);else console.log(`Unsupported media type: ${s.type} for ${s.name}`)}),i.length===0?{role:n.role,content:n.content||"I've attached some files, but they couldn't be processed."}:{role:n.role,content:i}})}function Mo(){try{const o=lr(fr);if(console.log("Retrieving OpenAI API key from settings store"),!o||!o.apiKeys)throw console.error("Settings or apiKeys object is undefined:",o),new Error("OpenAI API key not found. Settings store may not be initialized properly.");const n=o.apiKeys.openai;if(!n)throw console.error("OpenAI API key is empty or undefined"),new Error("OpenAI API key not found. Please add your API key in Settings.");if(console.log("FULL API KEY FROM SETTINGS: ",n),!n.startsWith("sk-")||n.length<20)throw console.error("Invalid OpenAI API key format"),new Error('Invalid OpenAI API key format. Keys should start with "sk-" and be at least 20 characters long.');return console.log(`Retrieved OpenAI API key (length: ${n.length}, starts with: ${n.substring(0,4)}...)`),n}catch(o){throw console.error("Error retrieving OpenAI API key:",o),o}}async function Ti(o=3,n=500){let i=0;for(;i<o;)try{return Mo()}catch(s){if(console.warn(`Failed to get API key (attempt ${i+1}/${o}):`,s),i===o-1)throw s;await new Promise(c=>setTimeout(c,n)),i++}throw new Error("Failed to retrieve API key after multiple attempts")}async function gu(o,n,i,s,c){var d,S,O,B;try{const q=await Ti();console.log("SECURITY WARNING: Printing full API key for debugging: ",q),console.log("EXACT KEY SENT TO OPENAI: ",q),console.log(`Key format check: length=${q.length}, starts with=${q.substring(0,4)}, contains "sk-"=${q.includes("sk-")}`);const H=[...q.substring(0,10)].map(ee=>ee.charCodeAt(0));console.log(`First 10 character codes: ${H.join(", ")}`);const F=`Bearer ${q.trim()}`;console.log(`Authorization header format: Bearer ${q.trim()}`);const L=Qs(n),V=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:F},body:JSON.stringify({model:o,messages:L,stream:!0,temperature:.7})});if(!V.ok){const ee=await V.text();let ue=`OpenAI API error (${V.status}): ${V.statusText}`;try{const he=JSON.parse(ee);he.error&&(V.status===401?ue="Authentication error with OpenAI. Please check your API key in Settings.":he.error.message&&(ue=`OpenAI API error: ${he.error.message}`))}catch{V.status===401?ue="Authentication error with OpenAI. Please check your API key in Settings.":ee&&(ue=`OpenAI API error: ${ee}`)}throw new Error(ue)}const ae=(d=V.body)==null?void 0:d.getReader();if(!ae)throw new Error("Failed to get response reader");const me=new TextDecoder("utf-8");let Se="",ce="";for(;;){const{done:ee,value:ue}=await ae.read();if(ee)break;Se+=me.decode(ue,{stream:!0});const he=Se.split(`
`);Se=he.pop()||"";for(const Je of he){const de=Je.trim();if(!(!de||de==="data: [DONE]"))try{const re=de.replace(/^data: /,""),pe=JSON.parse(re),lt=(O=(S=pe.choices[0])==null?void 0:S.delta)==null?void 0:O.content;if(lt&&(ce+=lt,i(ce)),(B=pe.choices[0])!=null&&B.finish_reason)return s(),ce}catch(re){console.warn("Error parsing chunk:",re)}}}return s(),ce}catch(q){throw console.error("OpenAI stream completion error:",q),c(q instanceof Error?q:new Error(String(q))),q}}async function vu(o,n){var i,s;try{const c=await Ti();console.log(`Processing ${n.length} messages for OpenAI non-streaming completion`),n.some(F=>F.media&&F.media.length>0)&&console.log("Messages contain media - ensuring proper conversion");const S=`Bearer ${c.trim()}`,O=Qs(n),B=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:S},body:JSON.stringify({model:o,messages:O,stream:!1,temperature:.7})});if(!B.ok){const F=await B.text();let L=`OpenAI API error (${B.status}): ${B.statusText}`;try{const V=JSON.parse(F);V.error&&(B.status===401?L="Authentication error with OpenAI. Please check your API key in Settings.":V.error.message&&(L=`OpenAI API error: ${V.error.message}`))}catch{B.status===401?L="Authentication error with OpenAI. Please check your API key in Settings.":F&&(L=`OpenAI API error: ${F}`)}throw new Error(L)}const H=(s=(i=(await B.json()).choices[0])==null?void 0:i.message)==null?void 0:s.content;return typeof H=="string"?H:Array.isArray(H)?H.filter(F=>F.type==="text"&&F.text).map(F=>F.text).join(`

`):""}catch(c){throw console.error("OpenAI completion error:",c),c}}async function bu(o){try{const n=await Ti(),i=new FormData;i.append("file",o),i.append("purpose","assistants"),console.log(`Uploading file to OpenAI: ${o.name}, type: ${o.type}, size: ${o.size} bytes`);const s=await fetch("https://api.openai.com/v1/files",{method:"POST",headers:{Authorization:`Bearer ${n.trim()}`},body:i});if(!s.ok){const d=await s.text();let S=`OpenAI API error (${s.status}): ${s.statusText}`;try{const O=JSON.parse(d);O.error&&O.error.message&&(S=`OpenAI API error: ${O.error.message}`)}catch{d&&(S=`OpenAI API error: ${d}`)}throw new Error(S)}const c=await s.json();return console.log(`File uploaded successfully to OpenAI: ${c.id}`),c.id}catch(n){throw console.error("Error uploading file to OpenAI:",n),n}}const xe=[];for(let o=0;o<256;++o)xe.push((o+256).toString(16).slice(1));function Io(o,n=0){return(xe[o[n+0]]+xe[o[n+1]]+xe[o[n+2]]+xe[o[n+3]]+"-"+xe[o[n+4]]+xe[o[n+5]]+"-"+xe[o[n+6]]+xe[o[n+7]]+"-"+xe[o[n+8]]+xe[o[n+9]]+"-"+xe[o[n+10]]+xe[o[n+11]]+xe[o[n+12]]+xe[o[n+13]]+xe[o[n+14]]+xe[o[n+15]]).toLowerCase()}let gi;const To=new Uint8Array(16);function Ro(){if(!gi){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");gi=crypto.getRandomValues.bind(crypto)}return gi(To)}const Do=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ms={randomUUID:Do};function jo(o,n,i){var c;if(Ms.randomUUID&&!o)return Ms.randomUUID();o=o||{};const s=o.random??((c=o.rng)==null?void 0:c.call(o))??Ro();if(s.length<16)throw new Error("Random bytes length must be >= 16");return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Io(s)}const Zs=[{id:"gemini-2.0-flash-exp",name:"Gemini 2.0 Flash",provider:"google",description:"Fast and efficient model with enhanced thinking capabilities",isLocal:!1,maxTokens:32768,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!0,supportsMultimodal:!0,supportsImageGeneration:!0}];function Bo(o){return o.split(",")[1]}function Ko(o,n){return`data:${n};base64,${o}`}function Co(o){const n=o.match(/^data:([^;]+);base64,/);return n?n[1]:"application/octet-stream"}function qo(o){return o.map(n=>{const i=[];return n.content.trim()&&i.push({text:n.content}),n.media&&n.media.length>0&&n.media.forEach(s=>{s.type==="image"&&s.preview&&i.push({inlineData:{mimeType:Co(s.preview),data:Bo(s.preview)}})}),i.length>0?{role:n.role==="assistant"?"model":"user",parts:i}:null}).filter(n=>n!==null)}function Is(o){if(!o.data||o.data.trim()==="")return console.warn("Empty or invalid base64 data received from Google Gemini API"),null;const n=o.mimeType.startsWith("image/")?"image":"document",i=Ko(o.data,o.mimeType);return{id:jo(),type:n,name:`${n}_${new Date().getTime()}`,preview:i,timestamp:Date.now(),size:o.data.length*.75}}function No(){const n=lr(fr).apiKeys.google;if(!n)throw new Error("Google API key not found. Please add your API key in Settings.");return n}function Fo(o){if(o!=null&&o.error){const n=o.error;let i=n.message||"Unknown Google API error";if(n.code&&(i=`[${n.code}] ${i}`),n.details&&n.details.length>0){const s=n.details.filter(c=>c["@type"]&&c["@type"].includes("BadRequest")).flatMap(c=>c.fieldViolations||[]).map(c=>`- ${c.field}: ${c.description}`).join(`
`);s&&(i+=`

Details:
`+s)}return i}return o instanceof Error?o.message:String(o)}async function wu(o,n,i,s,c,d){var S,O,B,q,H,F,L,V,ae,me,Se,ce,ee;try{const ue=No(),he=qo(n);console.log("Using model:",o),o!=="gemini-2.0-flash-exp"&&console.warn("Warning: Expected to use gemini-2.0-flash-exp but got:",o),console.log("Sending request to Google Gemini API with model:",o),console.log("Messages after conversion:",JSON.stringify(he,null,2));const Je=n.some(Ge=>{const we=Ge.content.toLowerCase();return Ge.role==="user"&&(we.includes("generate an image")||we.includes("create an image")||we.includes("draw")||we.includes("picture of")||we.includes("image of"))}),de={contents:he,generationConfig:{temperature:.7,maxOutputTokens:2048,responseModalities:Je?["TEXT","IMAGE"]:["TEXT"]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}]},re=`https://generativelanguage.googleapis.com/v1beta/models/${o}:streamGenerateContent?key=${ue}`;console.log("API URL (without key):",re.replace(ue,"API_KEY_HIDDEN"));const pe=await fetch(re,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(de)});if(!pe.ok){let Ge;try{Ge=await pe.json()}catch{throw new Error(`Google API error: ${pe.statusText||pe.status}`)}const we=Fo(Ge);throw Je&&we.includes("responseModalities")?new Error(`Failed to generate image: The model doesn't support the requested image generation features.

API Error: ${we}`):we.includes("rate limit")?new Error(`Rate limit exceeded: Please try again later or reduce the frequency of requests.

API Error: ${we}`):new Error(`Google API error: ${we}`)}const lt=(S=pe.body)==null?void 0:S.getReader();if(!lt)throw new Error("Failed to get response reader");const pn=new TextDecoder("utf-8");let Fe="",Te="",Be=[];for(console.log("Starting to read the stream...");;){const{done:Ge,value:we}=await lt.read();if(Ge){console.log("Stream reading complete");break}const ft=pn.decode(we,{stream:!0});console.log("Received chunk length:",ft.length),Fe+=ft;let Nt=!1,ye=null;try{ye=JSON.parse(Fe),Nt=!0,console.log("Successfully parsed complete JSON"),Fe=""}catch{if(console.log("Failed to parse complete buffer, looking for array content"),Fe.trim().startsWith("[")){console.log("Buffer starts with array indicator [");try{const ie=Fe.lastIndexOf("]");if(ie>0){const Ke=Fe.substring(0,ie+1);try{ye=JSON.parse(Ke),Nt=!0,console.log("Successfully parsed array portion"),Fe=Fe.substring(ie+1)}catch{console.log("Failed to parse array portion")}}}catch(ie){console.log("Error handling array:",ie)}}}if(Nt&&ye)if(console.log("Processing valid JSON data"),Array.isArray(ye))for(const ge of ye){if(ge.error){const ie=`Google API error: ${ge.error.message||"Unknown error"}`;return console.error(ie),c(new Error(ie)),""}if((q=(B=(O=ge.candidates)==null?void 0:O[0])==null?void 0:B.content)!=null&&q.parts){const ie=ge.candidates[0].content.parts;let Ke="";const $e=[];for(const _e of ie)if(_e.text)Ke+=_e.text;else if(_e.inlineData){console.log(`Received inlineData with mimeType: ${_e.inlineData.mimeType}, data length: ${((H=_e.inlineData.data)==null?void 0:H.length)||0}`);const kt=Is(_e.inlineData);kt?($e.push(kt),Be.push(kt)):(console.warn("Failed to create media item from inlineData"),Ke+=`

**Note**: Attempted to generate an image, but received invalid data. This might be due to content restrictions or a technical issue.`)}Ke&&(Te+=Ke),i(Te,Be)}if(((L=(F=ge.candidates)==null?void 0:F[0])==null?void 0:L.finishReason)==="STOP")return console.log("Received completion signal (STOP) in array"),s(),Te}else{if(ye.error){const ge=`Google API error: ${ye.error.message||"Unknown error"}`;return console.error(ge),c(new Error(ge)),""}if((me=(ae=(V=ye.candidates)==null?void 0:V[0])==null?void 0:ae.content)!=null&&me.parts){const ge=ye.candidates[0].content.parts;let ie="";const Ke=[];for(const $e of ge)if($e.text)ie+=$e.text;else if($e.inlineData){console.log(`Received inlineData with mimeType: ${$e.inlineData.mimeType}, data length: ${((Se=$e.inlineData.data)==null?void 0:Se.length)||0}`);const _e=Is($e.inlineData);_e?(Ke.push(_e),Be.push(_e)):(console.warn("Failed to create media item from inlineData"),ie+=`

**Note**: Attempted to generate an image, but received invalid data. This might be due to content restrictions or a technical issue.`)}ie&&(Te+=ie),i(Te,Be)}if(((ee=(ce=ye.candidates)==null?void 0:ce[0])==null?void 0:ee.finishReason)==="STOP")return console.log("Received completion signal (STOP) in single object"),s(),Te}}return s(),Te}catch(ue){throw c(ue instanceof Error?ue:new Error(String(ue))),ue}}function ea(){const n=lr(fr).apiKeys.ollamaHost||"http://localhost:11434";return n.endsWith("/")?n.slice(0,-1):n}async function $o(){try{const o=ea(),n=await fetch(`${o}/api/tags`);if(!n.ok)throw new Error(`Failed to fetch Ollama models: ${n.statusText}`);return(await n.json()).models.map(s=>({id:s.name,name:Uo(s.name),provider:"ollama",description:Lo(s),isLocal:!0,maxTokens:4096,supportsStreaming:!0,supportsFiles:!1}))}catch(o){return console.error("Error fetching Ollama models:",o),[]}}function Uo(o){let n=o.split(":")[0];return n=n.split("-").map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join(" "),n}function Lo(o){const n=o.details;return n&&n.parameter_size?`${n.family||"Open source"} model (${n.parameter_size})`:"Local LLM model"}function Wo(o){let n="";for(const i of o)i.role==="system"?n+=`SYSTEM: ${i.content}

`:i.role==="user"?n+=`USER: ${i.content}

`:i.role==="assistant"&&(n+=`ASSISTANT: ${i.content}

`);return n+="ASSISTANT: ",n}async function _u(o,n,i,s,c){var d;try{const S=ea(),O=Wo(n),B=await fetch(`${S}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:o,prompt:O,stream:!0,options:{temperature:.7}})});if(!B.ok){const L=await B.text();throw new Error(`Ollama API error: ${L||B.statusText}`)}const q=(d=B.body)==null?void 0:d.getReader();if(!q)throw new Error("Failed to get response reader");const H=new TextDecoder("utf-8");let F="";for(;;){const{done:L,value:V}=await q.read();if(L)break;const me=H.decode(V,{stream:!0}).split(`
`);for(const Se of me)if(Se.trim())try{const ce=JSON.parse(Se);if(ce.response&&(F+=ce.response,i(F)),ce.done)return s(),F}catch(ce){console.warn("Error parsing Ollama chunk:",ce)}}return s(),F}catch(S){throw c(S instanceof Error?S:new Error(String(S))),S}}const Ri=[...xo,...Oo,...Zs],ta=Ts([]),xu=Da(ta,o=>[...Ri,...o]);let Ho=[],Vo=[...Ri];const Jo=Zs[0];async function Su(){try{const o=await $o();return Ho=o,ta.set(o),Vo=[...Ri,...o],o}catch(o){return console.error("Failed to initialize models:",o),[]}}class Go extends ar{constructor(){super("gervaisDB"),this.version(1).stores({chats:"id, title, updatedAt, createdAt",messages:"id, chatId, role, timestamp",mediaItems:"id, messageId, type, timestamp",settings:"id"}),this.chats.mapToClass(zo)}async initialize(){{try{const i=await this.settings.get("user-settings");if(i){console.log("Found existing settings in IndexedDB:",i);return}const s=localStorage.getItem("settings");if(s)try{const c=JSON.parse(s);await this.settings.put({...c,id:"user-settings"}),console.log("Settings migrated from localStorage to IndexedDB:",c)}catch(c){console.error("Failed to migrate settings:",c)}else{const c={id:"user-settings",apiKeys:{anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434",localHost:"http://localhost:8000"},theme:"system",videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1};await this.settings.put(c),console.log("Created default settings in IndexedDB:",c)}}catch(i){console.error("Error initializing settings:",i)}const n=localStorage.getItem("chats");if(n)try{const i=JSON.parse(n);await this.transaction("rw",this.chats,this.messages,this.mediaItems,async()=>{for(const s of i){const c=[...s.messages],d={...s};delete d.messages,await this.chats.put(d);for(const S of c){const O=S.media||[],B={...S,chatId:s.id};delete B.media,await this.messages.put(B);for(const q of O)await this.mediaItems.put({...q,messageId:S.id})}}console.log("Chats migrated from localStorage to IndexedDB")})}catch(i){console.error("Failed to migrate chats:",i)}}}async getAllChats(){return(await this.chats.orderBy("updatedAt").reverse().toArray()).map(i=>({...i,messages:[]}))}async getChat(n){const i=await this.chats.get(n);if(!i)return null;const s=await this.messages.where("chatId").equals(n).sortBy("timestamp");for(const c of s){const d=await this.mediaItems.where("messageId").equals(c.id).toArray();d.length>0&&(c.media=d)}return{...i,messages:s}}async createChat(n=Jo){const i={id:crypto.randomUUID(),title:"New Chat",messages:[],createdAt:Date.now(),updatedAt:Date.now(),model:n},s={...i};return delete s.messages,await this.chats.put(s),i}async updateChat(n,i){const s={...i};"messages"in s&&delete s.messages,s.updatedAt=Date.now(),await this.chats.update(n,s)}async deleteChat(n){await this.transaction("rw",this.chats,this.messages,this.mediaItems,async()=>{const i=await this.messages.where("chatId").equals(n).toArray();for(const s of i)await this.mediaItems.where("messageId").equals(s.id).delete();await this.messages.where("chatId").equals(n).delete(),await this.chats.delete(n)})}async addMessage(n,i){const s=crypto.randomUUID(),c=Date.now(),d={...i,id:s,chatId:n,timestamp:c};return await this.transaction("rw",this.messages,this.mediaItems,this.chats,async()=>{const S=d.media||[],O={...d};delete O.media,await this.messages.put(O);for(const q of S){const H={...q,id:q.id||crypto.randomUUID(),messageId:s,timestamp:q.timestamp||Date.now()};await this.mediaItems.put(H)}const B=await this.chats.get(n);if(B&&B.title==="New Chat"&&i.role==="user"){const q=i.content.slice(0,30)+(i.content.length>30?"...":"");await this.chats.update(n,{title:q,updatedAt:Date.now()})}else await this.chats.update(n,{updatedAt:Date.now()})}),s}async updateMessage(n,i){try{const s=await this.messages.get(n);if(!s){console.error(`Cannot update message ${n} - not found in database`);return}await this.transaction("rw",this.messages,this.mediaItems,this.chats,async()=>{const c={...i};if("media"in c&&c.media!==void 0){const d=c.media||[];delete c.media,await this.mediaItems.where("messageId").equals(n).delete();for(const S of d){const O={...S,id:S.id||crypto.randomUUID(),messageId:n,timestamp:S.timestamp||Date.now()};await this.mediaItems.put(O)}}"chatId"in c&&delete c.chatId,Object.keys(c).forEach(d=>{c[d]===void 0&&delete c[d]}),Object.keys(c).length>0&&await this.messages.update(n,c),s.chatId&&await this.chats.update(s.chatId,{updatedAt:Date.now()})})}catch(s){throw console.error("Error updating message:",s),s}}async getSettings(){let n=await this.settings.get("user-settings");if(!n){const i={id:"user-settings",apiKeys:{},theme:"system",videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1};await this.settings.put(i),n=i}return n}async updateSettings(n){const i=await this.getSettings();await this.settings.update("user-settings",{...i,...n})}async updateApiKeys(n){const s={...(await this.getSettings()).apiKeys,...n};await this.settings.update("user-settings",{apiKeys:s})}}class zo{constructor(n){n&&Object.assign(this,n),this.messages=this.messages||[]}}const ir=new Go;export{Jo as a,xo as b,xu as c,ir as d,yu as e,gu as f,Zs as g,vu as h,Su as i,wu as j,_u as k,ta as l,Ba as m,Oo as o,fr as s,bu as u,jo as v};
