import{aC as Ti,F as cr,aB as Da}from"./BSv_i5Hy.js";var ja=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ba(o){return o&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o}var sr={exports:{}},Ka=sr.exports,di;function Ca(){return di||(di=1,function(o,n){(function(s,i){o.exports=i()})(Ka,function(){var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,a){r.__proto__=a}||function(r,a){for(var u in a)Object.prototype.hasOwnProperty.call(a,u)&&(r[u]=a[u])})(e,t)},i=function(){return(i=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++)for(var u in t=arguments[r])Object.prototype.hasOwnProperty.call(t,u)&&(e[u]=t[u]);return e}).apply(this,arguments)};function c(e,t,r){for(var a,u=0,l=t.length;u<l;u++)!a&&u in t||((a=a||Array.prototype.slice.call(t,0,u))[u]=t[u]);return e.concat(a||Array.prototype.slice.call(t))}var d=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:ja,S=Object.keys,O=Array.isArray;function B(e,t){return typeof t!="object"||S(t).forEach(function(r){e[r]=t[r]}),e}typeof Promise>"u"||d.Promise||(d.Promise=Promise);var q=Object.getPrototypeOf,H={}.hasOwnProperty;function F(e,t){return H.call(e,t)}function L(e,t){typeof t=="function"&&(t=t(q(e))),(typeof Reflect>"u"?S:Reflect.ownKeys)(t).forEach(function(r){ae(e,r,t[r])})}var V=Object.defineProperty;function ae(e,t,r,a){V(e,t,B(r&&F(r,"get")&&typeof r.get=="function"?{get:r.get,set:r.set,configurable:!0}:{value:r,configurable:!0,writable:!0},a))}function de(e){return{from:function(t){return e.prototype=Object.create(t.prototype),ae(e.prototype,"constructor",e),{extend:L.bind(null,e.prototype)}}}}var we=Object.getOwnPropertyDescriptor,re=[].slice;function ee(e,t,r){return re.call(e,t,r)}function ge(e,t){return t(e)}function pe(e){if(!e)throw new Error("Assertion Failed")}function Je(e){d.setImmediate?setImmediate(e):setTimeout(e,0)}function ue(e,t){if(typeof t=="string"&&F(e,t))return e[t];if(!t)return e;if(typeof t!="string"){for(var r=[],a=0,u=t.length;a<u;++a){var l=ue(e,t[a]);r.push(l)}return r}var f=t.indexOf(".");if(f!==-1){var h=e[t.substr(0,f)];return h==null?void 0:ue(h,t.substr(f+1))}}function se(e,t,r){if(e&&t!==void 0&&!("isFrozen"in Object&&Object.isFrozen(e)))if(typeof t!="string"&&"length"in t){pe(typeof r!="string"&&"length"in r);for(var a=0,u=t.length;a<u;++a)se(e,t[a],r[a])}else{var l,f,h=t.indexOf(".");h!==-1?(l=t.substr(0,h),(f=t.substr(h+1))===""?r===void 0?O(e)&&!isNaN(parseInt(l))?e.splice(l,1):delete e[l]:e[l]=r:se(h=!(h=e[l])||!F(e,l)?e[l]={}:h,f,r)):r===void 0?O(e)&&!isNaN(parseInt(t))?e.splice(t,1):delete e[t]:e[t]=r}}function Ee(e){var t,r={};for(t in e)F(e,t)&&(r[t]=e[t]);return r}var Te=[].concat;function Ue(e){return Te.apply([],e)}var ht="BigUint64Array,BigInt64Array,Array,Boolean,String,Date,RegExp,Blob,File,FileList,FileSystemFileHandle,FileSystemDirectoryHandle,ArrayBuffer,DataView,Uint8ClampedArray,ImageBitmap,ImageData,Map,Set,CryptoKey".split(",").concat(Ue([8,16,32,64].map(function(e){return["Int","Uint","Float"].map(function(t){return t+e+"Array"})}))).filter(function(e){return d[e]}),ct=new Set(ht.map(function(e){return d[e]})),Re=null;function le(e){return Re=new WeakMap,e=function t(r){if(!r||typeof r!="object")return r;var a=Re.get(r);if(a)return a;if(O(r)){a=[],Re.set(r,a);for(var u=0,l=r.length;u<l;++u)a.push(t(r[u]))}else if(ct.has(r.constructor))a=r;else{var f,h=q(r);for(f in a=h===Object.prototype?{}:Object.create(h),Re.set(r,a),r)F(r,f)&&(a[f]=t(r[f]))}return a}(e),Re=null,e}var qt={}.toString;function lt(e){return qt.call(e).slice(8,-1)}var Me=typeof Symbol<"u"?Symbol.iterator:"@@iterator",De=typeof Me=="symbol"?function(e){var t;return e!=null&&(t=e[Me])&&t.apply(e)}:function(){return null};function ce(e,t){return t=e.indexOf(t),0<=t&&e.splice(t,1),0<=t}var Ie={};function ve(e){var t,r,a,u;if(arguments.length===1){if(O(e))return e.slice();if(this===Ie&&typeof e=="string")return[e];if(u=De(e)){for(r=[];!(a=u.next()).done;)r.push(a.value);return r}if(e==null)return[e];if(typeof(t=e.length)!="number")return[e];for(r=new Array(t);t--;)r[t]=e[t];return r}for(t=arguments.length,r=new Array(t);t--;)r[t]=arguments[t];return r}var Fe=typeof Symbol<"u"?function(e){return e[Symbol.toStringTag]==="AsyncFunction"}:function(){return!1},$t=["Unknown","Constraint","Data","TransactionInactive","ReadOnly","Version","NotFound","InvalidState","InvalidAccess","Abort","Timeout","QuotaExceeded","Syntax","DataClone"],Ce=["Modify","Bulk","OpenFailed","VersionChange","Schema","Upgrade","InvalidTable","MissingAPI","NoSuchDatabase","InvalidArgument","SubTransaction","Unsupported","Internal","DatabaseClosed","PrematureCommit","ForeignAwait"].concat($t),dn={VersionChanged:"Database version changed by other database connection",DatabaseClosed:"Database has been closed",Abort:"Transaction aborted",TransactionInactive:"Transaction has already completed or failed",MissingAPI:"IndexedDB API missing. Please visit https://tinyurl.com/y2uuvskb"};function St(e,t){this.name=e,this.message=t}function Rs(e,t){return e+". Errors: "+Object.keys(t).map(function(r){return t[r].toString()}).filter(function(r,a,u){return u.indexOf(r)===a}).join(`
`)}function pn(e,t,r,a){this.failures=t,this.failedKeys=a,this.successCount=r,this.message=Rs(e,t)}function kt(e,t){this.name="BulkError",this.failures=Object.keys(t).map(function(r){return t[r]}),this.failuresByPos=t,this.message=Rs(e,this.failures)}de(St).from(Error).extend({toString:function(){return this.name+": "+this.message}}),de(pn).from(St),de(kt).from(St);var vr=Ce.reduce(function(e,t){return e[t]=t+"Error",e},{}),na=St,$=Ce.reduce(function(e,t){var r=t+"Error";function a(u,l){this.name=r,u?typeof u=="string"?(this.message="".concat(u).concat(l?`
 `+l:""),this.inner=l||null):typeof u=="object"&&(this.message="".concat(u.name," ").concat(u.message),this.inner=u):(this.message=dn[t]||r,this.inner=null)}return de(a).from(na),e[t]=a,e},{});$.Syntax=SyntaxError,$.Type=TypeError,$.Range=RangeError;var Ds=$t.reduce(function(e,t){return e[t+"Error"]=$[t],e},{}),mn=Ce.reduce(function(e,t){return["Syntax","Type","Range"].indexOf(t)===-1&&(e[t+"Error"]=$[t]),e},{});function te(){}function Nt(e){return e}function ra(e,t){return e==null||e===Nt?t:function(r){return t(e(r))}}function ft(e,t){return function(){e.apply(this,arguments),t.apply(this,arguments)}}function sa(e,t){return e===te?t:function(){var r=e.apply(this,arguments);r!==void 0&&(arguments[0]=r);var a=this.onsuccess,u=this.onerror;this.onsuccess=null,this.onerror=null;var l=t.apply(this,arguments);return a&&(this.onsuccess=this.onsuccess?ft(a,this.onsuccess):a),u&&(this.onerror=this.onerror?ft(u,this.onerror):u),l!==void 0?l:r}}function ia(e,t){return e===te?t:function(){e.apply(this,arguments);var r=this.onsuccess,a=this.onerror;this.onsuccess=this.onerror=null,t.apply(this,arguments),r&&(this.onsuccess=this.onsuccess?ft(r,this.onsuccess):r),a&&(this.onerror=this.onerror?ft(a,this.onerror):a)}}function aa(e,t){return e===te?t:function(r){var a=e.apply(this,arguments);B(r,a);var u=this.onsuccess,l=this.onerror;return this.onsuccess=null,this.onerror=null,r=t.apply(this,arguments),u&&(this.onsuccess=this.onsuccess?ft(u,this.onsuccess):u),l&&(this.onerror=this.onerror?ft(l,this.onerror):l),a===void 0?r===void 0?void 0:r:B(a,r)}}function oa(e,t){return e===te?t:function(){return t.apply(this,arguments)!==!1&&e.apply(this,arguments)}}function br(e,t){return e===te?t:function(){var r=e.apply(this,arguments);if(r&&typeof r.then=="function"){for(var a=this,u=arguments.length,l=new Array(u);u--;)l[u]=arguments[u];return r.then(function(){return t.apply(a,l)})}return t.apply(this,arguments)}}mn.ModifyError=pn,mn.DexieError=St,mn.BulkError=kt;var Le=typeof location<"u"&&/^(http|https):\/\/(localhost|127\.0\.0\.1)/.test(location.href);function js(e){Le=e}var Ft={},Bs=100,ht=typeof Promise>"u"?[]:function(){var e=Promise.resolve();if(typeof crypto>"u"||!crypto.subtle)return[e,q(e),e];var t=crypto.subtle.digest("SHA-512",new Uint8Array([0]));return[t,q(t),e]}(),$t=ht[0],Ce=ht[1],ht=ht[2],Ce=Ce&&Ce.then,dt=$t&&$t.constructor,wr=!!ht,Ut=function(e,t){Lt.push([e,t]),yn&&(queueMicrotask(ca),yn=!1)},_r=!0,yn=!0,pt=[],gn=[],xr=Nt,Qe={id:"global",global:!0,ref:0,unhandleds:[],onunhandled:te,pgp:!1,env:{},finalize:te},N=Qe,Lt=[],mt=0,vn=[];function K(e){if(typeof this!="object")throw new TypeError("Promises must be constructed via new");this._listeners=[],this._lib=!1;var t=this._PSD=N;if(typeof e!="function"){if(e!==Ft)throw new TypeError("Not a function");return this._state=arguments[1],this._value=arguments[2],void(this._state===!1&&kr(this,this._value))}this._state=null,this._value=null,++t.ref,function r(a,u){try{u(function(l){if(a._state===null){if(l===a)throw new TypeError("A promise cannot be resolved with itself.");var f=a._lib&&Pt();l&&typeof l.then=="function"?r(a,function(h,m){l instanceof K?l._then(h,m):l.then(h,m)}):(a._state=!0,a._value=l,Cs(a)),f&&At()}},kr.bind(null,a))}catch(l){kr(a,l)}}(this,e)}var Sr={get:function(){var e=N,t=xn;function r(a,u){var l=this,f=!e.global&&(e!==N||t!==xn),h=f&&!et(),m=new K(function(g,w){Pr(l,new Ks(Ns(a,e,f,h),Ns(u,e,f,h),g,w,e))});return this._consoleTask&&(m._consoleTask=this._consoleTask),m}return r.prototype=Ft,r},set:function(e){ae(this,"then",e&&e.prototype===Ft?Sr:{get:function(){return e},set:Sr.set})}};function Ks(e,t,r,a,u){this.onFulfilled=typeof e=="function"?e:null,this.onRejected=typeof t=="function"?t:null,this.resolve=r,this.reject=a,this.psd=u}function kr(e,t){var r,a;gn.push(t),e._state===null&&(r=e._lib&&Pt(),t=xr(t),e._state=!1,e._value=t,a=e,pt.some(function(u){return u._value===a._value})||pt.push(a),Cs(e),r&&At())}function Cs(e){var t=e._listeners;e._listeners=[];for(var r=0,a=t.length;r<a;++r)Pr(e,t[r]);var u=e._PSD;--u.ref||u.finalize(),mt===0&&(++mt,Ut(function(){--mt==0&&Ar()},[]))}function Pr(e,t){if(e._state!==null){var r=e._state?t.onFulfilled:t.onRejected;if(r===null)return(e._state?t.resolve:t.reject)(e._value);++t.psd.ref,++mt,Ut(ua,[r,e,t])}else e._listeners.push(t)}function ua(e,t,r){try{var a,u=t._value;!t._state&&gn.length&&(gn=[]),a=Le&&t._consoleTask?t._consoleTask.run(function(){return e(u)}):e(u),t._state||gn.indexOf(u)!==-1||function(l){for(var f=pt.length;f;)if(pt[--f]._value===l._value)return pt.splice(f,1)}(t),r.resolve(a)}catch(l){r.reject(l)}finally{--mt==0&&Ar(),--r.psd.ref||r.psd.finalize()}}function ca(){yt(Qe,function(){Pt()&&At()})}function Pt(){var e=_r;return yn=_r=!1,e}function At(){var e,t,r;do for(;0<Lt.length;)for(e=Lt,Lt=[],r=e.length,t=0;t<r;++t){var a=e[t];a[0].apply(null,a[1])}while(0<Lt.length);yn=_r=!0}function Ar(){var e=pt;pt=[],e.forEach(function(a){a._PSD.onunhandled.call(null,a._value,a)});for(var t=vn.slice(0),r=t.length;r;)t[--r]()}function bn(e){return new K(Ft,!1,e)}function oe(e,t){var r=N;return function(){var a=Pt(),u=N;try{return tt(r,!0),e.apply(this,arguments)}catch(l){t&&t(l)}finally{tt(u,!1),a&&At()}}}L(K.prototype,{then:Sr,_then:function(e,t){Pr(this,new Ks(null,null,e,t,N))},catch:function(e){if(arguments.length===1)return this.then(null,e);var t=e,r=arguments[1];return typeof t=="function"?this.then(null,function(a){return(a instanceof t?r:bn)(a)}):this.then(null,function(a){return(a&&a.name===t?r:bn)(a)})},finally:function(e){return this.then(function(t){return K.resolve(e()).then(function(){return t})},function(t){return K.resolve(e()).then(function(){return bn(t)})})},timeout:function(e,t){var r=this;return e<1/0?new K(function(a,u){var l=setTimeout(function(){return u(new $.Timeout(t))},e);r.then(a,u).finally(clearTimeout.bind(null,l))}):this}}),typeof Symbol<"u"&&Symbol.toStringTag&&ae(K.prototype,Symbol.toStringTag,"Dexie.Promise"),Qe.env=qs(),L(K,{all:function(){var e=ve.apply(null,arguments).map(Sn);return new K(function(t,r){e.length===0&&t([]);var a=e.length;e.forEach(function(u,l){return K.resolve(u).then(function(f){e[l]=f,--a||t(e)},r)})})},resolve:function(e){return e instanceof K?e:e&&typeof e.then=="function"?new K(function(t,r){e.then(t,r)}):new K(Ft,!0,e)},reject:bn,race:function(){var e=ve.apply(null,arguments).map(Sn);return new K(function(t,r){e.map(function(a){return K.resolve(a).then(t,r)})})},PSD:{get:function(){return N},set:function(e){return N=e}},totalEchoes:{get:function(){return xn}},newPSD:Ze,usePSD:yt,scheduler:{get:function(){return Ut},set:function(e){Ut=e}},rejectionMapper:{get:function(){return xr},set:function(e){xr=e}},follow:function(e,t){return new K(function(r,a){return Ze(function(u,l){var f=N;f.unhandleds=[],f.onunhandled=l,f.finalize=ft(function(){var h,m=this;h=function(){m.unhandleds.length===0?u():l(m.unhandleds[0])},vn.push(function g(){h(),vn.splice(vn.indexOf(g),1)}),++mt,Ut(function(){--mt==0&&Ar()},[])},f.finalize),e()},t,r,a)})}}),dt&&(dt.allSettled&&ae(K,"allSettled",function(){var e=ve.apply(null,arguments).map(Sn);return new K(function(t){e.length===0&&t([]);var r=e.length,a=new Array(r);e.forEach(function(u,l){return K.resolve(u).then(function(f){return a[l]={status:"fulfilled",value:f}},function(f){return a[l]={status:"rejected",reason:f}}).then(function(){return--r||t(a)})})})}),dt.any&&typeof AggregateError<"u"&&ae(K,"any",function(){var e=ve.apply(null,arguments).map(Sn);return new K(function(t,r){e.length===0&&r(new AggregateError([]));var a=e.length,u=new Array(a);e.forEach(function(l,f){return K.resolve(l).then(function(h){return t(h)},function(h){u[f]=h,--a||r(new AggregateError(u))})})})}),dt.withResolvers&&(K.withResolvers=dt.withResolvers));var me={awaits:0,echoes:0,id:0},la=0,wn=[],_n=0,xn=0,fa=0;function Ze(e,t,r,a){var u=N,l=Object.create(u);return l.parent=u,l.ref=0,l.global=!1,l.id=++fa,Qe.env,l.env=wr?{Promise:K,PromiseProp:{value:K,configurable:!0,writable:!0},all:K.all,race:K.race,allSettled:K.allSettled,any:K.any,resolve:K.resolve,reject:K.reject}:{},t&&B(l,t),++u.ref,l.finalize=function(){--this.parent.ref||this.parent.finalize()},a=yt(l,e,r,a),l.ref===0&&l.finalize(),a}function Et(){return me.id||(me.id=++la),++me.awaits,me.echoes+=Bs,me.id}function et(){return!!me.awaits&&(--me.awaits==0&&(me.id=0),me.echoes=me.awaits*Bs,!0)}function Sn(e){return me.echoes&&e&&e.constructor===dt?(Et(),e.then(function(t){return et(),t},function(t){return et(),fe(t)})):e}function ha(){var e=wn[wn.length-1];wn.pop(),tt(e,!1)}function tt(e,t){var r,a=N;(t?!me.echoes||_n++&&e===N:!_n||--_n&&e===N)||queueMicrotask(t?(function(u){++xn,me.echoes&&--me.echoes!=0||(me.echoes=me.awaits=me.id=0),wn.push(N),tt(u,!0)}).bind(null,e):ha),e!==N&&(N=e,a===Qe&&(Qe.env=qs()),wr&&(r=Qe.env.Promise,t=e.env,(a.global||e.global)&&(Object.defineProperty(d,"Promise",t.PromiseProp),r.all=t.all,r.race=t.race,r.resolve=t.resolve,r.reject=t.reject,t.allSettled&&(r.allSettled=t.allSettled),t.any&&(r.any=t.any))))}function qs(){var e=d.Promise;return wr?{Promise:e,PromiseProp:Object.getOwnPropertyDescriptor(d,"Promise"),all:e.all,race:e.race,allSettled:e.allSettled,any:e.any,resolve:e.resolve,reject:e.reject}:{}}function yt(e,t,r,a,u){var l=N;try{return tt(e,!0),t(r,a,u)}finally{tt(l,!1)}}function Ns(e,t,r,a){return typeof e!="function"?e:function(){var u=N;r&&Et(),tt(t,!0);try{return e.apply(this,arguments)}finally{tt(u,!1),a&&queueMicrotask(et)}}}function Er(e){Promise===dt&&me.echoes===0?_n===0?e():enqueueNativeMicroTask(e):setTimeout(e,0)}(""+Ce).indexOf("[native code]")===-1&&(Et=et=te);var fe=K.reject,gt="ï¿¿",ze="Invalid key provided. Keys must be of type string, number, Date or Array<string | number | Date>.",Fs="String expected.",Ot=[],kn="__dbnames",Or="readonly",Mr="readwrite";function vt(e,t){return e?t?function(){return e.apply(this,arguments)&&t.apply(this,arguments)}:e:t}var $s={type:3,lower:-1/0,lowerOpen:!1,upper:[[]],upperOpen:!1};function Pn(e){return typeof e!="string"||/\./.test(e)?function(t){return t}:function(t){return t[e]===void 0&&e in t&&delete(t=le(t))[e],t}}function Us(){throw $.Type()}function Y(e,t){try{var r=Ls(e),a=Ls(t);if(r!==a)return r==="Array"?1:a==="Array"?-1:r==="binary"?1:a==="binary"?-1:r==="string"?1:a==="string"?-1:r==="Date"?1:a!=="Date"?NaN:-1;switch(r){case"number":case"Date":case"string":return t<e?1:e<t?-1:0;case"binary":return function(u,l){for(var f=u.length,h=l.length,m=f<h?f:h,g=0;g<m;++g)if(u[g]!==l[g])return u[g]<l[g]?-1:1;return f===h?0:f<h?-1:1}(Ws(e),Ws(t));case"Array":return function(u,l){for(var f=u.length,h=l.length,m=f<h?f:h,g=0;g<m;++g){var w=Y(u[g],l[g]);if(w!==0)return w}return f===h?0:f<h?-1:1}(e,t)}}catch{}return NaN}function Ls(e){var t=typeof e;return t!="object"?t:ArrayBuffer.isView(e)?"binary":(e=lt(e),e==="ArrayBuffer"?"binary":e)}function Ws(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e)}var Hs=(ie.prototype._trans=function(e,t,r){var a=this._tx||N.trans,u=this.name,l=Le&&typeof console<"u"&&console.createTask&&console.createTask("Dexie: ".concat(e==="readonly"?"read":"write"," ").concat(this.name));function f(g,w,p){if(!p.schema[u])throw new $.NotFound("Table "+u+" not part of transaction");return t(p.idbtrans,p)}var h=Pt();try{var m=a&&a.db._novip===this.db._novip?a===N.trans?a._promise(e,f,r):Ze(function(){return a._promise(e,f,r)},{trans:a,transless:N.transless||N}):function g(w,p,x,y){if(w.idbdb&&(w._state.openComplete||N.letThrough||w._vip)){var b=w._createTransaction(p,x,w._dbSchema);try{b.create(),w._state.PR1398_maxLoop=3}catch(_){return _.name===vr.InvalidState&&w.isOpen()&&0<--w._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),w.close({disableAutoOpen:!1}),w.open().then(function(){return g(w,p,x,y)})):fe(_)}return b._promise(p,function(_,v){return Ze(function(){return N.trans=b,y(_,v,b)})}).then(function(_){if(p==="readwrite")try{b.idbtrans.commit()}catch{}return p==="readonly"?_:b._completion.then(function(){return _})})}if(w._state.openComplete)return fe(new $.DatabaseClosed(w._state.dbOpenError));if(!w._state.isBeingOpened){if(!w._state.autoOpen)return fe(new $.DatabaseClosed);w.open().catch(te)}return w._state.dbReadyPromise.then(function(){return g(w,p,x,y)})}(this.db,e,[this.name],f);return l&&(m._consoleTask=l,m=m.catch(function(g){return console.trace(g),fe(g)})),m}finally{h&&At()}},ie.prototype.get=function(e,t){var r=this;return e&&e.constructor===Object?this.where(e).first(t):e==null?fe(new $.Type("Invalid argument to Table.get()")):this._trans("readonly",function(a){return r.core.get({trans:a,key:e}).then(function(u){return r.hook.reading.fire(u)})}).then(t)},ie.prototype.where=function(e){if(typeof e=="string")return new this.db.WhereClause(this,e);if(O(e))return new this.db.WhereClause(this,"[".concat(e.join("+"),"]"));var t=S(e);if(t.length===1)return this.where(t[0]).equals(e[t[0]]);var r=this.schema.indexes.concat(this.schema.primKey).filter(function(h){if(h.compound&&t.every(function(g){return 0<=h.keyPath.indexOf(g)})){for(var m=0;m<t.length;++m)if(t.indexOf(h.keyPath[m])===-1)return!1;return!0}return!1}).sort(function(h,m){return h.keyPath.length-m.keyPath.length})[0];if(r&&this.db._maxKey!==gt){var l=r.keyPath.slice(0,t.length);return this.where(l).equals(l.map(function(m){return e[m]}))}!r&&Le&&console.warn("The query ".concat(JSON.stringify(e)," on ").concat(this.name," would benefit from a ")+"compound index [".concat(t.join("+"),"]"));var a=this.schema.idxByName;function u(h,m){return Y(h,m)===0}var f=t.reduce(function(p,m){var g=p[0],w=p[1],p=a[m],x=e[m];return[g||p,g||!p?vt(w,p&&p.multi?function(y){return y=ue(y,m),O(y)&&y.some(function(b){return u(x,b)})}:function(y){return u(x,ue(y,m))}):w]},[null,null]),l=f[0],f=f[1];return l?this.where(l.name).equals(e[l.keyPath]).filter(f):r?this.filter(f):this.where(t).equals("")},ie.prototype.filter=function(e){return this.toCollection().and(e)},ie.prototype.count=function(e){return this.toCollection().count(e)},ie.prototype.offset=function(e){return this.toCollection().offset(e)},ie.prototype.limit=function(e){return this.toCollection().limit(e)},ie.prototype.each=function(e){return this.toCollection().each(e)},ie.prototype.toArray=function(e){return this.toCollection().toArray(e)},ie.prototype.toCollection=function(){return new this.db.Collection(new this.db.WhereClause(this))},ie.prototype.orderBy=function(e){return new this.db.Collection(new this.db.WhereClause(this,O(e)?"[".concat(e.join("+"),"]"):e))},ie.prototype.reverse=function(){return this.toCollection().reverse()},ie.prototype.mapToClass=function(e){var t,r=this.db,a=this.name;function u(){return t!==null&&t.apply(this,arguments)||this}(this.schema.mappedClass=e).prototype instanceof Us&&(function(m,g){if(typeof g!="function"&&g!==null)throw new TypeError("Class extends value "+String(g)+" is not a constructor or null");function w(){this.constructor=m}s(m,g),m.prototype=g===null?Object.create(g):(w.prototype=g.prototype,new w)}(u,t=e),Object.defineProperty(u.prototype,"db",{get:function(){return r},enumerable:!1,configurable:!0}),u.prototype.table=function(){return a},e=u);for(var l=new Set,f=e.prototype;f;f=q(f))Object.getOwnPropertyNames(f).forEach(function(m){return l.add(m)});function h(m){if(!m)return m;var g,w=Object.create(e.prototype);for(g in m)if(!l.has(g))try{w[g]=m[g]}catch{}return w}return this.schema.readHook&&this.hook.reading.unsubscribe(this.schema.readHook),this.schema.readHook=h,this.hook("reading",h),e},ie.prototype.defineClass=function(){return this.mapToClass(function(e){B(this,e)})},ie.prototype.add=function(e,t){var r=this,a=this.schema.primKey,u=a.auto,l=a.keyPath,f=e;return l&&u&&(f=Pn(l)(e)),this._trans("readwrite",function(h){return r.core.mutate({trans:h,type:"add",keys:t!=null?[t]:null,values:[f]})}).then(function(h){return h.numFailures?K.reject(h.failures[0]):h.lastResult}).then(function(h){if(l)try{se(e,l,h)}catch{}return h})},ie.prototype.update=function(e,t){return typeof e!="object"||O(e)?this.where(":id").equals(e).modify(t):(e=ue(e,this.schema.primKey.keyPath),e===void 0?fe(new $.InvalidArgument("Given object does not contain its primary key")):this.where(":id").equals(e).modify(t))},ie.prototype.put=function(e,t){var r=this,a=this.schema.primKey,u=a.auto,l=a.keyPath,f=e;return l&&u&&(f=Pn(l)(e)),this._trans("readwrite",function(h){return r.core.mutate({trans:h,type:"put",values:[f],keys:t!=null?[t]:null})}).then(function(h){return h.numFailures?K.reject(h.failures[0]):h.lastResult}).then(function(h){if(l)try{se(e,l,h)}catch{}return h})},ie.prototype.delete=function(e){var t=this;return this._trans("readwrite",function(r){return t.core.mutate({trans:r,type:"delete",keys:[e]})}).then(function(r){return r.numFailures?K.reject(r.failures[0]):void 0})},ie.prototype.clear=function(){var e=this;return this._trans("readwrite",function(t){return e.core.mutate({trans:t,type:"deleteRange",range:$s})}).then(function(t){return t.numFailures?K.reject(t.failures[0]):void 0})},ie.prototype.bulkGet=function(e){var t=this;return this._trans("readonly",function(r){return t.core.getMany({keys:e,trans:r}).then(function(a){return a.map(function(u){return t.hook.reading.fire(u)})})})},ie.prototype.bulkAdd=function(e,t,r){var a=this,u=Array.isArray(t)?t:void 0,l=(r=r||(u?void 0:t))?r.allKeys:void 0;return this._trans("readwrite",function(f){var g=a.schema.primKey,h=g.auto,g=g.keyPath;if(g&&u)throw new $.InvalidArgument("bulkAdd(): keys argument invalid on tables with inbound keys");if(u&&u.length!==e.length)throw new $.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,g=g&&h?e.map(Pn(g)):e;return a.core.mutate({trans:f,type:"add",keys:u,values:g,wantResults:l}).then(function(b){var p=b.numFailures,x=b.results,y=b.lastResult,b=b.failures;if(p===0)return l?x:y;throw new kt("".concat(a.name,".bulkAdd(): ").concat(p," of ").concat(m," operations failed"),b)})})},ie.prototype.bulkPut=function(e,t,r){var a=this,u=Array.isArray(t)?t:void 0,l=(r=r||(u?void 0:t))?r.allKeys:void 0;return this._trans("readwrite",function(f){var g=a.schema.primKey,h=g.auto,g=g.keyPath;if(g&&u)throw new $.InvalidArgument("bulkPut(): keys argument invalid on tables with inbound keys");if(u&&u.length!==e.length)throw new $.InvalidArgument("Arguments objects and keys must have the same length");var m=e.length,g=g&&h?e.map(Pn(g)):e;return a.core.mutate({trans:f,type:"put",keys:u,values:g,wantResults:l}).then(function(b){var p=b.numFailures,x=b.results,y=b.lastResult,b=b.failures;if(p===0)return l?x:y;throw new kt("".concat(a.name,".bulkPut(): ").concat(p," of ").concat(m," operations failed"),b)})})},ie.prototype.bulkUpdate=function(e){var t=this,r=this.core,a=e.map(function(f){return f.key}),u=e.map(function(f){return f.changes}),l=[];return this._trans("readwrite",function(f){return r.getMany({trans:f,keys:a,cache:"clone"}).then(function(h){var m=[],g=[];e.forEach(function(p,x){var y=p.key,b=p.changes,_=h[x];if(_){for(var v=0,k=Object.keys(b);v<k.length;v++){var P=k[v],A=b[P];if(P===t.schema.primKey.keyPath){if(Y(A,y)!==0)throw new $.Constraint("Cannot update primary key in bulkUpdate()")}else se(_,P,A)}l.push(x),m.push(y),g.push(_)}});var w=m.length;return r.mutate({trans:f,type:"put",keys:m,values:g,updates:{keys:a,changeSpecs:u}}).then(function(p){var x=p.numFailures,y=p.failures;if(x===0)return w;for(var b=0,_=Object.keys(y);b<_.length;b++){var v,k=_[b],P=l[Number(k)];P!=null&&(v=y[k],delete y[k],y[P]=v)}throw new kt("".concat(t.name,".bulkUpdate(): ").concat(x," of ").concat(w," operations failed"),y)})})})},ie.prototype.bulkDelete=function(e){var t=this,r=e.length;return this._trans("readwrite",function(a){return t.core.mutate({trans:a,type:"delete",keys:e})}).then(function(f){var u=f.numFailures,l=f.lastResult,f=f.failures;if(u===0)return l;throw new kt("".concat(t.name,".bulkDelete(): ").concat(u," of ").concat(r," operations failed"),f)})},ie);function ie(){}function Wt(e){function t(f,h){if(h){for(var m=arguments.length,g=new Array(m-1);--m;)g[m-1]=arguments[m];return r[f].subscribe.apply(null,g),e}if(typeof f=="string")return r[f]}var r={};t.addEventType=l;for(var a=1,u=arguments.length;a<u;++a)l(arguments[a]);return t;function l(f,h,m){if(typeof f!="object"){var g;h=h||oa;var w={subscribers:[],fire:m=m||te,subscribe:function(p){w.subscribers.indexOf(p)===-1&&(w.subscribers.push(p),w.fire=h(w.fire,p))},unsubscribe:function(p){w.subscribers=w.subscribers.filter(function(x){return x!==p}),w.fire=w.subscribers.reduce(h,m)}};return r[f]=t[f]=w}S(g=f).forEach(function(p){var x=g[p];if(O(x))l(p,g[p][0],g[p][1]);else{if(x!=="asap")throw new $.InvalidArgument("Invalid event config");var y=l(p,Nt,function(){for(var b=arguments.length,_=new Array(b);b--;)_[b]=arguments[b];y.subscribers.forEach(function(v){Je(function(){v.apply(null,_)})})})}})}}function Ht(e,t){return de(t).from({prototype:e}),t}function Mt(e,t){return!(e.filter||e.algorithm||e.or)&&(t?e.justLimit:!e.replayFilter)}function Ir(e,t){e.filter=vt(e.filter,t)}function Tr(e,t,r){var a=e.replayFilter;e.replayFilter=a?function(){return vt(a(),t())}:t,e.justLimit=r&&!a}function An(e,t){if(e.isPrimKey)return t.primaryKey;var r=t.getIndexByKeyPath(e.index);if(!r)throw new $.Schema("KeyPath "+e.index+" on object store "+t.name+" is not indexed");return r}function Vs(e,t,r){var a=An(e,t.schema);return t.openCursor({trans:r,values:!e.keysOnly,reverse:e.dir==="prev",unique:!!e.unique,query:{index:a,range:e.range}})}function En(e,t,r,a){var u=e.replayFilter?vt(e.filter,e.replayFilter()):e.filter;if(e.or){var l={},f=function(h,m,g){var w,p;u&&!u(m,g,function(x){return m.stop(x)},function(x){return m.fail(x)})||((p=""+(w=m.primaryKey))=="[object ArrayBuffer]"&&(p=""+new Uint8Array(w)),F(l,p)||(l[p]=!0,t(h,m,g)))};return Promise.all([e.or._iterate(f,r),Js(Vs(e,a,r),e.algorithm,f,!e.keysOnly&&e.valueMapper)])}return Js(Vs(e,a,r),vt(e.algorithm,u),t,!e.keysOnly&&e.valueMapper)}function Js(e,t,r,a){var u=oe(a?function(l,f,h){return r(a(l),f,h)}:r);return e.then(function(l){if(l)return l.start(function(){var f=function(){return l.continue()};t&&!t(l,function(h){return f=h},function(h){l.stop(h),f=te},function(h){l.fail(h),f=te})||u(l.value,l,function(h){return f=h}),f()})})}var Vt=(zs.prototype.execute=function(e){var t=this["@@propmod"];if(t.add!==void 0){var r=t.add;if(O(r))return c(c([],O(e)?e:[],!0),r).sort();if(typeof r=="number")return(Number(e)||0)+r;if(typeof r=="bigint")try{return BigInt(e)+r}catch{return BigInt(0)+r}throw new TypeError("Invalid term ".concat(r))}if(t.remove!==void 0){var a=t.remove;if(O(a))return O(e)?e.filter(function(u){return!a.includes(u)}).sort():[];if(typeof a=="number")return Number(e)-a;if(typeof a=="bigint")try{return BigInt(e)-a}catch{return BigInt(0)-a}throw new TypeError("Invalid subtrahend ".concat(a))}return r=(r=t.replacePrefix)===null||r===void 0?void 0:r[0],r&&typeof e=="string"&&e.startsWith(r)?t.replacePrefix[1]+e.substring(r.length):e},zs);function zs(e){this["@@propmod"]=e}var da=(Z.prototype._read=function(e,t){var r=this._ctx;return r.error?r.table._trans(null,fe.bind(null,r.error)):r.table._trans("readonly",e).then(t)},Z.prototype._write=function(e){var t=this._ctx;return t.error?t.table._trans(null,fe.bind(null,t.error)):t.table._trans("readwrite",e,"locked")},Z.prototype._addAlgorithm=function(e){var t=this._ctx;t.algorithm=vt(t.algorithm,e)},Z.prototype._iterate=function(e,t){return En(this._ctx,e,t,this._ctx.table.core)},Z.prototype.clone=function(e){var t=Object.create(this.constructor.prototype),r=Object.create(this._ctx);return e&&B(r,e),t._ctx=r,t},Z.prototype.raw=function(){return this._ctx.valueMapper=null,this},Z.prototype.each=function(e){var t=this._ctx;return this._read(function(r){return En(t,e,r,t.table.core)})},Z.prototype.count=function(e){var t=this;return this._read(function(r){var a=t._ctx,u=a.table.core;if(Mt(a,!0))return u.count({trans:r,query:{index:An(a,u.schema),range:a.range}}).then(function(f){return Math.min(f,a.limit)});var l=0;return En(a,function(){return++l,!1},r,u).then(function(){return l})}).then(e)},Z.prototype.sortBy=function(e,t){var r=e.split(".").reverse(),a=r[0],u=r.length-1;function l(m,g){return g?l(m[r[g]],g-1):m[a]}var f=this._ctx.dir==="next"?1:-1;function h(m,g){return Y(l(m,u),l(g,u))*f}return this.toArray(function(m){return m.sort(h)}).then(t)},Z.prototype.toArray=function(e){var t=this;return this._read(function(r){var a=t._ctx;if(a.dir==="next"&&Mt(a,!0)&&0<a.limit){var u=a.valueMapper,l=An(a,a.table.core.schema);return a.table.core.query({trans:r,limit:a.limit,values:!0,query:{index:l,range:a.range}}).then(function(h){return h=h.result,u?h.map(u):h})}var f=[];return En(a,function(h){return f.push(h)},r,a.table.core).then(function(){return f})},e)},Z.prototype.offset=function(e){var t=this._ctx;return e<=0||(t.offset+=e,Mt(t)?Tr(t,function(){var r=e;return function(a,u){return r===0||(r===1?--r:u(function(){a.advance(r),r=0}),!1)}}):Tr(t,function(){var r=e;return function(){return--r<0}})),this},Z.prototype.limit=function(e){return this._ctx.limit=Math.min(this._ctx.limit,e),Tr(this._ctx,function(){var t=e;return function(r,a,u){return--t<=0&&a(u),0<=t}},!0),this},Z.prototype.until=function(e,t){return Ir(this._ctx,function(r,a,u){return!e(r.value)||(a(u),t)}),this},Z.prototype.first=function(e){return this.limit(1).toArray(function(t){return t[0]}).then(e)},Z.prototype.last=function(e){return this.reverse().first(e)},Z.prototype.filter=function(e){var t;return Ir(this._ctx,function(r){return e(r.value)}),(t=this._ctx).isMatch=vt(t.isMatch,e),this},Z.prototype.and=function(e){return this.filter(e)},Z.prototype.or=function(e){return new this.db.WhereClause(this._ctx.table,e,this)},Z.prototype.reverse=function(){return this._ctx.dir=this._ctx.dir==="prev"?"next":"prev",this._ondirectionchange&&this._ondirectionchange(this._ctx.dir),this},Z.prototype.desc=function(){return this.reverse()},Z.prototype.eachKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(r,a){e(a.key,a)})},Z.prototype.eachUniqueKey=function(e){return this._ctx.unique="unique",this.eachKey(e)},Z.prototype.eachPrimaryKey=function(e){var t=this._ctx;return t.keysOnly=!t.isMatch,this.each(function(r,a){e(a.primaryKey,a)})},Z.prototype.keys=function(e){var t=this._ctx;t.keysOnly=!t.isMatch;var r=[];return this.each(function(a,u){r.push(u.key)}).then(function(){return r}).then(e)},Z.prototype.primaryKeys=function(e){var t=this._ctx;if(t.dir==="next"&&Mt(t,!0)&&0<t.limit)return this._read(function(a){var u=An(t,t.table.core.schema);return t.table.core.query({trans:a,values:!1,limit:t.limit,query:{index:u,range:t.range}})}).then(function(a){return a.result}).then(e);t.keysOnly=!t.isMatch;var r=[];return this.each(function(a,u){r.push(u.primaryKey)}).then(function(){return r}).then(e)},Z.prototype.uniqueKeys=function(e){return this._ctx.unique="unique",this.keys(e)},Z.prototype.firstKey=function(e){return this.limit(1).keys(function(t){return t[0]}).then(e)},Z.prototype.lastKey=function(e){return this.reverse().firstKey(e)},Z.prototype.distinct=function(){var e=this._ctx,e=e.index&&e.table.schema.idxByName[e.index];if(!e||!e.multi)return this;var t={};return Ir(this._ctx,function(u){var a=u.primaryKey.toString(),u=F(t,a);return t[a]=!0,!u}),this},Z.prototype.modify=function(e){var t=this,r=this._ctx;return this._write(function(a){var u,l,f;f=typeof e=="function"?e:(u=S(e),l=u.length,function(v){for(var k=!1,P=0;P<l;++P){var A=u[P],E=e[A],M=ue(v,A);E instanceof Vt?(se(v,A,E.execute(M)),k=!0):M!==E&&(se(v,A,E),k=!0)}return k});var h=r.table.core,p=h.schema.primaryKey,m=p.outbound,g=p.extractKey,w=200,p=t.db._options.modifyChunkSize;p&&(w=typeof p=="object"?p[h.name]||p["*"]||200:p);function x(v,A){var P=A.failures,A=A.numFailures;b+=v-A;for(var E=0,M=S(P);E<M.length;E++){var D=M[E];y.push(P[D])}}var y=[],b=0,_=[];return t.clone().primaryKeys().then(function(v){function k(A){var E=Math.min(w,v.length-A);return h.getMany({trans:a,keys:v.slice(A,A+E),cache:"immutable"}).then(function(M){for(var D=[],I=[],T=m?[]:null,j=[],R=0;R<E;++R){var C=M[R],W={value:le(C),primKey:v[A+R]};f.call(W,W.value,W)!==!1&&(W.value==null?j.push(v[A+R]):m||Y(g(C),g(W.value))===0?(I.push(W.value),m&&T.push(v[A+R])):(j.push(v[A+R]),D.push(W.value)))}return Promise.resolve(0<D.length&&h.mutate({trans:a,type:"add",values:D}).then(function(X){for(var G in X.failures)j.splice(parseInt(G),1);x(D.length,X)})).then(function(){return(0<I.length||P&&typeof e=="object")&&h.mutate({trans:a,type:"put",keys:T,values:I,criteria:P,changeSpec:typeof e!="function"&&e,isAdditionalChunk:0<A}).then(function(X){return x(I.length,X)})}).then(function(){return(0<j.length||P&&e===Rr)&&h.mutate({trans:a,type:"delete",keys:j,criteria:P,isAdditionalChunk:0<A}).then(function(X){return x(j.length,X)})}).then(function(){return v.length>A+E&&k(A+w)})})}var P=Mt(r)&&r.limit===1/0&&(typeof e!="function"||e===Rr)&&{index:r.index,range:r.range};return k(0).then(function(){if(0<y.length)throw new pn("Error modifying one or more objects",y,b,_);return v.length})})})},Z.prototype.delete=function(){var e=this._ctx,t=e.range;return Mt(e)&&(e.isPrimKey||t.type===3)?this._write(function(r){var a=e.table.core.schema.primaryKey,u=t;return e.table.core.count({trans:r,query:{index:a,range:u}}).then(function(l){return e.table.core.mutate({trans:r,type:"deleteRange",range:u}).then(function(f){var h=f.failures;if(f.lastResult,f.results,f=f.numFailures,f)throw new pn("Could not delete some values",Object.keys(h).map(function(m){return h[m]}),l-f);return l-f})})}):this.modify(Rr)},Z);function Z(){}var Rr=function(e,t){return t.value=null};function pa(e,t){return e<t?-1:e===t?0:1}function ma(e,t){return t<e?-1:e===t?0:1}function je(e,t,r){return e=e instanceof Gs?new e.Collection(e):e,e._ctx.error=new(r||TypeError)(t),e}function It(e){return new e.Collection(e,function(){return Xs("")}).limit(0)}function On(e,t,r,a){var u,l,f,h,m,g,w,p=r.length;if(!r.every(function(b){return typeof b=="string"}))return je(e,Fs);function x(b){u=b==="next"?function(v){return v.toUpperCase()}:function(v){return v.toLowerCase()},l=b==="next"?function(v){return v.toLowerCase()}:function(v){return v.toUpperCase()},f=b==="next"?pa:ma;var _=r.map(function(v){return{lower:l(v),upper:u(v)}}).sort(function(v,k){return f(v.lower,k.lower)});h=_.map(function(v){return v.upper}),m=_.map(function(v){return v.lower}),w=(g=b)==="next"?"":a}x("next"),e=new e.Collection(e,function(){return nt(h[0],m[p-1]+a)}),e._ondirectionchange=function(b){x(b)};var y=0;return e._addAlgorithm(function(b,_,v){var k=b.key;if(typeof k!="string")return!1;var P=l(k);if(t(P,m,y))return!0;for(var A=null,E=y;E<p;++E){var M=function(D,I,T,j,R,C){for(var W=Math.min(D.length,j.length),X=-1,G=0;G<W;++G){var Be=I[G];if(Be!==j[G])return R(D[G],T[G])<0?D.substr(0,G)+T[G]+T.substr(G+1):R(D[G],j[G])<0?D.substr(0,G)+j[G]+T.substr(G+1):0<=X?D.substr(0,X)+I[X]+T.substr(X+1):null;R(D[G],Be)<0&&(X=G)}return W<j.length&&C==="next"?D+T.substr(D.length):W<D.length&&C==="prev"?D.substr(0,T.length):X<0?null:D.substr(0,X)+j[X]+T.substr(X+1)}(k,P,h[E],m[E],f,g);M===null&&A===null?y=E+1:(A===null||0<f(A,M))&&(A=M)}return _(A!==null?function(){b.continue(A+w)}:v),!1}),e}function nt(e,t,r,a){return{type:2,lower:e,upper:t,lowerOpen:r,upperOpen:a}}function Xs(e){return{type:1,lower:e,upper:e}}var Gs=(Object.defineProperty(ye.prototype,"Collection",{get:function(){return this._ctx.table.db.Collection},enumerable:!1,configurable:!0}),ye.prototype.between=function(e,t,r,a){r=r!==!1,a=a===!0;try{return 0<this._cmp(e,t)||this._cmp(e,t)===0&&(r||a)&&(!r||!a)?It(this):new this.Collection(this,function(){return nt(e,t,!r,!a)})}catch{return je(this,ze)}},ye.prototype.equals=function(e){return e==null?je(this,ze):new this.Collection(this,function(){return Xs(e)})},ye.prototype.above=function(e){return e==null?je(this,ze):new this.Collection(this,function(){return nt(e,void 0,!0)})},ye.prototype.aboveOrEqual=function(e){return e==null?je(this,ze):new this.Collection(this,function(){return nt(e,void 0,!1)})},ye.prototype.below=function(e){return e==null?je(this,ze):new this.Collection(this,function(){return nt(void 0,e,!1,!0)})},ye.prototype.belowOrEqual=function(e){return e==null?je(this,ze):new this.Collection(this,function(){return nt(void 0,e)})},ye.prototype.startsWith=function(e){return typeof e!="string"?je(this,Fs):this.between(e,e+gt,!0,!0)},ye.prototype.startsWithIgnoreCase=function(e){return e===""?this.startsWith(e):On(this,function(t,r){return t.indexOf(r[0])===0},[e],gt)},ye.prototype.equalsIgnoreCase=function(e){return On(this,function(t,r){return t===r[0]},[e],"")},ye.prototype.anyOfIgnoreCase=function(){var e=ve.apply(Ie,arguments);return e.length===0?It(this):On(this,function(t,r){return r.indexOf(t)!==-1},e,"")},ye.prototype.startsWithAnyOfIgnoreCase=function(){var e=ve.apply(Ie,arguments);return e.length===0?It(this):On(this,function(t,r){return r.some(function(a){return t.indexOf(a)===0})},e,gt)},ye.prototype.anyOf=function(){var e=this,t=ve.apply(Ie,arguments),r=this._cmp;try{t.sort(r)}catch{return je(this,ze)}if(t.length===0)return It(this);var a=new this.Collection(this,function(){return nt(t[0],t[t.length-1])});a._ondirectionchange=function(l){r=l==="next"?e._ascending:e._descending,t.sort(r)};var u=0;return a._addAlgorithm(function(l,f,h){for(var m=l.key;0<r(m,t[u]);)if(++u===t.length)return f(h),!1;return r(m,t[u])===0||(f(function(){l.continue(t[u])}),!1)}),a},ye.prototype.notEqual=function(e){return this.inAnyRange([[-1/0,e],[e,this.db._maxKey]],{includeLowers:!1,includeUppers:!1})},ye.prototype.noneOf=function(){var e=ve.apply(Ie,arguments);if(e.length===0)return new this.Collection(this);try{e.sort(this._ascending)}catch{return je(this,ze)}var t=e.reduce(function(r,a){return r?r.concat([[r[r.length-1][1],a]]):[[-1/0,a]]},null);return t.push([e[e.length-1],this.db._maxKey]),this.inAnyRange(t,{includeLowers:!1,includeUppers:!1})},ye.prototype.inAnyRange=function(k,t){var r=this,a=this._cmp,u=this._ascending,l=this._descending,f=this._min,h=this._max;if(k.length===0)return It(this);if(!k.every(function(P){return P[0]!==void 0&&P[1]!==void 0&&u(P[0],P[1])<=0}))return je(this,"First argument to inAnyRange() must be an Array of two-value Arrays [lower,upper] where upper must not be lower than lower",$.InvalidArgument);var m=!t||t.includeLowers!==!1,g=t&&t.includeUppers===!0,w,p=u;function x(P,A){return p(P[0],A[0])}try{(w=k.reduce(function(P,A){for(var E=0,M=P.length;E<M;++E){var D=P[E];if(a(A[0],D[1])<0&&0<a(A[1],D[0])){D[0]=f(D[0],A[0]),D[1]=h(D[1],A[1]);break}}return E===M&&P.push(A),P},[])).sort(x)}catch{return je(this,ze)}var y=0,b=g?function(P){return 0<u(P,w[y][1])}:function(P){return 0<=u(P,w[y][1])},_=m?function(P){return 0<l(P,w[y][0])}:function(P){return 0<=l(P,w[y][0])},v=b,k=new this.Collection(this,function(){return nt(w[0][0],w[w.length-1][1],!m,!g)});return k._ondirectionchange=function(P){p=P==="next"?(v=b,u):(v=_,l),w.sort(x)},k._addAlgorithm(function(P,A,E){for(var M,D=P.key;v(D);)if(++y===w.length)return A(E),!1;return!b(M=D)&&!_(M)||(r._cmp(D,w[y][1])===0||r._cmp(D,w[y][0])===0||A(function(){p===u?P.continue(w[y][0]):P.continue(w[y][1])}),!1)}),k},ye.prototype.startsWithAnyOf=function(){var e=ve.apply(Ie,arguments);return e.every(function(t){return typeof t=="string"})?e.length===0?It(this):this.inAnyRange(e.map(function(t){return[t,t+gt]})):je(this,"startsWithAnyOf() only works with strings")},ye);function ye(){}function We(e){return oe(function(t){return Jt(t),e(t.target.error),!1})}function Jt(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault()}var zt="storagemutated",Dr="x-storagemutated-1",rt=Wt(null,zt),ya=(He.prototype._lock=function(){return pe(!N.global),++this._reculock,this._reculock!==1||N.global||(N.lockOwnerFor=this),this},He.prototype._unlock=function(){if(pe(!N.global),--this._reculock==0)for(N.global||(N.lockOwnerFor=null);0<this._blockedFuncs.length&&!this._locked();){var e=this._blockedFuncs.shift();try{yt(e[1],e[0])}catch{}}return this},He.prototype._locked=function(){return this._reculock&&N.lockOwnerFor!==this},He.prototype.create=function(e){var t=this;if(!this.mode)return this;var r=this.db.idbdb,a=this.db._state.dbOpenError;if(pe(!this.idbtrans),!e&&!r)switch(a&&a.name){case"DatabaseClosedError":throw new $.DatabaseClosed(a);case"MissingAPIError":throw new $.MissingAPI(a.message,a);default:throw new $.OpenFailed(a)}if(!this.active)throw new $.TransactionInactive;return pe(this._completion._state===null),(e=this.idbtrans=e||(this.db.core||r).transaction(this.storeNames,this.mode,{durability:this.chromeTransactionDurability})).onerror=oe(function(u){Jt(u),t._reject(e.error)}),e.onabort=oe(function(u){Jt(u),t.active&&t._reject(new $.Abort(e.error)),t.active=!1,t.on("abort").fire(u)}),e.oncomplete=oe(function(){t.active=!1,t._resolve(),"mutatedParts"in e&&rt.storagemutated.fire(e.mutatedParts)}),this},He.prototype._promise=function(e,t,r){var a=this;if(e==="readwrite"&&this.mode!=="readwrite")return fe(new $.ReadOnly("Transaction is readonly"));if(!this.active)return fe(new $.TransactionInactive);if(this._locked())return new K(function(l,f){a._blockedFuncs.push([function(){a._promise(e,t,r).then(l,f)},N])});if(r)return Ze(function(){var l=new K(function(f,h){a._lock();var m=t(f,h,a);m&&m.then&&m.then(f,h)});return l.finally(function(){return a._unlock()}),l._lib=!0,l});var u=new K(function(l,f){var h=t(l,f,a);h&&h.then&&h.then(l,f)});return u._lib=!0,u},He.prototype._root=function(){return this.parent?this.parent._root():this},He.prototype.waitFor=function(e){var t,r=this._root(),a=K.resolve(e);r._waitingFor?r._waitingFor=r._waitingFor.then(function(){return a}):(r._waitingFor=a,r._waitingQueue=[],t=r.idbtrans.objectStore(r.storeNames[0]),function l(){for(++r._spinCount;r._waitingQueue.length;)r._waitingQueue.shift()();r._waitingFor&&(t.get(-1/0).onsuccess=l)}());var u=r._waitingFor;return new K(function(l,f){a.then(function(h){return r._waitingQueue.push(oe(l.bind(null,h)))},function(h){return r._waitingQueue.push(oe(f.bind(null,h)))}).finally(function(){r._waitingFor===u&&(r._waitingFor=null)})})},He.prototype.abort=function(){this.active&&(this.active=!1,this.idbtrans&&this.idbtrans.abort(),this._reject(new $.Abort))},He.prototype.table=function(e){var t=this._memoizedTables||(this._memoizedTables={});if(F(t,e))return t[e];var r=this.schema[e];if(!r)throw new $.NotFound("Table "+e+" not part of transaction");return r=new this.db.Table(e,r,this),r.core=this.db.core.table(e),t[e]=r},He);function He(){}function jr(e,t,r,a,u,l,f){return{name:e,keyPath:t,unique:r,multi:a,auto:u,compound:l,src:(r&&!f?"&":"")+(a?"*":"")+(u?"++":"")+Ys(t)}}function Ys(e){return typeof e=="string"?e:e?"["+[].join.call(e,"+")+"]":""}function Br(e,t,r){return{name:e,primKey:t,indexes:r,mappedClass:null,idxByName:(a=function(u){return[u.name,u]},r.reduce(function(u,l,f){return f=a(l,f),f&&(u[f[0]]=f[1]),u},{}))};var a}var Xt=function(e){try{return e.only([[]]),Xt=function(){return[[]]},[[]]}catch{return Xt=function(){return gt},gt}};function Kr(e){return e==null?function(){}:typeof e=="string"?(t=e).split(".").length===1?function(r){return r[t]}:function(r){return ue(r,t)}:function(r){return ue(r,e)};var t}function Qs(e){return[].slice.call(e)}var ga=0;function Gt(e){return e==null?":id":typeof e=="string"?e:"[".concat(e.join("+"),"]")}function va(e,t,m){function a(v){if(v.type===3)return null;if(v.type===4)throw new Error("Cannot convert never type to IDBKeyRange");var y=v.lower,b=v.upper,_=v.lowerOpen,v=v.upperOpen;return y===void 0?b===void 0?null:t.upperBound(b,!!v):b===void 0?t.lowerBound(y,!!_):t.bound(y,b,!!_,!!v)}function u(x){var y,b=x.name;return{name:b,schema:x,mutate:function(_){var v=_.trans,k=_.type,P=_.keys,A=_.values,E=_.range;return new Promise(function(M,D){M=oe(M);var I=v.objectStore(b),T=I.keyPath==null,j=k==="put"||k==="add";if(!j&&k!=="delete"&&k!=="deleteRange")throw new Error("Invalid operation type: "+k);var R,C=(P||A||{length:1}).length;if(P&&A&&P.length!==A.length)throw new Error("Given keys array must have same length as given values array.");if(C===0)return M({numFailures:0,failures:{},results:[],lastResult:void 0});function W(Oe){++Be,Jt(Oe)}var X=[],G=[],Be=0;if(k==="deleteRange"){if(E.type===4)return M({numFailures:Be,failures:G,results:[],lastResult:void 0});E.type===3?X.push(R=I.clear()):X.push(R=I.delete(a(E)))}else{var T=j?T?[A,P]:[A,null]:[P,null],U=T[0],xe=T[1];if(j)for(var Se=0;Se<C;++Se)X.push(R=xe&&xe[Se]!==void 0?I[k](U[Se],xe[Se]):I[k](U[Se])),R.onerror=W;else for(Se=0;Se<C;++Se)X.push(R=I[k](U[Se])),R.onerror=W}function $n(Oe){Oe=Oe.target.result,X.forEach(function(_t,es){return _t.error!=null&&(G[es]=_t.error)}),M({numFailures:Be,failures:G,results:k==="delete"?P:X.map(function(_t){return _t.result}),lastResult:Oe})}R.onerror=function(Oe){W(Oe),$n(Oe)},R.onsuccess=$n})},getMany:function(_){var v=_.trans,k=_.keys;return new Promise(function(P,A){P=oe(P);for(var E,M=v.objectStore(b),D=k.length,I=new Array(D),T=0,j=0,R=function(X){X=X.target,I[X._pos]=X.result,++j===T&&P(I)},C=We(A),W=0;W<D;++W)k[W]!=null&&((E=M.get(k[W]))._pos=W,E.onsuccess=R,E.onerror=C,++T);T===0&&P(I)})},get:function(_){var v=_.trans,k=_.key;return new Promise(function(P,A){P=oe(P);var E=v.objectStore(b).get(k);E.onsuccess=function(M){return P(M.target.result)},E.onerror=We(A)})},query:(y=g,function(_){return new Promise(function(v,k){v=oe(v);var P,A,E,T=_.trans,M=_.values,D=_.limit,R=_.query,I=D===1/0?void 0:D,j=R.index,R=R.range,T=T.objectStore(b),j=j.isPrimaryKey?T:T.index(j.name),R=a(R);if(D===0)return v({result:[]});y?((I=M?j.getAll(R,I):j.getAllKeys(R,I)).onsuccess=function(C){return v({result:C.target.result})},I.onerror=We(k)):(P=0,A=!M&&"openKeyCursor"in j?j.openKeyCursor(R):j.openCursor(R),E=[],A.onsuccess=function(C){var W=A.result;return W?(E.push(M?W.value:W.primaryKey),++P===D?v({result:E}):void W.continue()):v({result:E})},A.onerror=We(k))})}),openCursor:function(_){var v=_.trans,k=_.values,P=_.query,A=_.reverse,E=_.unique;return new Promise(function(M,D){M=oe(M);var j=P.index,I=P.range,T=v.objectStore(b),T=j.isPrimaryKey?T:T.index(j.name),j=A?E?"prevunique":"prev":E?"nextunique":"next",R=!k&&"openKeyCursor"in T?T.openKeyCursor(a(I),j):T.openCursor(a(I),j);R.onerror=We(D),R.onsuccess=oe(function(C){var W,X,G,Be,U=R.result;U?(U.___id=++ga,U.done=!1,W=U.continue.bind(U),X=(X=U.continuePrimaryKey)&&X.bind(U),G=U.advance.bind(U),Be=function(){throw new Error("Cursor not stopped")},U.trans=v,U.stop=U.continue=U.continuePrimaryKey=U.advance=function(){throw new Error("Cursor not started")},U.fail=oe(D),U.next=function(){var xe=this,Se=1;return this.start(function(){return Se--?xe.continue():xe.stop()}).then(function(){return xe})},U.start=function(xe){function Se(){if(R.result)try{xe()}catch(Oe){U.fail(Oe)}else U.done=!0,U.start=function(){throw new Error("Cursor behind last entry")},U.stop()}var $n=new Promise(function(Oe,_t){Oe=oe(Oe),R.onerror=We(_t),U.fail=_t,U.stop=function(es){U.stop=U.continue=U.continuePrimaryKey=U.advance=Be,Oe(es)}});return R.onsuccess=oe(function(Oe){R.onsuccess=Se,Se()}),U.continue=W,U.continuePrimaryKey=X,U.advance=G,Se(),$n},M(U)):M(null)},D)})},count:function(_){var v=_.query,k=_.trans,P=v.index,A=v.range;return new Promise(function(E,M){var D=k.objectStore(b),I=P.isPrimaryKey?D:D.index(P.name),D=a(A),I=D?I.count(D):I.count();I.onsuccess=oe(function(T){return E(T.target.result)}),I.onerror=We(M)})}}}var l,f,h,w=(f=m,h=Qs((l=e).objectStoreNames),{schema:{name:l.name,tables:h.map(function(x){return f.objectStore(x)}).map(function(x){var y=x.keyPath,v=x.autoIncrement,b=O(y),_={},v={name:x.name,primaryKey:{name:null,isPrimaryKey:!0,outbound:y==null,compound:b,keyPath:y,autoIncrement:v,unique:!0,extractKey:Kr(y)},indexes:Qs(x.indexNames).map(function(k){return x.index(k)}).map(function(E){var P=E.name,A=E.unique,M=E.multiEntry,E=E.keyPath,M={name:P,compound:O(E),keyPath:E,unique:A,multiEntry:M,extractKey:Kr(E)};return _[Gt(E)]=M}),getIndexByKeyPath:function(k){return _[Gt(k)]}};return _[":id"]=v.primaryKey,y!=null&&(_[Gt(y)]=v.primaryKey),v})},hasGetAll:0<h.length&&"getAll"in f.objectStore(h[0])&&!(typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604)}),m=w.schema,g=w.hasGetAll,w=m.tables.map(u),p={};return w.forEach(function(x){return p[x.name]=x}),{stack:"dbcore",transaction:e.transaction.bind(e),table:function(x){if(!p[x])throw new Error("Table '".concat(x,"' not found"));return p[x]},MIN_KEY:-1/0,MAX_KEY:Xt(t),schema:m}}function ba(e,t,r,a){var u=r.IDBKeyRange;return r.indexedDB,{dbcore:(a=va(t,u,a),e.dbcore.reduce(function(l,f){return f=f.create,i(i({},l),f(l))},a))}}function Mn(e,a){var r=a.db,a=ba(e._middlewares,r,e._deps,a);e.core=a.dbcore,e.tables.forEach(function(u){var l=u.name;e.core.schema.tables.some(function(f){return f.name===l})&&(u.core=e.core.table(l),e[l]instanceof e.Table&&(e[l].core=u.core))})}function In(e,t,r,a){r.forEach(function(u){var l=a[u];t.forEach(function(f){var h=function m(g,w){return we(g,w)||(g=q(g))&&m(g,w)}(f,u);(!h||"value"in h&&h.value===void 0)&&(f===e.Transaction.prototype||f instanceof e.Transaction?ae(f,u,{get:function(){return this.table(u)},set:function(m){V(this,u,{value:m,writable:!0,configurable:!0,enumerable:!0})}}):f[u]=new e.Table(u,l))})})}function Cr(e,t){t.forEach(function(r){for(var a in r)r[a]instanceof e.Table&&delete r[a]})}function wa(e,t){return e._cfg.version-t._cfg.version}function _a(e,t,r,a){var u=e._dbSchema;r.objectStoreNames.contains("$meta")&&!u.$meta&&(u.$meta=Br("$meta",ei("")[0],[]),e._storeNames.push("$meta"));var l=e._createTransaction("readwrite",e._storeNames,u);l.create(r),l._completion.catch(a);var f=l._reject.bind(l),h=N.transless||N;Ze(function(){return N.trans=l,N.transless=h,t!==0?(Mn(e,r),g=t,((m=l).storeNames.includes("$meta")?m.table("$meta").get("version").then(function(w){return w??g}):K.resolve(g)).then(function(w){return x=w,y=l,b=r,_=[],w=(p=e)._versions,v=p._dbSchema=Rn(0,p.idbdb,b),(w=w.filter(function(k){return k._cfg.version>=x})).length!==0?(w.forEach(function(k){_.push(function(){var P=v,A=k._cfg.dbschema;Dn(p,P,b),Dn(p,A,b),v=p._dbSchema=A;var E=qr(P,A);E.add.forEach(function(j){Nr(b,j[0],j[1].primKey,j[1].indexes)}),E.change.forEach(function(j){if(j.recreate)throw new $.Upgrade("Not yet support for changing primary key");var R=b.objectStore(j.name);j.add.forEach(function(C){return Tn(R,C)}),j.change.forEach(function(C){R.deleteIndex(C.name),Tn(R,C)}),j.del.forEach(function(C){return R.deleteIndex(C)})});var M=k._cfg.contentUpgrade;if(M&&k._cfg.version>x){Mn(p,b),y._memoizedTables={};var D=Ee(A);E.del.forEach(function(j){D[j]=P[j]}),Cr(p,[p.Transaction.prototype]),In(p,[p.Transaction.prototype],S(D),D),y.schema=D;var I,T=Fe(M);return T&&Et(),E=K.follow(function(){var j;(I=M(y))&&T&&(j=et.bind(null,null),I.then(j,j))}),I&&typeof I.then=="function"?K.resolve(I):E.then(function(){return I})}}),_.push(function(P){var A,E,M=k._cfg.dbschema;A=M,E=P,[].slice.call(E.db.objectStoreNames).forEach(function(D){return A[D]==null&&E.db.deleteObjectStore(D)}),Cr(p,[p.Transaction.prototype]),In(p,[p.Transaction.prototype],p._storeNames,p._dbSchema),y.schema=p._dbSchema}),_.push(function(P){p.idbdb.objectStoreNames.contains("$meta")&&(Math.ceil(p.idbdb.version/10)===k._cfg.version?(p.idbdb.deleteObjectStore("$meta"),delete p._dbSchema.$meta,p._storeNames=p._storeNames.filter(function(A){return A!=="$meta"})):P.objectStore("$meta").put(k._cfg.version,"version"))})}),function k(){return _.length?K.resolve(_.shift()(y.idbtrans)).then(k):K.resolve()}().then(function(){Zs(v,b)})):K.resolve();var p,x,y,b,_,v}).catch(f)):(S(u).forEach(function(w){Nr(r,w,u[w].primKey,u[w].indexes)}),Mn(e,r),void K.follow(function(){return e.on.populate.fire(l)}).catch(f));var m,g})}function xa(e,t){Zs(e._dbSchema,t),t.db.version%10!=0||t.objectStoreNames.contains("$meta")||t.db.createObjectStore("$meta").add(Math.ceil(t.db.version/10-1),"version");var r=Rn(0,e.idbdb,t);Dn(e,e._dbSchema,t);for(var a=0,u=qr(r,e._dbSchema).change;a<u.length;a++){var l=function(f){if(f.change.length||f.recreate)return console.warn("Unable to patch indexes of table ".concat(f.name," because it has changes on the type of index or primary key.")),{value:void 0};var h=t.objectStore(f.name);f.add.forEach(function(m){Le&&console.debug("Dexie upgrade patch: Creating missing index ".concat(f.name,".").concat(m.src)),Tn(h,m)})}(u[a]);if(typeof l=="object")return l.value}}function qr(e,t){var r,a={del:[],add:[],change:[]};for(r in e)t[r]||a.del.push(r);for(r in t){var u=e[r],l=t[r];if(u){var f={name:r,def:l,recreate:!1,del:[],add:[],change:[]};if(""+(u.primKey.keyPath||"")!=""+(l.primKey.keyPath||"")||u.primKey.auto!==l.primKey.auto)f.recreate=!0,a.change.push(f);else{var h=u.idxByName,m=l.idxByName,g=void 0;for(g in h)m[g]||f.del.push(g);for(g in m){var w=h[g],p=m[g];w?w.src!==p.src&&f.change.push(p):f.add.push(p)}(0<f.del.length||0<f.add.length||0<f.change.length)&&a.change.push(f)}}else a.add.push([r,l])}return a}function Nr(e,t,r,a){var u=e.db.createObjectStore(t,r.keyPath?{keyPath:r.keyPath,autoIncrement:r.auto}:{autoIncrement:r.auto});return a.forEach(function(l){return Tn(u,l)}),u}function Zs(e,t){S(e).forEach(function(r){t.db.objectStoreNames.contains(r)||(Le&&console.debug("Dexie: Creating missing table",r),Nr(t,r,e[r].primKey,e[r].indexes))})}function Tn(e,t){e.createIndex(t.name,t.keyPath,{unique:t.unique,multiEntry:t.multi})}function Rn(e,t,r){var a={};return ee(t.objectStoreNames,0).forEach(function(u){for(var l=r.objectStore(u),f=jr(Ys(g=l.keyPath),g||"",!0,!1,!!l.autoIncrement,g&&typeof g!="string",!0),h=[],m=0;m<l.indexNames.length;++m){var w=l.index(l.indexNames[m]),g=w.keyPath,w=jr(w.name,g,!!w.unique,!!w.multiEntry,!1,g&&typeof g!="string",!1);h.push(w)}a[u]=Br(u,f,h)}),a}function Dn(e,t,r){for(var a=r.db.objectStoreNames,u=0;u<a.length;++u){var l=a[u],f=r.objectStore(l);e._hasGetAll="getAll"in f;for(var h=0;h<f.indexNames.length;++h){var m=f.indexNames[h],g=f.index(m).keyPath,w=typeof g=="string"?g:"["+ee(g).join("+")+"]";!t[l]||(g=t[l].idxByName[w])&&(g.name=m,delete t[l].idxByName[w],t[l].idxByName[m]=g)}}typeof navigator<"u"&&/Safari/.test(navigator.userAgent)&&!/(Chrome\/|Edge\/)/.test(navigator.userAgent)&&d.WorkerGlobalScope&&d instanceof d.WorkerGlobalScope&&[].concat(navigator.userAgent.match(/Safari\/(\d*)/))[1]<604&&(e._hasGetAll=!1)}function ei(e){return e.split(",").map(function(t,r){var a=(t=t.trim()).replace(/([&*]|\+\+)/g,""),u=/^\[/.test(a)?a.match(/^\[(.*)\]$/)[1].split("+"):a;return jr(a,u||null,/\&/.test(t),/\*/.test(t),/\+\+/.test(t),O(u),r===0)})}var Sa=(jn.prototype._parseStoresSpec=function(e,t){S(e).forEach(function(r){if(e[r]!==null){var a=ei(e[r]),u=a.shift();if(u.unique=!0,u.multi)throw new $.Schema("Primary key cannot be multi-valued");a.forEach(function(l){if(l.auto)throw new $.Schema("Only primary key can be marked as autoIncrement (++)");if(!l.keyPath)throw new $.Schema("Index must have a name and cannot be an empty string")}),t[r]=Br(r,u,a)}})},jn.prototype.stores=function(r){var t=this.db;this._cfg.storesSource=this._cfg.storesSource?B(this._cfg.storesSource,r):r;var r=t._versions,a={},u={};return r.forEach(function(l){B(a,l._cfg.storesSource),u=l._cfg.dbschema={},l._parseStoresSpec(a,u)}),t._dbSchema=u,Cr(t,[t._allTables,t,t.Transaction.prototype]),In(t,[t._allTables,t,t.Transaction.prototype,this._cfg.tables],S(u),u),t._storeNames=S(u),this},jn.prototype.upgrade=function(e){return this._cfg.contentUpgrade=br(this._cfg.contentUpgrade||te,e),this},jn);function jn(){}function Fr(e,t){var r=e._dbNamesDB;return r||(r=e._dbNamesDB=new Xe(kn,{addons:[],indexedDB:e,IDBKeyRange:t})).version(1).stores({dbnames:"name"}),r.table("dbnames")}function $r(e){return e&&typeof e.databases=="function"}function Ur(e){return Ze(function(){return N.letThrough=!0,e()})}function Lr(e){return!("from"in e)}var _e=function(e,t){if(!this){var r=new _e;return e&&"d"in e&&B(r,e),r}B(this,arguments.length?{d:1,from:e,to:1<arguments.length?t:e}:{d:0})};function Yt(e,t,r){var a=Y(t,r);if(!isNaN(a)){if(0<a)throw RangeError();if(Lr(e))return B(e,{from:t,to:r,d:1});var u=e.l,a=e.r;if(Y(r,e.from)<0)return u?Yt(u,t,r):e.l={from:t,to:r,d:1,l:null,r:null},ni(e);if(0<Y(t,e.to))return a?Yt(a,t,r):e.r={from:t,to:r,d:1,l:null,r:null},ni(e);Y(t,e.from)<0&&(e.from=t,e.l=null,e.d=a?a.d+1:1),0<Y(r,e.to)&&(e.to=r,e.r=null,e.d=e.l?e.l.d+1:1),r=!e.r,u&&!e.l&&Qt(e,u),a&&r&&Qt(e,a)}}function Qt(e,t){Lr(t)||function r(a,m){var l=m.from,f=m.to,h=m.l,m=m.r;Yt(a,l,f),h&&r(a,h),m&&r(a,m)}(e,t)}function ti(e,t){var r=Bn(t),a=r.next();if(a.done)return!1;for(var u=a.value,l=Bn(e),f=l.next(u.from),h=f.value;!a.done&&!f.done;){if(Y(h.from,u.to)<=0&&0<=Y(h.to,u.from))return!0;Y(u.from,h.from)<0?u=(a=r.next(h.from)).value:h=(f=l.next(u.from)).value}return!1}function Bn(e){var t=Lr(e)?null:{s:0,n:e};return{next:function(r){for(var a=0<arguments.length;t;)switch(t.s){case 0:if(t.s=1,a)for(;t.n.l&&Y(r,t.n.from)<0;)t={up:t,n:t.n.l,s:1};else for(;t.n.l;)t={up:t,n:t.n.l,s:1};case 1:if(t.s=2,!a||Y(r,t.n.to)<=0)return{value:t.n,done:!1};case 2:if(t.n.r){t.s=3,t={up:t,n:t.n.r,s:0};continue}case 3:t=t.up}return{done:!0}}}}function ni(e){var t,r,a=(((t=e.r)===null||t===void 0?void 0:t.d)||0)-(((r=e.l)===null||r===void 0?void 0:r.d)||0),u=1<a?"r":a<-1?"l":"";u&&(t=u=="r"?"l":"r",r=i({},e),a=e[u],e.from=a.from,e.to=a.to,e[u]=a[u],r[u]=a[t],(e[t]=r).d=ri(r)),e.d=ri(e)}function ri(r){var t=r.r,r=r.l;return(t?r?Math.max(t.d,r.d):t.d:r?r.d:0)+1}function Kn(e,t){return S(t).forEach(function(r){e[r]?Qt(e[r],t[r]):e[r]=function a(u){var l,f,h={};for(l in u)F(u,l)&&(f=u[l],h[l]=!f||typeof f!="object"||ct.has(f.constructor)?f:a(f));return h}(t[r])}),e}function Wr(e,t){return e.all||t.all||Object.keys(e).some(function(r){return t[r]&&ti(t[r],e[r])})}L(_e.prototype,((Ce={add:function(e){return Qt(this,e),this},addKey:function(e){return Yt(this,e,e),this},addKeys:function(e){var t=this;return e.forEach(function(r){return Yt(t,r,r)}),this},hasKey:function(e){var t=Bn(this).next(e).value;return t&&Y(t.from,e)<=0&&0<=Y(t.to,e)}})[Me]=function(){return Bn(this)},Ce));var bt={},Hr={},Vr=!1;function Cn(e){Kn(Hr,e),Vr||(Vr=!0,setTimeout(function(){Vr=!1,Jr(Hr,!(Hr={}))},0))}function Jr(e,t){t===void 0&&(t=!1);var r=new Set;if(e.all)for(var a=0,u=Object.values(bt);a<u.length;a++)si(f=u[a],e,r,t);else for(var l in e){var f,h=/^idb\:\/\/(.*)\/(.*)\//.exec(l);h&&(l=h[1],h=h[2],(f=bt["idb://".concat(l,"/").concat(h)])&&si(f,e,r,t))}r.forEach(function(m){return m()})}function si(e,t,r,a){for(var u=[],l=0,f=Object.entries(e.queries.query);l<f.length;l++){for(var h=f[l],m=h[0],g=[],w=0,p=h[1];w<p.length;w++){var x=p[w];Wr(t,x.obsSet)?x.subscribers.forEach(function(v){return r.add(v)}):a&&g.push(x)}a&&u.push([m,g])}if(a)for(var y=0,b=u;y<b.length;y++){var _=b[y],m=_[0],g=_[1];e.queries.query[m]=g}}function ka(e){var t=e._state,r=e._deps.indexedDB;if(t.isBeingOpened||e.idbdb)return t.dbReadyPromise.then(function(){return t.dbOpenError?fe(t.dbOpenError):e});t.isBeingOpened=!0,t.dbOpenError=null,t.openComplete=!1;var a=t.openCanceller,u=Math.round(10*e.verno),l=!1;function f(){if(t.openCanceller!==a)throw new $.DatabaseClosed("db.open() was cancelled")}function h(){return new K(function(x,y){if(f(),!r)throw new $.MissingAPI;var b=e.name,_=t.autoSchema||!u?r.open(b):r.open(b,u);if(!_)throw new $.MissingAPI;_.onerror=We(y),_.onblocked=oe(e._fireOnBlocked),_.onupgradeneeded=oe(function(v){var k;w=_.transaction,t.autoSchema&&!e._options.allowEmptyDB?(_.onerror=Jt,w.abort(),_.result.close(),(k=r.deleteDatabase(b)).onsuccess=k.onerror=oe(function(){y(new $.NoSuchDatabase("Database ".concat(b," doesnt exist")))})):(w.onerror=We(y),v=v.oldVersion>Math.pow(2,62)?0:v.oldVersion,p=v<1,e.idbdb=_.result,l&&xa(e,w),_a(e,v/10,w,y))},y),_.onsuccess=oe(function(){w=null;var v,k,P,A,E,M=e.idbdb=_.result,D=ee(M.objectStoreNames);if(0<D.length)try{var I=M.transaction((A=D).length===1?A[0]:A,"readonly");if(t.autoSchema)k=M,P=I,(v=e).verno=k.version/10,P=v._dbSchema=Rn(0,k,P),v._storeNames=ee(k.objectStoreNames,0),In(v,[v._allTables],S(P),P);else if(Dn(e,e._dbSchema,I),((E=qr(Rn(0,(E=e).idbdb,I),E._dbSchema)).add.length||E.change.some(function(T){return T.add.length||T.change.length}))&&!l)return console.warn("Dexie SchemaDiff: Schema was extended without increasing the number passed to db.version(). Dexie will add missing parts and increment native version number to workaround this."),M.close(),u=M.version+1,l=!0,x(h());Mn(e,I)}catch{}Ot.push(e),M.onversionchange=oe(function(T){t.vcFired=!0,e.on("versionchange").fire(T)}),M.onclose=oe(function(T){e.on("close").fire(T)}),p&&(E=e._deps,I=b,M=E.indexedDB,E=E.IDBKeyRange,$r(M)||I===kn||Fr(M,E).put({name:I}).catch(te)),x()},y)}).catch(function(x){switch(x==null?void 0:x.name){case"UnknownError":if(0<t.PR1398_maxLoop)return t.PR1398_maxLoop--,console.warn("Dexie: Workaround for Chrome UnknownError on open()"),h();break;case"VersionError":if(0<u)return u=0,h()}return K.reject(x)})}var m,g=t.dbReadyResolve,w=null,p=!1;return K.race([a,(typeof navigator>"u"?K.resolve():!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise(function(x){function y(){return indexedDB.databases().finally(x)}m=setInterval(y,100),y()}).finally(function(){return clearInterval(m)}):Promise.resolve()).then(h)]).then(function(){return f(),t.onReadyBeingFired=[],K.resolve(Ur(function(){return e.on.ready.fire(e.vip)})).then(function x(){if(0<t.onReadyBeingFired.length){var y=t.onReadyBeingFired.reduce(br,te);return t.onReadyBeingFired=[],K.resolve(Ur(function(){return y(e.vip)})).then(x)}})}).finally(function(){t.openCanceller===a&&(t.onReadyBeingFired=null,t.isBeingOpened=!1)}).catch(function(x){t.dbOpenError=x;try{w&&w.abort()}catch{}return a===t.openCanceller&&e._close(),fe(x)}).finally(function(){t.openComplete=!0,g()}).then(function(){var x;return p&&(x={},e.tables.forEach(function(y){y.schema.indexes.forEach(function(b){b.name&&(x["idb://".concat(e.name,"/").concat(y.name,"/").concat(b.name)]=new _e(-1/0,[[[]]]))}),x["idb://".concat(e.name,"/").concat(y.name,"/")]=x["idb://".concat(e.name,"/").concat(y.name,"/:dels")]=new _e(-1/0,[[[]]])}),rt(zt).fire(x),Jr(x,!0)),e})}function zr(e){function t(l){return e.next(l)}var r=u(t),a=u(function(l){return e.throw(l)});function u(l){return function(m){var h=l(m),m=h.value;return h.done?m:m&&typeof m.then=="function"?m.then(r,a):O(m)?Promise.all(m).then(r,a):r(m)}}return u(t)()}function qn(e,t,r){for(var a=O(e)?e.slice():[e],u=0;u<r;++u)a.push(t);return a}var Pa={stack:"dbcore",name:"VirtualIndexMiddleware",level:1,create:function(e){return i(i({},e),{table:function(t){var r=e.table(t),a=r.schema,u={},l=[];function f(p,x,y){var b=Gt(p),_=u[b]=u[b]||[],v=p==null?0:typeof p=="string"?1:p.length,k=0<x,k=i(i({},y),{name:k?"".concat(b,"(virtual-from:").concat(y.name,")"):y.name,lowLevelIndex:y,isVirtual:k,keyTail:x,keyLength:v,extractKey:Kr(p),unique:!k&&y.unique});return _.push(k),k.isPrimaryKey||l.push(k),1<v&&f(v===2?p[0]:p.slice(0,v-1),x+1,y),_.sort(function(P,A){return P.keyTail-A.keyTail}),k}t=f(a.primaryKey.keyPath,0,a.primaryKey),u[":id"]=[t];for(var h=0,m=a.indexes;h<m.length;h++){var g=m[h];f(g.keyPath,0,g)}function w(p){var x,y=p.query.index;return y.isVirtual?i(i({},p),{query:{index:y.lowLevelIndex,range:(x=p.query.range,y=y.keyTail,{type:x.type===1?2:x.type,lower:qn(x.lower,x.lowerOpen?e.MAX_KEY:e.MIN_KEY,y),lowerOpen:!0,upper:qn(x.upper,x.upperOpen?e.MIN_KEY:e.MAX_KEY,y),upperOpen:!0})}}):p}return i(i({},r),{schema:i(i({},a),{primaryKey:t,indexes:l,getIndexByKeyPath:function(p){return(p=u[Gt(p)])&&p[0]}}),count:function(p){return r.count(w(p))},query:function(p){return r.query(w(p))},openCursor:function(p){var x=p.query.index,y=x.keyTail,b=x.isVirtual,_=x.keyLength;return b?r.openCursor(w(p)).then(function(k){return k&&v(k)}):r.openCursor(p);function v(k){return Object.create(k,{continue:{value:function(P){P!=null?k.continue(qn(P,p.reverse?e.MAX_KEY:e.MIN_KEY,y)):p.unique?k.continue(k.key.slice(0,_).concat(p.reverse?e.MIN_KEY:e.MAX_KEY,y)):k.continue()}},continuePrimaryKey:{value:function(P,A){k.continuePrimaryKey(qn(P,e.MAX_KEY,y),A)}},primaryKey:{get:function(){return k.primaryKey}},key:{get:function(){var P=k.key;return _===1?P[0]:P.slice(0,_)}},value:{get:function(){return k.value}}})}}})}})}};function Xr(e,t,r,a){return r=r||{},a=a||"",S(e).forEach(function(u){var l,f,h;F(t,u)?(l=e[u],f=t[u],typeof l=="object"&&typeof f=="object"&&l&&f?(h=lt(l))!==lt(f)?r[a+u]=t[u]:h==="Object"?Xr(l,f,r,a+u+"."):l!==f&&(r[a+u]=t[u]):l!==f&&(r[a+u]=t[u])):r[a+u]=void 0}),S(t).forEach(function(u){F(e,u)||(r[a+u]=t[u])}),r}function Gr(e,t){return t.type==="delete"?t.keys:t.keys||t.values.map(e.extractKey)}var Aa={stack:"dbcore",name:"HooksMiddleware",level:2,create:function(e){return i(i({},e),{table:function(t){var r=e.table(t),a=r.schema.primaryKey;return i(i({},r),{mutate:function(u){var l=N.trans,f=l.table(t).hook,h=f.deleting,m=f.creating,g=f.updating;switch(u.type){case"add":if(m.fire===te)break;return l._promise("readwrite",function(){return w(u)},!0);case"put":if(m.fire===te&&g.fire===te)break;return l._promise("readwrite",function(){return w(u)},!0);case"delete":if(h.fire===te)break;return l._promise("readwrite",function(){return w(u)},!0);case"deleteRange":if(h.fire===te)break;return l._promise("readwrite",function(){return function p(x,y,b){return r.query({trans:x,values:!1,query:{index:a,range:y},limit:b}).then(function(_){var v=_.result;return w({type:"delete",keys:v,trans:x}).then(function(k){return 0<k.numFailures?Promise.reject(k.failures[0]):v.length<b?{failures:[],numFailures:0,lastResult:void 0}:p(x,i(i({},y),{lower:v[v.length-1],lowerOpen:!0}),b)})})}(u.trans,u.range,1e4)},!0)}return r.mutate(u);function w(p){var x,y,b,_=N.trans,v=p.keys||Gr(a,p);if(!v)throw new Error("Keys missing");return(p=p.type==="add"||p.type==="put"?i(i({},p),{keys:v}):i({},p)).type!=="delete"&&(p.values=c([],p.values)),p.keys&&(p.keys=c([],p.keys)),x=r,b=v,((y=p).type==="add"?Promise.resolve([]):x.getMany({trans:y.trans,keys:b,cache:"immutable"})).then(function(k){var P=v.map(function(A,E){var M,D,I,T=k[E],j={onerror:null,onsuccess:null};return p.type==="delete"?h.fire.call(j,A,T,_):p.type==="add"||T===void 0?(M=m.fire.call(j,A,p.values[E],_),A==null&&M!=null&&(p.keys[E]=A=M,a.outbound||se(p.values[E],a.keyPath,A))):(M=Xr(T,p.values[E]),(D=g.fire.call(j,M,A,T,_))&&(I=p.values[E],Object.keys(D).forEach(function(R){F(I,R)?I[R]=D[R]:se(I,R,D[R])}))),j});return r.mutate(p).then(function(A){for(var E=A.failures,M=A.results,D=A.numFailures,A=A.lastResult,I=0;I<v.length;++I){var T=(M||v)[I],j=P[I];T==null?j.onerror&&j.onerror(E[I]):j.onsuccess&&j.onsuccess(p.type==="put"&&k[I]?p.values[I]:T)}return{failures:E,results:M,numFailures:D,lastResult:A}}).catch(function(A){return P.forEach(function(E){return E.onerror&&E.onerror(A)}),Promise.reject(A)})})}}})}})}};function ii(e,t,r){try{if(!t||t.keys.length<e.length)return null;for(var a=[],u=0,l=0;u<t.keys.length&&l<e.length;++u)Y(t.keys[u],e[l])===0&&(a.push(r?le(t.values[u]):t.values[u]),++l);return a.length===e.length?a:null}catch{return null}}var Ea={stack:"dbcore",level:-1,create:function(e){return{table:function(t){var r=e.table(t);return i(i({},r),{getMany:function(a){if(!a.cache)return r.getMany(a);var u=ii(a.keys,a.trans._cache,a.cache==="clone");return u?K.resolve(u):r.getMany(a).then(function(l){return a.trans._cache={keys:a.keys,values:a.cache==="clone"?le(l):l},l})},mutate:function(a){return a.type!=="add"&&(a.trans._cache=null),r.mutate(a)}})}}}};function ai(e,t){return e.trans.mode==="readonly"&&!!e.subscr&&!e.trans.explicit&&e.trans.db._options.cache!=="disabled"&&!t.schema.primaryKey.outbound}function oi(e,t){switch(e){case"query":return t.values&&!t.unique;case"get":case"getMany":case"count":case"openCursor":return!1}}var Oa={stack:"dbcore",level:0,name:"Observability",create:function(e){var t=e.schema.name,r=new _e(e.MIN_KEY,e.MAX_KEY);return i(i({},e),{transaction:function(a,u,l){if(N.subscr&&u!=="readonly")throw new $.ReadOnly("Readwrite transaction in liveQuery context. Querier source: ".concat(N.querier));return e.transaction(a,u,l)},table:function(a){var u=e.table(a),l=u.schema,f=l.primaryKey,p=l.indexes,h=f.extractKey,m=f.outbound,g=f.autoIncrement&&p.filter(function(y){return y.compound&&y.keyPath.includes(f.keyPath)}),w=i(i({},u),{mutate:function(y){function b(R){return R="idb://".concat(t,"/").concat(a,"/").concat(R),A[R]||(A[R]=new _e)}var _,v,k,P=y.trans,A=y.mutatedParts||(y.mutatedParts={}),E=b(""),M=b(":dels"),D=y.type,j=y.type==="deleteRange"?[y.range]:y.type==="delete"?[y.keys]:y.values.length<50?[Gr(f,y).filter(function(R){return R}),y.values]:[],I=j[0],T=j[1],j=y.trans._cache;return O(I)?(E.addKeys(I),(j=D==="delete"||I.length===T.length?ii(I,j):null)||M.addKeys(I),(j||T)&&(_=b,v=j,k=T,l.indexes.forEach(function(R){var C=_(R.name||"");function W(G){return G!=null?R.extractKey(G):null}function X(G){return R.multiEntry&&O(G)?G.forEach(function(Be){return C.addKey(Be)}):C.addKey(G)}(v||k).forEach(function(G,xe){var U=v&&W(v[xe]),xe=k&&W(k[xe]);Y(U,xe)!==0&&(U!=null&&X(U),xe!=null&&X(xe))})}))):I?(T={from:(T=I.lower)!==null&&T!==void 0?T:e.MIN_KEY,to:(T=I.upper)!==null&&T!==void 0?T:e.MAX_KEY},M.add(T),E.add(T)):(E.add(r),M.add(r),l.indexes.forEach(function(R){return b(R.name).add(r)})),u.mutate(y).then(function(R){return!I||y.type!=="add"&&y.type!=="put"||(E.addKeys(R.results),g&&g.forEach(function(C){for(var W=y.values.map(function(U){return C.extractKey(U)}),X=C.keyPath.findIndex(function(U){return U===f.keyPath}),G=0,Be=R.results.length;G<Be;++G)W[G][X]=R.results[G];b(C.name).addKeys(W)})),P.mutatedParts=Kn(P.mutatedParts||{},A),R})}}),p=function(b){var _=b.query,b=_.index,_=_.range;return[b,new _e((b=_.lower)!==null&&b!==void 0?b:e.MIN_KEY,(_=_.upper)!==null&&_!==void 0?_:e.MAX_KEY)]},x={get:function(y){return[f,new _e(y.key)]},getMany:function(y){return[f,new _e().addKeys(y.keys)]},count:p,query:p,openCursor:p};return S(x).forEach(function(y){w[y]=function(b){var _=N.subscr,v=!!_,k=ai(N,u)&&oi(y,b)?b.obsSet={}:_;if(v){var P=function(T){return T="idb://".concat(t,"/").concat(a,"/").concat(T),k[T]||(k[T]=new _e)},A=P(""),E=P(":dels"),_=x[y](b),v=_[0],_=_[1];if((y==="query"&&v.isPrimaryKey&&!b.values?E:P(v.name||"")).add(_),!v.isPrimaryKey){if(y!=="count"){var M=y==="query"&&m&&b.values&&u.query(i(i({},b),{values:!1}));return u[y].apply(this,arguments).then(function(T){if(y==="query"){if(m&&b.values)return M.then(function(W){return W=W.result,A.addKeys(W),T});var j=b.values?T.result.map(h):T.result;(b.values?A:E).addKeys(j)}else if(y==="openCursor"){var R=T,C=b.values;return R&&Object.create(R,{key:{get:function(){return E.addKey(R.primaryKey),R.key}},primaryKey:{get:function(){var W=R.primaryKey;return E.addKey(W),W}},value:{get:function(){return C&&A.addKey(R.primaryKey),R.value}}})}return T})}E.add(r)}}return u[y].apply(this,arguments)}}),w}})}};function ui(e,t,r){if(r.numFailures===0)return t;if(t.type==="deleteRange")return null;var a=t.keys?t.keys.length:"values"in t&&t.values?t.values.length:1;return r.numFailures===a?null:(t=i({},t),O(t.keys)&&(t.keys=t.keys.filter(function(u,l){return!(l in r.failures)})),"values"in t&&O(t.values)&&(t.values=t.values.filter(function(u,l){return!(l in r.failures)})),t)}function Yr(e,t){return r=e,((a=t).lower===void 0||(a.lowerOpen?0<Y(r,a.lower):0<=Y(r,a.lower)))&&(e=e,(t=t).upper===void 0||(t.upperOpen?Y(e,t.upper)<0:Y(e,t.upper)<=0));var r,a}function ci(e,t,x,a,u,l){if(!x||x.length===0)return e;var f=t.query.index,h=f.multiEntry,m=t.query.range,g=a.schema.primaryKey.extractKey,w=f.extractKey,p=(f.lowLevelIndex||f).extractKey,x=x.reduce(function(y,b){var _=y,v=[];if(b.type==="add"||b.type==="put")for(var k=new _e,P=b.values.length-1;0<=P;--P){var A,E=b.values[P],M=g(E);k.hasKey(M)||(A=w(E),(h&&O(A)?A.some(function(R){return Yr(R,m)}):Yr(A,m))&&(k.addKey(M),v.push(E)))}switch(b.type){case"add":var D=new _e().addKeys(t.values?y.map(function(C){return g(C)}):y),_=y.concat(t.values?v.filter(function(C){return C=g(C),!D.hasKey(C)&&(D.addKey(C),!0)}):v.map(function(C){return g(C)}).filter(function(C){return!D.hasKey(C)&&(D.addKey(C),!0)}));break;case"put":var I=new _e().addKeys(b.values.map(function(C){return g(C)}));_=y.filter(function(C){return!I.hasKey(t.values?g(C):C)}).concat(t.values?v:v.map(function(C){return g(C)}));break;case"delete":var T=new _e().addKeys(b.keys);_=y.filter(function(C){return!T.hasKey(t.values?g(C):C)});break;case"deleteRange":var j=b.range;_=y.filter(function(C){return!Yr(g(C),j)})}return _},e);return x===e?e:(x.sort(function(y,b){return Y(p(y),p(b))||Y(g(y),g(b))}),t.limit&&t.limit<1/0&&(x.length>t.limit?x.length=t.limit:e.length===t.limit&&x.length<t.limit&&(u.dirty=!0)),l?Object.freeze(x):x)}function li(e,t){return Y(e.lower,t.lower)===0&&Y(e.upper,t.upper)===0&&!!e.lowerOpen==!!t.lowerOpen&&!!e.upperOpen==!!t.upperOpen}function Ma(e,t){return function(r,a,u,l){if(r===void 0)return a!==void 0?-1:0;if(a===void 0)return 1;if((a=Y(r,a))===0){if(u&&l)return 0;if(u)return 1;if(l)return-1}return a}(e.lower,t.lower,e.lowerOpen,t.lowerOpen)<=0&&0<=function(r,a,u,l){if(r===void 0)return a!==void 0?1:0;if(a===void 0)return-1;if((a=Y(r,a))===0){if(u&&l)return 0;if(u)return-1;if(l)return 1}return a}(e.upper,t.upper,e.upperOpen,t.upperOpen)}function Ia(e,t,r,a){e.subscribers.add(r),a.addEventListener("abort",function(){var u,l;e.subscribers.delete(r),e.subscribers.size===0&&(u=e,l=t,setTimeout(function(){u.subscribers.size===0&&ce(l,u)},3e3))})}var Ta={stack:"dbcore",level:0,name:"Cache",create:function(e){var t=e.schema.name;return i(i({},e),{transaction:function(r,a,u){var l,f,h=e.transaction(r,a,u);return a==="readwrite"&&(f=(l=new AbortController).signal,u=function(m){return function(){if(l.abort(),a==="readwrite"){for(var g=new Set,w=0,p=r;w<p.length;w++){var x=p[w],y=bt["idb://".concat(t,"/").concat(x)];if(y){var b=e.table(x),_=y.optimisticOps.filter(function(C){return C.trans===h});if(h._explicit&&m&&h.mutatedParts)for(var v=0,k=Object.values(y.queries.query);v<k.length;v++)for(var P=0,A=(D=k[v]).slice();P<A.length;P++)Wr((I=A[P]).obsSet,h.mutatedParts)&&(ce(D,I),I.subscribers.forEach(function(C){return g.add(C)}));else if(0<_.length){y.optimisticOps=y.optimisticOps.filter(function(C){return C.trans!==h});for(var E=0,M=Object.values(y.queries.query);E<M.length;E++)for(var D,I,T,j=0,R=(D=M[E]).slice();j<R.length;j++)(I=R[j]).res!=null&&h.mutatedParts&&(m&&!I.dirty?(T=Object.isFrozen(I.res),T=ci(I.res,I.req,_,b,I,T),I.dirty?(ce(D,I),I.subscribers.forEach(function(C){return g.add(C)})):T!==I.res&&(I.res=T,I.promise=K.resolve({result:T}))):(I.dirty&&ce(D,I),I.subscribers.forEach(function(C){return g.add(C)})))}}}g.forEach(function(C){return C()})}}},h.addEventListener("abort",u(!1),{signal:f}),h.addEventListener("error",u(!1),{signal:f}),h.addEventListener("complete",u(!0),{signal:f})),h},table:function(r){var a=e.table(r),u=a.schema.primaryKey;return i(i({},a),{mutate:function(l){var f=N.trans;if(u.outbound||f.db._options.cache==="disabled"||f.explicit||f.idbtrans.mode!=="readwrite")return a.mutate(l);var h=bt["idb://".concat(t,"/").concat(r)];return h?(f=a.mutate(l),l.type!=="add"&&l.type!=="put"||!(50<=l.values.length||Gr(u,l).some(function(m){return m==null}))?(h.optimisticOps.push(l),l.mutatedParts&&Cn(l.mutatedParts),f.then(function(m){0<m.numFailures&&(ce(h.optimisticOps,l),(m=ui(0,l,m))&&h.optimisticOps.push(m),l.mutatedParts&&Cn(l.mutatedParts))}),f.catch(function(){ce(h.optimisticOps,l),l.mutatedParts&&Cn(l.mutatedParts)})):f.then(function(m){var g=ui(0,i(i({},l),{values:l.values.map(function(w,p){var x;return m.failures[p]?w:(w=(x=u.keyPath)!==null&&x!==void 0&&x.includes(".")?le(w):i({},w),se(w,u.keyPath,m.results[p]),w)})}),m);h.optimisticOps.push(g),queueMicrotask(function(){return l.mutatedParts&&Cn(l.mutatedParts)})}),f):a.mutate(l)},query:function(l){if(!ai(N,a)||!oi("query",l))return a.query(l);var f=((g=N.trans)===null||g===void 0?void 0:g.db._options.cache)==="immutable",p=N,h=p.requery,m=p.signal,g=function(b,_,v,k){var P=bt["idb://".concat(b,"/").concat(_)];if(!P)return[];if(!(_=P.queries[v]))return[null,!1,P,null];var A=_[(k.query?k.query.index.name:null)||""];if(!A)return[null,!1,P,null];switch(v){case"query":var E=A.find(function(M){return M.req.limit===k.limit&&M.req.values===k.values&&li(M.req.query.range,k.query.range)});return E?[E,!0,P,A]:[A.find(function(M){return("limit"in M.req?M.req.limit:1/0)>=k.limit&&(!k.values||M.req.values)&&Ma(M.req.query.range,k.query.range)}),!1,P,A];case"count":return E=A.find(function(M){return li(M.req.query.range,k.query.range)}),[E,!!E,P,A]}}(t,r,"query",l),w=g[0],p=g[1],x=g[2],y=g[3];return w&&p?w.obsSet=l.obsSet:(p=a.query(l).then(function(b){var _=b.result;if(w&&(w.res=_),f){for(var v=0,k=_.length;v<k;++v)Object.freeze(_[v]);Object.freeze(_)}else b.result=le(_);return b}).catch(function(b){return y&&w&&ce(y,w),Promise.reject(b)}),w={obsSet:l.obsSet,promise:p,subscribers:new Set,type:"query",req:l,dirty:!1},y?y.push(w):(y=[w],(x=x||(bt["idb://".concat(t,"/").concat(r)]={queries:{query:{},count:{}},objs:new Map,optimisticOps:[],unsignaledParts:{}})).queries.query[l.query.index.name||""]=y)),Ia(w,y,h,m),w.promise.then(function(b){return{result:ci(b.result,l,x==null?void 0:x.optimisticOps,a,w,f)}})}})}})}};function Nn(e,t){return new Proxy(e,{get:function(r,a,u){return a==="db"?t:Reflect.get(r,a,u)}})}var Xe=(he.prototype.version=function(e){if(isNaN(e)||e<.1)throw new $.Type("Given version is not a positive number");if(e=Math.round(10*e)/10,this.idbdb||this._state.isBeingOpened)throw new $.Schema("Cannot add version when database is open");this.verno=Math.max(this.verno,e);var t=this._versions,r=t.filter(function(a){return a._cfg.version===e})[0];return r||(r=new this.Version(e),t.push(r),t.sort(wa),r.stores({}),this._state.autoSchema=!1,r)},he.prototype._whenReady=function(e){var t=this;return this.idbdb&&(this._state.openComplete||N.letThrough||this._vip)?e():new K(function(r,a){if(t._state.openComplete)return a(new $.DatabaseClosed(t._state.dbOpenError));if(!t._state.isBeingOpened){if(!t._state.autoOpen)return void a(new $.DatabaseClosed);t.open().catch(te)}t._state.dbReadyPromise.then(r,a)}).then(e)},he.prototype.use=function(e){var t=e.stack,r=e.create,a=e.level,u=e.name;return u&&this.unuse({stack:t,name:u}),e=this._middlewares[t]||(this._middlewares[t]=[]),e.push({stack:t,create:r,level:a??10,name:u}),e.sort(function(l,f){return l.level-f.level}),this},he.prototype.unuse=function(e){var t=e.stack,r=e.name,a=e.create;return t&&this._middlewares[t]&&(this._middlewares[t]=this._middlewares[t].filter(function(u){return a?u.create!==a:!!r&&u.name!==r})),this},he.prototype.open=function(){var e=this;return yt(Qe,function(){return ka(e)})},he.prototype._close=function(){var e=this._state,t=Ot.indexOf(this);if(0<=t&&Ot.splice(t,1),this.idbdb){try{this.idbdb.close()}catch{}this.idbdb=null}e.isBeingOpened||(e.dbReadyPromise=new K(function(r){e.dbReadyResolve=r}),e.openCanceller=new K(function(r,a){e.cancelOpen=a}))},he.prototype.close=function(r){var t=(r===void 0?{disableAutoOpen:!0}:r).disableAutoOpen,r=this._state;t?(r.isBeingOpened&&r.cancelOpen(new $.DatabaseClosed),this._close(),r.autoOpen=!1,r.dbOpenError=new $.DatabaseClosed):(this._close(),r.autoOpen=this._options.autoOpen||r.isBeingOpened,r.openComplete=!1,r.dbOpenError=null)},he.prototype.delete=function(e){var t=this;e===void 0&&(e={disableAutoOpen:!0});var r=0<arguments.length&&typeof arguments[0]!="object",a=this._state;return new K(function(u,l){function f(){t.close(e);var h=t._deps.indexedDB.deleteDatabase(t.name);h.onsuccess=oe(function(){var m,g,w;m=t._deps,g=t.name,w=m.indexedDB,m=m.IDBKeyRange,$r(w)||g===kn||Fr(w,m).delete(g).catch(te),u()}),h.onerror=We(l),h.onblocked=t._fireOnBlocked}if(r)throw new $.InvalidArgument("Invalid closeOptions argument to db.delete()");a.isBeingOpened?a.dbReadyPromise.then(f):f()})},he.prototype.backendDB=function(){return this.idbdb},he.prototype.isOpen=function(){return this.idbdb!==null},he.prototype.hasBeenClosed=function(){var e=this._state.dbOpenError;return e&&e.name==="DatabaseClosed"},he.prototype.hasFailed=function(){return this._state.dbOpenError!==null},he.prototype.dynamicallyOpened=function(){return this._state.autoSchema},Object.defineProperty(he.prototype,"tables",{get:function(){var e=this;return S(this._allTables).map(function(t){return e._allTables[t]})},enumerable:!1,configurable:!0}),he.prototype.transaction=function(){var e=(function(t,r,a){var u=arguments.length;if(u<2)throw new $.InvalidArgument("Too few arguments");for(var l=new Array(u-1);--u;)l[u-1]=arguments[u];return a=l.pop(),[t,Ue(l),a]}).apply(this,arguments);return this._transaction.apply(this,e)},he.prototype._transaction=function(e,t,r){var a=this,u=N.trans;u&&u.db===this&&e.indexOf("!")===-1||(u=null);var l,f,h=e.indexOf("?")!==-1;e=e.replace("!","").replace("?","");try{if(f=t.map(function(g){if(g=g instanceof a.Table?g.name:g,typeof g!="string")throw new TypeError("Invalid table argument to Dexie.transaction(). Only Table or String are allowed");return g}),e=="r"||e===Or)l=Or;else{if(e!="rw"&&e!=Mr)throw new $.InvalidArgument("Invalid transaction mode: "+e);l=Mr}if(u){if(u.mode===Or&&l===Mr){if(!h)throw new $.SubTransaction("Cannot enter a sub-transaction with READWRITE mode when parent transaction is READONLY");u=null}u&&f.forEach(function(g){if(u&&u.storeNames.indexOf(g)===-1){if(!h)throw new $.SubTransaction("Table "+g+" not included in parent transaction.");u=null}}),h&&u&&!u.active&&(u=null)}}catch(g){return u?u._promise(null,function(w,p){p(g)}):fe(g)}var m=(function g(w,p,x,y,b){return K.resolve().then(function(){var _=N.transless||N,v=w._createTransaction(p,x,w._dbSchema,y);if(v.explicit=!0,_={trans:v,transless:_},y)v.idbtrans=y.idbtrans;else try{v.create(),v.idbtrans._explicit=!0,w._state.PR1398_maxLoop=3}catch(A){return A.name===vr.InvalidState&&w.isOpen()&&0<--w._state.PR1398_maxLoop?(console.warn("Dexie: Need to reopen db"),w.close({disableAutoOpen:!1}),w.open().then(function(){return g(w,p,x,null,b)})):fe(A)}var k,P=Fe(b);return P&&Et(),_=K.follow(function(){var A;(k=b.call(v,v))&&(P?(A=et.bind(null,null),k.then(A,A)):typeof k.next=="function"&&typeof k.throw=="function"&&(k=zr(k)))},_),(k&&typeof k.then=="function"?K.resolve(k).then(function(A){return v.active?A:fe(new $.PrematureCommit("Transaction committed too early. See http://bit.ly/2kdckMn"))}):_.then(function(){return k})).then(function(A){return y&&v._resolve(),v._completion.then(function(){return A})}).catch(function(A){return v._reject(A),fe(A)})})}).bind(null,this,l,f,u,r);return u?u._promise(l,m,"lock"):N.trans?yt(N.transless,function(){return a._whenReady(m)}):this._whenReady(m)},he.prototype.table=function(e){if(!F(this._allTables,e))throw new $.InvalidTable("Table ".concat(e," does not exist"));return this._allTables[e]},he);function he(e,t){var r=this;this._middlewares={},this.verno=0;var a=he.dependencies;this._options=t=i({addons:he.addons,autoOpen:!0,indexedDB:a.indexedDB,IDBKeyRange:a.IDBKeyRange,cache:"cloned"},t),this._deps={indexedDB:t.indexedDB,IDBKeyRange:t.IDBKeyRange},a=t.addons,this._dbSchema={},this._versions=[],this._storeNames=[],this._allTables={},this.idbdb=null,this._novip=this;var u,l,f,h,m,g={dbOpenError:null,isBeingOpened:!1,onReadyBeingFired:null,openComplete:!1,dbReadyResolve:te,dbReadyPromise:null,cancelOpen:te,openCanceller:null,autoSchema:!0,PR1398_maxLoop:3,autoOpen:t.autoOpen};g.dbReadyPromise=new K(function(p){g.dbReadyResolve=p}),g.openCanceller=new K(function(p,x){g.cancelOpen=x}),this._state=g,this.name=e,this.on=Wt(this,"populate","blocked","versionchange","close",{ready:[br,te]}),this.on.ready.subscribe=ge(this.on.ready.subscribe,function(p){return function(x,y){he.vip(function(){var b,_=r._state;_.openComplete?(_.dbOpenError||K.resolve().then(x),y&&p(x)):_.onReadyBeingFired?(_.onReadyBeingFired.push(x),y&&p(x)):(p(x),b=r,y||p(function v(){b.on.ready.unsubscribe(x),b.on.ready.unsubscribe(v)}))})}}),this.Collection=(u=this,Ht(da.prototype,function(k,v){this.db=u;var y=$s,b=null;if(v)try{y=v()}catch(P){b=P}var _=k._ctx,v=_.table,k=v.hook.reading.fire;this._ctx={table:v,index:_.index,isPrimKey:!_.index||v.schema.primKey.keyPath&&_.index===v.schema.primKey.name,range:y,keysOnly:!1,dir:"next",unique:"",algorithm:null,filter:null,replayFilter:null,justLimit:!0,isMatch:null,offset:0,limit:1/0,error:b,or:_.or,valueMapper:k!==Nt?k:null}})),this.Table=(l=this,Ht(Hs.prototype,function(p,x,y){this.db=l,this._tx=y,this.name=p,this.schema=x,this.hook=l._allTables[p]?l._allTables[p].hook:Wt(null,{creating:[sa,te],reading:[ra,Nt],updating:[aa,te],deleting:[ia,te]})})),this.Transaction=(f=this,Ht(ya.prototype,function(p,x,y,b,_){var v=this;this.db=f,this.mode=p,this.storeNames=x,this.schema=y,this.chromeTransactionDurability=b,this.idbtrans=null,this.on=Wt(this,"complete","error","abort"),this.parent=_||null,this.active=!0,this._reculock=0,this._blockedFuncs=[],this._resolve=null,this._reject=null,this._waitingFor=null,this._waitingQueue=null,this._spinCount=0,this._completion=new K(function(k,P){v._resolve=k,v._reject=P}),this._completion.then(function(){v.active=!1,v.on.complete.fire()},function(k){var P=v.active;return v.active=!1,v.on.error.fire(k),v.parent?v.parent._reject(k):P&&v.idbtrans&&v.idbtrans.abort(),fe(k)})})),this.Version=(h=this,Ht(Sa.prototype,function(p){this.db=h,this._cfg={version:p,storesSource:null,dbschema:{},tables:{},contentUpgrade:null}})),this.WhereClause=(m=this,Ht(Gs.prototype,function(p,x,y){if(this.db=m,this._ctx={table:p,index:x===":id"?null:x,or:y},this._cmp=this._ascending=Y,this._descending=function(b,_){return Y(_,b)},this._max=function(b,_){return 0<Y(b,_)?b:_},this._min=function(b,_){return Y(b,_)<0?b:_},this._IDBKeyRange=m._deps.IDBKeyRange,!this._IDBKeyRange)throw new $.MissingAPI})),this.on("versionchange",function(p){0<p.newVersion?console.warn("Another connection wants to upgrade database '".concat(r.name,"'. Closing db now to resume the upgrade.")):console.warn("Another connection wants to delete database '".concat(r.name,"'. Closing db now to resume the delete request.")),r.close({disableAutoOpen:!1})}),this.on("blocked",function(p){!p.newVersion||p.newVersion<p.oldVersion?console.warn("Dexie.delete('".concat(r.name,"') was blocked")):console.warn("Upgrade '".concat(r.name,"' blocked by other connection holding version ").concat(p.oldVersion/10))}),this._maxKey=Xt(t.IDBKeyRange),this._createTransaction=function(p,x,y,b){return new r.Transaction(p,x,y,r._options.chromeTransactionDurability,b)},this._fireOnBlocked=function(p){r.on("blocked").fire(p),Ot.filter(function(x){return x.name===r.name&&x!==r&&!x._state.vcFired}).map(function(x){return x.on("versionchange").fire(p)})},this.use(Ea),this.use(Ta),this.use(Oa),this.use(Pa),this.use(Aa);var w=new Proxy(this,{get:function(p,x,y){if(x==="_vip")return!0;if(x==="table")return function(_){return Nn(r.table(_),w)};var b=Reflect.get(p,x,y);return b instanceof Hs?Nn(b,w):x==="tables"?b.map(function(_){return Nn(_,w)}):x==="_createTransaction"?function(){return Nn(b.apply(this,arguments),w)}:b}});this.vip=w,a.forEach(function(p){return p(r)})}var Fn,Ce=typeof Symbol<"u"&&"observable"in Symbol?Symbol.observable:"@@observable",Ra=(Qr.prototype.subscribe=function(e,t,r){return this._subscribe(e&&typeof e!="function"?e:{next:e,error:t,complete:r})},Qr.prototype[Ce]=function(){return this},Qr);function Qr(e){this._subscribe=e}try{Fn={indexedDB:d.indexedDB||d.mozIndexedDB||d.webkitIndexedDB||d.msIndexedDB,IDBKeyRange:d.IDBKeyRange||d.webkitIDBKeyRange}}catch{Fn={indexedDB:null,IDBKeyRange:null}}function fi(e){var t,r=!1,a=new Ra(function(u){var l=Fe(e),f,h=!1,m={},g={},w={get closed(){return h},unsubscribe:function(){h||(h=!0,f&&f.abort(),p&&rt.storagemutated.unsubscribe(y))}};u.start&&u.start(w);var p=!1,x=function(){return Er(b)},y=function(_){Kn(m,_),Wr(g,m)&&x()},b=function(){var _,v,k;!h&&Fn.indexedDB&&(m={},_={},f&&f.abort(),f=new AbortController,k=function(P){var A=Pt();try{l&&Et();var E=Ze(e,P);return E=l?E.finally(et):E}finally{A&&At()}}(v={subscr:_,signal:f.signal,requery:x,querier:e,trans:null}),Promise.resolve(k).then(function(P){r=!0,t=P,h||v.signal.aborted||(m={},function(A){for(var E in A)if(F(A,E))return;return 1}(g=_)||p||(rt(zt,y),p=!0),Er(function(){return!h&&u.next&&u.next(P)}))},function(P){r=!1,["DatabaseClosedError","AbortError"].includes(P==null?void 0:P.name)||h||Er(function(){h||u.error&&u.error(P)})}))};return setTimeout(x,0),w});return a.hasValue=function(){return r},a.getValue=function(){return t},a}var wt=Xe;function Zr(e){var t=st;try{st=!0,rt.storagemutated.fire(e),Jr(e,!0)}finally{st=t}}L(wt,i(i({},mn),{delete:function(e){return new wt(e,{addons:[]}).delete()},exists:function(e){return new wt(e,{addons:[]}).open().then(function(t){return t.close(),!0}).catch("NoSuchDatabaseError",function(){return!1})},getDatabaseNames:function(e){try{return t=wt.dependencies,r=t.indexedDB,t=t.IDBKeyRange,($r(r)?Promise.resolve(r.databases()).then(function(a){return a.map(function(u){return u.name}).filter(function(u){return u!==kn})}):Fr(r,t).toCollection().primaryKeys()).then(e)}catch{return fe(new $.MissingAPI)}var t,r},defineClass:function(){return function(e){B(this,e)}},ignoreTransaction:function(e){return N.trans?yt(N.transless,e):e()},vip:Ur,async:function(e){return function(){try{var t=zr(e.apply(this,arguments));return t&&typeof t.then=="function"?t:K.resolve(t)}catch(r){return fe(r)}}},spawn:function(e,t,r){try{var a=zr(e.apply(r,t||[]));return a&&typeof a.then=="function"?a:K.resolve(a)}catch(u){return fe(u)}},currentTransaction:{get:function(){return N.trans||null}},waitFor:function(e,t){return t=K.resolve(typeof e=="function"?wt.ignoreTransaction(e):e).timeout(t||6e4),N.trans?N.trans.waitFor(t):t},Promise:K,debug:{get:function(){return Le},set:function(e){js(e)}},derive:de,extend:B,props:L,override:ge,Events:Wt,on:rt,liveQuery:fi,extendObservabilitySet:Kn,getByKeyPath:ue,setByKeyPath:se,delByKeyPath:function(e,t){typeof t=="string"?se(e,t,void 0):"length"in t&&[].map.call(t,function(r){se(e,r,void 0)})},shallowClone:Ee,deepClone:le,getObjectDiff:Xr,cmp:Y,asap:Je,minKey:-1/0,addons:[],connections:Ot,errnames:vr,dependencies:Fn,cache:bt,semVer:"4.0.11",version:"4.0.11".split(".").map(function(e){return parseInt(e)}).reduce(function(e,t,r){return e+t/Math.pow(10,2*r)})})),wt.maxKey=Xt(wt.dependencies.IDBKeyRange),typeof dispatchEvent<"u"&&typeof addEventListener<"u"&&(rt(zt,function(e){st||(e=new CustomEvent(Dr,{detail:e}),st=!0,dispatchEvent(e),st=!1)}),addEventListener(Dr,function(e){e=e.detail,st||Zr(e)}));var Tt,st=!1,hi=function(){};return typeof BroadcastChannel<"u"&&((hi=function(){(Tt=new BroadcastChannel(Dr)).onmessage=function(e){return e.data&&Zr(e.data)}})(),typeof Tt.unref=="function"&&Tt.unref(),rt(zt,function(e){st||Tt.postMessage(e)})),typeof addEventListener<"u"&&(addEventListener("pagehide",function(e){if(!Xe.disableBfCache&&e.persisted){Le&&console.debug("Dexie: handling persisted pagehide"),Tt!=null&&Tt.close();for(var t=0,r=Ot;t<r.length;t++)r[t].close({disableAutoOpen:!1})}}),addEventListener("pageshow",function(e){!Xe.disableBfCache&&e.persisted&&(Le&&console.debug("Dexie: handling persisted pageshow"),hi(),Zr({all:new _e(-1/0,[[]])}))})),K.rejectionMapper=function(e,t){return!e||e instanceof St||e instanceof TypeError||e instanceof SyntaxError||!e.name||!Ds[e.name]?e:(t=new Ds[e.name](t||e.message,e),"stack"in e&&ae(t,"stack",{get:function(){return this.inner.stack}}),t)},js(Le),i(Xe,Object.freeze({__proto__:null,Dexie:Xe,liveQuery:fi,Entity:Us,cmp:Y,PropModification:Vt,replacePrefix:function(e,t){return new Vt({replacePrefix:[e,t]})},add:function(e){return new Vt({add:e})},remove:function(e){return new Vt({remove:e})},default:Xe,RangeSet:_e,mergeRanges:Qt,rangesOverlap:ti}),{default:Xe}),Xe})}(sr)),sr.exports}var qa=Ca();const gs=Ba(qa),pi=Symbol.for("Dexie"),ir=globalThis[pi]||(globalThis[pi]=gs);if(gs.semVer!==ir.semVer)throw new Error(`Two different versions of Dexie loaded in the same app: ${gs.semVer} and ${ir.semVer}`);const{liveQuery:Yo,mergeRanges:Qo,rangesOverlap:Zo,RangeSet:eu,cmp:tu,Entity:nu,PropModification:ru,replacePrefix:su,add:iu,remove:au}=ir,vs={theme:"system",apiKeys:{anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434"},videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1,preserveKeyFormat:!1},{subscribe:Na,set:ts,update:ns}=Ti(vs),lr={subscribe:Na,async loadSettings(){try{const o=await rr.settings.get("user-settings");o?(console.log("Loaded settings from IndexedDB:",o),o.apiKeys?Object.entries(o.apiKeys).forEach(([n,s])=>{s&&typeof s=="string"&&s.length>0?console.log(`Found ${n} API key (length: ${s.length}, starts with: ${s.substring(0,4)}...)`):console.log(`No ${n} API key found in settings`)}):(console.warn("No API keys object found in loaded settings"),o.apiKeys={anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434"}),ts(o)):(console.log("Creating default settings in IndexedDB"),await rr.settings.add({...vs,id:"user-settings"}),ts(vs))}catch(o){console.error("Failed to load settings from IndexedDB:",o);try{const n=localStorage.getItem("gervais-settings");if(n){console.log("Found settings in localStorage, migrating to IndexedDB");const s=JSON.parse(n);ts(s),await rr.settings.add({...s,id:"user-settings"}),localStorage.removeItem("gervais-settings")}}catch(n){console.error("Failed to load settings from localStorage:",n)}}},async saveSettings(o){try{console.log("Saving settings to IndexedDB:",o),await rr.settings.put({...o,id:"user-settings"})}catch(n){console.error("Failed to save settings to IndexedDB:",n);try{localStorage.setItem("gervais-settings",JSON.stringify(o)),console.log("Saved settings to localStorage as fallback")}catch(s){console.error("Failed to save settings to localStorage:",s)}}},async updateApiKeys(o){ns(n=>{const s={...n,apiKeys:{...n.apiKeys,...o}};return this.saveSettings(s).catch(console.error),s})},async updateSettings(o){ns(n=>{const s={...n,...o,apiKeys:{...n.apiKeys,...o.apiKeys||{}}};return this.saveSettings(s).catch(console.error),s})},updateTheme(o){ns(n=>{const s={...n,theme:o};return this.saveSettings(s).catch(console.error),s})},async init(){await this.loadSettings()}},jt="0.39.0";let mi=!1,ln,Ri,bs,Di,ji,Bi;function Fa(o,n={auto:!1}){if(mi)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${o.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(ln)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${o.kind}'\` after \`import '@anthropic-ai/sdk/shims/${ln}'\``);mi=n.auto,ln=o.kind,Ri=o.fetch,bs=o.File,Di=o.ReadableStream,ji=o.getDefaultAgent,Bi=o.fileFromPath}class $a{constructor(n){this.body=n}get[Symbol.toStringTag](){return"MultipartBody"}}function Ua({manuallyImported:o}={}){const n=o?"You may need to use polyfills":"Add one of these imports before your first `import â¦ from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let s,i,c,d;try{s=fetch,i=Request,c=Response,d=Headers}catch(S){throw new Error(`this environment is missing the following Web Fetch API type: ${S.message}. ${n}`)}return{kind:"web",fetch:s,Request:i,Response:c,Headers:d,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${n}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${n}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${n}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${n}`)}},getMultipartRequestOptions:async(S,O)=>({...O,body:new $a(S)}),getDefaultAgent:S=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:S=>!1}}ln||Fa(Ua(),{auto:!0});class Q extends Error{}class Ae extends Q{constructor(n,s,i,c){super(`${Ae.makeMessage(n,s,i)}`),this.status=n,this.headers=c,this.request_id=c==null?void 0:c["request-id"],this.error=s}static makeMessage(n,s,i){const c=s!=null&&s.message?typeof s.message=="string"?s.message:JSON.stringify(s.message):s?JSON.stringify(s):i;return n&&c?`${n} ${c}`:n?`${n} status code (no body)`:c||"(no status code or body)"}static generate(n,s,i,c){if(!n||!c)return new fr({message:i,cause:ws(s)});const d=s;return n===400?new Ci(n,d,i,c):n===401?new qi(n,d,i,c):n===403?new Ni(n,d,i,c):n===404?new Fi(n,d,i,c):n===409?new $i(n,d,i,c):n===422?new Ui(n,d,i,c):n===429?new Li(n,d,i,c):n>=500?new Wi(n,d,i,c):new Ae(n,d,i,c)}}class $e extends Ae{constructor({message:n}={}){super(void 0,void 0,n||"Request was aborted.",void 0)}}class fr extends Ae{constructor({message:n,cause:s}){super(void 0,void 0,n||"Connection error.",void 0),s&&(this.cause=s)}}class Ki extends fr{constructor({message:n}={}){super({message:n??"Request timed out."})}}class Ci extends Ae{}class qi extends Ae{}class Ni extends Ae{}class Fi extends Ae{}class $i extends Ae{}class Ui extends Ae{}class Li extends Ae{}class Wi extends Ae{}var Un=function(o,n,s,i,c){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?o!==n||!c:!n.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?c.call(o,s):c?c.value=s:n.set(o,s),s},xt=function(o,n,s,i){if(s==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?o!==n||!i:!n.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?i:s==="a"?i.call(o):i?i.value:n.get(o)},Ke;class fn{constructor(){Ke.set(this,void 0),this.buffer=new Uint8Array,Un(this,Ke,null,"f")}decode(n){if(n==null)return[];const s=n instanceof ArrayBuffer?new Uint8Array(n):typeof n=="string"?new TextEncoder().encode(n):n;let i=new Uint8Array(this.buffer.length+s.length);i.set(this.buffer),i.set(s,this.buffer.length),this.buffer=i;const c=[];let d;for(;(d=La(this.buffer,xt(this,Ke,"f")))!=null;){if(d.carriage&&xt(this,Ke,"f")==null){Un(this,Ke,d.index,"f");continue}if(xt(this,Ke,"f")!=null&&(d.index!==xt(this,Ke,"f")+1||d.carriage)){c.push(this.decodeText(this.buffer.slice(0,xt(this,Ke,"f")-1))),this.buffer=this.buffer.slice(xt(this,Ke,"f")),Un(this,Ke,null,"f");continue}const S=xt(this,Ke,"f")!==null?d.preceding-1:d.preceding,O=this.decodeText(this.buffer.slice(0,S));c.push(O),this.buffer=this.buffer.slice(d.index),Un(this,Ke,null,"f")}return c}decodeText(n){if(n==null)return"";if(typeof n=="string")return n;if(typeof Buffer<"u"){if(n instanceof Buffer)return n.toString();if(n instanceof Uint8Array)return Buffer.from(n).toString();throw new Q(`Unexpected: received non-Uint8Array (${n.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(n instanceof Uint8Array||n instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(n);throw new Q(`Unexpected: received non-Uint8Array/ArrayBuffer (${n.constructor.name}) in a web platform. Please report this error.`)}throw new Q("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}Ke=new WeakMap;fn.NEWLINE_CHARS=new Set([`
`,"\r"]);fn.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function La(o,n){for(let c=n??0;c<o.length;c++){if(o[c]===10)return{preceding:c,index:c+1,carriage:!1};if(o[c]===13)return{preceding:c,index:c+1,carriage:!0}}return null}function Wa(o){for(let i=0;i<o.length-1;i++){if(o[i]===10&&o[i+1]===10||o[i]===13&&o[i+1]===13)return i+2;if(o[i]===13&&o[i+1]===10&&i+3<o.length&&o[i+2]===13&&o[i+3]===10)return i+4}return-1}function _s(o){if(o[Symbol.asyncIterator])return o;const n=o.getReader();return{async next(){try{const s=await n.read();return s!=null&&s.done&&n.releaseLock(),s}catch(s){throw n.releaseLock(),s}},async return(){const s=n.cancel();return n.releaseLock(),await s,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class Ve{constructor(n,s){this.iterator=n,this.controller=s}static fromSSEResponse(n,s){let i=!1;async function*c(){if(i)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");i=!0;let d=!1;try{for await(const S of Ha(n,s)){if(S.event==="completion")try{yield JSON.parse(S.data)}catch(O){throw console.error("Could not parse message into JSON:",S.data),console.error("From chunk:",S.raw),O}if(S.event==="message_start"||S.event==="message_delta"||S.event==="message_stop"||S.event==="content_block_start"||S.event==="content_block_delta"||S.event==="content_block_stop")try{yield JSON.parse(S.data)}catch(O){throw console.error("Could not parse message into JSON:",S.data),console.error("From chunk:",S.raw),O}if(S.event!=="ping"&&S.event==="error")throw Ae.generate(void 0,`SSE Error: ${S.data}`,S.data,Ji(n.headers))}d=!0}catch(S){if(S instanceof Error&&S.name==="AbortError")return;throw S}finally{d||s.abort()}}return new Ve(c,s)}static fromReadableStream(n,s){let i=!1;async function*c(){const S=new fn,O=_s(n);for await(const B of O)for(const q of S.decode(B))yield q;for(const B of S.flush())yield B}async function*d(){if(i)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");i=!0;let S=!1;try{for await(const O of c())S||O&&(yield JSON.parse(O));S=!0}catch(O){if(O instanceof Error&&O.name==="AbortError")return;throw O}finally{S||s.abort()}}return new Ve(d,s)}[Symbol.asyncIterator](){return this.iterator()}tee(){const n=[],s=[],i=this.iterator(),c=d=>({next:()=>{if(d.length===0){const S=i.next();n.push(S),s.push(S)}return d.shift()}});return[new Ve(()=>c(n),this.controller),new Ve(()=>c(s),this.controller)]}toReadableStream(){const n=this;let s;const i=new TextEncoder;return new Di({async start(){s=n[Symbol.asyncIterator]()},async pull(c){try{const{value:d,done:S}=await s.next();if(S)return c.close();const O=i.encode(JSON.stringify(d)+`
`);c.enqueue(O)}catch(d){c.error(d)}},async cancel(){var c;await((c=s.return)==null?void 0:c.call(s))}})}}async function*Ha(o,n){if(!o.body)throw n.abort(),new Q("Attempted to iterate over a response with no body");const s=new Ja,i=new fn,c=_s(o.body);for await(const d of Va(c))for(const S of i.decode(d)){const O=s.decode(S);O&&(yield O)}for(const d of i.flush()){const S=s.decode(d);S&&(yield S)}}async function*Va(o){let n=new Uint8Array;for await(const s of o){if(s==null)continue;const i=s instanceof ArrayBuffer?new Uint8Array(s):typeof s=="string"?new TextEncoder().encode(s):s;let c=new Uint8Array(n.length+i.length);c.set(n),c.set(i,n.length),n=c;let d;for(;(d=Wa(n))!==-1;)yield n.slice(0,d),n=n.slice(d)}n.length>0&&(yield n)}class Ja{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(n){if(n.endsWith("\r")&&(n=n.substring(0,n.length-1)),!n){if(!this.event&&!this.data.length)return null;const d={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],d}if(this.chunks.push(n),n.startsWith(":"))return null;let[s,i,c]=za(n,":");return c.startsWith(" ")&&(c=c.substring(1)),s==="event"?this.event=c:s==="data"&&this.data.push(c),null}}function za(o,n){const s=o.indexOf(n);return s!==-1?[o.substring(0,s),n,o.substring(s+n.length)]:[o,"",""]}const Xa=o=>o!=null&&typeof o=="object"&&typeof o.url=="string"&&typeof o.blob=="function",Ga=o=>o!=null&&typeof o=="object"&&typeof o.name=="string"&&typeof o.lastModified=="number"&&hr(o),hr=o=>o!=null&&typeof o=="object"&&typeof o.size=="number"&&typeof o.type=="string"&&typeof o.text=="function"&&typeof o.slice=="function"&&typeof o.arrayBuffer=="function";async function Ya(o,n,s){var c;if(o=await o,Ga(o))return o;if(Xa(o)){const d=await o.blob();n||(n=new URL(o.url).pathname.split(/[\\/]/).pop()??"unknown_file");const S=hr(d)?[await d.arrayBuffer()]:[d];return new bs(S,n,s)}const i=await Qa(o);if(n||(n=eo(o)??"unknown_file"),!(s!=null&&s.type)){const d=(c=i[0])==null?void 0:c.type;typeof d=="string"&&(s={...s,type:d})}return new bs(i,n,s)}async function Qa(o){var s;let n=[];if(typeof o=="string"||ArrayBuffer.isView(o)||o instanceof ArrayBuffer)n.push(o);else if(hr(o))n.push(await o.arrayBuffer());else if(to(o))for await(const i of o)n.push(i);else throw new Error(`Unexpected data type: ${typeof o}; constructor: ${(s=o==null?void 0:o.constructor)==null?void 0:s.name}; props: ${Za(o)}`);return n}function Za(o){return`[${Object.getOwnPropertyNames(o).map(s=>`"${s}"`).join(", ")}]`}function eo(o){var n;return rs(o.name)||rs(o.filename)||((n=rs(o.path))==null?void 0:n.split(/[\\/]/).pop())}const rs=o=>{if(typeof o=="string")return o;if(typeof Buffer<"u"&&o instanceof Buffer)return String(o)},to=o=>o!=null&&typeof o=="object"&&typeof o[Symbol.asyncIterator]=="function",yi=o=>o&&typeof o=="object"&&o.body&&o[Symbol.toStringTag]==="MultipartBody";var Kt={},no=function(o,n,s,i,c){if(typeof n=="function"?o!==n||!0:!n.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n.set(o,s),s},ro=function(o,n,s,i){if(typeof n=="function"?o!==n||!0:!n.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?i:s==="a"?i.call(o):i?i.value:n.get(o)},Ln;async function Hi(o){const{response:n}=o;if(o.options.stream)return Ct("response",n.status,n.url,n.headers,n.body),o.options.__streamClass?o.options.__streamClass.fromSSEResponse(n,o.controller):Ve.fromSSEResponse(n,o.controller);if(n.status===204)return null;if(o.options.__binaryResponse)return n;const s=n.headers.get("content-type");if((s==null?void 0:s.includes("application/json"))||(s==null?void 0:s.includes("application/vnd.api+json"))){const d=await n.json();return Ct("response",n.status,n.url,n.headers,d),Vi(d,n)}const c=await n.text();return Ct("response",n.status,n.url,n.headers,c),c}function Vi(o,n){return!o||typeof o!="object"||Array.isArray(o)?o:Object.defineProperty(o,"_request_id",{value:n.headers.get("request-id"),enumerable:!1})}class dr extends Promise{constructor(n,s=Hi){super(i=>{i(null)}),this.responsePromise=n,this.parseResponse=s}_thenUnwrap(n){return new dr(this.responsePromise,async s=>Vi(n(await this.parseResponse(s),s),s.response))}asResponse(){return this.responsePromise.then(n=>n.response)}async withResponse(){const[n,s]=await Promise.all([this.parse(),this.asResponse()]);return{data:n,response:s,request_id:s.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(n,s){return this.parse().then(n,s)}catch(n){return this.parse().catch(n)}finally(n){return this.parse().finally(n)}}class so{constructor({baseURL:n,maxRetries:s=2,timeout:i=6e5,httpAgent:c,fetch:d}){this.baseURL=n,this.maxRetries=ss("maxRetries",s),this.timeout=ss("timeout",i),this.httpAgent=c,this.fetch=d??Ri}authHeaders(n){return{}}defaultHeaders(n){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...lo(),...this.authHeaders(n)}}validateHeaders(n,s){}defaultIdempotencyKey(){return`stainless-node-retry-${yo()}`}get(n,s){return this.methodRequest("get",n,s)}post(n,s){return this.methodRequest("post",n,s)}patch(n,s){return this.methodRequest("patch",n,s)}put(n,s){return this.methodRequest("put",n,s)}delete(n,s){return this.methodRequest("delete",n,s)}methodRequest(n,s,i){return this.request(Promise.resolve(i).then(async c=>{const d=c&&hr(c==null?void 0:c.body)?new DataView(await c.body.arrayBuffer()):(c==null?void 0:c.body)instanceof DataView?c.body:(c==null?void 0:c.body)instanceof ArrayBuffer?new DataView(c.body):c&&ArrayBuffer.isView(c==null?void 0:c.body)?new DataView(c.body.buffer):c==null?void 0:c.body;return{method:n,path:s,...c,body:d}}))}getAPIList(n,s,i){return this.requestAPIList(s,{method:"get",path:n,...i})}calculateContentLength(n){if(typeof n=="string"){if(typeof Buffer<"u")return Buffer.byteLength(n,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(n).length.toString()}else if(ArrayBuffer.isView(n))return n.byteLength.toString();return null}buildRequest(n,{retryCount:s=0}={}){var ae;n={...n};const{method:i,path:c,query:d,headers:S={}}=n,O=ArrayBuffer.isView(n.body)||n.__binaryRequest&&typeof n.body=="string"?n.body:yi(n.body)?n.body.body:n.body?JSON.stringify(n.body,null,2):null,B=this.calculateContentLength(O),q=this.buildURL(c,d);"timeout"in n&&ss("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const H=n.httpAgent??this.httpAgent??ji(q),F=n.timeout+1e3;typeof((ae=H==null?void 0:H.options)==null?void 0:ae.timeout)=="number"&&F>(H.options.timeout??0)&&(H.options.timeout=F),this.idempotencyHeader&&i!=="get"&&(n.idempotencyKey||(n.idempotencyKey=this.defaultIdempotencyKey()),S[this.idempotencyHeader]=n.idempotencyKey);const L=this.buildHeaders({options:n,headers:S,contentLength:B,retryCount:s});return{req:{method:i,...O&&{body:O},headers:L,...H&&{agent:H},signal:n.signal??null},url:q,timeout:n.timeout}}buildHeaders({options:n,headers:s,contentLength:i,retryCount:c}){const d={};i&&(d["content-length"]=i);const S=this.defaultHeaders(n);return wi(d,S),wi(d,s),yi(n.body)&&ln!=="node"&&delete d["content-type"],Wn(S,"x-stainless-retry-count")===void 0&&Wn(s,"x-stainless-retry-count")===void 0&&(d["x-stainless-retry-count"]=String(c)),Wn(S,"x-stainless-timeout")===void 0&&Wn(s,"x-stainless-timeout")===void 0&&n.timeout&&(d["x-stainless-timeout"]=String(n.timeout)),this.validateHeaders(d,s),d}_calculateNonstreamingTimeout(n){if(3600*n/128e3>600)throw new Q("Streaming is strongly recommended for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-python#streaming-responses for more details");return 600*1e3}async prepareOptions(n){}async prepareRequest(n,{url:s,options:i}){}parseHeaders(n){return n?Symbol.iterator in n?Object.fromEntries(Array.from(n).map(s=>[...s])):{...n}:{}}makeStatusError(n,s,i,c){return Ae.generate(n,s,i,c)}request(n,s=null){return new dr(this.makeRequest(n,s))}async makeRequest(n,s){var F,L;const i=await n,c=i.maxRetries??this.maxRetries;s==null&&(s=c),await this.prepareOptions(i);const{req:d,url:S,timeout:O}=this.buildRequest(i,{retryCount:c-s});if(await this.prepareRequest(d,{url:S,options:i}),Ct("request",S,i,d.headers),(F=i.signal)!=null&&F.aborted)throw new $e;const B=new AbortController,q=await this.fetchWithTimeout(S,d,O,B).catch(ws);if(q instanceof Error){if((L=i.signal)!=null&&L.aborted)throw new $e;if(s)return this.retryRequest(i,s);throw q.name==="AbortError"?new Ki:new fr({cause:q})}const H=Ji(q.headers);if(!q.ok){if(s&&this.shouldRetry(q)){const ee=`retrying, ${s} attempts remaining`;return Ct(`response (error; ${ee})`,q.status,S,H),this.retryRequest(i,s,H)}const V=await q.text().catch(ee=>ws(ee).message),ae=fo(V),de=ae?void 0:V;throw Ct(`response (error; ${s?"(error; no more retries left)":"(error; not retryable)"})`,q.status,S,H,de),this.makeStatusError(q.status,ae,de,H)}return{response:q,options:i,controller:B}}requestAPIList(n,s){const i=this.makeRequest(s,null);return new ao(this,i,n)}buildURL(n,s){const i=po(n)?new URL(n):new URL(this.baseURL+(this.baseURL.endsWith("/")&&n.startsWith("/")?n.slice(1):n)),c=this.defaultQuery();return ar(c)||(s={...c,...s}),typeof s=="object"&&s&&!Array.isArray(s)&&(i.search=this.stringifyQuery(s)),i.toString()}stringifyQuery(n){return Object.entries(n).filter(([s,i])=>typeof i<"u").map(([s,i])=>{if(typeof i=="string"||typeof i=="number"||typeof i=="boolean")return`${encodeURIComponent(s)}=${encodeURIComponent(i)}`;if(i===null)return`${encodeURIComponent(s)}=`;throw new Q(`Cannot stringify type ${typeof i}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(n,s,i,c){const{signal:d,...S}=s||{};d&&d.addEventListener("abort",()=>c.abort());const O=setTimeout(()=>c.abort(),i),B={signal:c.signal,...S};B.method&&(B.method=B.method.toUpperCase());const q=60*1e3,H=setTimeout(()=>{var F,L;if(B&&((F=B==null?void 0:B.agent)!=null&&F.sockets))for(const V of Object.values((L=B==null?void 0:B.agent)==null?void 0:L.sockets).flat())V!=null&&V.setKeepAlive&&V.setKeepAlive(!0,q)},q);return this.fetch.call(void 0,n,B).finally(()=>{clearTimeout(O),clearTimeout(H)})}shouldRetry(n){const s=n.headers.get("x-should-retry");return s==="true"?!0:s==="false"?!1:n.status===408||n.status===409||n.status===429||n.status>=500}async retryRequest(n,s,i){let c;const d=i==null?void 0:i["retry-after-ms"];if(d){const O=parseFloat(d);Number.isNaN(O)||(c=O)}const S=i==null?void 0:i["retry-after"];if(S&&!c){const O=parseFloat(S);Number.isNaN(O)?c=Date.parse(S)-Date.now():c=O*1e3}if(!(c&&0<=c&&c<60*1e3)){const O=n.maxRetries??this.maxRetries;c=this.calculateDefaultRetryTimeoutMillis(s,O)}return await mo(c),this.makeRequest(n,s-1)}calculateDefaultRetryTimeoutMillis(n,s){const d=s-n,S=Math.min(.5*Math.pow(2,d),8),O=1-Math.random()*.25;return S*O*1e3}getUserAgent(){return`${this.constructor.name}/JS ${jt}`}}class io{constructor(n,s,i,c){Ln.set(this,void 0),no(this,Ln,n),this.options=c,this.response=s,this.body=i}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const n=this.nextPageInfo();if(!n)throw new Q("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const s={...this.options};if("params"in n&&typeof s.query=="object")s.query={...s.query,...n.params};else if("url"in n){const i=[...Object.entries(s.query||{}),...n.url.searchParams.entries()];for(const[c,d]of i)n.url.searchParams.set(c,d);s.query=void 0,s.path=n.url.toString()}return await ro(this,Ln,"f").requestAPIList(this.constructor,s)}async*iterPages(){let n=this;for(yield n;n.hasNextPage();)n=await n.getNextPage(),yield n}async*[(Ln=new WeakMap,Symbol.asyncIterator)](){for await(const n of this.iterPages())for(const s of n.getPaginatedItems())yield s}}class ao extends dr{constructor(n,s,i){super(s,async c=>new i(n,c.response,await Hi(c),c.options))}async*[Symbol.asyncIterator](){const n=await this;for await(const s of n)yield s}}const Ji=o=>new Proxy(Object.fromEntries(o.entries()),{get(n,s){const i=s.toString();return n[i.toLowerCase()]||n[i]}}),oo={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},ot=o=>typeof o=="object"&&o!==null&&!ar(o)&&Object.keys(o).every(n=>zi(oo,n)),uo=()=>{var n;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":jt,"X-Stainless-OS":vi(Deno.build.os),"X-Stainless-Arch":gi(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((n=Deno.version)==null?void 0:n.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":jt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":jt,"X-Stainless-OS":vi(process.platform),"X-Stainless-Arch":gi(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const o=co();return o?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":jt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${o.browser}`,"X-Stainless-Runtime-Version":o.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":jt,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function co(){if(typeof navigator>"u"||!navigator)return null;const o=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:n,pattern:s}of o){const i=s.exec(navigator.userAgent);if(i){const c=i[1]||0,d=i[2]||0,S=i[3]||0;return{browser:n,version:`${c}.${d}.${S}`}}}return null}const gi=o=>o==="x32"?"x32":o==="x86_64"||o==="x64"?"x64":o==="arm"?"arm":o==="aarch64"||o==="arm64"?"arm64":o?`other:${o}`:"unknown",vi=o=>(o=o.toLowerCase(),o.includes("ios")?"iOS":o==="android"?"Android":o==="darwin"?"MacOS":o==="win32"?"Windows":o==="freebsd"?"FreeBSD":o==="openbsd"?"OpenBSD":o==="linux"?"Linux":o?`Other:${o}`:"Unknown");let bi;const lo=()=>bi??(bi=uo()),fo=o=>{try{return JSON.parse(o)}catch{return}},ho=/^[a-z][a-z0-9+.-]*:/i,po=o=>ho.test(o),mo=o=>new Promise(n=>setTimeout(n,o)),ss=(o,n)=>{if(typeof n!="number"||!Number.isInteger(n))throw new Q(`${o} must be an integer`);if(n<0)throw new Q(`${o} must be a positive integer`);return n},ws=o=>{if(o instanceof Error)return o;if(typeof o=="object"&&o!==null)try{return new Error(JSON.stringify(o))}catch{}return new Error(String(o))},is=o=>{var n,s,i,c;if(typeof process<"u")return((n=Kt==null?void 0:Kt[o])==null?void 0:n.trim())??void 0;if(typeof Deno<"u")return(c=(i=(s=Deno.env)==null?void 0:s.get)==null?void 0:i.call(s,o))==null?void 0:c.trim()};function ar(o){if(!o)return!0;for(const n in o)return!1;return!0}function zi(o,n){return Object.prototype.hasOwnProperty.call(o,n)}function wi(o,n){for(const s in n){if(!zi(n,s))continue;const i=s.toLowerCase();if(!i)continue;const c=n[s];c===null?delete o[i]:c!==void 0&&(o[i]=c)}}function Ct(o,...n){typeof process<"u"&&(Kt==null?void 0:Kt.DEBUG)==="true"&&console.log(`Anthropic:DEBUG:${o}`,...n)}const yo=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,o=>{const n=Math.random()*16|0;return(o==="x"?n:n&3|8).toString(16)}),go=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",vo=o=>typeof(o==null?void 0:o.get)=="function",Wn=(o,n)=>{var i;const s=n.toLowerCase();if(vo(o)){const c=((i=n[0])==null?void 0:i.toUpperCase())+n.substring(1).replace(/([^\w])(\w)/g,(d,S,O)=>S+O.toUpperCase());for(const d of[n,s,n.toUpperCase(),c]){const S=o.get(d);if(S)return S}}for(const[c,d]of Object.entries(o))if(c.toLowerCase()===s)return Array.isArray(d)?(d.length<=1||console.warn(`Received ${d.length} entries for the ${n} header, using the first entry.`),d[0]):d};class pr extends io{constructor(n,s,i,c){super(n,s,i,c),this.data=i.data||[],this.has_more=i.has_more||!1,this.first_id=i.first_id||null,this.last_id=i.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const n=this.nextPageInfo();if(!n)return null;if("params"in n)return n.params;const s=Object.fromEntries(n.url.searchParams);return Object.keys(s).length?s:null}nextPageInfo(){var s;if((s=this.options.query)!=null&&s.before_id){const i=this.first_id;return i?{params:{before_id:i}}:null}const n=this.last_id;return n?{params:{after_id:n}}:null}}class ut{constructor(n){this._client=n}}let xs=class extends ut{retrieve(n,s){return this._client.get(`/v1/models/${n}?beta=true`,s)}list(n={},s){return ot(n)?this.list({},n):this._client.getAPIList("/v1/models?beta=true",Ss,{query:n,...s})}};class Ss extends pr{}xs.BetaModelInfosPage=Ss;class mr{constructor(n,s){this.iterator=n,this.controller=s}async*decoder(){const n=new fn;for await(const s of this.iterator)for(const i of n.decode(s))yield JSON.parse(i);for(const s of n.flush())yield JSON.parse(s)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(n,s){if(!n.body)throw s.abort(),new Q("Attempted to iterate over a response with no body");return new mr(_s(n.body),s)}}let ks=class extends ut{create(n,s){const{betas:i,...c}=n;return this._client.post("/v1/messages/batches?beta=true",{body:c,...s,headers:{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),...s==null?void 0:s.headers}})}retrieve(n,s={},i){if(ot(s))return this.retrieve(n,{},s);const{betas:c}=s;return this._client.get(`/v1/messages/batches/${n}?beta=true`,{...i,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...i==null?void 0:i.headers}})}list(n={},s){if(ot(n))return this.list({},n);const{betas:i,...c}=n;return this._client.getAPIList("/v1/messages/batches?beta=true",Ps,{query:c,...s,headers:{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),...s==null?void 0:s.headers}})}delete(n,s={},i){if(ot(s))return this.delete(n,{},s);const{betas:c}=s;return this._client.delete(`/v1/messages/batches/${n}?beta=true`,{...i,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...i==null?void 0:i.headers}})}cancel(n,s={},i){if(ot(s))return this.cancel(n,{},s);const{betas:c}=s;return this._client.post(`/v1/messages/batches/${n}/cancel?beta=true`,{...i,headers:{"anthropic-beta":[...c??[],"message-batches-2024-09-24"].toString(),...i==null?void 0:i.headers}})}async results(n,s={},i){if(ot(s))return this.results(n,{},s);const c=await this.retrieve(n);if(!c.results_url)throw new Q(`No batch \`results_url\`; Has it finished processing? ${c.processing_status} - ${c.id}`);const{betas:d}=s;return this._client.get(c.results_url,{...i,headers:{"anthropic-beta":[...d??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary",...i==null?void 0:i.headers},__binaryResponse:!0})._thenUnwrap((S,O)=>mr.fromResponse(O.response,O.controller))}};class Ps extends pr{}ks.BetaMessageBatchesPage=Ps;const bo=o=>{let n=0,s=[];for(;n<o.length;){let i=o[n];if(i==="\\"){n++;continue}if(i==="{"){s.push({type:"brace",value:"{"}),n++;continue}if(i==="}"){s.push({type:"brace",value:"}"}),n++;continue}if(i==="["){s.push({type:"paren",value:"["}),n++;continue}if(i==="]"){s.push({type:"paren",value:"]"}),n++;continue}if(i===":"){s.push({type:"separator",value:":"}),n++;continue}if(i===","){s.push({type:"delimiter",value:","}),n++;continue}if(i==='"'){let O="",B=!1;for(i=o[++n];i!=='"';){if(n===o.length){B=!0;break}if(i==="\\"){if(n++,n===o.length){B=!0;break}O+=i+o[n],i=o[++n]}else O+=i,i=o[++n]}i=o[++n],B||s.push({type:"string",value:O});continue}if(i&&/\s/.test(i)){n++;continue}let d=/[0-9]/;if(i&&d.test(i)||i==="-"||i==="."){let O="";for(i==="-"&&(O+=i,i=o[++n]);i&&d.test(i)||i===".";)O+=i,i=o[++n];s.push({type:"number",value:O});continue}let S=/[a-z]/i;if(i&&S.test(i)){let O="";for(;i&&S.test(i)&&n!==o.length;)O+=i,i=o[++n];if(O=="true"||O=="false"||O==="null")s.push({type:"name",value:O});else{n++;continue}continue}n++}return s},Bt=o=>{if(o.length===0)return o;let n=o[o.length-1];switch(n.type){case"separator":return o=o.slice(0,o.length-1),Bt(o);case"number":let s=n.value[n.value.length-1];if(s==="."||s==="-")return o=o.slice(0,o.length-1),Bt(o);case"string":let i=o[o.length-2];if((i==null?void 0:i.type)==="delimiter")return o=o.slice(0,o.length-1),Bt(o);if((i==null?void 0:i.type)==="brace"&&i.value==="{")return o=o.slice(0,o.length-1),Bt(o);break;case"delimiter":return o=o.slice(0,o.length-1),Bt(o)}return o},wo=o=>{let n=[];return o.map(s=>{s.type==="brace"&&(s.value==="{"?n.push("}"):n.splice(n.lastIndexOf("}"),1)),s.type==="paren"&&(s.value==="["?n.push("]"):n.splice(n.lastIndexOf("]"),1))}),n.length>0&&n.reverse().map(s=>{s==="}"?o.push({type:"brace",value:"}"}):s==="]"&&o.push({type:"paren",value:"]"})}),o},_o=o=>{let n="";return o.map(s=>{switch(s.type){case"string":n+='"'+s.value+'"';break;default:n+=s.value;break}}),n},Xi=o=>JSON.parse(_o(wo(Bt(bo(o)))));var ke=function(o,n,s,i,c){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?o!==n||!c:!n.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?c.call(o,s):c?c.value=s:n.set(o,s),s},J=function(o,n,s,i){if(s==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?o!==n||!i:!n.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?i:s==="a"?i.call(o):i?i.value:n.get(o)},qe,it,Zt,Hn,en,tn,Vn,nn,Ge,rn,Jn,zn,Rt,Xn,Gn,as,_i,os,us,cs,ls,xi;const Si="__json_buf";class or{constructor(){qe.add(this),this.messages=[],this.receivedMessages=[],it.set(this,void 0),this.controller=new AbortController,Zt.set(this,void 0),Hn.set(this,()=>{}),en.set(this,()=>{}),tn.set(this,void 0),Vn.set(this,()=>{}),nn.set(this,()=>{}),Ge.set(this,{}),rn.set(this,!1),Jn.set(this,!1),zn.set(this,!1),Rt.set(this,!1),Xn.set(this,void 0),Gn.set(this,void 0),os.set(this,n=>{if(ke(this,Jn,!0,"f"),n instanceof Error&&n.name==="AbortError"&&(n=new $e),n instanceof $e)return ke(this,zn,!0,"f"),this._emit("abort",n);if(n instanceof Q)return this._emit("error",n);if(n instanceof Error){const s=new Q(n.message);return s.cause=n,this._emit("error",s)}return this._emit("error",new Q(String(n)))}),ke(this,Zt,new Promise((n,s)=>{ke(this,Hn,n,"f"),ke(this,en,s,"f")}),"f"),ke(this,tn,new Promise((n,s)=>{ke(this,Vn,n,"f"),ke(this,nn,s,"f")}),"f"),J(this,Zt,"f").catch(()=>{}),J(this,tn,"f").catch(()=>{})}get response(){return J(this,Xn,"f")}get request_id(){return J(this,Gn,"f")}async withResponse(){const n=await J(this,Zt,"f");if(!n)throw new Error("Could not resolve a `Response` object");return{data:this,response:n,request_id:n.headers.get("request-id")}}static fromReadableStream(n){const s=new or;return s._run(()=>s._fromReadableStream(n)),s}static createMessage(n,s,i){const c=new or;for(const d of s.messages)c._addMessageParam(d);return c._run(()=>c._createMessage(n,{...s,stream:!0},{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),c}_run(n){n().then(()=>{this._emitFinal(),this._emit("end")},J(this,os,"f"))}_addMessageParam(n){this.messages.push(n)}_addMessage(n,s=!0){this.receivedMessages.push(n),s&&this._emit("message",n)}async _createMessage(n,s,i){var O;const c=i==null?void 0:i.signal;c&&(c.aborted&&this.controller.abort(),c.addEventListener("abort",()=>this.controller.abort())),J(this,qe,"m",us).call(this);const{response:d,data:S}=await n.create({...s,stream:!0},{...i,signal:this.controller.signal}).withResponse();this._connected(d);for await(const B of S)J(this,qe,"m",cs).call(this,B);if((O=S.controller.signal)!=null&&O.aborted)throw new $e;J(this,qe,"m",ls).call(this)}_connected(n){this.ended||(ke(this,Xn,n,"f"),ke(this,Gn,n==null?void 0:n.headers.get("request-id"),"f"),J(this,Hn,"f").call(this,n),this._emit("connect"))}get ended(){return J(this,rn,"f")}get errored(){return J(this,Jn,"f")}get aborted(){return J(this,zn,"f")}abort(){this.controller.abort()}on(n,s){return(J(this,Ge,"f")[n]||(J(this,Ge,"f")[n]=[])).push({listener:s}),this}off(n,s){const i=J(this,Ge,"f")[n];if(!i)return this;const c=i.findIndex(d=>d.listener===s);return c>=0&&i.splice(c,1),this}once(n,s){return(J(this,Ge,"f")[n]||(J(this,Ge,"f")[n]=[])).push({listener:s,once:!0}),this}emitted(n){return new Promise((s,i)=>{ke(this,Rt,!0,"f"),n!=="error"&&this.once("error",i),this.once(n,s)})}async done(){ke(this,Rt,!0,"f"),await J(this,tn,"f")}get currentMessage(){return J(this,it,"f")}async finalMessage(){return await this.done(),J(this,qe,"m",as).call(this)}async finalText(){return await this.done(),J(this,qe,"m",_i).call(this)}_emit(n,...s){if(J(this,rn,"f"))return;n==="end"&&(ke(this,rn,!0,"f"),J(this,Vn,"f").call(this));const i=J(this,Ge,"f")[n];if(i&&(J(this,Ge,"f")[n]=i.filter(c=>!c.once),i.forEach(({listener:c})=>c(...s))),n==="abort"){const c=s[0];!J(this,Rt,"f")&&!(i!=null&&i.length)&&Promise.reject(c),J(this,en,"f").call(this,c),J(this,nn,"f").call(this,c),this._emit("end");return}if(n==="error"){const c=s[0];!J(this,Rt,"f")&&!(i!=null&&i.length)&&Promise.reject(c),J(this,en,"f").call(this,c),J(this,nn,"f").call(this,c),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",J(this,qe,"m",as).call(this))}async _fromReadableStream(n,s){var d;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),J(this,qe,"m",us).call(this),this._connected(null);const c=Ve.fromReadableStream(n,this.controller);for await(const S of c)J(this,qe,"m",cs).call(this,S);if((d=c.controller.signal)!=null&&d.aborted)throw new $e;J(this,qe,"m",ls).call(this)}[(it=new WeakMap,Zt=new WeakMap,Hn=new WeakMap,en=new WeakMap,tn=new WeakMap,Vn=new WeakMap,nn=new WeakMap,Ge=new WeakMap,rn=new WeakMap,Jn=new WeakMap,zn=new WeakMap,Rt=new WeakMap,Xn=new WeakMap,Gn=new WeakMap,os=new WeakMap,qe=new WeakSet,as=function(){if(this.receivedMessages.length===0)throw new Q("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},_i=function(){if(this.receivedMessages.length===0)throw new Q("stream ended without producing a Message with role=assistant");const s=this.receivedMessages.at(-1).content.filter(i=>i.type==="text").map(i=>i.text);if(s.length===0)throw new Q("stream ended without producing a content block with type=text");return s.join(" ")},us=function(){this.ended||ke(this,it,void 0,"f")},cs=function(s){if(this.ended)return;const i=J(this,qe,"m",xi).call(this,s);switch(this._emit("streamEvent",s,i),s.type){case"content_block_delta":{const c=i.content.at(-1);switch(s.delta.type){case"text_delta":{c.type==="text"&&this._emit("text",s.delta.text,c.text||"");break}case"citations_delta":{c.type==="text"&&this._emit("citation",s.delta.citation,c.citations??[]);break}case"input_json_delta":{c.type==="tool_use"&&c.input&&this._emit("inputJson",s.delta.partial_json,c.input);break}case"thinking_delta":{c.type==="thinking"&&this._emit("thinking",s.delta.thinking,c.thinking);break}case"signature_delta":{c.type==="thinking"&&this._emit("signature",c.signature);break}default:s.delta}break}case"message_stop":{this._addMessageParam(i),this._addMessage(i,!0);break}case"content_block_stop":{this._emit("contentBlock",i.content.at(-1));break}case"message_start":{ke(this,it,i,"f");break}}},ls=function(){if(this.ended)throw new Q("stream has ended, this shouldn't happen");const s=J(this,it,"f");if(!s)throw new Q("request ended without sending any chunks");return ke(this,it,void 0,"f"),s},xi=function(s){let i=J(this,it,"f");if(s.type==="message_start"){if(i)throw new Q(`Unexpected event order, got ${s.type} before receiving "message_stop"`);return s.message}if(!i)throw new Q(`Unexpected event order, got ${s.type} before "message_start"`);switch(s.type){case"message_stop":return i;case"message_delta":return i.stop_reason=s.delta.stop_reason,i.stop_sequence=s.delta.stop_sequence,i.usage.output_tokens=s.usage.output_tokens,i;case"content_block_start":return i.content.push(s.content_block),i;case"content_block_delta":{const c=i.content.at(s.index);switch(s.delta.type){case"text_delta":{(c==null?void 0:c.type)==="text"&&(c.text+=s.delta.text);break}case"citations_delta":{(c==null?void 0:c.type)==="text"&&(c.citations??(c.citations=[]),c.citations.push(s.delta.citation));break}case"input_json_delta":{if((c==null?void 0:c.type)==="tool_use"){let d=c[Si]||"";d+=s.delta.partial_json,Object.defineProperty(c,Si,{value:d,enumerable:!1,writable:!0}),d&&(c.input=Xi(d))}break}case"thinking_delta":{(c==null?void 0:c.type)==="thinking"&&(c.thinking+=s.delta.thinking);break}case"signature_delta":{(c==null?void 0:c.type)==="thinking"&&(c.signature=s.delta.signature);break}default:s.delta}return i}case"content_block_stop":return i}},Symbol.asyncIterator)](){const n=[],s=[];let i=!1;return this.on("streamEvent",c=>{const d=s.shift();d?d.resolve(c):n.push(c)}),this.on("end",()=>{i=!0;for(const c of s)c.resolve(void 0);s.length=0}),this.on("abort",c=>{i=!0;for(const d of s)d.reject(c);s.length=0}),this.on("error",c=>{i=!0;for(const d of s)d.reject(c);s.length=0}),{next:async()=>n.length?{value:n.shift(),done:!1}:i?{value:void 0,done:!0}:new Promise((d,S)=>s.push({resolve:d,reject:S})).then(d=>d?{value:d,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ve(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}const ki={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};let yr=class extends ut{constructor(){super(...arguments),this.batches=new ks(this._client)}create(n,s){const{betas:i,...c}=n;return c.model in ki&&console.warn(`The model '${c.model}' is deprecated and will reach end-of-life on ${ki[c.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages?beta=true",{body:c,timeout:this._client._options.timeout??(c.stream?6e5:this._client._calculateNonstreamingTimeout(c.max_tokens)),...s,headers:{...(i==null?void 0:i.toString())!=null?{"anthropic-beta":i==null?void 0:i.toString()}:void 0,...s==null?void 0:s.headers},stream:n.stream??!1})}stream(n,s){return or.createMessage(this,n,s)}countTokens(n,s){const{betas:i,...c}=n;return this._client.post("/v1/messages/count_tokens?beta=true",{body:c,...s,headers:{"anthropic-beta":[...i??[],"token-counting-2024-11-01"].toString(),...s==null?void 0:s.headers}})}};yr.Batches=ks;yr.BetaMessageBatchesPage=Ps;class hn extends ut{constructor(){super(...arguments),this.models=new xs(this._client),this.messages=new yr(this._client)}}hn.Models=xs;hn.BetaModelInfosPage=Ss;hn.Messages=yr;class Gi extends ut{create(n,s){return this._client.post("/v1/complete",{body:n,timeout:this._client._options.timeout??6e5,...s,stream:n.stream??!1})}}class As extends ut{create(n,s){return this._client.post("/v1/messages/batches",{body:n,...s})}retrieve(n,s){return this._client.get(`/v1/messages/batches/${n}`,s)}list(n={},s){return ot(n)?this.list({},n):this._client.getAPIList("/v1/messages/batches",Es,{query:n,...s})}delete(n,s){return this._client.delete(`/v1/messages/batches/${n}`,s)}cancel(n,s){return this._client.post(`/v1/messages/batches/${n}/cancel`,s)}async results(n,s){const i=await this.retrieve(n);if(!i.results_url)throw new Q(`No batch \`results_url\`; Has it finished processing? ${i.processing_status} - ${i.id}`);return this._client.get(i.results_url,{...s,headers:{Accept:"application/binary",...s==null?void 0:s.headers},__binaryResponse:!0})._thenUnwrap((c,d)=>mr.fromResponse(d.response,d.controller))}}class Es extends pr{}As.MessageBatchesPage=Es;var Pe=function(o,n,s,i,c){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!c)throw new TypeError("Private accessor was defined without a setter");if(typeof n=="function"?o!==n||!c:!n.has(o))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?c.call(o,s):c?c.value=s:n.set(o,s),s},z=function(o,n,s,i){if(s==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof n=="function"?o!==n||!i:!n.has(o))throw new TypeError("Cannot read private member from an object whose class did not declare it");return s==="m"?i:s==="a"?i.call(o):i?i.value:n.get(o)},Ne,at,sn,Yn,an,on,Qn,un,Ye,cn,Zn,er,Dt,tr,nr,fs,Pi,hs,ds,ps,ms,Ai;const Ei="__json_buf";class ur{constructor(){Ne.add(this),this.messages=[],this.receivedMessages=[],at.set(this,void 0),this.controller=new AbortController,sn.set(this,void 0),Yn.set(this,()=>{}),an.set(this,()=>{}),on.set(this,void 0),Qn.set(this,()=>{}),un.set(this,()=>{}),Ye.set(this,{}),cn.set(this,!1),Zn.set(this,!1),er.set(this,!1),Dt.set(this,!1),tr.set(this,void 0),nr.set(this,void 0),hs.set(this,n=>{if(Pe(this,Zn,!0,"f"),n instanceof Error&&n.name==="AbortError"&&(n=new $e),n instanceof $e)return Pe(this,er,!0,"f"),this._emit("abort",n);if(n instanceof Q)return this._emit("error",n);if(n instanceof Error){const s=new Q(n.message);return s.cause=n,this._emit("error",s)}return this._emit("error",new Q(String(n)))}),Pe(this,sn,new Promise((n,s)=>{Pe(this,Yn,n,"f"),Pe(this,an,s,"f")}),"f"),Pe(this,on,new Promise((n,s)=>{Pe(this,Qn,n,"f"),Pe(this,un,s,"f")}),"f"),z(this,sn,"f").catch(()=>{}),z(this,on,"f").catch(()=>{})}get response(){return z(this,tr,"f")}get request_id(){return z(this,nr,"f")}async withResponse(){const n=await z(this,sn,"f");if(!n)throw new Error("Could not resolve a `Response` object");return{data:this,response:n,request_id:n.headers.get("request-id")}}static fromReadableStream(n){const s=new ur;return s._run(()=>s._fromReadableStream(n)),s}static createMessage(n,s,i){const c=new ur;for(const d of s.messages)c._addMessageParam(d);return c._run(()=>c._createMessage(n,{...s,stream:!0},{...i,headers:{...i==null?void 0:i.headers,"X-Stainless-Helper-Method":"stream"}})),c}_run(n){n().then(()=>{this._emitFinal(),this._emit("end")},z(this,hs,"f"))}_addMessageParam(n){this.messages.push(n)}_addMessage(n,s=!0){this.receivedMessages.push(n),s&&this._emit("message",n)}async _createMessage(n,s,i){var O;const c=i==null?void 0:i.signal;c&&(c.aborted&&this.controller.abort(),c.addEventListener("abort",()=>this.controller.abort())),z(this,Ne,"m",ds).call(this);const{response:d,data:S}=await n.create({...s,stream:!0},{...i,signal:this.controller.signal}).withResponse();this._connected(d);for await(const B of S)z(this,Ne,"m",ps).call(this,B);if((O=S.controller.signal)!=null&&O.aborted)throw new $e;z(this,Ne,"m",ms).call(this)}_connected(n){this.ended||(Pe(this,tr,n,"f"),Pe(this,nr,n==null?void 0:n.headers.get("request-id"),"f"),z(this,Yn,"f").call(this,n),this._emit("connect"))}get ended(){return z(this,cn,"f")}get errored(){return z(this,Zn,"f")}get aborted(){return z(this,er,"f")}abort(){this.controller.abort()}on(n,s){return(z(this,Ye,"f")[n]||(z(this,Ye,"f")[n]=[])).push({listener:s}),this}off(n,s){const i=z(this,Ye,"f")[n];if(!i)return this;const c=i.findIndex(d=>d.listener===s);return c>=0&&i.splice(c,1),this}once(n,s){return(z(this,Ye,"f")[n]||(z(this,Ye,"f")[n]=[])).push({listener:s,once:!0}),this}emitted(n){return new Promise((s,i)=>{Pe(this,Dt,!0,"f"),n!=="error"&&this.once("error",i),this.once(n,s)})}async done(){Pe(this,Dt,!0,"f"),await z(this,on,"f")}get currentMessage(){return z(this,at,"f")}async finalMessage(){return await this.done(),z(this,Ne,"m",fs).call(this)}async finalText(){return await this.done(),z(this,Ne,"m",Pi).call(this)}_emit(n,...s){if(z(this,cn,"f"))return;n==="end"&&(Pe(this,cn,!0,"f"),z(this,Qn,"f").call(this));const i=z(this,Ye,"f")[n];if(i&&(z(this,Ye,"f")[n]=i.filter(c=>!c.once),i.forEach(({listener:c})=>c(...s))),n==="abort"){const c=s[0];!z(this,Dt,"f")&&!(i!=null&&i.length)&&Promise.reject(c),z(this,an,"f").call(this,c),z(this,un,"f").call(this,c),this._emit("end");return}if(n==="error"){const c=s[0];!z(this,Dt,"f")&&!(i!=null&&i.length)&&Promise.reject(c),z(this,an,"f").call(this,c),z(this,un,"f").call(this,c),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",z(this,Ne,"m",fs).call(this))}async _fromReadableStream(n,s){var d;const i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),z(this,Ne,"m",ds).call(this),this._connected(null);const c=Ve.fromReadableStream(n,this.controller);for await(const S of c)z(this,Ne,"m",ps).call(this,S);if((d=c.controller.signal)!=null&&d.aborted)throw new $e;z(this,Ne,"m",ms).call(this)}[(at=new WeakMap,sn=new WeakMap,Yn=new WeakMap,an=new WeakMap,on=new WeakMap,Qn=new WeakMap,un=new WeakMap,Ye=new WeakMap,cn=new WeakMap,Zn=new WeakMap,er=new WeakMap,Dt=new WeakMap,tr=new WeakMap,nr=new WeakMap,hs=new WeakMap,Ne=new WeakSet,fs=function(){if(this.receivedMessages.length===0)throw new Q("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Pi=function(){if(this.receivedMessages.length===0)throw new Q("stream ended without producing a Message with role=assistant");const s=this.receivedMessages.at(-1).content.filter(i=>i.type==="text").map(i=>i.text);if(s.length===0)throw new Q("stream ended without producing a content block with type=text");return s.join(" ")},ds=function(){this.ended||Pe(this,at,void 0,"f")},ps=function(s){if(this.ended)return;const i=z(this,Ne,"m",Ai).call(this,s);switch(this._emit("streamEvent",s,i),s.type){case"content_block_delta":{const c=i.content.at(-1);switch(s.delta.type){case"text_delta":{c.type==="text"&&this._emit("text",s.delta.text,c.text||"");break}case"citations_delta":{c.type==="text"&&this._emit("citation",s.delta.citation,c.citations??[]);break}case"input_json_delta":{c.type==="tool_use"&&c.input&&this._emit("inputJson",s.delta.partial_json,c.input);break}case"thinking_delta":{c.type==="thinking"&&this._emit("thinking",s.delta.thinking,c.thinking);break}case"signature_delta":{c.type==="thinking"&&this._emit("signature",c.signature);break}default:s.delta}break}case"message_stop":{this._addMessageParam(i),this._addMessage(i,!0);break}case"content_block_stop":{this._emit("contentBlock",i.content.at(-1));break}case"message_start":{Pe(this,at,i,"f");break}}},ms=function(){if(this.ended)throw new Q("stream has ended, this shouldn't happen");const s=z(this,at,"f");if(!s)throw new Q("request ended without sending any chunks");return Pe(this,at,void 0,"f"),s},Ai=function(s){let i=z(this,at,"f");if(s.type==="message_start"){if(i)throw new Q(`Unexpected event order, got ${s.type} before receiving "message_stop"`);return s.message}if(!i)throw new Q(`Unexpected event order, got ${s.type} before "message_start"`);switch(s.type){case"message_stop":return i;case"message_delta":return i.stop_reason=s.delta.stop_reason,i.stop_sequence=s.delta.stop_sequence,i.usage.output_tokens=s.usage.output_tokens,i;case"content_block_start":return i.content.push(s.content_block),i;case"content_block_delta":{const c=i.content.at(s.index);switch(s.delta.type){case"text_delta":{(c==null?void 0:c.type)==="text"&&(c.text+=s.delta.text);break}case"citations_delta":{(c==null?void 0:c.type)==="text"&&(c.citations??(c.citations=[]),c.citations.push(s.delta.citation));break}case"input_json_delta":{if((c==null?void 0:c.type)==="tool_use"){let d=c[Ei]||"";d+=s.delta.partial_json,Object.defineProperty(c,Ei,{value:d,enumerable:!1,writable:!0}),d&&(c.input=Xi(d))}break}case"thinking_delta":{(c==null?void 0:c.type)==="thinking"&&(c.thinking+=s.delta.thinking);break}case"signature_delta":{(c==null?void 0:c.type)==="thinking"&&(c.signature=s.delta.signature);break}default:s.delta}return i}case"content_block_stop":return i}},Symbol.asyncIterator)](){const n=[],s=[];let i=!1;return this.on("streamEvent",c=>{const d=s.shift();d?d.resolve(c):n.push(c)}),this.on("end",()=>{i=!0;for(const c of s)c.resolve(void 0);s.length=0}),this.on("abort",c=>{i=!0;for(const d of s)d.reject(c);s.length=0}),this.on("error",c=>{i=!0;for(const d of s)d.reject(c);s.length=0}),{next:async()=>n.length?{value:n.shift(),done:!1}:i?{value:void 0,done:!0}:new Promise((d,S)=>s.push({resolve:d,reject:S})).then(d=>d?{value:d,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ve(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}class gr extends ut{constructor(){super(...arguments),this.batches=new As(this._client)}create(n,s){return n.model in Oi&&console.warn(`The model '${n.model}' is deprecated and will reach end-of-life on ${Oi[n.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`),this._client.post("/v1/messages",{body:n,timeout:this._client._options.timeout??(n.stream?6e5:this._client._calculateNonstreamingTimeout(n.max_tokens)),...s,stream:n.stream??!1})}stream(n,s){return ur.createMessage(this,n,s)}countTokens(n,s){return this._client.post("/v1/messages/count_tokens",{body:n,...s})}}const Oi={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025"};gr.Batches=As;gr.MessageBatchesPage=Es;class Os extends ut{retrieve(n,s){return this._client.get(`/v1/models/${n}`,s)}list(n={},s){return ot(n)?this.list({},n):this._client.getAPIList("/v1/models",Ms,{query:n,...s})}}class Ms extends pr{}Os.ModelInfosPage=Ms;var Yi;class ne extends so{constructor({baseURL:n=is("ANTHROPIC_BASE_URL"),apiKey:s=is("ANTHROPIC_API_KEY")??null,authToken:i=is("ANTHROPIC_AUTH_TOKEN")??null,...c}={}){const d={apiKey:s,authToken:i,...c,baseURL:n||"https://api.anthropic.com"};if(!d.dangerouslyAllowBrowser&&go())throw new Q(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Anthropic({ apiKey, dangerouslyAllowBrowser: true });
`);super({baseURL:d.baseURL,timeout:d.timeout??6e5,httpAgent:d.httpAgent,maxRetries:d.maxRetries,fetch:d.fetch}),this.completions=new Gi(this),this.messages=new gr(this),this.models=new Os(this),this.beta=new hn(this),this._options=d,this.apiKey=s,this.authToken=i}defaultQuery(){return this._options.defaultQuery}defaultHeaders(n){return{...super.defaultHeaders(n),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(n,s){if(!(this.apiKey&&n["x-api-key"])&&s["x-api-key"]!==null&&!(this.authToken&&n.authorization)&&s.authorization!==null)throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(n){const s=this.apiKeyAuth(n),i=this.bearerAuth(n);return s!=null&&!ar(s)?s:i!=null&&!ar(i)?i:{}}apiKeyAuth(n){return this.apiKey==null?{}:{"X-Api-Key":this.apiKey}}bearerAuth(n){return this.authToken==null?{}:{Authorization:`Bearer ${this.authToken}`}}}Yi=ne;ne.Anthropic=Yi;ne.HUMAN_PROMPT=`

Human:`;ne.AI_PROMPT=`

Assistant:`;ne.DEFAULT_TIMEOUT=6e5;ne.AnthropicError=Q;ne.APIError=Ae;ne.APIConnectionError=fr;ne.APIConnectionTimeoutError=Ki;ne.APIUserAbortError=$e;ne.NotFoundError=Fi;ne.ConflictError=$i;ne.RateLimitError=Li;ne.BadRequestError=Ci;ne.AuthenticationError=qi;ne.InternalServerError=Wi;ne.PermissionDeniedError=Ni;ne.UnprocessableEntityError=Ui;ne.toFile=Ya;ne.fileFromPath=Bi;ne.Completions=Gi;ne.Messages=gr;ne.Models=Os;ne.ModelInfosPage=Ms;ne.Beta=hn;const{HUMAN_PROMPT:pu,AI_PROMPT:mu}=ne,xo=[{id:"claude-3-7-sonnet-20250219",name:"Claude 3.7 Sonnet",provider:"anthropic",description:"Latest and most capable model",isLocal:!1,maxTokens:2e5,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!0},{id:"claude-3-haiku-20240307",name:"Claude 3 Haiku",provider:"anthropic",description:"Fastest model for quick responses",isLocal:!1,maxTokens:1e5,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!1}];function So(o){return o.split(",")[1]}function ko(o){const n=o.match(/^data:([^;]+);base64,/);return n?n[1]:"application/octet-stream"}function Po(o){const n=o.filter(d=>d.role==="system"),s=n.length>0?n.map(d=>d.content).join(`

`):void 0;return{messages:o.filter(d=>d.role==="user"||d.role==="assistant").map(d=>{if(!d.media||d.media.length===0)return{role:d.role,content:d.content};const S=[];return d.content.trim()&&S.push({type:"text",text:d.content}),d.media.forEach(O=>{O.type==="image"&&O.preview&&S.push({type:"image",source:{type:"base64",media_type:ko(O.preview),data:So(O.preview)}})}),{role:d.role,content:S}}),systemPrompt:s}}function Ao(){const n=cr(lr).apiKeys.anthropic;if(!n)throw new Error("Anthropic API key not found. Please add your API key in Settings.");return n}async function yu(o,n,s,i,c,d){var S,O,B,q;try{const H=Ao(),{messages:F,systemPrompt:L}=Po(n);console.log("Sending request to Anthropic API with model:",o);try{console.log("Attempting to use Anthropic SDK..."),await Eo(H,o,F,L,s,i,c,d);return}catch(ee){console.error("Error using Anthropic SDK, falling back to fetch:",ee)}const V=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"content-type":"application/json","x-api-key":H,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:o,messages:F,system:L,dangerouslyAllowBrowser:"true",stream:!0,temperature:.7,max_tokens:4e3})});if(!V.ok){let ee=`Status code: ${V.status}`;try{ee=((S=(await V.json()).error)==null?void 0:S.message)||ee}catch{ee=V.statusText||ee}throw new Error(`Anthropic API error: ${ee}`)}const ae=(O=V.body)==null?void 0:O.getReader();if(!ae)throw new Error("Failed to get response reader");const de=new TextDecoder("utf-8");let we="",re="";for(;;){const{done:ee,value:ge}=await ae.read();if(ee)break;we+=de.decode(ge,{stream:!0});const pe=we.split(`
`);we=pe.pop()||"";for(const Je of pe){const ue=Je.trim();if(!(!ue||ue==="data: [DONE]"))try{const se=ue.replace(/^data: /,"");if(se==="")continue;const Ee=JSON.parse(se);if(Ee.type==="thinking"&&d&&((B=Ee.delta)!=null&&B.text)){d(Ee.delta.text);continue}if(Ee.type==="content_block_delta"&&((q=Ee.delta)!=null&&q.text)&&(re+=Ee.delta.text,s(re)),Ee.type==="message_stop")return i(),re}catch(se){console.warn("Error parsing chunk:",se)}}}return i(),re}catch(H){throw c(H instanceof Error?H:new Error(String(H))),H}}async function Eo(o,n,s,i,c,d,S,O){try{const B=new ne({apiKey:o,dangerouslyAllowBrowser:!0}),q=s.map(L=>({role:L.role,content:typeof L.content=="string"?L.content:L.content.filter(V=>V.type==="text").map(V=>V.text||"").join(`
`)}));console.log("Using Anthropic SDK with model:",n);const H=await B.messages.create({model:n,max_tokens:1024,messages:[{role:"user",content:"Hello, Claude"}],system:i,stream:!0});let F="";for await(const L of H)if(L.type==="content_block_delta"&&"text"in L.delta&&(F+=L.delta.text,c(F)),L.type==="message_stop")return d(),F;return d(),F}catch(B){throw console.error("Error using Anthropic SDK:",B),B}}const Oo=[{id:"gpt-4o",name:"GPT-4o",provider:"openai",description:"Most capable model for a wide range of tasks",isLocal:!1,maxTokens:8192,supportsStreaming:!0,supportsFiles:!0},{id:"gpt-4-turbo",name:"GPT-4 Turbo",provider:"openai",description:"Improved version of GPT-4",isLocal:!1,maxTokens:4096,supportsStreaming:!0,supportsFiles:!0},{id:"gpt-3.5-turbo",name:"GPT-3.5 Turbo",provider:"openai",description:"Fast and efficient for most tasks",isLocal:!1,maxTokens:4096,supportsStreaming:!0,supportsFiles:!0}];function Qi(o){return o.map(n=>{if(!n.media||n.media.length===0)return{role:n.role,content:n.content};const s=[];return n.content.trim()&&s.push({type:"text",text:n.content}),n.media.forEach(i=>{if(console.log(`Processing media item for OpenAI: ${i.type} ${i.name}`),i.type==="image"&&i.preview)s.push({type:"image_url",image_url:{url:i.preview,detail:"auto"}}),console.log(`Added image to OpenAI message: ${i.name}`);else if(i.type==="document")if(i.fileId)s.push({type:"text",text:`I've analyzed the document: ${i.name}. The file has been processed.`}),console.log(`Referenced uploaded document in message: ${i.name} (file ID: ${i.fileId})`);else if(i.preview)try{const c=i.preview.match(/^data:([^;]+);base64,/),d=c?c[1]:"application/octet-stream";console.log(`Processing document: ${i.name}, MIME type: ${d}`),d.startsWith("image/")?(s.push({type:"image_url",image_url:{url:i.preview,detail:"high"}}),console.log(`Added document with image MIME type to OpenAI message: ${i.name}`)):(console.warn(`Document type ${d} not supported via chat API: ${i.name}`),s.push({type:"text",text:`[Note: I attempted to analyze your document "${i.name}" but couldn't process it directly in the chat. For better document support, please try uploading it again.]`}))}catch(c){console.error(`Error processing document ${i.name}:`,c),s.push({type:"text",text:`[Error: Could not process document "${i.name}" due to technical error]`})}else console.log(`Document ${i.name} has no preview or fileId, cannot send to OpenAI`);else console.log(`Unsupported media type: ${i.type} for ${i.name}`)}),s.length===0?{role:n.role,content:n.content||"I've attached some files, but they couldn't be processed."}:{role:n.role,content:s}})}function Mo(){try{const o=cr(lr);if(console.log("Retrieving OpenAI API key from settings store"),!o||!o.apiKeys)throw console.error("Settings or apiKeys object is undefined:",o),new Error("OpenAI API key not found. Settings store may not be initialized properly.");const n=o.apiKeys.openai;if(!n)throw console.error("OpenAI API key is empty or undefined"),new Error("OpenAI API key not found. Please add your API key in Settings.");if(console.log("FULL API KEY FROM SETTINGS: ",n),!n.startsWith("sk-")||n.length<20)throw console.error("Invalid OpenAI API key format"),new Error('Invalid OpenAI API key format. Keys should start with "sk-" and be at least 20 characters long.');return console.log(`Retrieved OpenAI API key (length: ${n.length}, starts with: ${n.substring(0,4)}...)`),n}catch(o){throw console.error("Error retrieving OpenAI API key:",o),o}}async function Is(o=3,n=500){let s=0;for(;s<o;)try{return Mo()}catch(i){if(console.warn(`Failed to get API key (attempt ${s+1}/${o}):`,i),s===o-1)throw i;await new Promise(c=>setTimeout(c,n)),s++}throw new Error("Failed to retrieve API key after multiple attempts")}async function gu(o,n,s,i,c){var d,S,O,B;try{const q=await Is();console.log("SECURITY WARNING: Printing full API key for debugging: ",q),console.log("EXACT KEY SENT TO OPENAI: ",q),console.log(`Key format check: length=${q.length}, starts with=${q.substring(0,4)}, contains "sk-"=${q.includes("sk-")}`);const H=[...q.substring(0,10)].map(ee=>ee.charCodeAt(0));console.log(`First 10 character codes: ${H.join(", ")}`);const F=`Bearer ${q.trim()}`;console.log(`Authorization header format: Bearer ${q.trim()}`);const L=Qi(n),V=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:F},body:JSON.stringify({model:o,messages:L,stream:!0,temperature:.7})});if(!V.ok){const ee=await V.text();let ge=`OpenAI API error (${V.status}): ${V.statusText}`;try{const pe=JSON.parse(ee);pe.error&&(V.status===401?ge="Authentication error with OpenAI. Please check your API key in Settings.":pe.error.message&&(ge=`OpenAI API error: ${pe.error.message}`))}catch{V.status===401?ge="Authentication error with OpenAI. Please check your API key in Settings.":ee&&(ge=`OpenAI API error: ${ee}`)}throw new Error(ge)}const ae=(d=V.body)==null?void 0:d.getReader();if(!ae)throw new Error("Failed to get response reader");const de=new TextDecoder("utf-8");let we="",re="";for(;;){const{done:ee,value:ge}=await ae.read();if(ee)break;we+=de.decode(ge,{stream:!0});const pe=we.split(`
`);we=pe.pop()||"";for(const Je of pe){const ue=Je.trim();if(!(!ue||ue==="data: [DONE]"))try{const se=ue.replace(/^data: /,""),Ee=JSON.parse(se),Te=(O=(S=Ee.choices[0])==null?void 0:S.delta)==null?void 0:O.content;if(Te&&(re+=Te,s(re)),(B=Ee.choices[0])!=null&&B.finish_reason)return i(),re}catch(se){console.warn("Error parsing chunk:",se)}}}return i(),re}catch(q){throw console.error("OpenAI stream completion error:",q),c(q instanceof Error?q:new Error(String(q))),q}}async function vu(o,n){var s,i;try{const c=await Is();console.log(`Processing ${n.length} messages for OpenAI non-streaming completion`),n.some(F=>F.media&&F.media.length>0)&&console.log("Messages contain media - ensuring proper conversion");const S=`Bearer ${c.trim()}`,O=Qi(n),B=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:S},body:JSON.stringify({model:o,messages:O,stream:!1,temperature:.7})});if(!B.ok){const F=await B.text();let L=`OpenAI API error (${B.status}): ${B.statusText}`;try{const V=JSON.parse(F);V.error&&(B.status===401?L="Authentication error with OpenAI. Please check your API key in Settings.":V.error.message&&(L=`OpenAI API error: ${V.error.message}`))}catch{B.status===401?L="Authentication error with OpenAI. Please check your API key in Settings.":F&&(L=`OpenAI API error: ${F}`)}throw new Error(L)}const H=(i=(s=(await B.json()).choices[0])==null?void 0:s.message)==null?void 0:i.content;return typeof H=="string"?H:Array.isArray(H)?H.filter(F=>F.type==="text"&&F.text).map(F=>F.text).join(`

`):""}catch(c){throw console.error("OpenAI completion error:",c),c}}async function bu(o){try{const n=await Is(),s=new FormData;s.append("file",o),s.append("purpose","assistants"),console.log(`Uploading file to OpenAI: ${o.name}, type: ${o.type}, size: ${o.size} bytes`);const i=await fetch("https://api.openai.com/v1/files",{method:"POST",headers:{Authorization:`Bearer ${n.trim()}`},body:s});if(!i.ok){const d=await i.text();let S=`OpenAI API error (${i.status}): ${i.statusText}`;try{const O=JSON.parse(d);O.error&&O.error.message&&(S=`OpenAI API error: ${O.error.message}`)}catch{d&&(S=`OpenAI API error: ${d}`)}throw new Error(S)}const c=await i.json();return console.log(`File uploaded successfully to OpenAI: ${c.id}`),c.id}catch(n){throw console.error("Error uploading file to OpenAI:",n),n}}const be=[];for(let o=0;o<256;++o)be.push((o+256).toString(16).slice(1));function Io(o,n=0){return(be[o[n+0]]+be[o[n+1]]+be[o[n+2]]+be[o[n+3]]+"-"+be[o[n+4]]+be[o[n+5]]+"-"+be[o[n+6]]+be[o[n+7]]+"-"+be[o[n+8]]+be[o[n+9]]+"-"+be[o[n+10]]+be[o[n+11]]+be[o[n+12]]+be[o[n+13]]+be[o[n+14]]+be[o[n+15]]).toLowerCase()}let ys;const To=new Uint8Array(16);function Ro(){if(!ys){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ys=crypto.getRandomValues.bind(crypto)}return ys(To)}const Do=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Mi={randomUUID:Do};function jo(o,n,s){var c;if(Mi.randomUUID&&!o)return Mi.randomUUID();o=o||{};const i=o.random??((c=o.rng)==null?void 0:c.call(o))??Ro();if(i.length<16)throw new Error("Random bytes length must be >= 16");return i[6]=i[6]&15|64,i[8]=i[8]&63|128,Io(i)}const Zi=[{id:"gemini-2.0-flash-exp",name:"Gemini 2.0 Flash",provider:"google",description:"Fast and efficient model with enhanced thinking capabilities",isLocal:!1,maxTokens:32768,supportsStreaming:!0,supportsFiles:!0,supportsThinking:!0,supportsMultimodal:!0,supportsImageGeneration:!0}];function Bo(o){return o.split(",")[1]}function Ko(o,n){return`data:${n};base64,${o}`}function Co(o){const n=o.match(/^data:([^;]+);base64,/);return n?n[1]:"application/octet-stream"}function qo(o){return o.map(n=>{const s=[];return n.content.trim()&&s.push({text:n.content}),n.media&&n.media.length>0&&n.media.forEach(i=>{i.type==="image"&&i.preview&&s.push({inlineData:{mimeType:Co(i.preview),data:Bo(i.preview)}})}),s.length>0?{role:n.role==="assistant"?"model":"user",parts:s}:null}).filter(n=>n!==null)}function Ii(o){const n=o.mimeType.startsWith("image/")?"image":"document",s=Ko(o.data,o.mimeType);return{id:jo(),type:n,name:`${n}_${new Date().getTime()}`,preview:s,timestamp:Date.now(),size:o.data.length*.75}}function No(){const n=cr(lr).apiKeys.google;if(!n)throw new Error("Google API key not found. Please add your API key in Settings.");return n}function Fo(o){if(o!=null&&o.error){const n=o.error;let s=n.message||"Unknown Google API error";if(n.code&&(s=`[${n.code}] ${s}`),n.details&&n.details.length>0){const i=n.details.filter(c=>c["@type"]&&c["@type"].includes("BadRequest")).flatMap(c=>c.fieldViolations||[]).map(c=>`- ${c.field}: ${c.description}`).join(`
`);i&&(s+=`

Details:
`+i)}return s}return o instanceof Error?o.message:String(o)}async function wu(o,n,s,i,c,d){var S,O,B,q,H,F,L,V,ae,de,we;try{const re=No(),ee=qo(n);console.log("Using model:",o),o!=="gemini-2.0-flash-exp"&&console.warn("Warning: Expected to use gemini-2.0-flash-exp but got:",o),console.log("Sending request to Google Gemini API with model:",o),console.log("Messages after conversion:",JSON.stringify(ee,null,2));const ge=n.some(Re=>{const le=Re.content.toLowerCase();return Re.role==="user"&&(le.includes("generate an image")||le.includes("create an image")||le.includes("draw")||le.includes("picture of")||le.includes("image of"))}),pe={contents:ee,generationConfig:{temperature:.7,maxOutputTokens:2048,responseModalities:ge?["TEXT","IMAGE"]:["TEXT"]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}]},Je=`https://generativelanguage.googleapis.com/v1beta/models/${o}:streamGenerateContent?key=${re}`;console.log("API URL (without key):",Je.replace(re,"API_KEY_HIDDEN"));const ue=await fetch(Je,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(pe)});if(!ue.ok){let Re;try{Re=await ue.json()}catch{throw new Error(`Google API error: ${ue.statusText||ue.status}`)}const le=Fo(Re);throw ge&&le.includes("responseModalities")?new Error(`Failed to generate image: The model doesn't support the requested image generation features.

API Error: ${le}`):le.includes("rate limit")?new Error(`Rate limit exceeded: Please try again later or reduce the frequency of requests.

API Error: ${le}`):new Error(`Google API error: ${le}`)}const se=(S=ue.body)==null?void 0:S.getReader();if(!se)throw new Error("Failed to get response reader");const Ee=new TextDecoder("utf-8");let Te="",Ue="",ct=[];for(console.log("Starting to read the stream...");;){const{done:Re,value:le}=await se.read();if(Re){console.log("Stream reading complete");break}const qt=Ee.decode(le,{stream:!0});console.log("Received chunk length:",qt.length),Te+=qt;let lt=!1,Me=null;try{Me=JSON.parse(Te),lt=!0,console.log("Successfully parsed complete JSON"),Te=""}catch{if(console.log("Failed to parse complete buffer, looking for array content"),Te.trim().startsWith("[")){console.log("Buffer starts with array indicator [");try{const ce=Te.lastIndexOf("]");if(ce>0){const Ie=Te.substring(0,ce+1);try{Me=JSON.parse(Ie),lt=!0,console.log("Successfully parsed array portion"),Te=Te.substring(ce+1)}catch{console.log("Failed to parse array portion")}}}catch(ce){console.log("Error handling array:",ce)}}}if(lt&&Me)if(console.log("Processing valid JSON data"),Array.isArray(Me))for(const De of Me){if(De.error){const ce=`Google API error: ${De.error.message||"Unknown error"}`;return console.error(ce),c(new Error(ce)),""}if((q=(B=(O=De.candidates)==null?void 0:O[0])==null?void 0:B.content)!=null&&q.parts){const ce=De.candidates[0].content.parts;let Ie="";const ve=[];for(const Fe of ce)if(Fe.text)Ie+=Fe.text;else if(Fe.inlineData){const dn=Ii(Fe.inlineData);ve.push(dn),ct.push(dn)}Ie&&(Ue+=Ie),s(Ue,ct)}if(((F=(H=De.candidates)==null?void 0:H[0])==null?void 0:F.finishReason)==="STOP")return console.log("Received completion signal (STOP) in array"),i(),Ue}else{if(Me.error){const De=`Google API error: ${Me.error.message||"Unknown error"}`;return console.error(De),c(new Error(De)),""}if((ae=(V=(L=Me.candidates)==null?void 0:L[0])==null?void 0:V.content)!=null&&ae.parts){const De=Me.candidates[0].content.parts;let ce="";const Ie=[];for(const ve of De)if(ve.text)ce+=ve.text;else if(ve.inlineData){const Fe=Ii(ve.inlineData);Ie.push(Fe),ct.push(Fe)}ce&&(Ue+=ce),s(Ue,ct)}if(((we=(de=Me.candidates)==null?void 0:de[0])==null?void 0:we.finishReason)==="STOP")return console.log("Received completion signal (STOP) in single object"),i(),Ue}}return i(),Ue}catch(re){throw c(re instanceof Error?re:new Error(String(re))),re}}function ea(){const n=cr(lr).apiKeys.ollamaHost||"http://localhost:11434";return n.endsWith("/")?n.slice(0,-1):n}async function $o(){try{const o=ea(),n=await fetch(`${o}/api/tags`);if(!n.ok)throw new Error(`Failed to fetch Ollama models: ${n.statusText}`);return(await n.json()).models.map(i=>({id:i.name,name:Uo(i.name),provider:"ollama",description:Lo(i),isLocal:!0,maxTokens:4096,supportsStreaming:!0,supportsFiles:!1}))}catch(o){return console.error("Error fetching Ollama models:",o),[]}}function Uo(o){let n=o.split(":")[0];return n=n.split("-").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "),n}function Lo(o){const n=o.details;return n&&n.parameter_size?`${n.family||"Open source"} model (${n.parameter_size})`:"Local LLM model"}function Wo(o){let n="";for(const s of o)s.role==="system"?n+=`SYSTEM: ${s.content}

`:s.role==="user"?n+=`USER: ${s.content}

`:s.role==="assistant"&&(n+=`ASSISTANT: ${s.content}

`);return n+="ASSISTANT: ",n}async function _u(o,n,s,i,c){var d;try{const S=ea(),O=Wo(n),B=await fetch(`${S}/api/generate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:o,prompt:O,stream:!0,options:{temperature:.7}})});if(!B.ok){const L=await B.text();throw new Error(`Ollama API error: ${L||B.statusText}`)}const q=(d=B.body)==null?void 0:d.getReader();if(!q)throw new Error("Failed to get response reader");const H=new TextDecoder("utf-8");let F="";for(;;){const{done:L,value:V}=await q.read();if(L)break;const de=H.decode(V,{stream:!0}).split(`
`);for(const we of de)if(we.trim())try{const re=JSON.parse(we);if(re.response&&(F+=re.response,s(F)),re.done)return i(),F}catch(re){console.warn("Error parsing Ollama chunk:",re)}}return i(),F}catch(S){throw c(S instanceof Error?S:new Error(String(S))),S}}const Ts=[...xo,...Oo,...Zi],ta=Ti([]),xu=Da(ta,o=>[...Ts,...o]);let Ho=[],Vo=[...Ts];const Jo=Zi[0];async function Su(){try{const o=await $o();return Ho=o,ta.set(o),Vo=[...Ts,...o],o}catch(o){return console.error("Failed to initialize models:",o),[]}}class zo extends ir{constructor(){super("gervaisDB"),this.version(1).stores({chats:"id, title, updatedAt, createdAt",messages:"id, chatId, role, timestamp",mediaItems:"id, messageId, type, timestamp",settings:"id"}),this.chats.mapToClass(Xo)}async initialize(){{try{const s=await this.settings.get("user-settings");if(s){console.log("Found existing settings in IndexedDB:",s);return}const i=localStorage.getItem("settings");if(i)try{const c=JSON.parse(i);await this.settings.put({...c,id:"user-settings"}),console.log("Settings migrated from localStorage to IndexedDB:",c)}catch(c){console.error("Failed to migrate settings:",c)}else{const c={id:"user-settings",apiKeys:{anthropic:"",openai:"",google:"",ollamaHost:"http://localhost:11434",localHost:"http://localhost:8000"},theme:"system",videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1};await this.settings.put(c),console.log("Created default settings in IndexedDB:",c)}}catch(s){console.error("Error initializing settings:",s)}const n=localStorage.getItem("chats");if(n)try{const s=JSON.parse(n);await this.transaction("rw",this.chats,this.messages,this.mediaItems,async()=>{for(const i of s){const c=[...i.messages],d={...i};delete d.messages,await this.chats.put(d);for(const S of c){const O=S.media||[],B={...S,chatId:i.id};delete B.media,await this.messages.put(B);for(const q of O)await this.mediaItems.put({...q,messageId:S.id})}}console.log("Chats migrated from localStorage to IndexedDB")})}catch(s){console.error("Failed to migrate chats:",s)}}}async getAllChats(){return(await this.chats.orderBy("updatedAt").reverse().toArray()).map(s=>({...s,messages:[]}))}async getChat(n){const s=await this.chats.get(n);if(!s)return null;const i=await this.messages.where("chatId").equals(n).sortBy("timestamp");for(const c of i){const d=await this.mediaItems.where("messageId").equals(c.id).toArray();d.length>0&&(c.media=d)}return{...s,messages:i}}async createChat(n=Jo){const s={id:crypto.randomUUID(),title:"New Chat",messages:[],createdAt:Date.now(),updatedAt:Date.now(),model:n},i={...s};return delete i.messages,await this.chats.put(i),s}async updateChat(n,s){const i={...s};"messages"in i&&delete i.messages,i.updatedAt=Date.now(),await this.chats.update(n,i)}async deleteChat(n){await this.transaction("rw",this.chats,this.messages,this.mediaItems,async()=>{const s=await this.messages.where("chatId").equals(n).toArray();for(const i of s)await this.mediaItems.where("messageId").equals(i.id).delete();await this.messages.where("chatId").equals(n).delete(),await this.chats.delete(n)})}async addMessage(n,s){const i=crypto.randomUUID(),c=Date.now(),d={...s,id:i,chatId:n,timestamp:c};return await this.transaction("rw",this.messages,this.mediaItems,this.chats,async()=>{const S=d.media||[],O={...d};delete O.media,await this.messages.put(O);for(const q of S){const H={...q,id:q.id||crypto.randomUUID(),messageId:i,timestamp:q.timestamp||Date.now()};await this.mediaItems.put(H)}const B=await this.chats.get(n);if(B&&B.title==="New Chat"&&s.role==="user"){const q=s.content.slice(0,30)+(s.content.length>30?"...":"");await this.chats.update(n,{title:q,updatedAt:Date.now()})}else await this.chats.update(n,{updatedAt:Date.now()})}),i}async updateMessage(n,s){try{const i=await this.messages.get(n);if(!i){console.error(`Cannot update message ${n} - not found in database`);return}await this.transaction("rw",this.messages,this.mediaItems,this.chats,async()=>{const c={...s};if("media"in c&&c.media!==void 0){const d=c.media||[];delete c.media,await this.mediaItems.where("messageId").equals(n).delete();for(const S of d){const O={...S,id:S.id||crypto.randomUUID(),messageId:n,timestamp:S.timestamp||Date.now()};await this.mediaItems.put(O)}}"chatId"in c&&delete c.chatId,Object.keys(c).forEach(d=>{c[d]===void 0&&delete c[d]}),Object.keys(c).length>0&&await this.messages.update(n,c),i.chatId&&await this.chats.update(i.chatId,{updatedAt:Date.now()})})}catch(i){throw console.error("Error updating message:",i),i}}async getSettings(){let n=await this.settings.get("user-settings");if(!n){const s={id:"user-settings",apiKeys:{},theme:"system",videoCaptureDuration:5,videoCaptureFps:1,saveChatsToLocalStorage:!1};await this.settings.put(s),n=s}return n}async updateSettings(n){const s=await this.getSettings();await this.settings.update("user-settings",{...s,...n})}async updateApiKeys(n){const i={...(await this.getSettings()).apiKeys,...n};await this.settings.update("user-settings",{apiKeys:i})}}class Xo{constructor(n){n&&Object.assign(this,n),this.messages=this.messages||[]}}const rr=new zo;export{Jo as a,xo as b,xu as c,rr as d,yu as e,gu as f,Zi as g,vu as h,Su as i,wu as j,_u as k,ta as l,Ba as m,Oo as o,lr as s,bu as u,jo as v};
